<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>ElasticSearch高级 | Jason</title><meta name="keywords" content="ElasticSearch"><meta name="author" content="高明辉"><meta name="copyright" content="高明辉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="回顾mysql的内容： 123456789101112131415161718192021Select * from 表名 where 分组前条件 group by 分组字段 having 分组后筛选条件	1 where:     	where用在分组前,对分组前的数据进行筛选    	where后不能使用聚合函数    2 having:    	having用在分组后,对分组后的数据进行筛选">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch高级">
<meta property="og:url" content="http://example.com/2022/05/17/ElasticSearch%E9%AB%98%E7%BA%A7/index.html">
<meta property="og:site_name" content="Jason">
<meta property="og:description" content="回顾mysql的内容： 123456789101112131415161718192021Select * from 表名 where 分组前条件 group by 分组字段 having 分组后筛选条件	1 where:     	where用在分组前,对分组前的数据进行筛选    	where后不能使用聚合函数    2 having:    	having用在分组后,对分组后的数据进行筛选">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/%E5%B0%81%E9%9D%A2.png">
<meta property="article:published_time" content="2022-05-17T08:32:03.000Z">
<meta property="article:modified_time" content="2022-12-11T02:30:14.923Z">
<meta property="article:author" content="高明辉">
<meta property="article:tag" content="ElasticSearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/%E5%B0%81%E9%9D%A2.png"><link rel="shortcut icon" href="/img/%E7%BD%91%E7%AB%99%E5%9B%BE%E6%A0%87.png"><link rel="canonical" href="http://example.com/2022/05/17/ElasticSearch%E9%AB%98%E7%BA%A7/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ElasticSearch高级',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-12-11 10:30:14'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Jason" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/%E5%A4%B4%E5%83%8F.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">193</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">231</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">36</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li><li><a class="site-page child" href="/butterfly%E4%B8%BB%E9%A2%98"><i class="fa-fw https://github.com/jerryc127/hexo-theme-butterfly/"></i><span> 2</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/%E5%B0%81%E9%9D%A2.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Jason</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li><li><a class="site-page child" href="/butterfly%E4%B8%BB%E9%A2%98"><i class="fa-fw https://github.com/jerryc127/hexo-theme-butterfly/"></i><span> 2</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ElasticSearch高级</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-17T08:32:03.000Z" title="发表于 2022-05-17 16:32:03">2022-05-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-12-11T02:30:14.923Z" title="更新于 2022-12-11 10:30:14">2022-12-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/ElasticSearch/">ElasticSearch</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ElasticSearch高级"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><strong>回顾mysql的内容：</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Select</span> <span class="string">* from 表名 where 分组前条件 group by 分组字段 having 分组后筛选条件</span></span><br><span class="line">	<span class="attr">1</span> <span class="string">where: </span></span><br><span class="line">    	<span class="attr">where用在分组前,对分组前的数据进行筛选</span></span><br><span class="line">    	<span class="attr">where后不能使用聚合函数</span></span><br><span class="line">    <span class="attr">2</span> <span class="string">having:</span></span><br><span class="line">    	<span class="attr">having用在分组后,对分组后的数据进行筛选</span></span><br><span class="line">    	<span class="attr">having后可以使用聚合函数</span></span><br><span class="line">    <span class="attr">3</span> <span class="string">聚合函数:</span></span><br><span class="line">    	<span class="attr">count</span></span><br><span class="line">    	<span class="attr">max</span></span><br><span class="line">    	<span class="attr">min</span></span><br><span class="line">    	<span class="attr">sum</span></span><br><span class="line">    	<span class="attr">avg</span></span><br><span class="line"></span><br><span class="line"><span class="meta">根据性别分组</span>:  <span class="string">（前者为mysql概念，后者为es概念）</span></span><br><span class="line">	<span class="meta">男组</span> <span class="string">- 男桶</span></span><br><span class="line">	<span class="meta">女组</span> <span class="string">- 女桶</span></span><br><span class="line"><span class="meta">对分组后的数据进行聚合</span>: <span class="string">进行统计</span></span><br><span class="line">	<span class="meta">聚合函数</span> <span class="string">- 度量 </span></span><br><span class="line">		<span class="meta">聚合函数</span>: <span class="string">统计当前组中的数据信息</span></span><br><span class="line">		<span class="meta">度量</span>: <span class="string">测量桶中的数据信息</span></span><br></pre></td></tr></table></figure>



<h1 id="1-ES的聚合"><a href="#1-ES的聚合" class="headerlink" title="1.ES的聚合"></a>1.ES的聚合</h1><p>聚合（aggregations）可以让我们极其方便的实现对数据的统计、分析。例如：</p>
<ul>
<li>什么品牌的手机最受欢迎？</li>
<li>这些手机的平均价格、最高价格、最低价格？</li>
<li>这些手机每月的销售情况如何？</li>
</ul>
<p>实现这些统计功能的比数据库的sql要方便的多，而且查询速度非常快，可以实现近<strong>实时搜索</strong>效果。</p>
<p>要注意：<strong>参与聚合的字段，必须不能分词</strong>。</p>
<h2 id="1-1-基本概念"><a href="#1-1-基本概念" class="headerlink" title="1.1 基本概念"></a>1.1 基本概念</h2><p>Elasticsearch中的聚合，包含多种类型，最常用的两种，一个叫<code>桶</code>，一个叫<code>度量</code>：</p>
<blockquote>
<p><strong>桶（bucket）</strong></p>
</blockquote>
<p>桶的作用，是按照某种方式对数据进行分组，每一组数据在ES中称为一个<code>桶</code>，例如我们根据国籍对人划分，可以得到<code>中国桶</code>、<code>英国桶</code>，<code>日本桶</code>……或者我们按照年龄段对人进行划分：0-10,10-20,20-30,30-40等。</p>
<p>Elasticsearch中提供的划分桶的方式有很多：</p>
<ul>
<li>Date Histogram Aggregation：根据日期阶梯分组，例如给定阶梯为周，会自动每周分为一组</li>
<li>Histogram Aggregation：根据数值阶梯分组，与日期类似，需要知道分组的间隔（interval）</li>
<li>Terms Aggregation：根据词条内容分组，词条内容完全匹配的为一组，类似数据库group by </li>
<li>Range Aggregation：数值和日期的范围分组，指定开始和结束，然后按段分组</li>
<li>……</li>
</ul>
<p>综上所述，我们发现bucket aggregations 只负责对数据进行分组，并不进行计算，因此往往bucket中往往会嵌套另一种聚合：metrics aggregations即度量</p>
<blockquote>
<p><strong>度量（metrics）</strong></p>
</blockquote>
<p>分组完成以后，我们一般会对组中的数据进行聚合运算，例如求平均值、最大、最小、求和等，这些在ES中称为<code>度量</code></p>
<p>比较常用的一些度量聚合方式：</p>
<ul>
<li>Avg Aggregation：求平均值</li>
<li>Max Aggregation：求最大值</li>
<li>Min Aggregation：求最小值</li>
<li>Percentiles Aggregation：求百分比</li>
<li>Stats Aggregation：同时返回avg、max、min、sum、count等</li>
<li>Sum Aggregation：求和</li>
<li>Top hits Aggregation：求前几</li>
<li>Value Count Aggregation：求总数</li>
<li>……</li>
</ul>
<p>为了测试聚合，我们先批量导入一些数据</p>
<p>创建索引：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /car</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;color&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;make&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：在ES中，需要进行聚合、排序、过滤的字段其处理方式比较特殊，因此**不能被分词，必须使用<code>keyword</code>或<code>数值类型</code>**。这里我们将color和make这两个文字类型的字段设置为keyword类型，这个类型不会被分词，将来就可以参与聚合</p>
<p>导入数据，这里是采用批处理的API，大家直接复制到kibana运行即可：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /car/_bulk</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">&#123; <span class="attr">&quot;price&quot;</span> : <span class="number">10000</span>, <span class="attr">&quot;color&quot;</span> : <span class="string">&quot;红&quot;</span>, <span class="attr">&quot;make&quot;</span> : <span class="string">&quot;本田&quot;</span>, <span class="attr">&quot;sold&quot;</span> : <span class="string">&quot;2014-10-28&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">&#123; <span class="attr">&quot;price&quot;</span> : <span class="number">20000</span>, <span class="attr">&quot;color&quot;</span> : <span class="string">&quot;红&quot;</span>, <span class="attr">&quot;make&quot;</span> : <span class="string">&quot;本田&quot;</span>, <span class="attr">&quot;sold&quot;</span> : <span class="string">&quot;2014-11-05&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">&#123; <span class="attr">&quot;price&quot;</span> : <span class="number">30000</span>, <span class="attr">&quot;color&quot;</span> : <span class="string">&quot;绿&quot;</span>, <span class="attr">&quot;make&quot;</span> : <span class="string">&quot;福特&quot;</span>, <span class="attr">&quot;sold&quot;</span> : <span class="string">&quot;2014-05-18&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">&#123; <span class="attr">&quot;price&quot;</span> : <span class="number">15000</span>, <span class="attr">&quot;color&quot;</span> : <span class="string">&quot;蓝&quot;</span>, <span class="attr">&quot;make&quot;</span> : <span class="string">&quot;丰田&quot;</span>, <span class="attr">&quot;sold&quot;</span> : <span class="string">&quot;2014-07-02&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">&#123; <span class="attr">&quot;price&quot;</span> : <span class="number">12000</span>, <span class="attr">&quot;color&quot;</span> : <span class="string">&quot;绿&quot;</span>, <span class="attr">&quot;make&quot;</span> : <span class="string">&quot;丰田&quot;</span>, <span class="attr">&quot;sold&quot;</span> : <span class="string">&quot;2014-08-19&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">&#123; <span class="attr">&quot;price&quot;</span> : <span class="number">20000</span>, <span class="attr">&quot;color&quot;</span> : <span class="string">&quot;红&quot;</span>, <span class="attr">&quot;make&quot;</span> : <span class="string">&quot;本田&quot;</span>, <span class="attr">&quot;sold&quot;</span> : <span class="string">&quot;2014-11-05&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">&#123; <span class="attr">&quot;price&quot;</span> : <span class="number">80000</span>, <span class="attr">&quot;color&quot;</span> : <span class="string">&quot;红&quot;</span>, <span class="attr">&quot;make&quot;</span> : <span class="string">&quot;宝马&quot;</span>, <span class="attr">&quot;sold&quot;</span> : <span class="string">&quot;2014-01-01&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">&#123; <span class="attr">&quot;price&quot;</span> : <span class="number">25000</span>, <span class="attr">&quot;color&quot;</span> : <span class="string">&quot;蓝&quot;</span>, <span class="attr">&quot;make&quot;</span> : <span class="string">&quot;福特&quot;</span>, <span class="attr">&quot;sold&quot;</span> : <span class="string">&quot;2014-02-12&quot;</span> &#125;</span><br></pre></td></tr></table></figure>





<h2 id="1-2-聚合为桶"><a href="#1-2-聚合为桶" class="headerlink" title="1.2 聚合为桶"></a>1.2 聚合为桶</h2><p>首先，我们按照 汽车的颜色<code>color来</code>划分<code>桶</code>，按照颜色分桶，最好是使用TermAggregation类型，按照颜色的名称来分桶。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /car/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;size&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span> : &#123; </span><br><span class="line">        <span class="attr">&quot;popular_colors&quot;</span> : &#123; </span><br><span class="line">            <span class="attr">&quot;terms&quot;</span> : &#123; </span><br><span class="line">              <span class="attr">&quot;field&quot;</span> : <span class="string">&quot;color&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>size： 查询条数，这里设置为0，因为我们不关心搜索到的数据 ，只关心聚合结果，提高效率</li>
<li>aggs：声明这是一个聚合查询，是aggregations的缩写<ul>
<li>popular_colors：给这次聚合起一个名字，可任意指定。<ul>
<li>terms：聚合的类型，这里选择terms，是根据词条内容（这里是颜色）划分<ul>
<li>field：划分桶时依赖的字段</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span>: <span class="number">33</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: []</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;popular_colors&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;sum_other_doc_count&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;buckets&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;红&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span>: <span class="number">4</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;绿&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span>: <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;蓝&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span>: <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>hits：查询结果为空，因为我们设置了size为0</li>
<li>aggregations：聚合的结果</li>
<li>popular_colors：我们定义的聚合名称</li>
<li>buckets：查找到的桶，每个不同的color字段值都会形成一个桶<ul>
<li>key：这个桶对应的color字段的值</li>
<li>doc_count：这个桶中的文档数量</li>
</ul>
</li>
</ul>
<p>通过聚合的结果我们发现，目前红色的小车比较畅销！</p>
<h2 id="1-3-桶内度量"><a href="#1-3-桶内度量" class="headerlink" title="1.3 桶内度量"></a>1.3 桶内度量</h2><p>前面的例子告诉我们每个桶里面的文档数量，这很有用。 但通常，我们的应用需要提供更复杂的文档度量。 例如，每种颜色汽车的平均价格是多少？</p>
<p>因此，我们需要告诉Elasticsearch<code>使用哪个字段</code>，<code>使用何种度量方式</code>进行运算，这些信息要嵌套在<code>桶</code>内，<code>度量</code>的运算会基于<code>桶</code>内的文档进行</p>
<p>现在，我们为刚刚的聚合结果添加 求价格平均值的度量：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /car/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;size&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span> : &#123; </span><br><span class="line">        <span class="attr">&quot;popular_colors&quot;</span> : &#123; </span><br><span class="line">            <span class="attr">&quot;terms&quot;</span> : &#123; </span><br><span class="line">              <span class="attr">&quot;field&quot;</span> : <span class="string">&quot;color&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;avg_price&quot;</span>: &#123; </span><br><span class="line">                   <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">                      <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span> </span><br><span class="line">                   &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>aggs：我们在上一个aggs(popular_colors)中添加新的aggs。可见度量也是一个聚合</li>
<li>avg_price：聚合的名称</li>
<li>avg：度量的类型，这里是求平均值</li>
<li>field：度量运算的字段</li>
</ul>
<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;value&quot;</span> : <span class="number">8</span>,</span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> : <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;aggregations&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;popular_colors&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;sum_other_doc_count&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;buckets&quot;</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span> : <span class="string">&quot;红&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> : <span class="number">4</span>,</span><br><span class="line">          <span class="attr">&quot;avg_price&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span> : <span class="number">32500.0</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span> : <span class="string">&quot;绿&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> : <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;avg_price&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span> : <span class="number">21000.0</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span> : <span class="string">&quot;蓝&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> : <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;avg_price&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span> : <span class="number">20000.0</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到每个桶中都有自己的<code>avg_price</code>字段，这是度量聚合的结果</p>
<h2 id="1-4-桶内嵌套桶"><a href="#1-4-桶内嵌套桶" class="headerlink" title="1.4 桶内嵌套桶"></a>1.4 桶内嵌套桶</h2><p>刚刚的案例中，我们在桶内嵌套度量运算。事实上桶不仅可以嵌套运算， 还可以再嵌套其它桶。也就是说在每个分组中，再分更多组。</p>
<p>比如：我们想统计每种颜色的汽车中，分别属于哪个制造商，按照<code>make</code>字段再进行分桶</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET /car/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;size&quot;</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span> : &#123; </span><br><span class="line">        <span class="attr">&quot;popular_colors&quot;</span> : &#123; </span><br><span class="line">            <span class="attr">&quot;terms&quot;</span> : &#123; </span><br><span class="line">              <span class="attr">&quot;field&quot;</span> : <span class="string">&quot;color&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;avg_price&quot;</span>: &#123; </span><br><span class="line">                   <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">                      <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span> </span><br><span class="line">                   &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;maker&quot;</span>:&#123;</span><br><span class="line">                    <span class="attr">&quot;terms&quot;</span>:&#123;</span><br><span class="line">                        <span class="attr">&quot;field&quot;</span>:<span class="string">&quot;make&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>原来的color桶和avg计算我们不变</li>
<li>maker：在嵌套的aggs下新添一个桶，叫做maker</li>
<li>terms：桶的划分类型依然是词条</li>
<li>filed：这里根据make字段进行划分</li>
</ul>
<p>部分结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span>: <span class="number">16</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: []</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;popular_colors&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;sum_other_doc_count&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;buckets&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;红&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span>: <span class="number">4</span>,</span><br><span class="line">          <span class="attr">&quot;maker&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;本田&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span>: <span class="number">3</span></span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;宝马&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span>: <span class="number">1</span></span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">32500</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;绿&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;maker&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;丰田&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span>: <span class="number">1</span></span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;福特&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span>: <span class="number">1</span></span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">21000</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;蓝&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;maker&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;丰田&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span>: <span class="number">1</span></span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;福特&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span>: <span class="number">1</span></span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">20000</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们可以看到，新的聚合<code>maker</code>被嵌套在原来每一个<code>color</code>的桶中。</li>
<li>每个颜色下面都根据 <code>make</code>字段进行了分组</li>
<li>我们能读取到的信息：<ul>
<li>红色车共有4辆</li>
<li>红色车的平均售价是 $32，500 美元。</li>
<li>其中3辆是 Honda 本田制造，1辆是 BMW 宝马制造。</li>
</ul>
</li>
</ul>
<h1 id="2-ES集群"><a href="#2-ES集群" class="headerlink" title="2.ES集群"></a>2.ES集群</h1><p>我们之前安装的是单机的ES，线上部署肯定不能只用一台，因为<strong>一旦服务宕机，整个搜索服务就不可用</strong>了。因此必须使用集群来解决。</p>
<p>那么问题来了：什么是集群呢？</p>
<h2 id="2-1-什么是集群"><a href="#2-1-什么是集群" class="headerlink" title="2.1.什么是集群"></a>2.1.什么是集群</h2><p>来看下维基百科对集群的介绍：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/1543286678122.png" alt="1543286678122"></p>
<p>集群是==一组计算机==高度紧密协作，完成计算工作。其中的<strong>每个计算机称为一个节点</strong>。根据这些计算机的协作方式不同或者目的不同，我们将集群分成三类：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">1 高可用集群（宕机时可替代节点）</span></span><br><span class="line"><span class="meta">-</span> <span class="string">2 负载均衡集群（处理高并发）</span></span><br><span class="line"><span class="meta">-</span> <span class="string">3 科学计算集群（分布式处理，按照服务分为不同的节点）</span></span><br></pre></td></tr></table></figure>

<p>上述几种集群方式并非必须独立使用，我们在<strong>系统架构时经常会组合使用</strong>。</p>
<h3 id="2-1-1-高可用集群"><a href="#2-1-1-高可用集群" class="headerlink" title="2.1.1 高可用集群"></a>2.1.1 高可用集群</h3><p>High availability Cluster高可用群集，简称HAC。其设计思想是<strong>为了避免出现单点故障问题，在故障时可以==快速恢复，快速继续提供服务</strong>==。</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/1543287433625.png" alt="1543287433625"></p>
<p>如图所示，集群中两台计算机node01和node02，两者共享资源，处理业务也基本一致，互为==主从==。当node01工作时，node02就处于待命状态。所有业务在Node01上运行，若发生故障服务和资源会转移到Node02上。</p>
<p>这种架构保证了服务的高可用，但是闲置的节点是对资源的一种浪费。</p>
<h3 id="2-1-2-负载均衡集群"><a href="#2-1-2-负载均衡集群" class="headerlink" title="2.1.2 负载均衡集群"></a>2.1.2 负载均衡集群</h3><p>Load Balancing负载均衡，<strong>集群中的每一台计算机都来完成相同业务，不分主次</strong>。当用户请求到达时，通过某种算法，让请求均衡的分发到集群中的每个节点，充分利用每个节点的资源。如图所示：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/1543287806342.png" alt="1543287806342"></p>
<p>因为<strong>每个节点业务相同</strong>，如果某个节点出现故障，只需要把请求分发到其它节点即可。</p>
<h3 id="2-1-3-科学计算集群"><a href="#2-1-3-科学计算集群" class="headerlink" title="2.1.3 科学计算集群"></a>2.1.3 科学计算集群</h3><p>因为硬件设备的限制，单台计算机的处理性能是有上限的，如果<strong>计算需要的资源超过了单台计算机的能力</strong>，该怎么办呢？此时就可以使用科学计算集群。</p>
<p>我们<strong>把复杂任务拆分成一个个小的子任务</strong>，然后分配到集群中的不同节点上完成，最后再把计算结果汇总。这样大量低廉的PC机互联起来，组成一个”超级计算机”以解决复杂的计算任务。</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/1543288401040.png" alt="1543288401040"></p>
<p>这样的方式也称为==<strong>分布式运算或者分布式集群</strong>==，集群中的每个节点完成==<strong>不同任务</strong>==。</p>
<h2 id="2-2-WEB应用的集群模式"><a href="#2-2-WEB应用的集群模式" class="headerlink" title="2.2.WEB应用的集群模式"></a>2.2.WEB应用的集群模式</h2><p>上述计算机协作的集群方式任何领域都可以使用，在web开发中也是如此，不过有一些细节的不同。我们以一个电商网站为例，看看几种架构方式：</p>
<h3 id="2-2-1-单体应用"><a href="#2-2-1-单体应用" class="headerlink" title="2.2.1 单体应用"></a>2.2.1 单体应用</h3><p>所有业务在一个系统中完成：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104114208435.png" alt="image-20200104114208435"></p>
<p>出现的问题：</p>
<ul>
<li>系统庞大，功能耦合，难以维护</li>
<li>并发能力差，容易出现单点故障</li>
<li>无法针对不同功能进行优化</li>
</ul>
<h3 id="2-2-2-分布式架构"><a href="#2-2-2-分布式架构" class="headerlink" title="2.2.2 分布式架构"></a>2.2.2 分布式架构</h3><p>按照上面的分布式集群概念，集群中的每个节点完成不同业务。在web开发中也是如此，我们把完整系统进行拆分，形成独立系统，然后部署到不同的tomcat节点，不同节点通过网络通信，相互协作。</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104114653959.png" alt="image-20200104114653959"></p>
<p>这样就将复杂系统细分，降低了业务间的耦合，但是却带来了另一个问题，就是单个节点故障会导致整个系统不完整。为了保证高可用，还需要对集群做备份，实现负载均衡。</p>
<h3 id="2-2-3-高可用分布式集群架构"><a href="#2-2-3-高可用分布式集群架构" class="headerlink" title="2.2.3 高可用分布式集群架构"></a>2.2.3 高可用分布式集群架构</h3><p>为了解决上面所述的单点故障问题，我们可以为分布式系统中的每个节点都<strong>部署负载均衡节点</strong>，即：每个业务系统都有一个负载均衡的小集群。</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104115507599.png" alt="image-20200104115507599"></p>
<h2 id="2-3-ElasticSearch的集群"><a href="#2-3-ElasticSearch的集群" class="headerlink" title="2.3.ElasticSearch的集群"></a>2.3.ElasticSearch的集群</h2><p>单点的elasticsearch存在哪些可能出现的问题呢？</p>
<ul>
<li>单台机器<strong>存储容量有限</strong></li>
<li>单服务器容易出现<strong>单点故障，无法实现高可用</strong></li>
<li>单服务的<strong>并发处理能力有限</strong></li>
</ul>
<p>所以，为了应对这些问题，我们需要<strong>对elasticsearch搭建集群</strong></p>
<h3 id="2-3-1-数据分片"><a href="#2-3-1-数据分片" class="headerlink" title="2.3.1.数据分片"></a>2.3.1.数据分片</h3><p>首先，我们面临的第一个问题就是数据量太大，单点存储量有限的问题。</p>
<p>我们可以把数据拆分成多份，每一份存储到不同机器节点（node），从而实现减少每个节点数据量的目的。这就是数据的分布式存储，也叫做：<code>数据分片（Shard）</code>。</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104124440086.png" alt="image-20200104124440086"></p>
<p>此处，我们把数据分成3片：shard0、shard1、shard2</p>
<h3 id="2-3-2-数据备份"><a href="#2-3-2-数据备份" class="headerlink" title="2.3.2.数据备份"></a>2.3.2.数据备份</h3><p>数据分片解决了海量数据存储的问题，但是如果出现单点故障，那么分片数据就不再完整，这又该如何解决呢？</p>
<p>没错，就像大家为了备份手机数据，会额外存储一份到移动硬盘一样。我们可以给每个分片数据进行备份，存储到其它节点，防止数据丢失，这就是数据备份，也叫<code>数据副本（replica）</code>。</p>
<p>数据备份可以保证高可用，但是每个分片备份一份，所需要的节点数量就会翻一倍，成本实在是太高了！</p>
<p>为了在高可用和成本间寻求平衡，我们可以这样做：</p>
<ul>
<li>首先对数据分片，存储到不同节点</li>
<li>然后对每个分片进行备份，放到对方节点，<strong>完成互相备份</strong></li>
</ul>
<p>这样可以大大减少所需要的服务节点数量，如图，我们以3分片，每个分片备份一份为例：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104124551912.png" alt="image-20200104124551912"></p>
<p>现在，每个分片都有1个备份，存储在3个节点：</p>
<ul>
<li>node0：保存了分片0和1</li>
<li>node1：保存了分片0和2</li>
<li>node2：保存了分片1和2</li>
</ul>
<h2 id="2-4-搭建集群"><a href="#2-4-搭建集群" class="headerlink" title="2.4.搭建集群"></a>2.4.搭建集群</h2><p>1 下载的es压缩文件</p>
<p>2  解压缩压缩包（解压缩即安装）</p>
<p>3 修改占用内存: config/jvm.options文件（一定要改，将1g改成256M，否则搞崩你的电脑）<br>    -Xms256m<br>    -Xmx256m</p>
<p>4 将中文分词器插件相关文件复制到plugins目录下。</p>
<p>4 进入ElasticSearch的bin目录：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104121859074.png" alt="image-20200104121859074"> </p>
<p>5 然后打开<strong>3个控制台</strong>，分别输入下面的3个指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># node0指令：</span><br><span class="line">elasticsearch.bat -E node.name=node0 -E cluster.name=elastic -E path.data=node0_data</span><br><span class="line"># node1指令：</span><br><span class="line">elasticsearch.bat -E node.name=node1 -E cluster.name=elastic -E path.data=node1_data</span><br><span class="line"># node2指令：</span><br><span class="line">elasticsearch.bat -E node.name=node2 -E cluster.name=elastic -E path.data=node2_data</span><br></pre></td></tr></table></figure>

<p>6 命令解释：</p>
<ul>
<li><code>elasticsearch.bat</code>：运行elasticsearch.bat文件</li>
<li><code> -E node.name</code>：<code>-E</code>是环境参数，node.name是指定节点名称</li>
<li><code>cluster.name</code>：指定集群名称</li>
<li><code>path.data</code>：指定数据目录地址，相对路径是相对于ElasticSearch的安装目录</li>
</ul>
<p>打开的三个es，端口号默认从9200自增到9202</p>
<h2 id="2-5-配置Kibana访问集群"><a href="#2-5-配置Kibana访问集群" class="headerlink" title="2.5.配置Kibana访问集群"></a>2.5.配置Kibana访问集群</h2><h3 id="2-5-1-修改配置"><a href="#2-5-1-修改配置" class="headerlink" title="2.5.1.修改配置"></a>2.5.1.修改配置</h3><p>在Kibana中的config中打开kibana.yml文件：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104123006061.png" alt="image-20200104123006061"> </p>
<p>找到这样一行代码：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch.hosts: [&quot;http://localhost:9200&quot;]</span></span><br></pre></td></tr></table></figure>

<p>前面的<code>#</code>是注释，需要删除以打开注释。然后在后面的数组中添加ES的集群地址：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">elasticsearch.hosts:</span> [<span class="string">&quot;http://localhost:9200&quot;</span>,<span class="string">&quot;http://localhost:9201&quot;</span>,<span class="string">&quot;http://localhost:9202&quot;</span>]</span><br></pre></td></tr></table></figure>



<h3 id="2-5-2-重启并访问"><a href="#2-5-2-重启并访问" class="headerlink" title="2.5.2.重启并访问"></a>2.5.2.重启并访问</h3><p>重启kibana，然后再左侧的菜单点击monitor：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104123219341.png" alt="image-20200104123219341"> </p>
<p>在页面中点击按钮，打开监控功能，可能需要等待几秒钟。</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104123234801.png" alt="image-20200104123234801"></p>
<p>然后可以看到kibana提供的监控功能：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104123303523.png" alt="image-20200104123303523"></p>
<p>可以看到启动的3个节点的信息：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104123425983.png" alt="image-20200104123425983"></p>
<h2 id="2-6-测试集群"><a href="#2-6-测试集群" class="headerlink" title="2.6.测试集群"></a>2.6.测试集群</h2><h3 id="2-6-1-配置分片和副本信息"><a href="#2-6-1-配置分片和副本信息" class="headerlink" title="2.6.1.配置分片和副本信息"></a>2.6.1.配置分片和副本信息</h3><p>还记得创建索引库的API吗？</p>
<ul>
<li><p>请求方式：PUT</p>
</li>
<li><p>请求路径：/索引库名</p>
</li>
<li><p>请求参数：json格式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;属性名&quot;</span>: <span class="string">&quot;属性值&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>settings：就是索引库设置，其中可以定义索引库的各种属性，之前我们没有配置，是默认值。</p>
</li>
</ul>
<p>settings中就可以配置索引库的分片和副本信息，语法如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /heima</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span>: <span class="number">3</span>, # 设置分片数为3</span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span>: <span class="number">1</span> # 设置副本数为<span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有两个配置：</p>
<ul>
<li>number_of_shards：分片数量，这里设置为3</li>
<li>number_of_replicas：副本数量，这里设置为1，每个分片一个备份，一个原始数据，共2份。</li>
</ul>
<p>意思是<strong>三个集群的总数据容量分为3片，每个节点保存一份，同时再备份一份</strong></p>
<h3 id="2-6-2-查看分片结果"><a href="#2-6-2-查看分片结果" class="headerlink" title="2.6.2.查看分片结果"></a>2.6.2.查看分片结果</h3><p>进入monitor页面，然后选择查看索引库（indices)信息：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104123901902.png" alt="image-20200104123901902"></p>
<p>可以看到我们刚刚加入的索引库：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104124032092.png" alt="image-20200104124032092"></p>
<p>点击进入，然后拉到页面最底部：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104124127516.png" alt="image-20200104124127516"></p>
<p>可以看到每个分片在节点上的信息：</p>
<ul>
<li>node0：保存了分片0和1</li>
<li>node1：保存了分片0和2</li>
<li>node2：保存了分片1和2</li>
</ul>
<p>这个结果与我们上面画图分析是一致的。</p>
<h3 id="2-6-3-集群动态伸缩"><a href="#2-6-3-集群动态伸缩" class="headerlink" title="2.6.3.集群动态伸缩"></a>2.6.3.集群动态伸缩</h3><p>现在，我们让node1宕机，停止node1的控制台进程即可。</p>
<p>然后查看Kibana中的节点状态：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104124825356.png" alt="image-20200104124825356"></p>
<p>发现node1已经宕机了，此时数据是不安全的。</p>
<p>稍等片刻，再次查看：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104125003684.png" alt="image-20200104125003684"></p>
<p>发现<strong>分片数据进行了重新分配</strong>，node1上的分片被重新分配了。此时集群依然是健康的。</p>
<p>我们重新启动node1看看：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104125153682.png" alt="image-20200104125153682"></p>
<p>分片再次重新分配，那么每个节点都存储了部分分片。</p>
<h1 id="3-ES的Java客户端"><a href="#3-ES的Java客户端" class="headerlink" title="3.ES的Java客户端"></a>3.ES的Java客户端</h1><p>在elasticsearch官网中提供了各种语言的客户端：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/index.html">https://www.elastic.co/guide/en/elasticsearch/client/index.html</a></p>
<p>而Java的客户端就有两个：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104164045946.png" alt="image-20200104164045946"> </p>
<p>不过Java API这个客户端（Transport Client）已经在7.0以后过期了，而且在8.0版本中将直接废弃。所以我们会学习<strong>Java REST Client：</strong></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104164428873.png" alt="image-20200104164428873"> </p>
<p>然后再选择High Level REST Client这个。</p>
<p>Java  REST Client 其实就是<strong>利用Java语言向 ES服务发 Http的请求</strong>，因此请求和操作与前面学习的REST API 一模一样。</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20210630113645669.png" alt="image-20210630113645669"></p>
<p>不过，为了后面学习，我们需要准备一些数据，导入到ES中</p>
<h2 id="3-1-准备数据库数据"><a href="#3-1-准备数据库数据" class="headerlink" title="3.1.准备数据库数据"></a>3.1.准备数据库数据</h2><p>我们需要从数据库导入数据到ES中，因此需要做一些准备：</p>
<ul>
<li>引入依赖</li>
<li>执行sql，准备数据</li>
<li>引入实体类</li>
<li>引入mybatis相关配置</li>
<li>引入mapper和service代码</li>
</ul>
<h3 id="3-1-1-创建maven项目es-demo-并引入依赖"><a href="#3-1-1-创建maven项目es-demo-并引入依赖" class="headerlink" title="3.1.1.创建maven项目es-demo,并引入依赖"></a>3.1.1.创建maven项目es-demo,并引入依赖</h3><p>在项目的pom文件中引入一些依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.itcast.demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>es-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Junit单元测试 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--elastic客户端--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--数据库驱动--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mybatis--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--JSON工具--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.49<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--common工具--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="3-1-2-执行sql"><a href="#3-1-2-执行sql" class="headerlink" title="3.1.2.执行sql"></a>3.1.2.执行sql</h3><p>我们导入课前资料提供的Sql：<code>tb_user.sql</code>。或者执行sql语句：</p>
<p>表结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for tb_user</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `tb_user`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_user`  (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  `age` <span class="type">int</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">  `gender` <span class="type">varchar</span>(<span class="number">2</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;男&#x27;</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">  `note` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;备注&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">13</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> Compact;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of tb_user</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_user` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;张三&#x27;</span>, <span class="number">30</span>, <span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;张三同学在学Java&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_user` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="number">21</span>, <span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;李四同学在传智学Java&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_user` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;王五&#x27;</span>, <span class="number">22</span>, <span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;王五同学在学php&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_user` <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">&#x27;张伟&#x27;</span>, <span class="number">20</span>, <span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;张伟同学在传智播客学Java&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_user` <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="string">&#x27;李娜&#x27;</span>, <span class="number">28</span>, <span class="string">&#x27;女&#x27;</span>, <span class="string">&#x27;李娜同学在传智播客学Java&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_user` <span class="keyword">VALUES</span> (<span class="number">6</span>, <span class="string">&#x27;李磊&#x27;</span>, <span class="number">23</span>, <span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;李磊同学在传智播客学Java&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_user` <span class="keyword">VALUES</span> (<span class="number">7</span>, <span class="string">&#x27;韩梅梅&#x27;</span>, <span class="number">24</span>, <span class="string">&#x27;女&#x27;</span>, <span class="string">&#x27;韩梅梅同学在传智播客学php&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_user` <span class="keyword">VALUES</span> (<span class="number">8</span>, <span class="string">&#x27;柳岩&#x27;</span>, <span class="number">21</span>, <span class="string">&#x27;女&#x27;</span>, <span class="string">&#x27;柳岩同学在传智播客学表演&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_user` <span class="keyword">VALUES</span> (<span class="number">9</span>, <span class="string">&#x27;刘亦菲&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;女&#x27;</span>, <span class="string">&#x27;刘亦菲同学在传智播客学唱歌&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_user` <span class="keyword">VALUES</span> (<span class="number">10</span>, <span class="string">&#x27;范冰冰&#x27;</span>, <span class="number">25</span>, <span class="string">&#x27;女&#x27;</span>, <span class="string">&#x27;范冰冰同学在传智播客学表演&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_user` <span class="keyword">VALUES</span> (<span class="number">11</span>, <span class="string">&#x27;郑爽&#x27;</span>, <span class="number">23</span>, <span class="string">&#x27;女&#x27;</span>, <span class="string">&#x27;郑爽同学在传智播客学习如何装纯&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_user` <span class="keyword">VALUES</span> (<span class="number">12</span>, <span class="string">&#x27;唐嫣&#x27;</span>, <span class="number">26</span>, <span class="string">&#x27;女&#x27;</span>, <span class="string">&#x27;唐嫣同学在传智播客学习如何耍酷&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>



<h3 id="3-1-3-引入实体类"><a href="#3-1-3-引入实体类" class="headerlink" title="3.1.3.引入实体类"></a>3.1.3.引入实体类</h3><p>实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.es.pojo;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;<span class="comment">// 姓名</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;<span class="comment">// 年龄</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String gender;<span class="comment">// 性别</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String note;<span class="comment">// 备注</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-1-4-引入mybatis配置"><a href="#3-1-4-引入mybatis配置" class="headerlink" title="3.1.4.引入mybatis配置"></a>3.1.4.引入mybatis配置</h3><p>提供了配置：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104180104872.png" alt="image-20200104180104872"> </p>
<p>把：<code>jdbc.properties</code>、<code>mybatis-config.xml</code>、<code>UserMapper.xml</code>复制到项目中:</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200104180244813.png" alt="image-20200104180244813"> </p>
<h3 id="3-1-5-引入mapper和Service"><a href="#3-1-5-引入mapper和Service" class="headerlink" title="3.1.5.引入mapper和Service"></a>3.1.5.引入mapper和Service</h3><p>mapper：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.es.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.itcast.es.pojo.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">User <span class="title">findById</span><span class="params">(Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.es.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.itcast.es.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.es.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserService</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String resource = <span class="string">&quot;mybatis-config.xml&quot;</span>;</span><br><span class="line">            InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">            SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line">            userMapper = sqlSessionFactory.openSession(<span class="keyword">true</span>).getMapper(UserMapper.class);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提供了根据id查询和查询所有两个功能。</p>
<h2 id="3-2-连接ElasticSearch"><a href="#3-2-连接ElasticSearch" class="headerlink" title="3.2.连接ElasticSearch"></a>3.2.连接ElasticSearch</h2><p>在官网上可以看到连接ES的教程：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-getting-started-initialization.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-getting-started-initialization.html</a></p>
<p>首先需要与ES建立连接，ES提供了一个客户端RestHighLevelClient。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RestHighLevelClient client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">                RestClient.builder(</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>),</span><br><span class="line">                        <span class="comment">//new HttpHost(&quot;localhost&quot;, 9201, &quot;http&quot;),</span></span><br><span class="line">                        <span class="comment">//new HttpHost(&quot;localhost&quot;, 9202, &quot;http&quot;)</span></span><br><span class="line">                )</span><br><span class="line">        );</span><br></pre></td></tr></table></figure>

<p>ES中的所有操作都是通过RestHighLevelClient来完成的：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200105103815463.png" alt="image-20200105103815463"> </p>
<p>为了后面测试方便，我们写到一个单元测试中，并且通过<code>@Before</code>注解来初始化客户端连接。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 建立连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">                RestClient.builder(</span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">&quot;192.168.159.131&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>),</span><br><span class="line">                        <span class="comment">//new HttpHost(&quot;localhost&quot;, 9201, &quot;http&quot;),</span></span><br><span class="line">                        <span class="comment">//new HttpHost(&quot;localhost&quot;, 9202, &quot;http&quot;)</span></span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭客户端连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="4-Java实现创建库和映射"><a href="#4-Java实现创建库和映射" class="headerlink" title="4.Java实现创建库和映射"></a>4.Java实现创建库和映射</h1><p>开发中，往往库和映射的操作一起完成，官网详细文档地址：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/_index_apis.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/_index_apis.html</a></p>
<p>这里我们主要实现库和映射的创建。查询、删除等功能大家可参考文档自己实现。</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200105093038617.png" alt="image-20200105093038617"> </p>
<h2 id="4-1-思路分析"><a href="#4-1-思路分析" class="headerlink" title="4.1.思路分析"></a>4.1.思路分析</h2><p>按照官网给出的步骤，创建索引包括下面几个步骤：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">1）创建CreateIndexRequest对象，并指定索引库名称</span></span><br><span class="line"><span class="meta">-</span> <span class="string">2）指定settings配置</span></span><br><span class="line"><span class="meta">-</span> <span class="string">3）指定mapping配置</span></span><br><span class="line"><span class="meta">-</span> <span class="string">4）发起请求，得到响应</span></span><br></pre></td></tr></table></figure>

<p>其实仔细分析，与我们在Kibana中的Rest风格API完全一致：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT /heima</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span>: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-2-设计映射规则"><a href="#4-2-设计映射规则" class="headerlink" title="4.2.设计映射规则"></a>4.2.设计映射规则</h2><p>Java代码中设置mapping，依然与REST中一致，需要JSON风格的映射规则。因此我们先在kibana中给User实体类定义好映射规则。</p>
<p>User包括下面的字段：</p>
<ul>
<li>Id：主键，在ES中是唯一标示，数字，可以选择long类型</li>
<li>name：姓名，字符串类型，但是无需分词，使用keyword，也无需查找，index为false</li>
<li>age：年龄，整数，可以使用integer</li>
<li>gender：性别，字符串类型，但是无需分词，使用keyword</li>
<li>note：备注，用户详细信息，字符串类型。需要分词，使用text</li>
</ul>
<p>映射如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PUT /user</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span>: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;long&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;age&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;gender&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;note&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-3-代码实现"><a href="#4-3-代码实现" class="headerlink" title="4.3.代码实现"></a>4.3.代码实现</h2><p>我们在上面新建的ElasticDemo类中新建单元测试，完成代码，思路就是之前分析的4步骤：</p>
<ul>
<li>1）创建CreateIndexRequest对象，并指定索引库名称</li>
<li>2）指定settings配置</li>
<li>3）指定mapping配置</li>
<li>4）发起请求，得到响应</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建CreateIndexRequest对象，并指定索引库名称</span></span><br><span class="line">        CreateIndexRequest request = <span class="keyword">new</span> CreateIndexRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.指定settings配置</span></span><br><span class="line">        request.settings(Settings.builder()</span><br><span class="line">                .put(<span class="string">&quot;index.number_of_shards&quot;</span>, <span class="number">3</span>)</span><br><span class="line">                .put(<span class="string">&quot;index.number_of_replicas&quot;</span>, <span class="number">1</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// 3.指定mapping配置</span></span><br><span class="line">        request.mapping(<span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    \&quot;properties\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;      \&quot;id\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        \&quot;type\&quot;: \&quot;long\&quot;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;      \&quot;name\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;      \&quot;age\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;      \&quot;gender\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;      \&quot;note\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;      &#125;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;  &#125;&quot;</span>,</span><br><span class="line">                XContentType.JSON);</span><br><span class="line">        <span class="comment">// 4.发起请求，得到响应</span></span><br><span class="line">        CreateIndexResponse response = client.indices().create(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;response = &quot;</span> + response.isAcknowledged());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = true</span><br></pre></td></tr></table></figure>

<h2 id="演示代码"><a href="#演示代码" class="headerlink" title="演示代码"></a>演示代码</h2><p>下面演示的，创建客户端，创建索引库以及设置setting，mapping，查看删除索引库代码都比较固定的套路，只不过</p>
<p>1 我们要<strong>学会从官网上看不同版本的API写出不同版本的代码，我们要学会那种迁移学习的能力</strong>，而不仅仅是低端的搬运工！关于索引库的一些操作API：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.16/_index_apis.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.16/_index_apis.html</a></p>
<p>2 然后<strong>查看响应时，一下子不知道如何解析，分析得到的相应信息，可以用debug功能，一步步解析我想要的数据</strong>！这也是一种比较重要的能力！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.es;</span><br><span class="line">(略)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client =<span class="keyword">null</span> ;</span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 创建客户端对象</span></span><br><span class="line">        client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">                RestClient.builder(</span><br><span class="line">                        <span class="comment">//new HttpHost(&quot;localhost&quot;, 9200, &quot;http&quot;),</span></span><br><span class="line">                        <span class="keyword">new</span> HttpHost(<span class="string">&quot;192.168.190.149&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ====================<span class="doctag">TODO:</span>操作索引库========================</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">TODO:</span>创建索引库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIndexCreate</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 创建添加索引库的请求信息对象  指定索引库的名称</span></span><br><span class="line">        CreateIndexRequest createIndexRequest = <span class="keyword">new</span> CreateIndexRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        CreateIndexResponse createIndexResponse =</span><br><span class="line">                client.indices().create(createIndexRequest,RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(createIndexResponse.isAcknowledged());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建索引库时,还可以为索引库添加属性和设置类型映射</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIndexCreate1</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="comment">// 创建描述语义的对象</span></span><br><span class="line">        CreateIndexRequest createIndexRequest = <span class="keyword">new</span> CreateIndexRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span>设置索引库的属性</span></span><br><span class="line">        <span class="comment">//createIndexRequest.settings(Settings.builder()</span></span><br><span class="line">        <span class="comment">//        .put(&quot;index.number_of_shards&quot;, 3)</span></span><br><span class="line">        <span class="comment">//        .put(&quot;index.number_of_replicas&quot;, 1)</span></span><br><span class="line">        <span class="comment">//);</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span>设置索引库的类型映射</span></span><br><span class="line">        <span class="comment">//createIndexRequest.mapping(&quot; &#123;\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;    \&quot;properties\&quot;: &#123;\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;      \&quot;id\&quot;: &#123;\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;        \&quot;type\&quot;: \&quot;long\&quot;\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;      &#125;,\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;      \&quot;name\&quot;:&#123;\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;      &#125;,\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;      \&quot;age\&quot;:&#123;\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;      &#125;,\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;      \&quot;gender\&quot;:&#123;\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;      &#125;,\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;      \&quot;note\&quot;:&#123;\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;        \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;      &#125;\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;    &#125;\n&quot; +</span></span><br><span class="line">        <span class="comment">//        &quot;  &#125;&quot;,XContentType.JSON);</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 合并到一起了！！！！！！！！！！</span></span><br><span class="line">        createIndexRequest.source(<span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;settings\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;number_of_shards\&quot;: 3,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;number_of_replicas\&quot;: 1\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;mappings\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;properties\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;id\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;long\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;name\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;age\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;gender\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;note\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>,XContentType.JSON);</span><br><span class="line">        CreateIndexResponse createIndexResponse =</span><br><span class="line">                client.indices().create(createIndexRequest,RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(createIndexResponse.isAcknowledged());</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     <span class="doctag">TODO:</span> 操作ES流程</span></span><br><span class="line"><span class="comment">        1.获取客户端对象</span></span><br><span class="line"><span class="comment">        2.创建请求语义对象(用于封装本次请求的行为)</span></span><br><span class="line"><span class="comment">        3.发送请求给ES,并接收响应结果</span></span><br><span class="line"><span class="comment">        4.解析响应结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看索引库</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIndexGet</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        GetIndexRequest request = <span class="keyword">new</span> GetIndexRequest(<span class="string">&quot;car&quot;</span>);</span><br><span class="line">        GetIndexResponse response = client.indices().get(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 获取索引库的配置信息</span></span><br><span class="line">        Map&lt;String, Settings&gt; settings = response.getSettings();</span><br><span class="line">        System.out.println(settings.toString());</span><br><span class="line">        <span class="comment">// 获取索引库的映射信息</span></span><br><span class="line">        Map&lt;String, MappingMetaData&gt; mappings = response.getMappings();</span><br><span class="line">        MappingMetaData metaData = mappings.get(<span class="string">&quot;car&quot;</span>);</span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = metaData.sourceAsMap();</span><br><span class="line">        System.out.println(sourceAsMap.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除索引库</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIndexDelete</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        DeleteIndexRequest request = <span class="keyword">new</span> DeleteIndexRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        AcknowledgedResponse deleteIndexResponse =</span><br><span class="line">                client.indices().delete(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(deleteIndexResponse.isAcknowledged());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (client!=<span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">this</span>.client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="5-Java实现文档的CRUD"><a href="#5-Java实现文档的CRUD" class="headerlink" title="5.Java实现文档的CRUD"></a>5.Java实现文档的CRUD</h1><p>文档操作包括：<strong>新增文档、查询文档、修改文档、删除文档等</strong>。</p>
<p>官网地址：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-supported-apis.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-supported-apis.html</a></p>
<h2 id="5-1-新增"><a href="#5-1-新增" class="headerlink" title="5.1.新增"></a>5.1.新增</h2><p>官网地址：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-document-index.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-document-index.html</a></p>
<h3 id="5-1-1-实现思路"><a href="#5-1-1-实现思路" class="headerlink" title="5.1.1.实现思路"></a>5.1.1.实现思路</h3><p>根据官网文档，实现的步骤如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">1）创建IndexRequest对象，并指定索引库名称</span></span><br><span class="line"><span class="meta">-</span> <span class="string">2）指定新增的数据的id</span></span><br><span class="line"><span class="meta">-</span> <span class="string">3）将新增的文档数据变成JSON格式</span></span><br><span class="line"><span class="meta">-</span> <span class="string">4）将JSON数据添加到IndexRequest中</span></span><br><span class="line"><span class="meta">-</span> <span class="string">5）发起请求，得到结果</span></span><br></pre></td></tr></table></figure>

<p>不过，我们的文档数据需要去查询数据库，因此前面会多出一个步骤：从数据库查询文档数据</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">1）从数据库查询文档数据</span></span><br><span class="line"><span class="meta">-</span> <span class="string">2）创建IndexRequest对象，并指定索引库名称</span></span><br><span class="line"><span class="meta">-</span> <span class="string">3）指定新增的数据的id</span></span><br><span class="line"><span class="meta">-</span> <span class="string">4）将新增的文档数据变成JSON格式</span></span><br><span class="line"><span class="meta">-</span> <span class="string">5）将JSON数据添加到IndexRequest中</span></span><br><span class="line"><span class="meta">-</span> <span class="string">6）发起请求，得到结果</span></span><br></pre></td></tr></table></figure>



<h3 id="5-1-2-具体代码"><a href="#5-1-2-具体代码" class="headerlink" title="5.1.2.具体代码"></a>5.1.2.具体代码</h3><p><strong>需要在单元测试类中线初始化UserService对象：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> UserService userService = <span class="keyword">new</span> UserService();</span><br></pre></td></tr></table></figure>

<p>新增文档：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     <span class="doctag">TODO:</span> 操作ES流程</span></span><br><span class="line"><span class="comment">        1.获取客户端对象</span></span><br><span class="line"><span class="comment">        2.创建请求语义对象(用于封装本次请求的行为)</span></span><br><span class="line"><span class="comment">        3.发送请求给ES,并接收响应结果</span></span><br><span class="line"><span class="comment">        4.解析响应结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加文档数据信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">docPost1</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        IndexRequest request = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        request.id(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        String jsonString = <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;age\&quot; : 18,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;gender\&quot; :\&quot;女\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;name\&quot; : \&quot;大幂幂\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;note\&quot; : \&quot;我好美啊.\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        request.source(jsonString, XContentType.JSON);</span><br><span class="line">        IndexResponse indexResponse = client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(indexResponse.status());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">docPost2</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        User user = service.findById(<span class="number">12L</span>);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">        IndexRequest request = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置添加的文档id值</span></span><br><span class="line">        request.id(user.getId().toString());</span><br><span class="line">        <span class="comment">//request.id(&quot;1&quot;); // 新增的ID一致时 则变成修改.</span></span><br><span class="line">        <span class="comment">// 设置文档数据信息</span></span><br><span class="line">        String jsonString = JSON.toJSONString(user); <span class="comment">// 导入第三方依赖包来转，就是香！</span></span><br><span class="line">        System.out.println(jsonString);</span><br><span class="line">        request.source(jsonString, XContentType.JSON);</span><br><span class="line">        IndexResponse indexResponse = client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">//System.out.println(indexResponse.status());</span></span><br><span class="line">        System.out.println(indexResponse.getResult());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">indexResponse = CREATED   </span><br></pre></td></tr></table></figure>

<h3 id="5-1-3-新增的ID一致时"><a href="#5-1-3-新增的ID一致时" class="headerlink" title="5.1.3.新增的ID一致时"></a>5.1.3.新增的ID一致时</h3><p>我们之前测试过，新增的时候如果ID存在则变成修改，我们试试，再次执行刚才的代码，可以看到结果变了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">indexResponse = UPDATED</span><br></pre></td></tr></table></figure>

<h2 id="5-2-查询文档"><a href="#5-2-查询文档" class="headerlink" title="5.2.查询文档"></a>5.2.查询文档</h2><p>官网地址：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-document-get.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-document-get.html</a></p>
<h3 id="5-2-1-实现思路"><a href="#5-2-1-实现思路" class="headerlink" title="5.2.1.实现思路"></a>5.2.1.实现思路</h3><p>这里的查询是根据id查询，必须知道文档的id才可以。</p>
<p>根据官网文档，实现的步骤如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">1）创建GetRequest 对象，并指定索引库名称、文档ID</span></span><br><span class="line"><span class="meta">-</span> <span class="string">2）发起请求，得到结果</span></span><br><span class="line"><span class="meta">-</span> <span class="string">3）从结果中得到source，是json字符串</span></span><br><span class="line"><span class="meta">-</span> <span class="string">4）将JSON反序列化为对象</span></span><br></pre></td></tr></table></figure>



<h3 id="5-2-2-具体代码"><a href="#5-2-2-具体代码" class="headerlink" title="5.2.2.具体代码"></a>5.2.2.具体代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询文档数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">docGet</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取文档对象 语义描述</span></span><br><span class="line">        GetRequest getRequest = <span class="keyword">new</span> GetRequest(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">// 发送请求获取文档对象</span></span><br><span class="line">        GetResponse getResponse = client.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 获取响应结果中的数据信息</span></span><br><span class="line">        String sourceAsString = getResponse.getSourceAsString();</span><br><span class="line">        System.out.println(sourceAsString);</span><br><span class="line">        <span class="comment">// 解析响应结果字符串</span></span><br><span class="line">        User user = JSON.parseObject(sourceAsString, User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;age&quot;:26,&quot;gender&quot;:&quot;女&quot;,&quot;id&quot;:12,&quot;name&quot;:&quot;唐嫣&quot;,&quot;note&quot;:&quot;唐嫣同学在传智播客学习如何耍酷&quot;&#125;</span><br><span class="line">User(id=12, name=唐嫣, age=26, gender=女, note=唐嫣同学在传智播客学习如何耍酷)</span><br></pre></td></tr></table></figure>



<h2 id="5-3-修改文档"><a href="#5-3-修改文档" class="headerlink" title="5.3.修改文档"></a>5.3.修改文档</h2><p><strong>新增时，如果ID一致就会覆盖旧的数据，实现修改</strong>。不过，如果我们<strong>只修改文档中的某个字段，可以使用另外的API</strong>：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-document-update.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-document-update.html</a></p>
<h3 id="5-3-1-思路"><a href="#5-3-1-思路" class="headerlink" title="5.3.1.思路"></a>5.3.1.思路</h3><p>根据官网信息，修改时需要指定某个已经存在的文档的id、然后指定要修改的字段及新的值。</p>
<p>基本步骤如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">1.创建UpdateRequest对象，指定索引库名称、文档ID</span></span><br><span class="line"><span class="meta">-</span> <span class="string">2.指定要修改的字段及属性值</span></span><br><span class="line"><span class="meta">-</span> <span class="string">3.发起请求</span></span><br></pre></td></tr></table></figure>



<h3 id="5-3-2-代码实现"><a href="#5-3-2-代码实现" class="headerlink" title="5.3.2.代码实现"></a>5.3.2.代码实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">docUpdate</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        UpdateRequest request = <span class="keyword">new</span> UpdateRequest(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置需要修改的字段信息</span></span><br><span class="line">        request.doc(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;唐嫣&quot;</span>);</span><br><span class="line">        UpdateResponse updateResponse =</span><br><span class="line">                client.update(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(updateResponse.getResult());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">updateResponse = UPDATED</span><br></pre></td></tr></table></figure>

<p>如果再次查询，可以发现李磊已经成功变性了：(哈哈哈)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user = User(id=6, name=李磊, age=23, gender=女, note=李磊同学在传智播客学Java)</span><br></pre></td></tr></table></figure>



<h2 id="5-4-删除文档"><a href="#5-4-删除文档" class="headerlink" title="5.4.删除文档"></a>5.4.删除文档</h2><p>官网地址：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-document-delete.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-document-delete.html</a></p>
<p>实现思路非常简单，直接根据ID删除即可：</p>
<ul>
<li>1.创建DeleteRequest对象，指定索引库名称、文档ID</li>
<li>2.发起请求</li>
</ul>
<p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">docDelete</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    DeleteRequest request = <span class="keyword">new</span> DeleteRequest(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    DeleteResponse deleteResponse = client.delete(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(deleteResponse.getResult());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deleteResponse = DELETED</span><br></pre></td></tr></table></figure>



<h2 id="5-5-批处理"><a href="#5-5-批处理" class="headerlink" title="5.5.批处理"></a>5.5.批处理</h2><p>如果我们需要把数据库中的所有用户信息都导入索引库，可以批量查询出多个用户，但是刚刚的新增文档是一次新增一个文档，这样效率太低了。</p>
<p>因此ElasticSearch提供了<strong>批处理的方案</strong>：BulkRequest</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-document-bulk.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-document-bulk.html</a></p>
<h3 id="5-5-1-思路分析"><a href="#5-5-1-思路分析" class="headerlink" title="5.5.1.思路分析"></a>5.5.1.思路分析</h3><p>一个BulkRequest可以在一次请求中执行多个 新增、更新、删除请求。</p>
<p>所以，BulkRequest就是<strong>把多个其它增、删、改请求整合，然后一起发送到ES来执行</strong>。</p>
<p>我们拿批量新增来举例，步骤如下：</p>
<ul>
<li><p>1.从数据库查询文档数据</p>
</li>
<li><p>2.创建BulkRequest对象</p>
</li>
<li><p>3.创建多个IndexRequest对象，组织文档数据，并添加到BulkRequest中</p>
</li>
<li><p>4.发起请求</p>
</li>
</ul>
<h3 id="5-5-2-具体代码"><a href="#5-5-2-具体代码" class="headerlink" title="5.5.2.具体代码"></a>5.5.2.具体代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量添加</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">docBulk</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 查询mysql中的数据信息</span></span><br><span class="line">        List&lt;User&gt; userList = service.findAll();</span><br><span class="line">        BulkRequest request = <span class="keyword">new</span> BulkRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (User user : userList) &#123;</span><br><span class="line">            IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest();</span><br><span class="line">            indexRequest.id(user.getId().toString());</span><br><span class="line">            String userJson = JSON.toJSONString(user);</span><br><span class="line">            indexRequest.source(userJson,XContentType.JSON);</span><br><span class="line"></span><br><span class="line">            request.add(indexRequest);<span class="comment">//先将每一条要添加的文档信息放到桶里面。</span></span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//一下子发给es进行操作。</span></span><br><span class="line">        BulkResponse bulkResponse = client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line">        System.out.println(bulkResponse.status());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">status: OK</span><br></pre></td></tr></table></figure>

<p>可以在Kibana中看到查询的结果：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200105115314222.png" alt="image-20200105115314222"></p>
<h1 id="6-Java实现查询"><a href="#6-Java实现查询" class="headerlink" title="6.Java实现查询"></a>6.Java实现查询</h1><p>查询、搜索相关功能主要包括：</p>
<ul>
<li><p>基本查询</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">分词查询</span></span><br><span class="line"><span class="meta">-</span> <span class="string">词条查询</span></span><br><span class="line"><span class="meta">-</span> <span class="string">范围查询</span></span><br><span class="line"><span class="meta">-</span> <span class="string">布尔查询</span></span><br><span class="line"><span class="meta">-</span> <span class="string">Filter功能</span></span><br></pre></td></tr></table></figure></li>
<li><p>排序</p>
</li>
<li><p>分页</p>
</li>
<li><p>高亮</p>
</li>
<li><p>source过滤</p>
</li>
</ul>
<p>官方文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-search.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.x/java-rest-high-search.html</a></p>
<h2 id="6-1-查询的核心API"><a href="#6-1-查询的核心API" class="headerlink" title="6.1.查询的核心API"></a>6.1.查询的核心API</h2><p>先来看下REST风格中查询的语法：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200105153514672.png" alt="image-20200105153514672"> </p>
<p>整个请求对象是一个大JSON对象，包含5部分属性：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">query：查询属性</span></span><br><span class="line"><span class="meta">-</span> <span class="string">sort：排序属性</span></span><br><span class="line"><span class="meta">-</span> <span class="string">from和size：分页属性</span></span><br><span class="line"><span class="meta">-</span> <span class="string">highlight：高亮属性</span></span><br><span class="line"><span class="meta">-</span> <span class="string">aggs：聚合属性</span></span><br></pre></td></tr></table></figure>

<p>而Java客户端，其实也是在构建这样的JSON对象。</p>
<h3 id="6-1-1-SearchSourceBuilder"><a href="#6-1-1-SearchSourceBuilder" class="headerlink" title="6.1.1.SearchSourceBuilder"></a>6.1.1.SearchSourceBuilder</h3><p>在Java客户端中，<code>SearchSourceBuilder</code>就是用来构建上面提到的大JSON对象，其中包含了5个方法：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">query(QueryBuilder)：查询条件</span></span><br><span class="line"><span class="meta">-</span> <span class="string">sort(String, SortOrder)：排序条件</span></span><br><span class="line"><span class="meta">-</span> <span class="string">from(int)和size(int)：分页条件</span></span><br><span class="line"><span class="meta">-</span> <span class="string">highlight(HighlightBuilder)：高亮条件</span></span><br><span class="line"><span class="meta">-</span> <span class="string">aggregation(AggregationBuilder)：聚合条件</span></span><br></pre></td></tr></table></figure>

<p>如图：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200105154343366.png" alt="image-20200105154343366"> </p>
<p>是不是与REST风格API的JSON对象一致？</p>
<p>接下来，再逐个来看每一个查询子属性。</p>
<h3 id="6-1-2-查询条件QueryBuilders"><a href="#6-1-2-查询条件QueryBuilders" class="headerlink" title="6.1.2.查询条件QueryBuilders"></a>6.1.2.查询条件QueryBuilders</h3><p>SearchSourceBuilder的query(QueryBuilder)方法，用来构建查询条件，而查询分为：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">分词查询：MatchQuery</span></span><br><span class="line"><span class="meta">-</span> <span class="string">词条查询：TermQuery</span></span><br><span class="line"><span class="meta">-</span> <span class="string">布尔查询：BooleanQuery</span></span><br><span class="line"><span class="meta">-</span> <span class="string">范围查询：RangeQuery</span></span><br><span class="line"><span class="meta">-</span> <span class="string">模糊查询：FuzzyQuery</span></span><br></pre></td></tr></table></figure>

<ul>
<li>…</li>
</ul>
<p>这些查询有一个统一的工具类来提供：QueryBuilders</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200105155220039.png" alt="image-20200105155220039"> </p>
<h2 id="6-2-搜索结果API"><a href="#6-2-搜索结果API" class="headerlink" title="6.2.搜索结果API"></a>6.2.搜索结果API</h2><p>在Kibana中看一下搜索结果：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200105163216526.png" alt="image-20200105163216526"> </p>
<p>搜索得到的结果整体是一个JSON对象，包含下列2个属性：</p>
<ul>
<li>hits：查询结果，其中又包含两个属性：<ul>
<li>total：总命中数量</li>
<li>hits：查询到的文档数据，是一个数组，数组中的每个对象就包含一个文档结果，又包含：<ul>
<li>_source：文档原始信息</li>
<li>highlight：高亮结果信息</li>
</ul>
</li>
</ul>
</li>
<li>aggregations：聚合结果对象，其中包含多个属性，属性名称由添加聚合时的名称来确定：<ul>
<li>gender_agg：这个是我们创建聚合时用的<code>聚合名称</code>，其中包含聚合结果<ul>
<li>buckets：聚合结果数组</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Java客户端中的SearchResponse代表整个JSON结果</p>
<h3 id="6-2-1-SearchResponse"><a href="#6-2-1-SearchResponse" class="headerlink" title="6.2.1.SearchResponse"></a>6.2.1.SearchResponse</h3><p>Java客户端中的SearchResponse代表整个JSON结果，包含下面的方法：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200105164513323.png" alt="image-20200105164513323"> </p>
<p>包含两个方法：</p>
<ul>
<li>getHits()：返回的是SearchHits，代表查询结果</li>
<li>getAggregations()：返回的是Aggregations，代表聚合结果</li>
</ul>
<h3 id="6-2-2-SearchHits查询结果"><a href="#6-2-2-SearchHits查询结果" class="headerlink" title="6.2.2.SearchHits查询结果"></a>6.2.2.SearchHits查询结果</h3><p>SearchHits代表查询结果的JSON对象：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200105171202561.png" alt="image-20200105171202561"> </p>
<p>包含下面的方法：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200105165201949.png" alt="image-20200105165201949"> </p>
<p>核心方法有3个：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">getHits()：返回SearchHit数组</span></span><br><span class="line"><span class="meta">-</span> <span class="string">getMaxScore()：返回float，文档的最大得分</span></span><br><span class="line"><span class="meta">-</span> <span class="string">getTotalHists()：返回TotalHists，总命中数</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-3-SearchHit结果对象"><a href="#6-2-3-SearchHit结果对象" class="headerlink" title="6.2.3.SearchHit结果对象"></a>6.2.3.SearchHit结果对象</h3><p>SearchHit封装的就是结果数组中的每一个JSON对象：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200105171414852.png" alt="image-20200105171414852"> </p>
<p>包含这样的方法：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200105171625893.png" alt="image-20200105171625893"> </p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">getSourceAsString()：返回的是`_source`</span></span><br><span class="line"><span class="meta">-</span> <span class="string">getHighLightFields()：返回是高亮结果</span></span><br></pre></td></tr></table></figure>

<h2 id="6-3-基本查询"><a href="#6-3-基本查询" class="headerlink" title="6.3.基本查询"></a>6.3.基本查询</h2><h3 id="6-3-1-思路分析"><a href="#6-3-1-思路分析" class="headerlink" title="6.3.1.思路分析"></a>6.3.1.思路分析</h3><p>步骤如下：</p>
<ul>
<li><strong>1.创建SearchSourceBuilder对象</strong><ul>
<li>1.1.添加查询条件QueryBuilders</li>
<li>1.2.添加排序、分页等其它条件</li>
</ul>
</li>
<li>2.<strong>创建SearchRequest对象，并制定索引库名称</strong></li>
<li><strong>3.添加SearchSourceBuilder对象到SearchRequest对象中</strong></li>
<li>4.<strong>发起请求，得到结果</strong></li>
<li>5.<strong>解析结果</strong><ul>
<li>5.1.获取总条数</li>
<li>5.2.获取SearchHits数组，并遍历<ul>
<li>获取其中的<code>_source</code>，是JSON数据</li>
<li>把<code>_source</code>反序列化为User对象</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="6-3-2-查询所有"><a href="#6-3-2-查询所有" class="headerlink" title="6.3.2.查询所有"></a>6.3.2.查询所有</h3><p>QueryBuilders可以实现各种查询，比如查询所有：match_all</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBasicSearch</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1.创建SearchSourceBuilder对象</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">//  1.1.添加查询条件QueryBuilders，这里选择match_all，查询所有</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">    <span class="comment">//  1.2.添加排序、分页等其它条件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.创建SearchRequest对象，并制定索引库名称</span></span><br><span class="line">    SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    <span class="comment">// 3.添加SearchSourceBuilder对象到SearchRequest对象中</span></span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line">    <span class="comment">// 4.发起请求，得到结果</span></span><br><span class="line">    SearchResponse response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 5.解析结果</span></span><br><span class="line">    SearchHits searchHits = response.getHits();</span><br><span class="line">    <span class="comment">//  5.1.获取总条数</span></span><br><span class="line">    <span class="keyword">long</span> total = searchHits.getTotalHits().value;</span><br><span class="line">    System.out.println(<span class="string">&quot;total = &quot;</span> + total);</span><br><span class="line">    <span class="comment">//  5.2.获取SearchHits数组，并遍历</span></span><br><span class="line">    SearchHit[] hits = searchHits.getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">//  - 获取其中的`_source`，是JSON数据</span></span><br><span class="line">        String json = hit.getSourceAsString();</span><br><span class="line">        <span class="comment">//  - 把`_source`反序列化为User对象</span></span><br><span class="line">        User user = JSON.parseObject(json, User.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;user = &quot;</span> + user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">total = 12</span><br><span class="line">user = User(id=5, name=李娜, age=28, gender=女, note=李娜同学在传智播客学Java)</span><br><span class="line">user = User(id=7, name=韩梅梅, age=24, gender=女, note=韩梅梅同学在传智播客学php)</span><br><span class="line">user = User(id=2, name=李四, age=21, gender=男, note=李四同学在传智学Java)</span><br><span class="line">user = User(id=3, name=王五, age=22, gender=男, note=王五同学在学php)</span><br><span class="line">user = User(id=4, name=张伟, age=20, gender=男, note=张伟同学在传智播客学Java)</span><br><span class="line">user = User(id=10, name=范冰冰, age=25, gender=女, note=范冰冰同学在传智播客学表演)</span><br><span class="line">user = User(id=12, name=唐嫣, age=26, gender=女, note=唐嫣同学在传智播客学习如何耍酷)</span><br><span class="line">user = User(id=1, name=张三, age=30, gender=男, note=张三同学在学Java)</span><br><span class="line">user = User(id=6, name=李磊, age=23, gender=男, note=李磊同学在传智播客学Java)</span><br><span class="line">user = User(id=8, name=柳岩, age=21, gender=女, note=柳岩同学在传智播客学表演)</span><br></pre></td></tr></table></figure>



<h3 id="6-3-3-分词查询"><a href="#6-3-3-分词查询" class="headerlink" title="6.3.3.分词查询"></a>6.3.3.分词查询</h3><p>MatchQuery就是<strong>分词查询</strong>，会对搜索的内容分词后查询：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;note&quot;</span>, <span class="string">&quot;唱歌表演&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>完整代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBasicSearch</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1.创建SearchSourceBuilder对象</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">//  1.1.添加查询条件QueryBuilders，这里选择match_all，查询所有</span></span><br><span class="line">    <span class="comment">//        sourceBuilder.query(QueryBuilders.matchAllQuery());</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;note&quot;</span>, <span class="string">&quot;唱歌表演&quot;</span>));</span><br><span class="line">    <span class="comment">//  1.2.添加排序、分页等其它条件</span></span><br><span class="line">		<span class="comment">//这里先不演示！</span></span><br><span class="line">    <span class="comment">// 2.创建SearchRequest对象，并制定索引库名称</span></span><br><span class="line">    SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    <span class="comment">// 3.添加SearchSourceBuilder对象到SearchRequest对象中</span></span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line">    <span class="comment">// 4.发起请求，得到结果</span></span><br><span class="line">    SearchResponse response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 5.解析结果</span></span><br><span class="line">    SearchHits searchHits = response.getHits();</span><br><span class="line">    <span class="comment">//  5.1.获取总条数</span></span><br><span class="line">    <span class="keyword">long</span> total = searchHits.getTotalHits().value;</span><br><span class="line">    System.out.println(<span class="string">&quot;total = &quot;</span> + total);</span><br><span class="line">    <span class="comment">//  5.2.获取SearchHits数组，并遍历</span></span><br><span class="line">    SearchHit[] hits = searchHits.getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">//  - 获取其中的`_source`，是JSON数据</span></span><br><span class="line">        String json = hit.getSourceAsString();</span><br><span class="line">        <span class="comment">//  - 把`_source`反序列化为User对象</span></span><br><span class="line">        User user = JSON.parseObject(json, User.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;user = &quot;</span> + user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">total = 3</span><br><span class="line">user = User(id=8, name=柳岩, age=21, gender=女, note=柳岩同学在传智播客学表演)</span><br><span class="line">user = User(id=10, name=范冰冰, age=25, gender=女, note=范冰冰同学在传智播客学表演)</span><br><span class="line">user = User(id=9, name=刘亦菲, age=18, gender=女, note=刘亦菲同学在传智播客学唱歌)</span><br></pre></td></tr></table></figure>



<h3 id="6-3-4-布尔查询"><a href="#6-3-4-布尔查询" class="headerlink" title="6.3.4.布尔查询"></a>6.3.4.布尔查询</h3><p>BooleanQuery就是布尔查询，需要把其它几个查询用must、must_not组合，另外过滤条件最好使用filter来实现。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 布尔查询</span></span><br><span class="line">BoolQueryBuilder queryBuilder = QueryBuilders.boolQuery();</span><br><span class="line"><span class="comment">// 添加must条件</span></span><br><span class="line">queryBuilder.must(QueryBuilders.matchQuery(<span class="string">&quot;note&quot;</span>, <span class="string">&quot;唱歌表演&quot;</span>));</span><br><span class="line"><span class="comment">// 添加filter条件，不参与打分</span></span><br><span class="line">queryBuilder.filter(QueryBuilders.rangeQuery(<span class="string">&quot;age&quot;</span>).gte(<span class="number">18</span>).lte(<span class="number">24</span>));</span><br><span class="line">sourceBuilder.query(queryBuilder);</span><br></pre></td></tr></table></figure>

<p>完整代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * bool : 布尔查询</span></span><br><span class="line"><span class="comment">    * SearchSourceBuilder: 构建具体的查询条件</span></span><br><span class="line"><span class="comment">    *      - query(QueryBuilder)：查询条件</span></span><br><span class="line"><span class="comment">    *      - sort(String, SortOrder)：排序条件</span></span><br><span class="line"><span class="comment">    *      - from(int)和size(int)：分页条件</span></span><br><span class="line"><span class="comment">    *      - highlight(HighlightBuilder)：高亮条件</span></span><br><span class="line"><span class="comment">    *      - aggregation(AggregationBuilder)：聚合条件</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">search4</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       <span class="comment">// <span class="doctag">TODO:</span>构建最终查询语义对象</span></span><br><span class="line">       SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">       <span class="comment">// =====构建bool查询的具体语义</span></span><br><span class="line">       <span class="comment">// 构建检索语义</span></span><br><span class="line">       SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">       <span class="comment">// 布尔检索</span></span><br><span class="line">       BoolQueryBuilder queryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">       <span class="comment">// 添加must条件</span></span><br><span class="line">       <span class="comment">//queryBuilder.must(QueryBuilders.matchQuery(&quot;note&quot;, &quot;唱歌表演&quot;));</span></span><br><span class="line">       queryBuilder.must(QueryBuilders.matchQuery(<span class="string">&quot;gender&quot;</span>, <span class="string">&quot;女&quot;</span>));</span><br><span class="line">       <span class="comment">// 添加filter条件，不影响分值</span></span><br><span class="line">       queryBuilder.filter(QueryBuilders.rangeQuery(<span class="string">&quot;age&quot;</span>).gte(<span class="number">18</span>).lte(<span class="number">24</span>));</span><br><span class="line">       sourceBuilder.query(queryBuilder);</span><br><span class="line">       <span class="comment">//=======</span></span><br><span class="line">       searchRequest.source(sourceBuilder);</span><br><span class="line"></span><br><span class="line">       SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">       <span class="comment">// 获取所有的返回结果</span></span><br><span class="line">       SearchHits hits = searchResponse.getHits();</span><br><span class="line">       TotalHits totalHits = hits.getTotalHits();</span><br><span class="line">       <span class="keyword">long</span> total = totalHits.value;</span><br><span class="line">       System.out.println(<span class="string">&quot;总条数 : &quot;</span>+total);</span><br><span class="line"></span><br><span class="line">       SearchHit[] dataHits = hits.getHits();</span><br><span class="line">       <span class="keyword">for</span> (SearchHit data : dataHits) &#123;</span><br><span class="line">           User user = JSON.parseObject(data.getSourceAsString(),User.class);</span><br><span class="line">           System.out.println(user);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>SearchRequest， SearchSourceBuilder  ，BoolQueryBuilder 层层包装！</p>
<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">total = 2</span><br><span class="line">user = User(id=8, name=柳岩, age=21, gender=女, note=柳岩同学在传智播客学表演)</span><br><span class="line">user = User(id=9, name=刘亦菲, age=18, gender=女, note=刘亦菲同学在传智播客学唱歌)</span><br></pre></td></tr></table></figure>



<h2 id="6-4-source过滤"><a href="#6-4-source过滤" class="headerlink" title="6.4.source过滤"></a>6.4.source过滤</h2><p>在原来搜索的基础上，通过SearchSourceBuilder的fetchSource(String[] includes, String[] excludes)方法实现：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">includes：包含的字段</span></span><br><span class="line"><span class="meta">-</span> <span class="string">excludes：要排除的字段</span></span><br></pre></td></tr></table></figure>

<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.source过滤，指定includes，只要id、name、note</span></span><br><span class="line">sourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;note&quot;</span>&#125;, <span class="keyword">new</span> String[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>

<p>完整代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBasicSearch</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1.创建SearchSourceBuilder对象</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">//  1.1.添加查询条件QueryBuilders，这里选择match_all，查询所有</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;note&quot;</span>, <span class="string">&quot;唱歌表演&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.source过滤，指定includes，只要id、name、note</span></span><br><span class="line">    sourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;note&quot;</span>&#125;, <span class="keyword">new</span> String[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.创建SearchRequest对象，并制定索引库名称</span></span><br><span class="line">    SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    <span class="comment">// 4.添加SearchSourceBuilder对象到SearchRequest对象中</span></span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line">    <span class="comment">// 5.发起请求，得到结果</span></span><br><span class="line">    SearchResponse response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 6.解析结果</span></span><br><span class="line">    SearchHits searchHits = response.getHits();</span><br><span class="line">    <span class="comment">//  6.1.获取总条数</span></span><br><span class="line">    <span class="keyword">long</span> total = searchHits.getTotalHits().value;</span><br><span class="line">    System.out.println(<span class="string">&quot;total = &quot;</span> + total);</span><br><span class="line">    <span class="comment">//  6.2.获取SearchHits数组，并遍历</span></span><br><span class="line">    SearchHit[] hits = searchHits.getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">//  - 获取其中的`_source`，是JSON数据</span></span><br><span class="line">        String json = hit.getSourceAsString();</span><br><span class="line">        <span class="comment">//  - 把`_source`反序列化为User对象</span></span><br><span class="line">        User user = JSON.parseObject(json, User.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;user = &quot;</span> + user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">total = 3</span><br><span class="line">user = User(id=8, name=柳岩, age=null, gender=null, note=柳岩同学在传智播客学表演)</span><br><span class="line">user = User(id=10, name=范冰冰, age=null, gender=null, note=范冰冰同学在传智播客学表演)</span><br><span class="line">user = User(id=9, name=刘亦菲, age=null, gender=null, note=刘亦菲同学在传智播客学唱歌)</span><br></pre></td></tr></table></figure>



<h2 id="6-5-排序"><a href="#6-5-排序" class="headerlink" title="6.5.排序"></a>6.5.排序</h2><h3 id="6-5-1-API介绍"><a href="#6-5-1-API介绍" class="headerlink" title="6.5.1.API介绍"></a>6.5.1.API介绍</h3><p>通过SearchSourceBuilder的sort(String, SortOrder)方法用来实现排序条件的封装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> name 排序字段名称</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> order 排序的方式</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SearchSourceBuilder <span class="title">sort</span><span class="params">(String name, SortOrder order)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的SortOrder是一个枚举，包含ASC和DESC两个枚举项：</p>
<h3 id="6-5-2-具体实现"><a href="#6-5-2-具体实现" class="headerlink" title="6.5.2.具体实现"></a>6.5.2.具体实现</h3><p>在原由查询的基础上，给SearchSourceBuilder中添加sort即可:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  1.2.添加排序条件</span></span><br><span class="line">sourceBuilder.sort(<span class="string">&quot;id&quot;</span>, SortOrder.ASC);</span><br></pre></td></tr></table></figure>

<p>完整代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">searchOrder</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 描述查询的语义</span></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    <span class="comment">// 构建查询条件 五大类</span></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    <span class="comment">//searchSourceBuilder.sort(new ScoreSortBuilder().order(SortOrder.DESC));</span></span><br><span class="line">    searchSourceBuilder.sort(<span class="keyword">new</span> FieldSortBuilder(<span class="string">&quot;id&quot;</span>).order(SortOrder.DESC));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将查询条件对象赋给查询语义对象</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">    SearchResponse searchResponse =</span><br><span class="line">            client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取所有的返回结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    TotalHits totalHits = hits.getTotalHits();</span><br><span class="line">    <span class="keyword">long</span> total = totalHits.value;</span><br><span class="line">    System.out.println(<span class="string">&quot;总条数 : &quot;</span>+total);</span><br><span class="line"></span><br><span class="line">    SearchHit[] dataHits = hits.getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit data : dataHits) &#123;</span><br><span class="line">        User user = JSON.parseObject(data.getSourceAsString(),User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">total = <span class="number">12</span></span><br><span class="line">user = User(id=<span class="number">1</span>, name=张三, age=<span class="number">30</span>, gender=男, note=张三同学在学Java)</span><br><span class="line">user = User(id=<span class="number">2</span>, name=李四, age=<span class="number">21</span>, gender=男, note=李四同学在传智学Java)</span><br><span class="line">user = User(id=<span class="number">3</span>, name=王五, age=<span class="number">22</span>, gender=男, note=王五同学在学php)</span><br><span class="line">user = User(id=<span class="number">4</span>, name=张伟, age=<span class="number">20</span>, gender=男, note=张伟同学在传智播客学Java)</span><br><span class="line">user = User(id=<span class="number">5</span>, name=李娜, age=<span class="number">28</span>, gender=女, note=李娜同学在传智播客学Java)</span><br><span class="line">user = User(id=<span class="number">6</span>, name=李磊, age=<span class="number">23</span>, gender=男, note=李磊同学在传智播客学Java)</span><br><span class="line">user = User(id=<span class="number">7</span>, name=韩梅梅, age=<span class="number">24</span>, gender=女, note=韩梅梅同学在传智播客学php)</span><br><span class="line">user = User(id=<span class="number">8</span>, name=柳岩, age=<span class="number">21</span>, gender=女, note=柳岩同学在传智播客学表演)</span><br><span class="line">user = User(id=<span class="number">9</span>, name=刘亦菲, age=<span class="number">18</span>, gender=女, note=刘亦菲同学在传智播客学唱歌)</span><br><span class="line">user = User(id=<span class="number">10</span>, name=范冰冰, age=<span class="number">25</span>, gender=女, note=范冰冰同学在传智播客学表演)</span><br></pre></td></tr></table></figure>



<h2 id="6-5-分页"><a href="#6-5-分页" class="headerlink" title="6.5.分页"></a>6.5.分页</h2><p>在原由查询的基础上，给SearchSourceBuilder中添加from和size即可。例如我们的分页信息是：</p>
<p>page = 1，size = 5，代表查询第一页，每页5条，可以计算出： from = (page - 1) * size = 0</p>
<p>所以，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.3.添加分页条件</span></span><br><span class="line"><span class="keyword">int</span> page = <span class="number">1</span>, size = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">int</span> from = (page - <span class="number">1</span>) * size;</span><br><span class="line">sourceBuilder.from(from);</span><br><span class="line">sourceBuilder.size(size);</span><br></pre></td></tr></table></figure>

<p>完整代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">searchPage</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="comment">// 描述查询的语义</span></span><br><span class="line">      SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">      <span class="comment">//###################################################################</span></span><br><span class="line">      <span class="comment">// 构建查询条件 五大类</span></span><br><span class="line">      SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">      searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">      <span class="comment">// 排序</span></span><br><span class="line">      searchSourceBuilder.sort(<span class="keyword">new</span> FieldSortBuilder(<span class="string">&quot;id&quot;</span>).order(SortOrder.DESC));</span><br><span class="line">      <span class="comment">// 起始索引</span></span><br><span class="line">      searchSourceBuilder.from(<span class="number">0</span>);</span><br><span class="line">      searchSourceBuilder.size(<span class="number">4</span>);</span><br><span class="line">      <span class="comment">// 将查询条件对象赋给查询语义对象</span></span><br><span class="line">      searchRequest.source(searchSourceBuilder);</span><br><span class="line"><span class="comment">//###################################################################</span></span><br><span class="line">      </span><br><span class="line">      SearchResponse searchResponse =</span><br><span class="line">              client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取所有的返回结果</span></span><br><span class="line">      SearchHits hits = searchResponse.getHits();</span><br><span class="line">      TotalHits totalHits = hits.getTotalHits();</span><br><span class="line">      <span class="keyword">long</span> total = totalHits.value;</span><br><span class="line">      System.out.println(<span class="string">&quot;总条数 : &quot;</span>+total);</span><br><span class="line"></span><br><span class="line">      SearchHit[] dataHits = hits.getHits();</span><br><span class="line">      <span class="keyword">for</span> (SearchHit data : dataHits) &#123;</span><br><span class="line">          User user = JSON.parseObject(data.getSourceAsString(),User.class);</span><br><span class="line">          System.out.println(user);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">total = <span class="number">12</span></span><br><span class="line">user = User(id=<span class="number">1</span>, name=张三, age=<span class="number">30</span>, gender=男, note=张三同学在学Java)</span><br><span class="line">user = User(id=<span class="number">2</span>, name=李四, age=<span class="number">21</span>, gender=男, note=李四同学在传智学Java)</span><br><span class="line">user = User(id=<span class="number">3</span>, name=王五, age=<span class="number">22</span>, gender=男, note=王五同学在学php)</span><br><span class="line">user = User(id=<span class="number">4</span>, name=张伟, age=<span class="number">20</span>, gender=男, note=张伟同学在传智播客学Java)</span><br><span class="line">user = User(id=<span class="number">5</span>, name=李娜, age=<span class="number">28</span>, gender=女, note=李娜同学在传智播客学Java)</span><br></pre></td></tr></table></figure>



<h2 id="6-6-高亮"><a href="#6-6-高亮" class="headerlink" title="6.6.高亮"></a>6.6.高亮</h2><h3 id="6-6-1-开启高亮"><a href="#6-6-1-开启高亮" class="headerlink" title="6.6.1.开启高亮"></a>6.6.1.开启高亮</h3><p>高亮需要在SearchSourceBuilder的highlighter()方法来实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.高亮，指定高亮字段</span></span><br><span class="line">sourceBuilder.highlighter(<span class="keyword">new</span> HighlightBuilder().field(<span class="string">&quot;note&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>完整代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHighlight</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 3.创建SearchRequest对象，并制定索引库名称</span></span><br><span class="line">    SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    <span class="comment">//###################################################################</span></span><br><span class="line">    <span class="comment">// 1.创建SearchSourceBuilder对象</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">//  1.1.添加查询条件QueryBuilders</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;note&quot;</span>, <span class="string">&quot;唱歌表演&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.高亮，指定高亮字段</span></span><br><span class="line">    sourceBuilder.highlighter(<span class="keyword">new</span> HighlightBuilder().field(<span class="string">&quot;note&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.添加SearchSourceBuilder对象到SearchRequest对象中</span></span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line">    <span class="comment">//###################################################################</span></span><br><span class="line">    <span class="comment">// 5.发起请求，得到结果</span></span><br><span class="line">    SearchResponse response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 6.解析结果</span></span><br><span class="line">    SearchHits searchHits = response.getHits();</span><br><span class="line">    <span class="comment">//  6.1.获取总条数</span></span><br><span class="line">    <span class="keyword">long</span> total = searchHits.getTotalHits().value;</span><br><span class="line">    System.out.println(<span class="string">&quot;total = &quot;</span> + total);</span><br><span class="line">    <span class="comment">//  6.2.获取SearchHits数组，并遍历</span></span><br><span class="line">    SearchHit[] hits = searchHits.getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">        <span class="comment">//  - 获取其中的`_source`，是JSON数据</span></span><br><span class="line">        String json = hit.getSourceAsString();</span><br><span class="line">        <span class="comment">//  - 把`_source`反序列化为User对象</span></span><br><span class="line">        User user = JSON.parseObject(json, User.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;user = &quot;</span> + user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行，查看结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">total = 3</span><br><span class="line">user = User(id=8, name=柳岩, age=21, gender=女, note=柳岩同学在传智播客学表演)</span><br><span class="line">user = User(id=10, name=范冰冰, age=25, gender=女, note=范冰冰同学在传智播客学表演)</span><br><span class="line">user = User(id=9, name=刘亦菲, age=18, gender=女, note=刘亦菲同学在传智播客学唱歌)</span><br></pre></td></tr></table></figure>



<p>结果并未高亮，为什么？</p>
<p>这是因为查询结果中，文档数据和高亮数据是分离的：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200105184133923.png" alt="image-20200105184133923"> </p>
<p>我们需要自己在搜索结果中解析高亮结果</p>
<h3 id="6-6-2-解析高亮结果"><a href="#6-6-2-解析高亮结果" class="headerlink" title="6.6.2.解析高亮结果"></a>6.6.2.解析高亮结果</h3><p>搜索结果SearchHit对象中，包含两个方法：</p>
<ul>
<li>getSourceAsString()：返回的是<code>_source</code></li>
<li>getHighLightFields()：返回是高亮结果，Map&lt;String, HighlightField&gt;，map的key是高亮字段名称</li>
</ul>
<p>解析SearchHit并高亮的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">searchHighlight</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 描述查询的语义</span></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    <span class="comment">// 构建查询条件 五大类</span></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    searchSourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;note&quot;</span>,<span class="string">&quot;唱歌跳舞&quot;</span>));</span><br><span class="line">    <span class="comment">// 高亮</span></span><br><span class="line">    searchSourceBuilder.highlighter(<span class="keyword">new</span> HighlightBuilder().field(<span class="string">&quot;note&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将查询条件对象赋给查询语义对象</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">    SearchResponse searchResponse =</span><br><span class="line">            client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取所有的返回结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    TotalHits totalHits = hits.getTotalHits();</span><br><span class="line">    <span class="keyword">long</span> total = totalHits.value;</span><br><span class="line">    System.out.println(<span class="string">&quot;总条数 : &quot;</span>+total);</span><br><span class="line"></span><br><span class="line">    SearchHit[] dataHits = hits.getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit data : dataHits) &#123;</span><br><span class="line">        User user = JSON.parseObject(data.getSourceAsString(),User.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span>获取高亮结果 </span></span><br><span class="line">        Map&lt;String, HighlightField&gt; highlightFields = data.getHighlightFields();</span><br><span class="line">        <span class="comment">// 根据字段名，获取字段值</span></span><br><span class="line">        HighlightField highlightField = highlightFields.get(<span class="string">&quot;note&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取高亮结果的片段数组</span></span><br><span class="line">        Text[] fragments = highlightField.getFragments();</span><br><span class="line">        <span class="comment">// 拼接成字符串</span></span><br><span class="line">        String note = StringUtils.join(fragments);</span><br><span class="line">        System.out.println(note);</span><br><span class="line">        <span class="comment">// 覆盖旧值</span></span><br><span class="line">        user.setNote(note);</span><br><span class="line"></span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">total = 3</span><br><span class="line">user = User(id=8, name=柳岩, age=21, gender=女, note=柳岩同学在传智播客学&lt;em&gt;表演&lt;/em&gt;)</span><br><span class="line">user = User(id=10, name=范冰冰, age=25, gender=女, note=范冰冰同学在传智播客学&lt;em&gt;表演&lt;/em&gt;)</span><br><span class="line">user = User(id=9, name=刘亦菲, age=18, gender=女, note=刘亦菲同学在传智播客学&lt;em&gt;唱歌&lt;/em&gt;)</span><br></pre></td></tr></table></figure>

<h1 id="7-Java实现聚合"><a href="#7-Java实现聚合" class="headerlink" title="7.Java实现聚合"></a>7.Java实现聚合</h1><p>聚合功能通过SearchSourceBuilder的aggregation(AggregationBuilder aggregation)方法用来构建聚合条件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Add an aggregation to perform as part of the search.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> SearchSourceBuilder <span class="title">aggregation</span><span class="params">(AggregationBuilder aggregation)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// ..</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>其中要用到的各种聚合如：</p>
<ul>
<li>Term聚合</li>
<li>Rang聚合</li>
<li>Sum聚合</li>
</ul>
<p>等都通过AggregationBuilders来提供：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200105160257481.png" alt="image-20200105160257481"> </p>
<h2 id="7-1-添加聚合条件"><a href="#7-1-添加聚合条件" class="headerlink" title="7.1.添加聚合条件"></a>7.1.添加聚合条件</h2><p>举例，假如对性别字段<code>gender</code>做聚合，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sourceBuilder.aggregation(AggregationBuilders.terms(<span class="string">&quot;gender_agg&quot;</span>).field(<span class="string">&quot;gender&quot;</span>));</span><br></pre></td></tr></table></figure>

<ul>
<li>terms(String)：确定聚合类型是Term类型</li>
<li>term(“gender_agg”)：给聚合起个名字，要唯一，获取聚合结果以名称获取。</li>
<li>field(“gender”)：确定要聚合的字段名称，这里是gender</li>
</ul>
<p>完整请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 聚合</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">searchAggs</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       <span class="comment">// 描述查询的语义</span></span><br><span class="line">       SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">       <span class="comment">// 构建查询条件 五大类</span></span><br><span class="line">       SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">       searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">       <span class="comment">// 聚合分桶</span></span><br><span class="line">       searchSourceBuilder.aggregation(AggregationBuilders.terms(<span class="string">&quot;gender_agg&quot;</span>).field(<span class="string">&quot;gender&quot;</span>));</span><br><span class="line">       <span class="comment">// 将查询条件对象赋给查询语义对象</span></span><br><span class="line">       searchRequest.source(searchSourceBuilder);</span><br><span class="line">       SearchResponse searchResponse =</span><br><span class="line">               client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 获取所有的返回结果</span></span><br><span class="line">       SearchHits hits = searchResponse.getHits();</span><br><span class="line">       TotalHits totalHits = hits.getTotalHits();</span><br><span class="line">       <span class="keyword">long</span> total = totalHits.value;</span><br><span class="line">       System.out.println(<span class="string">&quot;总条数 : &quot;</span>+total);</span><br><span class="line"></span><br><span class="line">       SearchHit[] dataHits = hits.getHits();</span><br><span class="line">       <span class="keyword">for</span> (SearchHit data : dataHits) &#123;</span><br><span class="line">           User user = JSON.parseObject(data.getSourceAsString(),User.class);</span><br><span class="line">           System.out.println(user);</span><br><span class="line">       &#125;</span><br><span class="line">       System.out.println(<span class="string">&quot;===============================&quot;</span>);</span><br><span class="line">       <span class="comment">// 解析聚合结果###################################################</span></span><br><span class="line">       Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line">       <span class="comment">// 根据桶名获取具体的聚合数据信息####################################</span></span><br><span class="line">       Terms terms = aggregations.get(<span class="string">&quot;gender_agg&quot;</span>);</span><br><span class="line"></span><br><span class="line">       List&lt;? extends Terms.Bucket&gt; buckets = terms.getBuckets();</span><br><span class="line">       <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">           <span class="comment">// 6.4.获取key</span></span><br><span class="line">           String key = bucket.getKeyAsString();</span><br><span class="line">           System.out.println(<span class="string">&quot;key = &quot;</span> + key);</span><br><span class="line">           <span class="comment">// 6.5.获取count</span></span><br><span class="line">           <span class="keyword">long</span> count = bucket.getDocCount();</span><br><span class="line">           System.out.println(<span class="string">&quot;count = &quot;</span> + count);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h2 id="7-2-解析聚合结果"><a href="#7-2-解析聚合结果" class="headerlink" title="7.2.解析聚合结果"></a>7.2.解析聚合结果</h2><p>聚合结果是一个JSON对象，如图：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200106115813370.png" alt="image-20200106115813370"> </p>
<p>对象的属性是聚合的名称，可以有多个。因此获取聚合要以聚合名称获取，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6.解析结果</span></span><br><span class="line">Aggregations aggregations = response.getAggregations();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7.根据聚合名称获取聚合结果</span></span><br><span class="line">Aggregation aggregation = aggregations.get(<span class="string">&quot;gender_agg&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>返回值Aggregation是一个接口，包含很多不同实现：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/image-20200106150546712.png" alt="image-20200106150546712"> </p>
<p>因为我们上面采用的是Term聚合，因此结果应该用Terms这个子接口来接收，然后就可以从中获取到Buckets数组。</p>
<p>打印结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">key = 女</span><br><span class="line">count = 7</span><br><span class="line">key = 男</span><br><span class="line">count = 5</span><br></pre></td></tr></table></figure>





</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">高明辉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/05/17/ElasticSearch%E9%AB%98%E7%BA%A7/">http://example.com/2022/05/17/ElasticSearch%E9%AB%98%E7%BA%A7/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Jason</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ElasticSearch/">ElasticSearch</a></div><div class="post_share"><div class="social-share" data-image="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/03-ElasticSearch/%E5%B0%81%E9%9D%A2.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="添加微信"/></a><div class="post-qr-code-desc">添加微信</div></li><li class="reward-item"><a href="/img/pay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/pay.jpg" alt="付款码"/></a><div class="post-qr-code-desc">付款码</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/05/18/SpringCloud-1/"><img class="prev-cover" src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/04-SpringCloud/%E5%B0%81%E9%9D%A2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">SpringCloud-1</div></div></a></div><div class="next-post pull-right"><a href="/2022/05/15/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"><img class="next-cover" src="/img/%E4%B8%BB%E9%A1%B5%E9%9D%A2%E5%9B%BE%E7%89%87.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">深度学习环境搭建</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/05/13/linux%E4%B8%AD%E4%BD%BF%E7%94%A8docker%E5%AE%89%E8%A3%85elasticsearch%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AE%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8/" title="linux中使用docker安装elasticsearch以及配置中文分词器"><img class="cover" src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/02-ElasticSearch/%E5%B0%81%E9%9D%A2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-13</div><div class="title">linux中使用docker安装elasticsearch以及配置中文分词器</div></div></a></div><div><a href="/2022/05/13/ElasticSearch%E5%9F%BA%E7%A1%80/" title="ElasticSearch基础"><img class="cover" src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/02-ElasticSearch/%E5%B0%81%E9%9D%A2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-13</div><div class="title">ElasticSearch基础</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-ES%E7%9A%84%E8%81%9A%E5%90%88"><span class="toc-number">1.</span> <span class="toc-text">1.ES的聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E8%81%9A%E5%90%88%E4%B8%BA%E6%A1%B6"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 聚合为桶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E6%A1%B6%E5%86%85%E5%BA%A6%E9%87%8F"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 桶内度量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E6%A1%B6%E5%86%85%E5%B5%8C%E5%A5%97%E6%A1%B6"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 桶内嵌套桶</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-ES%E9%9B%86%E7%BE%A4"><span class="toc-number">2.</span> <span class="toc-text">2.ES集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E4%BB%80%E4%B9%88%E6%98%AF%E9%9B%86%E7%BE%A4"><span class="toc-number">2.1.</span> <span class="toc-text">2.1.什么是集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 高可用集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%9B%86%E7%BE%A4"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2 负载均衡集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-%E7%A7%91%E5%AD%A6%E8%AE%A1%E7%AE%97%E9%9B%86%E7%BE%A4"><span class="toc-number">2.1.3.</span> <span class="toc-text">2.1.3 科学计算集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-WEB%E5%BA%94%E7%94%A8%E7%9A%84%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.2.</span> <span class="toc-text">2.2.WEB应用的集群模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E5%8D%95%E4%BD%93%E5%BA%94%E7%94%A8"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 单体应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 分布式架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-%E9%AB%98%E5%8F%AF%E7%94%A8%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3 高可用分布式集群架构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-ElasticSearch%E7%9A%84%E9%9B%86%E7%BE%A4"><span class="toc-number">2.3.</span> <span class="toc-text">2.3.ElasticSearch的集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1.数据分片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2.数据备份</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="toc-number">2.4.</span> <span class="toc-text">2.4.搭建集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E9%85%8D%E7%BD%AEKibana%E8%AE%BF%E9%97%AE%E9%9B%86%E7%BE%A4"><span class="toc-number">2.5.</span> <span class="toc-text">2.5.配置Kibana访问集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-1-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.1.</span> <span class="toc-text">2.5.1.修改配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-2-%E9%87%8D%E5%90%AF%E5%B9%B6%E8%AE%BF%E9%97%AE"><span class="toc-number">2.5.2.</span> <span class="toc-text">2.5.2.重启并访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4"><span class="toc-number">2.6.</span> <span class="toc-text">2.6.测试集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-1-%E9%85%8D%E7%BD%AE%E5%88%86%E7%89%87%E5%92%8C%E5%89%AF%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">2.6.1.</span> <span class="toc-text">2.6.1.配置分片和副本信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-2-%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87%E7%BB%93%E6%9E%9C"><span class="toc-number">2.6.2.</span> <span class="toc-text">2.6.2.查看分片结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-3-%E9%9B%86%E7%BE%A4%E5%8A%A8%E6%80%81%E4%BC%B8%E7%BC%A9"><span class="toc-number">2.6.3.</span> <span class="toc-text">2.6.3.集群动态伸缩</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-ES%E7%9A%84Java%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">3.</span> <span class="toc-text">3.ES的Java客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE%E5%BA%93%E6%95%B0%E6%8D%AE"><span class="toc-number">3.1.</span> <span class="toc-text">3.1.准备数据库数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-%E5%88%9B%E5%BB%BAmaven%E9%A1%B9%E7%9B%AEes-demo-%E5%B9%B6%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">3.1.1.</span> <span class="toc-text">3.1.1.创建maven项目es-demo,并引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-%E6%89%A7%E8%A1%8Csql"><span class="toc-number">3.1.2.</span> <span class="toc-text">3.1.2.执行sql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3-%E5%BC%95%E5%85%A5%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-number">3.1.3.</span> <span class="toc-text">3.1.3.引入实体类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-4-%E5%BC%95%E5%85%A5mybatis%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.4.</span> <span class="toc-text">3.1.4.引入mybatis配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-5-%E5%BC%95%E5%85%A5mapper%E5%92%8CService"><span class="toc-number">3.1.5.</span> <span class="toc-text">3.1.5.引入mapper和Service</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E8%BF%9E%E6%8E%A5ElasticSearch"><span class="toc-number">3.2.</span> <span class="toc-text">3.2.连接ElasticSearch</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Java%E5%AE%9E%E7%8E%B0%E5%88%9B%E5%BB%BA%E5%BA%93%E5%92%8C%E6%98%A0%E5%B0%84"><span class="toc-number">4.</span> <span class="toc-text">4.Java实现创建库和映射</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">4.1.</span> <span class="toc-text">4.1.思路分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E8%AE%BE%E8%AE%A1%E6%98%A0%E5%B0%84%E8%A7%84%E5%88%99"><span class="toc-number">4.2.</span> <span class="toc-text">4.2.设计映射规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.3.</span> <span class="toc-text">4.3.代码实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%94%E7%A4%BA%E4%BB%A3%E7%A0%81"><span class="toc-number">4.4.</span> <span class="toc-text">演示代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Java%E5%AE%9E%E7%8E%B0%E6%96%87%E6%A1%A3%E7%9A%84CRUD"><span class="toc-number">5.</span> <span class="toc-text">5.Java实现文档的CRUD</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E6%96%B0%E5%A2%9E"><span class="toc-number">5.1.</span> <span class="toc-text">5.1.新增</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">5.1.1.</span> <span class="toc-text">5.1.1.实现思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2-%E5%85%B7%E4%BD%93%E4%BB%A3%E7%A0%81"><span class="toc-number">5.1.2.</span> <span class="toc-text">5.1.2.具体代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-3-%E6%96%B0%E5%A2%9E%E7%9A%84ID%E4%B8%80%E8%87%B4%E6%97%B6"><span class="toc-number">5.1.3.</span> <span class="toc-text">5.1.3.新增的ID一致时</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-number">5.2.</span> <span class="toc-text">5.2.查询文档</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">5.2.1.</span> <span class="toc-text">5.2.1.实现思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-%E5%85%B7%E4%BD%93%E4%BB%A3%E7%A0%81"><span class="toc-number">5.2.2.</span> <span class="toc-text">5.2.2.具体代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E4%BF%AE%E6%94%B9%E6%96%87%E6%A1%A3"><span class="toc-number">5.3.</span> <span class="toc-text">5.3.修改文档</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-%E6%80%9D%E8%B7%AF"><span class="toc-number">5.3.1.</span> <span class="toc-text">5.3.1.思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.3.2.</span> <span class="toc-text">5.3.2.代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-number">5.4.</span> <span class="toc-text">5.4.删除文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E6%89%B9%E5%A4%84%E7%90%86"><span class="toc-number">5.5.</span> <span class="toc-text">5.5.批处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">5.5.1.</span> <span class="toc-text">5.5.1.思路分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-2-%E5%85%B7%E4%BD%93%E4%BB%A3%E7%A0%81"><span class="toc-number">5.5.2.</span> <span class="toc-text">5.5.2.具体代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-Java%E5%AE%9E%E7%8E%B0%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.</span> <span class="toc-text">6.Java实现查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E6%9F%A5%E8%AF%A2%E7%9A%84%E6%A0%B8%E5%BF%83API"><span class="toc-number">6.1.</span> <span class="toc-text">6.1.查询的核心API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-SearchSourceBuilder"><span class="toc-number">6.1.1.</span> <span class="toc-text">6.1.1.SearchSourceBuilder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6QueryBuilders"><span class="toc-number">6.1.2.</span> <span class="toc-text">6.1.2.查询条件QueryBuilders</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9CAPI"><span class="toc-number">6.2.</span> <span class="toc-text">6.2.搜索结果API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-SearchResponse"><span class="toc-number">6.2.1.</span> <span class="toc-text">6.2.1.SearchResponse</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-SearchHits%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C"><span class="toc-number">6.2.2.</span> <span class="toc-text">6.2.2.SearchHits查询结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-3-SearchHit%E7%BB%93%E6%9E%9C%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.2.3.</span> <span class="toc-text">6.2.3.SearchHit结果对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.3.</span> <span class="toc-text">6.3.基本查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">6.3.1.</span> <span class="toc-text">6.3.1.思路分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-2-%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89"><span class="toc-number">6.3.2.</span> <span class="toc-text">6.3.2.查询所有</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-3-%E5%88%86%E8%AF%8D%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.3.3.</span> <span class="toc-text">6.3.3.分词查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-4-%E5%B8%83%E5%B0%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.3.4.</span> <span class="toc-text">6.3.4.布尔查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-source%E8%BF%87%E6%BB%A4"><span class="toc-number">6.4.</span> <span class="toc-text">6.4.source过滤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E6%8E%92%E5%BA%8F"><span class="toc-number">6.5.</span> <span class="toc-text">6.5.排序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-1-API%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.5.1.</span> <span class="toc-text">6.5.1.API介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-2-%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.5.2.</span> <span class="toc-text">6.5.2.具体实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E5%88%86%E9%A1%B5"><span class="toc-number">6.6.</span> <span class="toc-text">6.5.分页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6-%E9%AB%98%E4%BA%AE"><span class="toc-number">6.7.</span> <span class="toc-text">6.6.高亮</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-1-%E5%BC%80%E5%90%AF%E9%AB%98%E4%BA%AE"><span class="toc-number">6.7.1.</span> <span class="toc-text">6.6.1.开启高亮</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-2-%E8%A7%A3%E6%9E%90%E9%AB%98%E4%BA%AE%E7%BB%93%E6%9E%9C"><span class="toc-number">6.7.2.</span> <span class="toc-text">6.6.2.解析高亮结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-Java%E5%AE%9E%E7%8E%B0%E8%81%9A%E5%90%88"><span class="toc-number">7.</span> <span class="toc-text">7.Java实现聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E6%B7%BB%E5%8A%A0%E8%81%9A%E5%90%88%E6%9D%A1%E4%BB%B6"><span class="toc-number">7.1.</span> <span class="toc-text">7.1.添加聚合条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E8%A7%A3%E6%9E%90%E8%81%9A%E5%90%88%E7%BB%93%E6%9E%9C"><span class="toc-number">7.2.</span> <span class="toc-text">7.2.解析聚合结果</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 高明辉</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'Aaee0Vekhg5KbLhMOJQrEU6A-gzGzoHsz',
      appKey: 'mmLHPEEtqvOSJhsqWra8Sq6K',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script type="text/javascript" src="/js/fairyDustCursor.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>