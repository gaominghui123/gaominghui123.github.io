<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>docker高级 | Jason</title><meta name="keywords" content="Docker,Docker Compose,Docker Swarm,jenkins,Rancher"><meta name="author" content="高明辉"><meta name="copyright" content="高明辉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Docker高级学习目标 123- 了解DockerCompose的基本语法- 使用Docker-Swarm部署一个Java应用- 了解持续集成持续部署  1 容器编排概述Docker只是一个对项目做打包和运行的小工具，如果止步于此，那么充其量就是一个开发者手里的小玩具。 因为真实的项目都是要集群部署的，还要考虑负载均衡、水平扩展、动态伸缩、集群容错等问题，而Docker并不具备这样的功能。 而要">
<meta property="og:type" content="article">
<meta property="og:title" content="docker高级">
<meta property="og:url" content="http://example.com/2022/05/26/docker%E9%AB%98%E7%BA%A7/index.html">
<meta property="og:site_name" content="Jason">
<meta property="og:description" content="Docker高级学习目标 123- 了解DockerCompose的基本语法- 使用Docker-Swarm部署一个Java应用- 了解持续集成持续部署  1 容器编排概述Docker只是一个对项目做打包和运行的小工具，如果止步于此，那么充其量就是一个开发者手里的小玩具。 因为真实的项目都是要集群部署的，还要考虑负载均衡、水平扩展、动态伸缩、集群容错等问题，而Docker并不具备这样的功能。 而要">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/01-Docker%E5%9F%BA%E7%A1%80/%E5%B0%81%E9%9D%A2.png">
<meta property="article:published_time" content="2022-05-26T02:16:58.000Z">
<meta property="article:modified_time" content="2022-05-26T02:24:17.515Z">
<meta property="article:author" content="高明辉">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="Docker Compose">
<meta property="article:tag" content="Docker Swarm">
<meta property="article:tag" content="jenkins">
<meta property="article:tag" content="Rancher">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/01-Docker%E5%9F%BA%E7%A1%80/%E5%B0%81%E9%9D%A2.png"><link rel="shortcut icon" href="/img/%E7%BD%91%E7%AB%99%E5%9B%BE%E6%A0%87.png"><link rel="canonical" href="http://example.com/2022/05/26/docker%E9%AB%98%E7%BA%A7/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'docker高级',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-26 10:24:17'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Jason" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/%E5%A4%B4%E5%83%8F.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">155</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">187</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li><li><a class="site-page child" href="/butterfly%E4%B8%BB%E9%A2%98"><i class="fa-fw https://github.com/jerryc127/hexo-theme-butterfly/"></i><span> 2</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/01-Docker%E5%9F%BA%E7%A1%80/%E5%B0%81%E9%9D%A2.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Jason</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li><li><a class="site-page child" href="/butterfly%E4%B8%BB%E9%A2%98"><i class="fa-fw https://github.com/jerryc127/hexo-theme-butterfly/"></i><span> 2</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">docker高级</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-26T02:16:58.000Z" title="发表于 2022-05-26 10:16:58">2022-05-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-05-26T02:24:17.515Z" title="更新于 2022-05-26 10:24:17">2022-05-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Docker/">Docker</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="docker高级"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Docker高级"><a href="#Docker高级" class="headerlink" title="Docker高级"></a>Docker高级</h1><p><strong>学习目标</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">了解DockerCompose的基本语法</span></span><br><span class="line"><span class="meta">-</span> <span class="string">使用Docker-Swarm部署一个Java应用</span></span><br><span class="line"><span class="meta">-</span> <span class="string">了解持续集成持续部署</span></span><br></pre></td></tr></table></figure>

<h1 id="1-容器编排概述"><a href="#1-容器编排概述" class="headerlink" title="1 容器编排概述"></a>1 容器编排概述</h1><p>Docker只是一个对项目做打包和运行的小工具，如果止步于此，那么充其量就是一个开发者手里的<code>小玩具</code>。</p>
<p>因为真实的项目都是要集群部署的，<strong>还要考虑负载均衡、水平扩展、动态伸缩、集群容错等问题</strong>，而Docker并不具备这样的功能。</p>
<p>而要想让Docker在集群中的部署如同单机部署一样的方便，那就需要用到<strong>容器编排</strong>技术了。</p>
<p>“编排”（Orchestration）在云计算行业里不算是新词汇，它主要是指用户如何通过某些工具或者配置来完成一组虚拟机以及关联资源的定义、配置、创建、删除等工作，然后由云计算平台按照这些指定的逻辑来完成的过程。</p>
<p>而容器时代，“编排”显然就是对 Docker 容器的一系列定义、配置和创建动作的管理。目前容器编排技术比较知名的包括：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">Docker公司自己的：docker-compose + swarm组合</span></span><br><span class="line"><span class="meta">-</span> <span class="string">Google牵头的Kubernetes技术，简称为k8s</span></span><br></pre></td></tr></table></figure>

<h1 id="2-Docker-Compose"><a href="#2-Docker-Compose" class="headerlink" title="2 Docker Compose"></a>2 Docker Compose</h1><p><code>Docker Compose</code> 是 Docker 官方编排（Orchestration）项目之一，负责快速的部署分布式应用，官网地址： <a target="_blank" rel="noopener" href="https://github.com/docker/compose">https://github.com/docker/compose</a> ，其前身是开源项目 Fig。</p>
<p>本节将介绍 <code>Compose</code> 项目情况以及安装和使用。</p>
<p>网址：<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/">https://docs.docker.com/compose/compose-file/</a></p>
<h2 id="2-1-为什么要用Docker-Compose"><a href="#2-1-为什么要用Docker-Compose" class="headerlink" title="2.1 为什么要用Docker Compose"></a>2.1 为什么要用Docker Compose</h2><p>通过Dockerfile我们可以将一个项目很方便的打包为一个Docker镜像。但是在日常工作中，经常会碰到需要多个容器相互配合来完成某项任务的情况。例如要实现一个 Web 项目，除了 Web 服务容器本身，往往还需要再加上后端的数据库服务容器，甚至还包括负载均衡容器等。</p>
<p>那么如何定义各个容器的依赖关系，这就需要用到docker-compose了。</p>
<p><code>Compose</code> 恰好满足了Docker集群化的需求。它允许用户通过一个单独的 ==docker-compose.yml== 模板文件（YAML 格式）来<strong>定义一组相关联的应用容器为一个项目</strong>（project）。</p>
<h2 id="2-2-Docker-Compose安装"><a href="#2-2-Docker-Compose安装" class="headerlink" title="2.2 Docker Compose安装"></a>2.2 Docker Compose安装</h2><p>MAC下或者Windows下的Docker自带Compose功能，无需安装。</p>
<p>Linux下需要通过命令安装：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">curl -L https://get.daocloud.io/docker/compose/releases/download/1.24.1/docker-compose-`uname -s`-`uname -m` &gt; /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line"><span class="comment"># 修改权限</span></span><br><span class="line">chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/bin/docker-compose /usr/bin/docker-compose</span><br></pre></td></tr></table></figure>

<h2 id="2-3-Docker-Compose快速入门"><a href="#2-3-Docker-Compose快速入门" class="headerlink" title="2.3 Docker Compose快速入门"></a>2.3 Docker Compose快速入门</h2><p>假设我们要部署一个SpringBoot项目，并且依赖于Redis。</p>
<h3 id="2-3-1-导入微服务工程"><a href="#2-3-1-导入微服务工程" class="headerlink" title="2.3.1 导入微服务工程"></a>2.3.1 导入微服务工程</h3><p>工程的基本功能就是统计用户的访问量，代码在<code>资料</code>中docker-demo，直接解压到没有中文的目录下，使用Idea导入即可。</p>
<p><strong>打包项目，获得app.jar</strong>(利用idea中的maven管理的package命令进行打包)</p>
<h3 id="2-3-2-编写Dockerfile"><a href="#2-3-2-编写Dockerfile" class="headerlink" title="2.3.2 编写Dockerfile"></a>2.3.2 编写Dockerfile</h3><p>（1）在任意位置创建一个新目录,docker-compose，将app.jar复制到该目录</p>
<p>（2）在该目录中，新建一个==Dockerfile==文件，并编写下面的内容：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span>-alpine</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./app.jar /tmp/app.jar</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">9090</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/tmp/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-3-编写docker-compose"><a href="#2-3-3-编写docker-compose" class="headerlink" title="2.3.3 编写docker-compose"></a>2.3.3 编写docker-compose</h3><p>在刚才的目录中，创建一个==docker-compose.yml==文件并填写内容：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9090:9090&quot;</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;redis&quot;</span></span><br></pre></td></tr></table></figure>

<p>此时的结构如下：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626122026530-1625530478553.png" alt="image-20210626122026530"></p>
<p>命令解读：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">version：compose的版本</span></span><br><span class="line"><span class="meta">-</span> <span class="string">services：服务列表，包括两个服务：</span></span><br><span class="line">  <span class="meta">-</span> <span class="string">web：自己写的Java项目</span></span><br><span class="line">    <span class="meta">-</span> <span class="string">build：这个服务镜像是临时构建的，构建目录是当前目录，会利用当前目录的Dockerfile来完成构建。</span></span><br><span class="line">    <span class="meta">-</span> <span class="string">ports：端口映射，对外开放8080端口</span></span><br><span class="line">  <span class="meta">-</span> <span class="string">redis：redis服务</span></span><br></pre></td></tr></table></figure>



<h3 id="2-3-4-启动测试"><a href="#2-3-4-启动测试" class="headerlink" title="2.3.4 启动测试"></a>2.3.4 启动测试</h3><p>将刚刚准备好的文件夹docker-compose上传到Linux的<code>/opt</code>目录：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626122243656-1625530478554.png" alt="image-20210626122243656"></p>
<p>进入docker-compose目录然后执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up</span><br></pre></td></tr></table></figure>

<p>构建完成后，可以看到项目运行的日志信息：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20201109001711441-1625530478554.png" alt="image-20201109001711441"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20201109001832104-1625530478554.png" alt="image-20201109001832104"></p>
<p>此时，访问浏览器 <a target="_blank" rel="noopener" href="http://192.168.80.151:9090/hello%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E4%B8%8B%E9%9D%A2%E7%9A%84%E7%BB%93%E6%9E%9C%EF%BC%9A">http://192.168.80.151:9090/hello，可以看到下面的结果：</a></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626123534275-1625530478554.png" alt="image-20210626123534275"></p>
<p>如果多次访问，这个次数会累加。</p>
<p>按<code>CTRL+C</code>后可以<strong>停止运行程序，并且Docker运行的容器中也会关闭</strong>。</p>
<p>通过<code>docker-compose up -d</code>命令，可以<strong>后台启动</strong>，这样就不会显示日志：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20201109002000959-1625530478554.png" alt="image-20201109002000959"></p>
<p>通过<code>docker-compose stop</code> 关闭容器</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20201109002527208-1625530478554.png" alt="image-20201109002527208"></p>
<p>通过<code>docker-compose down</code>关闭容器并删除</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20201109002122299-1625530478554.png" alt="image-20201109002122299"></p>
<p>上面讲的是：<strong>在linux中安装docker compose ，然后构建项目并且打包，并且 一些配置文件放到一定目录机构中，再拷贝到linux运行，还可以直接就在windows运行了，windows本来就已经自带了docker compose</strong>。（不管是在linux还是windows运行，不需要原本存在 docker 镜像，docker-compose.yml 文件会帮我们构建并且运行）</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">也可以进入跑起来的redis容器，查看具体的key-val哈：</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">exec -it docker-compose_redis_1 bash</span></span><br><span class="line"><span class="attr">redis-cli</span></span><br><span class="line"><span class="attr">ping</span> <span class="string"></span></span><br><span class="line"><span class="attr">keys</span> <span class="string">*</span></span><br><span class="line"><span class="meta">get....</span> <span class="string">(查看一下值)</span></span><br><span class="line"><span class="attr">quilt（退出redis）</span></span><br><span class="line"><span class="attr">exit(退出容器)</span></span><br></pre></td></tr></table></figure>



<h2 id="2-4-Docker-Compose-相关命令"><a href="#2-4-Docker-Compose-相关命令" class="headerlink" title="2.4 Docker Compose 相关命令"></a>2.4 Docker Compose 相关命令</h2><p>docker-compose的相关命令参数：</p>
<p>通过：<code>docker-compose --help</code> 查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost docker-demo]<span class="comment"># docker-compose --help</span></span><br><span class="line">利用Docker来定义和构建一个多容器的应用</span><br><span class="line"></span><br><span class="line">使用方式:</span><br><span class="line">  docker-compose [-f &lt;arg&gt;...] [options] [COMMAND] [ARGS...]</span><br><span class="line">  docker-compose -h|--<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">1 Options:</span><br><span class="line">  -f, --file FILE             指定一个 compose 文件，</span><br><span class="line">                              (默认: docker-compose.yml)</span><br><span class="line">  -p, --project-name NAME     指定project名字</span><br><span class="line">                              (默认: 目录名称)</span><br><span class="line">  --verbose                   显示更多日志</span><br><span class="line">  --log-level LEVEL           日志级别 (DEBUG, INFO, WARNING, ERROR, CRITICAL)</span><br><span class="line">  -v, --version               打印版本并退出</span><br><span class="line">  -H, --host HOST             Daemon socket to connect to</span><br><span class="line">2 Commands:</span><br><span class="line">  build              构建多个service</span><br><span class="line">  config             校验 Compose 文件，格式是否正确，若正确则显示配置，</span><br><span class="line">  					 若格式错误显示错误原因</span><br><span class="line">  down               停止并删除 容器, 网络, 镜像, 和 数据卷</span><br><span class="line">  <span class="built_in">exec</span>               进入一个指定的容器</span><br><span class="line">  <span class="built_in">help</span>               Get <span class="built_in">help</span> on a <span class="built_in">command</span></span><br><span class="line">  images             列出该Compose中包含的各个镜像</span><br><span class="line">  <span class="built_in">kill</span>               通过发送 SIGKILL 信号来强制停止服务容器</span><br><span class="line">  					 格式为 docker-compose <span class="built_in">kill</span> [options] [SERVICE...]</span><br><span class="line">  logs               查看服务容器的输出日志</span><br><span class="line">  					 格式为 docker-compose logs [options] [SERVICE...]。</span><br><span class="line">  pause              暂停一个容器</span><br><span class="line">  port               打印某个容器端口所映射的公共端口</span><br><span class="line">  ps                 列出项目中目前的所有容器</span><br><span class="line">  pull               拉取服务依赖的镜像</span><br><span class="line">  push               推送服务依赖的镜像到 Docker 镜像仓库</span><br><span class="line">  restart            重启项目中的服务</span><br><span class="line">  rm                 删除停止的容器（要先停止容器）</span><br><span class="line">  run                在某个服务上运行指令</span><br><span class="line">  scale              设定某个容器的运行个数</span><br><span class="line">  start              启动多个 services</span><br><span class="line">  stop               停止多个 services</span><br><span class="line">  top                查看各个服务容器内运行的进程。</span><br><span class="line">  unpause            恢复处于暂停状态中的服务。</span><br><span class="line">  up                 创建并启动多个service的容器</span><br><span class="line">  version            Show the Docker-Compose version information</span><br></pre></td></tr></table></figure>



<h2 id="2-5-Docker-Compose常用语法"><a href="#2-5-Docker-Compose常用语法" class="headerlink" title="2.5 Docker Compose常用语法"></a>2.5 Docker Compose常用语法</h2><p>Compose模板文件是Compose的核心，包括有多种版本的Compose文件格式–：1，2，2.x和3.x。对应的Docker版本也不一样，对照表：</p>
<table>
<thead>
<tr>
<th align="left"><strong>Compose file format</strong></th>
<th align="left"><strong>Docker Engine release</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">3.8</td>
<td align="left">19.03.0+</td>
</tr>
<tr>
<td align="left">3.7</td>
<td align="left">18.06.0+</td>
</tr>
<tr>
<td align="left">3.6</td>
<td align="left">18.02.0+</td>
</tr>
<tr>
<td align="left">3.5</td>
<td align="left">17.12.0+</td>
</tr>
<tr>
<td align="left">3.4</td>
<td align="left">17.09.0+</td>
</tr>
<tr>
<td align="left">3.3</td>
<td align="left">17.06.0+</td>
</tr>
<tr>
<td align="left">3.2</td>
<td align="left">17.04.0+</td>
</tr>
<tr>
<td align="left">3.1</td>
<td align="left">1.13.1+</td>
</tr>
<tr>
<td align="left">3.0</td>
<td align="left">1.13.0+</td>
</tr>
<tr>
<td align="left">2.4</td>
<td align="left">17.12.0+</td>
</tr>
<tr>
<td align="left">2.3</td>
<td align="left">17.06.0+</td>
</tr>
<tr>
<td align="left">2.2</td>
<td align="left">1.13.0+</td>
</tr>
<tr>
<td align="left">2.1</td>
<td align="left">1.12.0+</td>
</tr>
<tr>
<td align="left">2.0</td>
<td align="left">1.10.0+</td>
</tr>
<tr>
<td align="left">1.0</td>
<td align="left">1.9.1.+</td>
</tr>
</tbody></table>
<p>编写时，需要根据自己的docker版本来选择指定的Compose版本。</p>
<p>详细语法参考文档：<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/">https://docs.docker.com/compose/compose-file/</a></p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p><code>Compose</code> 中有两个重要的概念：</p>
<ul>
<li><strong>项目</strong> (<code>project</code>)：<strong>由一组关联的应用容器组成的一个完整业务单元</strong>，在 <code>docker-compose.yml</code> 文件中定义。</li>
<li><strong>服务</strong> (<code>service</code>)：<strong>一个应用的容器，实际上可以包括若干运行相同镜像的容器实例</strong>。</li>
</ul>
<p><code>Compose</code> 的默认管理对象是项目，通过子命令对项目中的一组容器进行便捷地生命周期管理。</p>
<p>Compose文件是一个YAML文件，定义 一个或多个服务（service），网络（network）和 卷（volume）。撰写文件的默认路径为<code>./docker-compose.yml</code>。</p>
<blockquote>
<p><strong>提示</strong>：您可以为此文件使用 <code>.yml</code>或<code>.yaml</code>扩展名。他们俩都工作。</p>
</blockquote>
<p>简单来说，一个<code>project</code>包含多个<code>service</code>，每个<code>service</code>都是一个组件。<strong>例如入门案例中的Java项目和Redis都是<code>service</code>。</strong>部署时，可能每个service都会有多个容器去运行，形成负载均衡的集群。</p>
<p>因此，我们定义service，就是在定义这个service在容器运行时的规则参数，就像是给<code>docker run</code>命令设置参数一样。</p>
<p>我们定义network和volume类似于 <code>docker network create</code>和<code>docker volume create</code>这两个命令的效果。</p>
<p>只不过，我们定义规则，执行命令则由docker compose来完成。</p>
<p>参考我们之前的Demo，我们来学习下Compose的模板文件语法：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9090:9090&quot;</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;redis&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="version"><a href="#version" class="headerlink" title="version"></a>version</h3><p>版本信息，详见上面提到的Compose版本与Docker的对应关系。</p>
<h3 id="build"><a href="#build" class="headerlink" title="build"></a>build</h3><p>指定 <code>Dockerfile</code> 所在文件夹的路径（可以是绝对路径，或者相对 <code>docker-compose.yml</code> 文件的路径）。 <code>Compose</code> 将会利用它自动构建这个镜像，然后使用这个镜像。</p>
<p>在入门案例中，因为<code>Dockerfile</code>和<code>docker-compose.yml</code>是在一个目录，因此build值指定为<code>.</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br></pre></td></tr></table></figure>

<p>另外，你也可以先制定目录，然后在指定Dockerfile文件，例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span> </span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="attr">buildno:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>build：Dockerfile配置<ul>
<li>context：用来指定Compose的工作环境目录，如果不指定或使用了相对路径则默认为<code>docker-compose.yml</code>所在目录。</li>
<li>dockerfile：指定Dockerfile的文件名称</li>
</ul>
</li>
</ul>
<h3 id="command"><a href="#command" class="headerlink" title="command"></a>command</h3><p>覆盖容器运行时的默认命令。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;-Xmx256m&quot;</span>, <span class="string">&quot;/tmp/app.jar&quot;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="depends-on"><a href="#depends-on" class="headerlink" title="depends_on"></a>depends_on</h3><p>解决容器的依赖、启动先后的问题。以下例子中会先启动 <code>redis</code> <code>db</code> 再启动 <code>web</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">  <span class="comment"># redis服务</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">  <span class="comment"># mysql服务</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br></pre></td></tr></table></figure>

<h3 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h3><p>指定服务容器启动后执行的入口文件或者启动命令，例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">entrypoint:</span> <span class="string">/code/entrypoint.sh</span></span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">entrypoint:</span> [<span class="string">&quot;php&quot;</span>, <span class="string">&quot;-d&quot;</span>, <span class="string">&quot;memory_limit=-1&quot;</span>, <span class="string">&quot;vendor/bin/phpunit&quot;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="environment"><a href="#environment" class="headerlink" title="environment"></a>environment</h3><p>添加环境变量。您可以使用数组或字典。任何布尔值（true，false，yes，no）都需要用引号引起来，以确保YML解析器不会将其转换为True或False。</p>
<p>仅具有键的环境变量在运行Compose的计算机上解析为它们的值，这对于秘密或特定于主机的值很有用。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">environment:</span></span><br><span class="line">  <span class="attr">RACK_ENV:</span> <span class="string">development</span></span><br><span class="line">  <span class="attr">SHOW:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">  <span class="attr">SESSION_SECRET:</span></span><br></pre></td></tr></table></figure>

<p>或：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">environment:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">RACK_ENV=development</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">SHOW=true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">SESSION_SECRET</span></span><br></pre></td></tr></table></figure>

<h3 id="expose"><a href="#expose" class="headerlink" title="expose"></a>expose</h3><p>指定内部端口，不将其发布到宿主机上，只有链接的其它服务才能访问它们。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">expose:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;3000&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;8000&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="extra-hosts"><a href="#extra-hosts" class="headerlink" title="extra_hosts"></a>extra_hosts</h3><p>类似 Docker 中的 <code>--add-host</code> 参数，指定额外的 host 名称映射信息。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">extra_hosts:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">&quot;googledns:8.8.8.8&quot;</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">&quot;dockerhub:52.1.157.61&quot;</span></span><br></pre></td></tr></table></figure>

<p>会在启动后的服务容器中 <code>/etc/hosts</code> 文件中添加如下两条条目。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">8.8.8.8 googledns</span><br><span class="line">52.1.157.61 dockerhub</span><br></pre></td></tr></table></figure>

<h3 id="image"><a href="#image" class="headerlink" title="image"></a>image</h3><p>指定用于启动容器的图像。可以是镜像名称（仓库:tag）或镜像ID，例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure>

<p>如果镜像在本地不存在，而且你没有指定<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/#build">build</a>参数，那么Compose会尝试<code>docker pull</code>来拉取镜像</p>
<h3 id="logging"><a href="#logging" class="headerlink" title="logging"></a>logging</h3><p>配置日志选项。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">driver:</span> <span class="string">syslog</span></span><br><span class="line">  <span class="attr">options:</span></span><br><span class="line">    <span class="attr">syslog-address:</span> <span class="string">&quot;tcp://192.168.0.42:123&quot;</span></span><br></pre></td></tr></table></figure>

<p>目前支持三种日志驱动类型。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">driver:</span> <span class="string">&quot;json-file&quot;</span> <span class="comment"># 记录为json文件</span></span><br><span class="line"><span class="attr">driver:</span> <span class="string">&quot;syslog&quot;</span> <span class="comment"># 发送到syslog服务</span></span><br><span class="line"><span class="attr">driver:</span> <span class="string">&quot;none&quot;</span> <span class="comment"># 没有日志记录</span></span><br></pre></td></tr></table></figure>

<p>默认采用<code>json-file</code>的日志方式，可以通过<code>options</code> 配置日志文件的限制参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">options:</span></span><br><span class="line">  <span class="attr">max-size:</span> <span class="string">&quot;200k&quot;</span></span><br><span class="line">  <span class="attr">max-file:</span> <span class="string">&quot;10&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="network-mode"><a href="#network-mode" class="headerlink" title="network_mode"></a>network_mode</h3><p>网络模式。使用与<code>docker --network</code>参数相同的值:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">network_mode:</span> <span class="string">&quot;bridge&quot;</span></span><br><span class="line"><span class="attr">network_mode:</span> <span class="string">&quot;host&quot;</span></span><br><span class="line"><span class="attr">network_mode:</span> <span class="string">&quot;none&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="networks"><a href="#networks" class="headerlink" title="networks"></a>networks</h3><p>要加入的网络，引用Compose文件中的顶级项目networks下的定义的网络名称 。</p>
<p><strong>要通过容器名称互相访问，则，各个容器必须处于同一个网络中。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;nginx:alpine&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">new</span> <span class="comment"># 加入名称为new的网络</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">worker:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;my-worker-image:latest&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">legacy</span> <span class="comment"># 加入名称为legacy的网络</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">new:</span> <span class="comment"># 加入名称为new的网络</span></span><br><span class="line">        <span class="attr">aliases:</span> <span class="comment"># 在new网络中的别名</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">database</span></span><br><span class="line">      <span class="attr">legacy:</span> <span class="comment"># 加入名称为legacy的网络</span></span><br><span class="line">        <span class="attr">aliases:</span> <span class="comment"># 在legacy网络中的别名</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">new:</span> <span class="comment"># 定义一个网络，名称为new</span></span><br><span class="line">  <span class="attr">legacy:</span> <span class="comment"># 定义一个网络，名称为legacy</span></span><br></pre></td></tr></table></figure>

<p>另外，在定义网络时可以指定<code>ip</code>网段，而加入网络的容器则需要在网段中选择一个固定ip地址：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">app_net:</span></span><br><span class="line">        <span class="attr">ipv4_address:</span> <span class="number">172.16</span><span class="number">.238</span><span class="number">.10</span> <span class="comment"># 指定一个IPv4子网地址</span></span><br><span class="line">        <span class="attr">ipv6_address:</span> <span class="number">2001</span><span class="string">:3984:3989::10</span> <span class="comment"># 指定一个IPv6子网地址</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">app_net:</span></span><br><span class="line">    <span class="attr">ipam:</span></span><br><span class="line">      <span class="attr">driver:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet:</span> <span class="string">&quot;172.16.238.0/24&quot;</span> <span class="comment"># 定义IPv4的地址网段   </span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet:</span> <span class="string">&quot;2001:3984:3989::/64&quot;</span> <span class="comment"># 定义IPv6的地址网段</span></span><br></pre></td></tr></table></figure>

<h3 id="ports"><a href="#ports" class="headerlink" title="ports"></a>ports</h3><p>暴露的端口信息，会映射到宿主机端口，另外为了避免语法出错，所有端口配置都必须使用字符串格式：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;3000&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;3000-3005&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;8000:8000&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;9090-9091:8080-8081&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;49100:22&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;127.0.0.1:8001:8001&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;127.0.0.1:5000-5010:5000-5010&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;6060:6060/udp&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;12400-12500:1240&quot;</span></span><br></pre></td></tr></table></figure>

<p>如果仅指定了容器端口，则会随机选择一个宿主机端口。</p>
<h3 id="restart"><a href="#restart" class="headerlink" title="restart"></a>restart</h3><p>指定容器退出后的重启策略。包括下面的几种选项：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">restart:</span> <span class="string">&quot;no&quot;</span> <span class="comment"># 在任何情况下都不会重新启动容器</span></span><br><span class="line"><span class="attr">restart:</span> <span class="string">always</span> <span class="comment"># 容器总是重新启动。</span></span><br><span class="line"><span class="attr">restart:</span> <span class="string">on-failure</span> <span class="comment"># 遇到故障后重启</span></span><br><span class="line"><span class="attr">restart:</span> <span class="string">unless-stopped</span> <span class="comment"># 总是重新启动容器，除非容器停止</span></span><br></pre></td></tr></table></figure>

<p>生产环境建议配置为：<code>always</code>或者<code>unless-stopped</code></p>
<h3 id="volumes"><a href="#volumes" class="headerlink" title="volumes"></a>volumes</h3><p>指定要挂载的数据卷或目录。数据卷可以是某个service的局部数据卷，也可以是提前定义的全局数据卷（通过顶级参数volumes来指定）。</p>
<p>例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">volumes:</span> <span class="comment"># 完整的数据卷配置语法</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">volume</span></span><br><span class="line">        <span class="attr">source:</span> <span class="string">mydata</span> <span class="comment"># 数据卷</span></span><br><span class="line">        <span class="attr">target:</span> <span class="string">/data</span> <span class="comment"># 容器内目录</span></span><br><span class="line">        <span class="attr">volume:</span></span><br><span class="line">          <span class="attr">nocopy:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">bind</span></span><br><span class="line">        <span class="attr">source:</span> <span class="string">./static</span> <span class="comment"># 宿主机目录</span></span><br><span class="line">        <span class="attr">target:</span> <span class="string">/opt/app/static</span> <span class="comment"># 容器内目录</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:latest</span></span><br><span class="line">    <span class="attr">volumes:</span> <span class="comment"># 简化的数据卷语法</span></span><br><span class="line">      <span class="comment"># 将一个宿主机目录映射到容器内的某个目录</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/var/run/postgres.sock:/var/run/postgres/postgres.sock&quot;</span></span><br><span class="line">      <span class="comment"># 将一个全局卷映射到容器内某个目录</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;dbdata:/var/lib/postgresql/data&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mydata:</span> <span class="comment"># 定义全局的数据卷mydata</span></span><br><span class="line">  <span class="attr">dbdata:</span> <span class="comment"># 定义全局的数据卷dbdata</span></span><br></pre></td></tr></table></figure>

<p>其他swarm配置，上面只是讲解了Compose的部分模板语法。有关swarm下的一些配置并未说明，在swarm部分继续讲解。</p>
<h1 id="3-Docker-Swarm"><a href="#3-Docker-Swarm" class="headerlink" title="3 Docker Swarm"></a>3 Docker Swarm</h1><p>Docker-Compose负责定义Project和Service（服务）。但是服务<strong>具体运行在哪个服务节点</strong>？需要<strong>多少个Docker容器来部署？</strong>这就要靠Docker Swarm来管理了。</p>
<p><code>Swarm</code> 是使用 <a target="_blank" rel="noopener" href="https://github.com/docker/swarmkit/"><code>SwarmKit</code></a> 构建的 Docker 引擎内置（原生）的集群管理和编排工具。</p>
<p>网址：<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/">https://docs.docker.com/engine/swarm/</a></p>
<h2 id="3-1-Docker-Swarm相关概念"><a href="#3-1-Docker-Swarm相关概念" class="headerlink" title="3.1 Docker Swarm相关概念"></a>3.1 Docker Swarm相关概念</h2><p>Docker Swarm 是 Docker 的集群管理工具。它将 Docker 主机池转变为单个虚拟 Docker 主机。 Docker Swarm 提供了标准的 Docker API，所有任何已经与 Docker 守护程序通信的工具都可以使用 Swarm 轻松地扩展到多个主机。</p>
<p>使用 <code>Swarm</code> 集群之前需要了解以下几个概念：</p>
<h3 id="3-1-1-Node节点"><a href="#3-1-1-Node节点" class="headerlink" title="3.1.1 Node节点"></a>3.1.1 Node节点</h3><p><strong>什么是节点？</strong></p>
<p>运行 Docker 的主机可以主动初始化一个 <code>Swarm</code> 集群或者加入一个已存在的 <code>Swarm</code> 集群，这样这个运行 Docker 的主机就成为一个 <code>Swarm</code> 集群的节点 (<code>node</code>) 。</p>
<p><strong>节点的分类：</strong></p>
<p>节点分为<strong>管理 (<code>manager</code>) 节点</strong>和<strong>工作 (<code>worker</code>) 节点</strong>。</p>
<p><strong>管理节点：</strong>用于 <code>Swarm</code> 集群的管理，<code>docker swarm</code> 命令基本只能在管理节点执行（节点退出集群命令 <code>docker swarm leave</code> 可以在工作节点执行）。一个 <code>Swarm</code> 集群可以有多个管理节点（高可用），但只有一个管理节点可以成为 <code>leader</code>，<code>leader</code> 通过 <code>raft</code> 协议实现。</p>
<p><strong>工作节点：</strong>是任务执行节点，管理节点将服务 (<code>service</code>) 下发至工作节点执行。管理节点默认也作为工作节点。你也可以通过配置让服务只运行在管理节点。</p>
<p><strong>Docker-Swarm的官方架构图：</strong></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20201109004124428-1625530478554.png" alt="image-20201109004124428"></p>
<h3 id="3-1-2-Service服务和Task任务"><a href="#3-1-2-Service服务和Task任务" class="headerlink" title="3.1.2 Service服务和Task任务"></a>3.1.2 Service服务和Task任务</h3><p><strong>任务 （<code>Task</code>）</strong>：是 <code>Swarm</code> 中的<strong>最小的调度单位，可以理解为一个单一的容器</strong>。</p>
<p><strong>服务 （<code>Services</code>）</strong>： 是指<strong>一组任务的集合，服务定义了任务的属性</strong>。服务有两种模式：</p>
<ul>
<li><code>replicated services</code> 按照一定规则在各个工作节点上运行指定个数的任务。</li>
<li><code>global services</code> 每个工作节点上运行一个任务</li>
</ul>
<p>两种模式通过 <code>docker service create</code> 的 <code>--mode</code> 参数指定。</p>
<p><strong>容器、任务、服务的关系图：</strong></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20201109004545055-1625530478555.png" alt="image-20201109004545055"></p>
<h2 id="3-2-创建Swarm集群"><a href="#3-2-创建Swarm集群" class="headerlink" title="3.2 创建Swarm集群"></a>3.2 创建Swarm集群</h2><p>我们知道 <code>Swarm</code> 集群由 <strong>管理节点</strong> 和 <strong>工作节点</strong> 组成。本节我们来创建一个包含一个管理节点和两个工作节点的最小 <code>Swarm</code> 集群。</p>
<p>我会启动3台虚拟机，计划如下：</p>
<table>
<thead>
<tr>
<th>虚拟机IP</th>
<th>节点角色</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.80.99</td>
<td>管理节点</td>
</tr>
<tr>
<td>192.168.80.100</td>
<td>工作节点</td>
</tr>
<tr>
<td>192.168.80.101</td>
<td>工作节点</td>
</tr>
</tbody></table>
<p><strong>注意</strong>：节点的IP请定义为自己的虚拟机IP。</p>
<p><strong>虚拟机克隆</strong></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626132820171-1625530478555.png" alt="image-20210626132820171"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626132859269-1625530478555.png" alt="image-20210626132859269"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626132927652-1625530478555.png" alt="image-20210626132927652"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626133831847-1625530478555.png" alt="image-20210626133831847"></p>
<p>结果：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626134615100-1625530478555.png" alt="image-20210626134615100"></p>
<p><strong>分别先后开启f1,f2,修改ip分别为100,101，切记，此时不能同时开任何两个虚拟机</strong></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626134831109-1625530478555.png" alt="image-20210626134831109"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626134946452-1625530478555.png" alt="image-20210626134946452"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626135021759-1625530478555.png" alt="image-20210626135021759"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626135229567-1625530478555.png" alt="image-20210626135229567"></p>
<p>分别在三台机器执行命令：（域名映射）</p>
<p>99机器</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;192.168.80.99 master&#x27;</span> &gt;&gt; /etc/hosts</span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure>

<p>100机器</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;192.168.80.100 slaver1&#x27;</span> &gt;&gt; /etc/hosts</span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure>

<p>101机器</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;192.168.80.101 slaver2&#x27; &gt;&gt; /etc/hosts</span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure>

<p><strong>一定要重启机器</strong></p>
<p><strong>一定要重启机器</strong></p>
<p><strong>一定要重启机器</strong></p>
<h3 id="3-2-1-创建管理节点"><a href="#3-2-1-创建管理节点" class="headerlink" title="3.2.1 创建管理节点"></a>3.2.1 创建管理节点</h3><p>我们在节点192.168.200.99上运行一个命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init --advertise-addr 192.168.80.99</span><br></pre></td></tr></table></figure>

<p>因为我们的虚拟机可能有多个IP地址，这里通过<code>--advertise-addr</code>指定一个IP地址，这里我选择的是我的NAT网卡的地址。</p>
<p>执行命令效果如下：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626165656364-1625530478555.png" alt="image-20210626165656364"></p>
<h3 id="3-2-2-创建工作节点"><a href="#3-2-2-创建工作节点" class="headerlink" title="3.2.2 创建工作节点"></a>3.2.2 创建工作节点</h3><p>通过上面执行的结果可以看到这样的提示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">docker swarm join --token SWMTKN-1-61z291f29zm8w3rh0wbptpzipavgq9lso77a6s46os5mijf5xr-553q8z2bs91r67ptxd1nq1mge 192.168.80.151:2377</span><br></pre></td></tr></table></figure>

<p>所以，我们需要在<code>另外两台机器</code>：<strong>192.168.80.152和192.168.80.153</strong>上执行命令,<strong>不要复制笔记，要复制自己的内容</strong>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join --token SWMTKN-1-40jgt6v1n59mb7aaw41yg10coxo2524tdgw2t6g2sorbiuflhj-5rymf91h0w2l9ic3adbkik39y 192.168.80.151:2377</span><br></pre></td></tr></table></figure>

<p>效果：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626165810134-1625530478555.png" alt="image-20210626165810134"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626165825582-1625530478555.png" alt="image-20210626165825582"></p>
<h3 id="3-2-3-查看swarm集群"><a href="#3-2-3-查看swarm集群" class="headerlink" title="3.2.3.查看swarm集群"></a>3.2.3.查看swarm集群</h3><p>在管理节点：<strong>192.168.80.151</strong>上执行命令，查看swarm集群信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node ls</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img src="F:/java/01-重要部分：2021基础就业/05阶段：服务框架/上海05-服务框架/07.Docker高级/resources/img/image-20210626165907655-1625530478555.png" alt="image-20210626165907655"></p>
<p>此时，我们已经创建了一个最小的 <code>Swarm</code> 集群，包含一个管理节点和两个工作节点。</p>
<h2 id="3-3-部署单个服务"><a href="#3-3-部署单个服务" class="headerlink" title="3.3 部署单个服务"></a>3.3 部署单个服务</h2><p>通过<code>docker service create</code>命令，可以创建一个service，并在swarm集群中运行。</p>
<h3 id="3-3-1-创建服务"><a href="#3-3-1-创建服务" class="headerlink" title="3.3.1.创建服务"></a>3.3.1.创建服务</h3><p>在管理节点：<strong>192.168.80.151</strong>上运行代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create --replicas 3 -p 80:80 --name nginx nginx</span><br></pre></td></tr></table></figure>

<p>解读：</p>
<ul>
<li><code>--replicas 3</code>：代表这个服务要创建3个副本，也就是启动3个容器来运行nginx<strong>（工作节点都不用做任何工作，管理节点会均衡分发任务给当前集群下的工作节点）</strong></li>
</ul>
<p>如图：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20201109010318388-1625530478555.png" alt="image-20201109010318388"></p>
<h3 id="3-3-2-查看服务"><a href="#3-3-2-查看服务" class="headerlink" title="3.3.2 查看服务"></a>3.3.2 查看服务</h3><p>通过<code>docker service ls</code>可以查看服务状态：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20201109010353253-1625530478556.png" alt="image-20201109010353253"></p>
<p>通过<code>docker service ps nginx</code>命令可以查看nginx服务的运行节点信息：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626170156585-1625530478556.png" alt="image-20210626170156585"></p>
<p>在工作节点也可以通过docker ps 命令查看到已经跑起来的容器！</p>
<p>此时，我们通过浏览器访问：<a target="_blank" rel="noopener" href="http://192.168.80.151或者http//192.168.80.152%E6%88%96%E8%80%85http://192.168.80.153%E9%83%BD%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E4%B8%80%E6%A0%B7%E7%9A%84%E6%95%88%E6%9E%9C%EF%BC%9A">http://192.168.80.151或者http://192.168.80.152或者http://192.168.80.153都可以看到一样的效果：</a></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626170235800-1625530478556.png" alt="image-20210626170235800"></p>
<p>注意：</p>
<p><strong>如果浏览器访问部署好的集群节点访问不了时，根据如下步骤配置IPV4的支持！</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward=<span class="number">1</span>  #最下方添加这段代码</span><br><span class="line">#重启network服务</span><br><span class="line">systemctl restart network &amp;&amp; systemctl restart docker</span><br><span class="line">#查看是否修改成功 （备注：返回<span class="number">1</span>，就是成功）</span><br><span class="line">[root<span class="meta">@docker</span>-node2 ~]# sysctl net.ipv4.ip_forward</span><br><span class="line">net.ipv4.ip_forward = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>其它命令：</p>
<p>我们可以使用 <code>docker service scale</code> 对一个服务运行的容器数量进行伸缩。</p>
<p>当业务处于高峰期时，我们需要扩展服务运行的容器数量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service scale nginx=5</span><br></pre></td></tr></table></figure>

<p>当业务平稳时，我们需要减少服务运行的容器数量。<strong>（ps：缩减到两个，而不是减少两个哦）</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service scale nginx=2</span><br></pre></td></tr></table></figure>

<p>使用 <code>docker service rm</code> 来从 <code>Swarm</code> 集群移除某个服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service rm nginx</span><br></pre></td></tr></table></figure>

<p><strong>注意事项：</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">当nginx减到两个时，有两个节点有部署服务，有一个节点没有部署服务，</span></span><br><span class="line"><span class="attr">但是他们是一个集群，在浏览器中访问任何一台节点地址，都能访问到nginx资源，这就是集群灵活的地方！</span></span><br></pre></td></tr></table></figure>



<h2 id="3-4-部署多个服务"><a href="#3-4-部署多个服务" class="headerlink" title="3.4 部署多个服务"></a>3.4 部署多个服务</h2><p><strong>使用 <code>docker service create</code> 一次只能部署一个服务</strong>，使用 <strong><code>docker-compose.yml</code> 我们可以一次启动多个关联的服务并部署到swarm集群</strong>中。</p>
<p>接下来，我们就来搭建一个多服务的集群，包括下面的服务：</p>
<ul>
<li><strong>web：</strong>就是之前在docker-compose案例中的Java项目，依赖于redis进行计数。部署3个</li>
<li><strong>redis：</strong>redis数据库，记录某个IP的访问次数，部署1个，在管理节点。</li>
<li><strong>nginx：</strong>nginx服务，对3个web服务反向代理，部署1个，在管理节点</li>
</ul>
<p>部署计划表：</p>
<table>
<thead>
<tr>
<th>服务名称</th>
<th>部署数量</th>
<th>节点IP</th>
</tr>
</thead>
<tbody><tr>
<td>web</td>
<td>3</td>
<td>192.168.80.151, 192.168.80.152, 192.168.80.153</td>
</tr>
<tr>
<td>redis</td>
<td>1</td>
<td>192.168.80.151</td>
</tr>
<tr>
<td>nginx</td>
<td>1</td>
<td>192.168.80.151</td>
</tr>
</tbody></table>
<p>结构如下：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20201102105907797-1625530478556.png" alt="image-20201102105907797"></p>
<h3 id="3-4-1-准备镜像"><a href="#3-4-1-准备镜像" class="headerlink" title="3.4.1 准备镜像"></a>3.4.1 准备镜像</h3><p>首先，我们需要在3个docker节点上都准备java项目的镜像。</p>
<p><strong>1）上传</strong></p>
<p>找到之前准备的<code>docker-compose</code>这个文件夹:</p>
<p>分别上传到3<strong>个docker</strong>节点的 `/opt 目录：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626170803800-1625530478556.png" alt="image-20210626170803800"></p>
<p><strong>2）构建镜像</strong></p>
<p>然后分别在3个docker节点中运行下面的命令：</p>
<p>进入:  /opt/docker-compose ,执行如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t web:latest .</span><br></pre></td></tr></table></figure>



<p>通过<code>docker images</code>查看镜像：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626171123064-1625530478556.png" alt="image-20210626171123064"></p>
<h3 id="3-4-2-编写nginx配置"><a href="#3-4-2-编写nginx配置" class="headerlink" title="3.4.2 编写nginx配置"></a>3.4.2 编写nginx配置</h3><p>我们需要<strong>用nginx反向代理3个web节点</strong>，因此需要编写一个nginx的配置文件。</p>
<p><strong>nginx部署在管理节点</strong>：<code>192.168.80.151</code>，所以进入管理节点的<code>/opt/docker-compose/swarm</code>目录下，创建一个<code>nginx.conf</code>文件，内容如下：</p>
<p>/opt/docker-compose/swarm</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">default_type</span>  text/html; <span class="comment"># 默认响应类型是html</span></span><br><span class="line">	</span><br><span class="line">	<span class="section">server</span> &#123;</span><br><span class="line">		<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">		<span class="attribute">location</span> /hello &#123;</span><br><span class="line">            <span class="comment"># 代理/hello路径，会代理到web服务的9090端口</span></span><br><span class="line">			<span class="attribute">proxy_pass</span> http://web:9090;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="attribute">location</span> / &#123;</span><br><span class="line">			<span class="attribute">root</span>	/usr/share/nginx/html;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li><code>proxy_pass http://web:9090</code>：会把请求代理到web服务的9090端口。<strong>Docker-Swarm会自动对3个docker节点的web服务负载均衡</strong></li>
</ul>
<h3 id="3-4-3-编写docker-compose"><a href="#3-4-3-编写docker-compose" class="headerlink" title="3.4.3 编写docker-compose"></a>3.4.3 编写docker-compose</h3><p>swarm下的docke-swarm会有一些变化，我们修改管理节点（192.168.80.151）下的<code>docker-compose.yml</code>文件，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;web:latest&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">overlay</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">3</span>  <span class="comment"># 三个副本</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;redis:latest&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">overlay</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span> [<span class="string">node.role</span> <span class="string">==</span> <span class="string">manager</span>]</span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;nginx:latest&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">overlay</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/docker-compose/swarm/nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span> [<span class="string">node.role</span> <span class="string">==</span> <span class="string">manager</span>]</span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">overlay:</span></span><br></pre></td></tr></table></figure>

<p>解读：</p>
<ul>
<li><strong>service：服务，包括3个</strong><ul>
<li><strong>web：java项目</strong><ul>
<li>image：指定web服务的镜像，就是刚刚自己打包的<code>web:latest</code></li>
<li>networks: 网络配置，这里是用了默认的overlay格式，是swarm模式的固定格式</li>
<li>deploy：swarm下的部署配置<ul>
<li>mode：replicated代表在多个节点上做备份</li>
<li>replicas: 3 ，<strong>备份数量为3，即web服务会部署到swarm集群的随机3个节点</strong></li>
</ul>
</li>
</ul>
</li>
<li><strong>redis：redis数据库</strong><ul>
<li>image: “redis:latest”，指定用到的镜像是redis最新镜像</li>
<li>deploy：swarm下的部署配置<ul>
<li>placement: 指定部署位置<ul>
<li> constraints: [node.role == manager] <strong>部署到manager节点</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>nginx：nginx服务</strong><ul>
<li>image: “nginx:latest”，指定镜像名称</li>
<li>networks: 指定网络，这里是用了默认的overlay格式，是swarm模式的固定格式</li>
<li>ports: 对外暴露的端口为80</li>
<li>volumes: 数据卷，指定目录下的nginx.conf文件挂载到容器中</li>
<li>deploy: 部署，<strong>指定部署位置到manager节点</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="3-4-4-部署运行"><a href="#3-4-4-部署运行" class="headerlink" title="3.4.4 部署运行"></a>3.4.4 部署运行</h3><p>多服务运行与单个服务命令不同，<strong>在管理节点</strong>（192.168.80.151）的docker-compose目录下运行下面的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stack deploy -c docker-compose.yml counter</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li><code>docker stack</code>：就是通过docker-compose部署的命令</li>
<li><code>-c docker-compose.yml</code>：指定docker-compose文件位置</li>
<li><code>counter</code>：给部署的集群起个名字</li>
</ul>
<p>运行过程如图：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20201109193630473-1625530478556.png" alt="image-20201109193630473"></p>
<p>通过<code>docker stack ls</code>可以查看到当前集群信息：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20201109193723407-1625530478556.png" alt="image-20201109193723407"></p>
<p>通过<code>docker stack ps [集群名]</code> 可以查看集群中的服务信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stack ps counter</span><br><span class="line"><span class="comment"># 或者 docker stack services counter</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626171747386-1625530478556.png" alt="image-20210626171747386"></p>
<p>此时，访问浏览器：<a target="_blank" rel="noopener" href="http://192.168.80.151/hello%E5%8D%B3%E5%8F%AF%EF%BC%9A">http://192.168.80.151/hello即可：</a></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626171903854-1625530478556.png" alt="image-20210626171903854"></p>
<p>整个访问流程详解：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">根据上面讲的，因为是集群（管理者，工作者），</span></span><br><span class="line"><span class="attr">无论访问哪一个节点（管理节点，工作节点），都会去找nginx（因为有配置nginx），</span></span><br><span class="line"><span class="meta">又因为nginx配置文件的hello路径配置定位到：proxy_pass</span> <span class="string">http://web:9090</span></span><br><span class="line"><span class="attr">那么，web服务所在的节点地址是集群中的哪个节点地址呢？？？不用我们管，nginx会帮我们均衡！</span></span><br></pre></td></tr></table></figure>

<p>此时，通过命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service logs -f counter_web  <span class="comment"># counter_web为我们的java项目服务</span></span><br></pre></td></tr></table></figure>

<p>可以查看运行日志：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20201109195354830-1625530478556.png" alt="image-20201109195354830"></p>
<p>多次访问99主节点，可以看到，Docker-Swarm会自己对3个web服务做负载均衡：</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20201109195456557-1625530478556.png" alt="image-20201109195456557"></p>
<h1 id="4-持续集成-amp-持续部署"><a href="#4-持续集成-amp-持续部署" class="headerlink" title="4 持续集成&amp;持续部署"></a>4 持续集成&amp;持续部署</h1><h2 id="4-1-理解什么是持续集成-amp-持续部署"><a href="#4-1-理解什么是持续集成-amp-持续部署" class="headerlink" title="4.1 理解什么是持续集成&amp;持续部署"></a>4.1 理解什么是持续集成&amp;持续部署</h2><p>随着软件开发复杂度的不断提高，团队开发成员间如何更好地协同工作以确保软件<br>开发的质量已经慢慢成为开发过程中不可回避的问题。互联网软件的开发和发布，已经形成了一套标准流程。</p>
<p>如: 在互联网企业中，每时每刻都有需求的变更，bug的修复， 为了将改动及时更新到生产服务器上，下面的图片我们需要每天执行N多次，<strong>开发人员完成代码自测后提交到git，然后需要将git中最新的代码生成镜像并部署到测试服务器，如果测试通过了还需要将最新代码部署到生产服务器。如果采用手动方式操作，那将会浪费大量的时间浪费在运维部署方面</strong>。</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605489947242-1625530478557.png" alt="1605489947242"></p>
<p>现在的互联网企业，基本都会采用以下方案解决:</p>
<p><strong>持续集成（Continuous integration，简称 CI）。</strong></p>
<p><strong>持续部署（continuous deployment, 简称 CD）</strong></p>
<h3 id="4-1-1-持续集成"><a href="#4-1-1-持续集成" class="headerlink" title="4.1.1 持续集成"></a>4.1.1 持续集成</h3><p><strong>持续集成</strong> （Continuous integration，简称 CI） 指的是，频繁地（一天多次）<strong>将代码集成到主干</strong>。</p>
<p>它的好处主要有两个。</p>
<ol>
<li><p><strong>快速发现错误。</strong>每完成一点更新，就集成到主干，可以快速发现错误，定位错误也比较容易。</p>
</li>
<li><p><strong>防止分支大幅偏离主干</strong>。如果不是经常集成，主干又在不断更新，会导致以后集成的难度变大，甚至难以集成。</p>
</li>
</ol>
<p>持续集成的目的，就是让产品可以快速迭代，同时还能保持高质量。它的核心措施是，代码集成到主干之前，必须通过自动化测试。只要有一个测试用例失败，就不能集成。</p>
<p>Martin Fowler 说过，”持续集成并不能消除 Bug，而是让它们非常容易发现和改正。”</p>
<p>与持续集成相关的，还有两个概念，分别是持续交付和持续部署。</p>
<h3 id="4-1-2-持续交付"><a href="#4-1-2-持续交付" class="headerlink" title="4.1.2 持续交付"></a>4.1.2 持续交付</h3><p>持续交付（Continuous delivery）指的是，频繁地将软件的新版本，交付给质量团队或者用户，以供评审。如果评审通过，代码就进入生产阶段。</p>
<p>持续交付可以看作持续集成的下一步。它强调的是，不管怎么更新，软件是随时随地可以交付的。</p>
<h3 id="4-1-3-持续部署"><a href="#4-1-3-持续部署" class="headerlink" title="4.1.3 持续部署"></a>4.1.3 持续部署</h3><p>持续部署（continuous deployment）是持续交付的下一步，指的是代码通过评审以后，<strong>自动部署</strong>到生产环境。</p>
<p>持续部署的目标是，代码在任何时刻都是可部署的，可以进入生产阶段。</p>
<p>持续部署的前提是能自动化完成测试、构建、部署等步骤。</p>
<h3 id="4-1-4-演示流程说明"><a href="#4-1-4-演示流程说明" class="headerlink" title="4.1.4 演示流程说明"></a>4.1.4 演示流程说明</h3><p>为了保证团队开发人员提交代码的质量，减轻了软件发布时的压力；<br>持续集成中的任何一个环节都是自动完成的，无需太多的人工干预，有利于减少重复<br>过程以节省时间、费用和工作量；接下来我们会演示一套基本的自动化持续集成和持续部署方案，来帮助大家理解互联网企业的软件部署方案。</p>
<p>流程如下:</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605837774557-1625530478557.png" alt="1605837774557"></p>
<p>实现流程：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">1.</span> <span class="string">开发人员将代码提交到 git 指定分支   如: dev</span></span><br><span class="line"><span class="meta">2.</span> <span class="string">git仓库触发push事件，发送webhooks通知到持续集成软件</span></span><br><span class="line"><span class="meta">3.</span> <span class="string">持续集成软件触发构建任务，对dev分支的代码进行构建、编译、单元测试</span></span><br><span class="line"><span class="meta">4.</span> <span class="string">如果构建失败，发送邮件提醒代码提交人员或管理员</span></span><br><span class="line"><span class="meta">5.</span> <span class="string">如果构建成功，最新代码将会被构建Docker镜像并上传到注册中心</span></span><br><span class="line"><span class="meta">6.</span> <span class="string">构建成功触发webhooks通知容器编排软件，进行服务升级</span></span><br><span class="line"><span class="meta">7.</span> <span class="string">容器编排软件，触发对应的服务升级任务， 将创建对应服务的新容器替换之前的容器</span></span><br><span class="line"><span class="meta">8.</span> <span class="string">完成最新代码的自动构建与自动部署，全程无工作人员干预</span></span><br></pre></td></tr></table></figure>

<p>要实现上面流程，我们需要了解两款新的软件   <strong><code>jenkins</code> 和 <code>rancher</code></strong></p>
<h2 id="4-2-CI-amp-CD-jenkins"><a href="#4-2-CI-amp-CD-jenkins" class="headerlink" title="4.2 CI&amp;CD jenkins"></a>4.2 CI&amp;CD jenkins</h2><h3 id="4-2-1-jenkins介绍"><a href="#4-2-1-jenkins介绍" class="headerlink" title="4.2.1 jenkins介绍"></a>4.2.1 jenkins介绍</h3><p>Jenkins，原名Hudson，2011年改为现在的名字，它 是一个开源的实现持续集成的<br>软件工具。官方网站：<a target="_blank" rel="noopener" href="http://jenkins-ci.org/">http://jenkins-ci.org/</a> 。</p>
<p> Jenkins 能实施<strong>监控集成中存在的错误</strong>，提供详细的日志文件和提醒功能，还能用图<br>表的形式形象地展示项目构建的趋势和稳定性。</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605852309418-1625530478557.png" alt="1605852309418"></p>
<p>  特点：</p>
<ul>
<li><strong>易配置</strong>：提供友好的GUI配置界面；</li>
<li><strong>变更支持</strong>：Jenkins能从代码仓库（Subversion/CVS）中获取并产生代码更新列表并<br>输出到编译输出信息中；<br>支持永久链接：用户是通过web来访问Jenkins的，而这些web页面的链接地址都是<br>永久链接地址，因此，你可以在各种文档中直接使用该链接；</li>
<li><strong>集成E-Mail/RSS/IM</strong>：当完成一次集成时，可通过这些工具实时告诉你集成结果（据<br>我所知，构建一次集成需要花费一定时间，有了这个功能，你就可以在等待结果过程<br>中，干别的事情）；</li>
<li><strong>JUnit/TestNG</strong>测试报告：也就是用以图表等形式提供详细的测试报表功能；</li>
<li><strong>支持分布式构建</strong>：Jenkins可以把集成构建等工作分发到多台计算机中完成；<br>文件指纹信息：Jenkins会保存哪次集成构建产生了哪些jars文件，哪一次集成构建使<br>用了哪个版本的jars文件等构建记录；</li>
<li><strong>支持第三方插件</strong>：使得 Jenkins 变得越来越强大</li>
</ul>
<h3 id="4-2-2-安装配置jenkins"><a href="#4-2-2-安装配置jenkins" class="headerlink" title="4.2.2 安装配置jenkins"></a>4.2.2 安装配置jenkins</h3><p>jenkins的官方文档中提供了多种安装方式，本文选择docker的安装方式来学习jenkins</p>
<h4 id="4-2-2-1-安装jenkins"><a href="#4-2-2-1-安装jenkins" class="headerlink" title="4.2.2.1 安装jenkins"></a>4.2.2.1 安装jenkins</h4><p>更改系统配置：</p>
<p><strong>强烈建议虚拟机内存升级到4G，CPU给4核心</strong></p>
<p><strong>强烈建议虚拟机内存升级到4G，CPU给4核心</strong></p>
<p><strong>强烈建议虚拟机内存升级到4G，CPU给4核心</strong></p>
<p><strong>下载jenkins</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkins/jenkins:lts-centos7 </span><br><span class="line">建议windows下载完之后再传到centos系统中！</span><br><span class="line">docker load -i ziliao.tar</span><br><span class="line">docker images (查看上面解压出来的镜像)</span><br></pre></td></tr></table></figure>

<p><strong>创建jenkins容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name myjenkins -p 8888:8080 --restart=always jenkins/jenkins:lts-centos7</span><br></pre></td></tr></table></figure>

<p><strong>查看jenkins启动日志</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f myjenkins</span><br></pre></td></tr></table></figure>

<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210519212902939-1625530478557.png" alt="image-20210519212902939"></p>
<p>启动成功后 访问:</p>
<p><a target="_blank" rel="noopener" href="http://192.168.80.151:8888/">http://192.168.80.151:8888</a></p>
<h4 id="4-2-2-2-解锁jenkins"><a href="#4-2-2-2-解锁jenkins" class="headerlink" title="4.2.2.2 解锁jenkins"></a>4.2.2.2 解锁jenkins</h4><p>第一次运行时，需要先解锁jenkins</p>
<p>具体步骤:</p>
<ol>
<li>去容器中 指定文件查看管理员密码 </li>
<li>将密码拷贝到文本框</li>
<li>点击继续即可</li>
</ol>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605853229487-1625530478557.png" alt="1605853229487"></p>
<p><strong>密码在日志文件中已经打印，也可以根据提示在容器中获取</strong></p>
<p>具体解锁的管理员密码，在jenkins的安装目录中，因为我们是采用的容器安装，所以需要进入到容器中查看,命令如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入到jenkins容器</span></span><br><span class="line">docker exec -it myjenkins bash</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看密码</span></span><br><span class="line">cat /var/jenkins_home/secrets/initialAdminPassword</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将密码复制到上图管理员密码文本框，然后点击继续 完成解锁</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626172752249-1625530478557.png" alt="image-20210626172752249"></p>
<h4 id="4-2-2-3-安装推荐插件"><a href="#4-2-2-3-安装推荐插件" class="headerlink" title="4.2.2.3 安装推荐插件"></a>4.2.2.3 安装推荐插件</h4><p>jenkins的各项功能，依赖各种插件，可以手工选择安装也可以按照推荐安装</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626174213291-1625530478557.png" alt="image-20210626174213291"></p>
<p>我们课程主要使用git 和 chinese中文插件，所以搜索安装</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626174254482-1625530478557.png" alt="image-20210626174254482"></p>
<p><img src="F:/java/01-重要部分：2021基础就业/05阶段：服务框架/上海05-服务框架/07.Docker高级/resources/img/image-20210626174400786-1625530478557.png" alt="image-20210626174400786"></p>
<p><strong>创建管理员用户</strong></p>
<p>插件安装完毕后，会进入到设置管理员用户页面，按自己需求设置就好，后续登录可以使用</p>
<p>设置完毕后点击保存并完成则进入到jenkins欢迎页</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605855220823-1625530478557.png" alt="1605855220823"></p>
<p>接下来，jenkins会让我们确认jenkins服务端的地址，直接下一步就好，</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626174604987-1625530478558.png" alt="image-20210626174604987"></p>
<p>然后点击开始使用jenkins进入到jenkins页面</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605855290646-1625530478558.png" alt="1605855290646"></p>
<p>进入到jenkins页面， 如果这个时候你的页面都是英文的话，重启下就好</p>
<p>(因为上面安装默认插件中已经安装了 中文插件)</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605855341537-1625530478558.png" alt="1605855341537"></p>
<h4 id="4-2-2-4-jenkins插件下载镜像加速"><a href="#4-2-2-4-jenkins插件下载镜像加速" class="headerlink" title="4.2.2.4 jenkins插件下载镜像加速"></a>4.2.2.4 jenkins插件下载镜像加速</h4><p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626175433767-1625530478558.png" alt="image-20210626175433767"></p>
<p>更新地址：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</a></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626175748534-1625530478558.png" alt="image-20210626175748534"></p>
<h4 id="4-2-2-4-配置maven环境"><a href="#4-2-2-4-配置maven环境" class="headerlink" title="4.2.2.4 配置maven环境"></a><strong>4.2.2.4 配置maven环境</strong></h4><p>对于git中项目的构建我们要使用到maven命令，那么在jenkins中需要下载对应的maven插件，以及jenkins所在的容器也要有maven环境</p>
<p><strong>(1) 下载maven插件:</strong></p>
<p>点击系统管理 –&gt; 点击插件管理 –&gt; 进入到插件管理页面</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605855531632-1625530478558.png" alt="1605855531632"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605855558517-1625530478558.png" alt="1605855558517"></p>
<p>点击可选插件 –&gt; 输入maven –&gt; 勾选Maven Integration –&gt; 下载待重启安装</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605856223602-1625530478558.png" alt="1605856223602"></p>
<p>等待下载完成后，重启jenkins容器即可</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605856272958-1625530478558.png" alt="1605856272958"></p>
<p><strong>(2) 安装maven环境</strong></p>
<p>将资源中的maven安装包，拷贝到容器中解压即可，再配置好华为云镜像</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605511349048-1625530478558.png" alt="1605511349048"></p>
<p>将maven压缩包拷贝容器解压</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 目录根据自己实际情况来</span></span><br><span class="line">docker cp ./apache-maven-3.6.3-bin.tar.gz myjenkins:/var/jenkins_home/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入到容器</span></span><br><span class="line">docker exec -it -u root myjenkins bash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 将maven解压</span></span><br><span class="line">cd /var/jenkins_home</span><br><span class="line">tar -zxvf apache-maven-3.6.3-bin.tar.gz </span><br></pre></td></tr></table></figure>

<p>配置maven镜像</p>
<p>上传资料中的settings.xml文件到宿主机中并复制配置文件到容器中</p>
<p><img src="F:/java/01-重要部分：2021基础就业/05阶段：服务框架/上海05-服务框架/07.Docker高级/resources/img/image-20210626181013661-1625530478558.png" alt="image-20210626181013661"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp settings.xml myjenkins:/var/jenkins_home/apache-maven-3.6.3/conf/settings.xml</span><br></pre></td></tr></table></figure>



<p><strong>(3) jenkins中配置maven环境</strong></p>
<p>系统管理中点击全局工具配置</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605856856869-1625530478558.png" alt="1605856856869"></p>
<ol>
<li>新增maven</li>
<li>name随意,MAVEN_HOME: /var/jenkins_home/apache-maven-3.6.3</li>
<li>取消勾选自动安装</li>
<li>保存即可</li>
</ol>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605857052762-1625530478558.png" alt="1605857052762"></p>
<p>完成后，我们就可以通过jenkins创建构建任务啦~~~</p>
<h4 id="Docker私有Registry"><a href="#Docker私有Registry" class="headerlink" title="Docker私有Registry"></a>Docker私有Registry</h4><p>（1）拉取私有仓库镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry</span><br></pre></td></tr></table></figure>

<p>（2）启动私有仓库容器   并 修改开机自启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -id -p 5000:5000 --name myregistry --restart=always  registry</span><br></pre></td></tr></table></figure>

<p>（3）查看检验是否安装启动成功。</p>
<p>打开浏览器 输入地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.80.151:5000/v2/_catalog</span><br></pre></td></tr></table></figure>

<p>看到 {“repositories”:[]} ，表示私有仓库搭建成功并且内容为空</p>
<p><strong>设置当前docker信任私有注册中心</strong></p>
<p>（1）修改daemon.json，让 docker信任私有仓库地址</p>
<p>修改文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>

<p>添加如下内容，保存退出。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;insecure-registries&quot;</span>:[<span class="string">&quot;192.168.80.151:5000&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意：该文件中如有多个内容，比如有之前配置的私服镜像地址，用英文逗号隔开，参考如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://r2fftmt2.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">    <span class="attr">&quot;insecure-registries&quot;</span>:[<span class="string">&quot;192.168.80.151:5000&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时，ip地址要写自己的局域网ip地址哦</p>
<p>（2）重启docker 服务和私服</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>



<h3 id="4-2-3-jenkins快速入门"><a href="#4-2-3-jenkins快速入门" class="headerlink" title="4.2.3 jenkins快速入门"></a>4.2.3 jenkins快速入门</h3><h4 id="4-2-3-1-准备要部署的工程"><a href="#4-2-3-1-准备要部署的工程" class="headerlink" title="4.2.3.1 准备要部署的工程"></a>4.2.3.1 准备要部署的工程</h4><p>准备工作，导入资源中的docker-demo工程, 在pom中添加docker-maven插件配置,</p>
<p>注意将IP部分变成自己虚拟机的IP</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.itcast<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker_demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>app<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 打jar包时如果不配置该插件，打出来的jar包没有清单文件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 插件网址:https://github.com/spotify/docker-maven-plugin --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">imageName</span>&gt;</span>192.168.80.151:5000/$&#123;project.artifactId&#125;:$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">imageName</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">baseImage</span>&gt;</span>java:8-alpine <span class="tag">&lt;/<span class="name">baseImage</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">entryPoint</span>&gt;</span>[&quot;java&quot;,&quot;-jar&quot;,&quot;/$&#123;project.build.finalName&#125;.jar&quot;]<span class="tag">&lt;/<span class="name">entryPoint</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>/<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.build.directory&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">include</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dockerHost</span>&gt;</span>http://192.168.80.151:2375<span class="tag">&lt;/<span class="name">dockerHost</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面插件中的configuration标签配置<strong>指明打包命名格式，docker镜像命名，只要符合一定格式的命名才能上传到本地镜像仓库</strong>，注意<strong>要更改ip地址为自己的虚拟机ip地址</strong>！</p>
<p>将项目上传到码云(gitee.com)中(idea中快速将项目push到gitee中的方法请参考如下连接：)</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">https</span>:<span class="string">//gaominghui123.github.io/2022/03/15/Day10-git/</span></span><br></pre></td></tr></table></figure>

<p>Git中的地址: <a href="mailto:&#x67;&#x69;&#x74;&#x40;&#x67;&#x69;&#116;&#x65;&#x65;&#x2e;&#x63;&#111;&#109;">&#x67;&#x69;&#x74;&#x40;&#x67;&#x69;&#116;&#x65;&#x65;&#x2e;&#x63;&#111;&#109;</a>:taft31/docker-demo.git</p>
<p><img src="F:/java/01-重要部分：2021基础就业/05阶段：服务框架/上海05-服务框架/07.Docker高级/resources/img/image-20210626182453657-1625530478558.png" alt="image-20210626182453657"></p>
<h4 id="4-2-3-2-创建maven构建任务"><a href="#4-2-3-2-创建maven构建任务" class="headerlink" title="4.2.3.2 创建maven构建任务"></a>4.2.3.2 创建maven构建任务</h4><p><strong>(1) 新建jenkins任务</strong></p>
<p>在jenkins的首页的第一个页签就是用于构建任务，点击新建任务:</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605857248023-1625530478559.png" alt="1605857248023"></p>
<p>定义任务名名称，勾选构建模板 保存任务</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626182544621-1625530478559.png" alt="image-20210626182544621"></p>
<p><strong>(2) 设置任务的构建信息:</strong></p>
<p><strong>描述信息设置</strong></p>
<p>如可以写成如下描述信息哈：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">拉取Gitee上的代码，并调用maven插件达成jar包，再将打好的包做成镜像，推送到本地镜像仓库。</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605857417849-1625530478559.png" alt="1605857417849"></p>
<p>**源码设置 **</p>
<p> jenkins可以根据配置的源码地址获取源码，来用于构建，配置如下:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">1.</span> <span class="string">选择git仓库</span></span><br><span class="line"><span class="meta">2.</span> <span class="string">设置git仓库地址 (将上面push的仓库地址填进去)</span></span><br><span class="line"><span class="meta">3.</span> <span class="string">如果是私有仓库需要添加凭证</span></span><br><span class="line"><span class="meta">4.</span> <span class="string">选择仓库分支</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605857556647-1625530478559.png" alt="1605857556647"></p>
<p><strong>构建触发器:</strong> </p>
<p>什么情况可以触发此任务，或者定时触发此任务，<strong>暂不设置</strong></p>
<p><strong>构建设置</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. Pre Steps 构建的前置任务，可以在构建执行前触发一些通知或脚本的执行</span><br><span class="line"><span class="number">2</span>. build 要执行的构建任务</span><br><span class="line"><span class="number">3</span>. PostSteps 构建的后置任务，可以在完成构建后触发的一些通知或脚本的执行</span><br></pre></td></tr></table></figure>

<p>构建任务配置如下:</p>
<p><code>Root POM</code>:  本次构建要使用的git仓库中的pom文件</p>
<p><code>Goals and options</code>: 要执行的mvn命令  不用写前面的mvn</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> maven命令</span> </span><br><span class="line">clean package -DskipTests docker:build -DpushImage</span><br><span class="line"><span class="meta">#</span><span class="bash">意思是 依次进行: 清除 打包 跳过单元测试 远程构建镜像  上传镜像到注册中心</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605857730695-1625530478559.png" alt="1605857730695"></p>
<p><strong>构建结果通知</strong></p>
<p>可以将构建结果，通知给配置的管理员或触发此任务的代码上传人员，本文不配置</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605857813161-1625530478559.png" alt="1605857813161"></p>
<p><strong>保存任务</strong></p>
<p>点击保存即可</p>
<p><strong>构建前要确认docker的2375端口是开放</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑此文件</span></span><br><span class="line">vi /lib/systemd/system/docker.service</span><br><span class="line"><span class="comment"># 修改此行配置</span></span><br><span class="line">ExecStart=/usr/bin/dockerd <span class="literal">-H</span> tcp://<span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">2375</span> <span class="literal">-H</span> unix:///var/run/docker.sock <span class="literal">-H</span> tcp://<span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">7654</span></span><br><span class="line"><span class="comment"># 重新加配置文件并重启docker</span></span><br><span class="line">systemctl daemon<span class="literal">-reload</span></span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>



<h4 id="4-2-3-3-执行maven构建任务"><a href="#4-2-3-3-执行maven构建任务" class="headerlink" title="4.2.3.3 执行maven构建任务"></a>4.2.3.3 执行maven构建任务</h4><p><strong>（1）执行构建任务</strong></p>
<p>当我们保存完毕任务之后，会进入到任务的详情页面， 点击立即构建即可执行该构建任务</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605858494552-1625530478559.png" alt="1605858494552"></p>
<p>或者返回首页面板，也能看到任务列表，列表后面的图标也可以用于构建</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605858525007-1625530478559.png" alt="1605858525007"></p>
<p><strong>（2） 查看任务执行日志</strong></p>
<p>点击构建后，在页面左下会出现任务的执行状态，点击进度条进入到任务构建详情中</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605858565132-1625530478559.png" alt="1605858565132"></p>
<p>可以通过控制台输出页面，查看控制台信息，和我们在idea控制中看到的信息类似</p>
<p>第一次执行会下载很多maven依赖</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605858604063-1625530478559.png" alt="1605858604063"></p>
<p>实际上，jenkins是从我们配置的git中拉取了源码信息，在使用maven的命令进行构建</p>
<p><strong>（3） 查看任务构建结果</strong></p>
<p>控制台出现  <code>BUILD SUCCESS</code> 代表构建成功啦</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605858832629-1625530478559.png" alt="1605858832629"></p>
<p>对应的虚拟机中已经有了这个镜像</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626200126181-1625530478559.png" alt="image-20210626200126181"></p>
<p>对应的注册中心中也上传了此镜像</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626200220451-1625530478559.png" alt="image-20210626200220451"></p>
<p>OK 那么接下来基于这个镜像构建出容器，我们就完成了部署。</p>
<h2 id="4-3-容器编排平台-Rancher"><a href="#4-3-容器编排平台-Rancher" class="headerlink" title="4.3 容器编排平台 Rancher"></a>4.3 容器编排平台 Rancher</h2><h3 id="4-3-1-Rancher介绍"><a href="#4-3-1-Rancher介绍" class="headerlink" title="4.3.1 Rancher介绍"></a>4.3.1 Rancher介绍</h3><p>前面我们了解了容器编排的概念，如: docker 的Swarm以及  google的k8s, 但是这些软件的入门门槛很高，需要我们记住很多命令，那么下面我们介绍一款软件 Rancher，它可以基于上面的容器编排软件，提供可视化的操作页面 实现容器的编排和管理。</p>
<p>Rancher是一个开源的企业级全栈化容器部署及管理平台。Rancher为容器提供一揽<br>子基础架构服务：CNI兼容的网络服务、存储服务、主机管理、负载均衡、防护墙……<br>Rancher让上述服务跨越公有云、私有云、虚拟机、物理机环境运行，真正实现一键式应<br>用部署和管理。<br> <a target="_blank" rel="noopener" href="https://www.cnrancher.com/">https://www.cnrancher.com/</a></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605858952789-1625530478560.png" alt="1605858952789"></p>
<h3 id="4-3-1-Rancher快速入门"><a href="#4-3-1-Rancher快速入门" class="headerlink" title="4.3.1 Rancher快速入门"></a>4.3.1 Rancher快速入门</h3><h4 id="4-3-1-1-安装Rancher"><a href="#4-3-1-1-安装Rancher" class="headerlink" title="4.3.1.1 安装Rancher"></a>4.3.1.1 安装Rancher</h4><p>下载rancher</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull rancher/server</span><br></pre></td></tr></table></figure>

<p>创建rancher容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name=myrancher -p 9099:8080 rancher/server</span><br></pre></td></tr></table></figure>

<p>查看rancher启动日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f myrancher</span><br></pre></td></tr></table></figure>

<p>访问Rancher:  <a target="_blank" rel="noopener" href="http://192.168.80.151:9099/">http://192.168.80.151:9099/</a></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605859055814-1625530478560.png" alt="1605859055814"></p>
<p>页面右下角 点击下拉框 选择简体中文</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605859091466-1625530478560.png" alt="1605859091466"></p>
<h4 id="4-3-1-2-配置环境"><a href="#4-3-1-2-配置环境" class="headerlink" title="4.3.1.2 配置环境"></a>4.3.1.2 配置环境</h4><p>在互联网项目中，可能会有多套部署环境 如: 测试环境 、 生产环境，不同的环境下会有不同的服务器 Rancher支持多环境多服务器管理</p>
<p>默认 我们处于default的默认环境中，点击环境管理可以创建环境</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605859140946-1625530478560.png" alt="1605859140946"></p>
<p>点击添加环境可以定义一个环境</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605859175441-1625530478560.png" alt="1605859175441"></p>
<p>构建环境时，需要设置环境的名称、环境描述、及环境模板</p>
<p>可以看到 环境模板支持多套，所谓的环境模板就是底层使用哪种编排工具</p>
<p>rancher支持 cattle、swarm、k8s、mesos等,默认使用cattle</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605859229797-1625530478560.png" alt="1605859229797"></p>
<p>入门案例我们使用内置的Cattle模板即可，添加后列表出现刚创建的环境</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605859274224-1625530478560.png" alt="1605859274224"></p>
<p>切换到prod环境中</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605859327642-1625530478560.png" alt="1605859327642"></p>
<h4 id="4-3-1-3-配置主机"><a href="#4-3-1-3-配置主机" class="headerlink" title="4.3.1.3 配置主机"></a>4.3.1.3 配置主机</h4><p>在不同的环境中可以会有不同的服务器，要想让我们的rancher能够管理这些服务器，需要在基础架构中添加主机</p>
<p><strong>（1） 添加主机</strong></p>
<p>点击基础架构下拉框中的<code>主机</code> –&gt; 在点击<code>添加主机</code> </p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605859380135-1625530478560.png" alt="1605859380135"></p>
<p><strong>(2) 复制脚本</strong></p>
<p>确认站点地址是否正确，然后点击保存（端口9099）</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626203241022-1625530478560.png" alt="image-20210626203241022"></p>
<p>复制脚本:</p>
<ol>
<li>要管理的主机IP  如: 要管理 192.168.80.151的虚拟机，因此<strong>下面的红圈1 中的ip要作修改</strong></li>
<li>复制脚本，将脚本复制到192.168.80.151的机器上执行</li>
<li>执行完毕后关闭此页面，等待主机连接</li>
</ol>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626220858903-1625530478560.png" alt="image-20210626220858903"></p>
<p><strong>(3) 到主机中执行脚本</strong></p>
<p>如: 到我的192.168.80.151的虚拟机中 执行如下命令:</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605859702912-1625530478560.png" alt="1605859702912"></p>
<p>运行完毕后，在rancher的页面上，关闭窗口 可以在主机列表中看到对应服务器信息</p>
<p>（需要等待主机中下载镜像及启动相关容器）</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626221247380-1625530478560.png" alt="image-20210626221247380"></p>
<p>显示<code>active</code> 代表服务器当前状态可用， 如果报红 或显示<code>reconnecting</code>则为重连状态，等待一会即可</p>
<h4 id="4-3-1-4-管理容器"><a href="#4-3-1-4-管理容器" class="headerlink" title="4.3.1.4 管理容器"></a>4.3.1.4 管理容器</h4><p>连接成功后，我们可以点击<code>基础架构</code>下的<code>容器</code> 进行容器的管理</p>
<p><img src="F:/java/01-重要部分：2021基础就业/05阶段：服务框架/上海05-服务框架/07.Docker高级/resources/img/image-20210626204226263-1625530478561.png" alt="image-20210626204226263"></p>
<p>说明:</p>
<p>（1）页面提供了对应主机上的容器管理功能，额外创建的容器都是系统容器，用于rancher的管理，可以通过 取消勾选显示系统容器进行过滤</p>
<p>（2）<strong>点击添加容器，可以通过简单配置构建一个容器</strong></p>
<p>​    如: 构建一个redis容器</p>
<ol>
<li>点击添加容器</li>
<li>配置容器名称、描述、镜像、端口映射即可</li>
</ol>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605860222158-1625530478561.png" alt="1605860222158"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605860305990-1625530478561.png" alt="1605860305990"></p>
<p>（3）容器列表结尾提供了容器的 重启、删除、查看日志等功能</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605860374959-1625530478561.png" alt="1605860374959"></p>
<h3 id="4-3-3-Rancher中的应用与服务"><a href="#4-3-3-Rancher中的应用与服务" class="headerlink" title="4.3.3 Rancher中的应用与服务"></a>4.3.3 Rancher中的应用与服务</h3><h4 id="4-3-3-1-应用与服务的概念"><a href="#4-3-3-1-应用与服务的概念" class="headerlink" title="4.3.3.1 应用与服务的概念"></a>4.3.3.1 应用与服务的概念</h4><p>上面的容器管理，<strong>仅仅是提供了容器的管理页面</strong>，但对于企业级的项目部署 会涉及到<strong>集群扩容缩容、服务升级、负载均衡等等高可用的管理</strong>。需要在Rancher中通过定义应用与服务的设置来管理。</p>
<p>应用(Project): 代表一个项目     如: 电商项目</p>
<p>服务(Service):代表一个服务     如: 电商项目下的订单微服务</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605841694459-1625530478561.png" alt="1605841694459"></p>
<h4 id="4-3-3-2-创建应用与服务"><a href="#4-3-3-2-创建应用与服务" class="headerlink" title="4.3.3.2 创建应用与服务"></a>4.3.3.2 创建应用与服务</h4><p>和我们学习的swarm类似，我们可以创建一个应用<code>project</code>  一个应用下可以包含多个服务</p>
<p><code>service</code> , 一个服务下可以运行多个相同的容器<code>container</code></p>
<p><strong>创建应用</strong></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605860470039-1625530478561.png" alt="1605860470039"></p>
<p>点击到环境首页，创建应用 ： 应用名称、描述  点击创建</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605860527144-1625530478561.png" alt="1605860527144"></p>
<p><strong>添加服务</strong></p>
<p>在刚创建好的myPro应用中添加服务</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605860574808-1625530478561.png" alt="1605860574808"></p>
<p>设置服务信息: </p>
<ol>
<li>容器名称(rancher中显示的名称)</li>
<li>描述</li>
<li>构建创建前拉取最新镜像</li>
<li>镜像的名称</li>
</ol>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626224317219-1625530478561.png" alt="image-20210626224317219"></p>
<p>点击创建，可以看到容器已经运行</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626223532122-1624718132586-1625530478561.png" alt="image-20210626223532122"></p>
<p> <img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626223551798-1625530478561.png" alt="image-20210626223551798"></p>
<p>在docker中也有对应的服务</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605861203059-1625530478561.png" alt="1605861203059"></p>
<h4 id="4-3-3-3-演示服务扩容"><a href="#4-3-3-3-演示服务扩容" class="headerlink" title="4.3.3.3 演示服务扩容"></a>4.3.3.3 演示服务扩容</h4><p>点击左侧的 数量加减 会自动对服务进行扩容 缩容</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626224416672-1625530478561.png" alt="image-20210626224416672"></p>
<h4 id="4-3-3-4-演示服务负载均衡"><a href="#4-3-3-4-演示服务负载均衡" class="headerlink" title="4.3.3.4 演示服务负载均衡"></a>4.3.3.4 演示服务负载均衡</h4><p>不过我们当前服务集群 <strong>并没有配置端口映射</strong>，因此<strong>外部无法访问，需要配置负载均衡</strong></p>
<p>回到服务列表，添加负载均衡</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605861417894-1625530478561.png" alt="1605861417894"></p>
<p>配置负载均衡</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">      <span class="meta">1.负载均衡名称</span> : <span class="string">lbdockerDemo</span></span><br><span class="line"><span class="meta">​</span>      <span class="string">2.负载均衡描述 : dockerDemo的负载均衡</span></span><br><span class="line"><span class="meta">​</span>      <span class="string">3.访问端口:   9001</span></span><br><span class="line"><span class="meta">​</span>      <span class="string">4.目标服务: myPro/dockerDemo</span></span><br><span class="line"><span class="meta">​</span>      <span class="string">5.映射服务容器端口: 9090</span></span><br></pre></td></tr></table></figure>



<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605861694062-1625530478562.png" alt="1605861694062"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626224727637-1625530478562.png" alt="image-20210626224727637"></p>
<p>访问测试:  <a target="_blank" rel="noopener" href="http://192.168.80.151:9001/hello">http://192.168.80.151:9001/hello</a>  多次点击</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626224903555-1624718944104-1625530478562.png" alt="image-20210626224903555"></p>
<p>依次查看3个容器的日志</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605862093699-1625530478562.png" alt="1605862093699"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605862150892-1625530478562.png" alt="1605862150892"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605862172571-1625530478562.png" alt="1605862172571"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605862198473-1625530478562.png" alt="1605862198473"></p>
<p>​    已经实现了负载均衡效果~~~~</p>
<p><strong>应用服务部署总结：</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1</span> <span class="string">由于一开始需要本地仓库，因此registry 容器早就开始运行了</span></span><br><span class="line"><span class="attr">2</span> <span class="string">上面也添加了redis容器</span></span><br><span class="line"><span class="attr">3</span> <span class="string">添加应用，应用中添加并运行服务镜像</span></span><br><span class="line">	<span class="meta">（我们idea</span> <span class="string">编写的项目，然后通过 gitee，jenkins等配置生成了镜像）</span></span><br><span class="line"><span class="attr">4</span> <span class="string">添加负载均衡（相当于添加了nginx容器）</span></span><br><span class="line"><span class="attr">5</span> <span class="string">通过 虚拟机ip+访问端口 来访问nginx，然后自动均衡负载访问到我们应用中的服务</span></span><br><span class="line"><span class="attr">6</span> <span class="string">通过rancher 管理平台方便实现扩容，减容。</span></span><br></pre></td></tr></table></figure>

<p><strong>同样的效果，对比前面学习的方法</strong>：将每一个镜像拉取下来，自己的项目镜像上传到虚拟机，然后通过docker编排文件构建应用服务，通过命令行扩容，缩容等操作，<strong>利用idea+git+ jenkins+rancher 来可视化部署，高端多了！</strong></p>
<h4 id="4-3-3-5-演示服务升级"><a href="#4-3-3-5-演示服务升级" class="headerlink" title="4.3.3.5 演示服务升级"></a>4.3.3.5 演示服务升级</h4><p>访问当前服务 <a target="_blank" rel="noopener" href="http://192.168.206.66:9001/hello">http://192.168.206.66:9001/hello</a></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626225151134-1625530478562.png" alt="image-20210626225151134"></p>
<p>变更当前代码</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605862350110-1625530478562.png" alt="1605862350110"></p>
<p>push提交到git</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605862398258-1625530478562.png" alt="1605862398258"></p>
<p>执行jenkins构建任务，将最新的代码打包成新镜像，并上传到注册中心</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605862470028-1625530478562.png" alt="1605862470028"></p>
<p>构建成功后，在rancher中进行服务升级 在详情页面或列表页面都有向上的箭头代表服务升级</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605862595138-1625530478562.png" alt="1605862595138"></p>
<p>填写升级信息， 启动行为勾选：先启动再停止</p>
<p>这样会先根据最新镜像创建容器，创建完毕后，再将之前的容器删除，来完成服务的更新</p>
<p><strong>点击升级</strong></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626230551086-1625530478562.png" alt="image-20210626230551086"></p>
<p>最后，点击完成升级 旧的容器将被删除掉</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626230746572-1625530478562.png" alt="image-20210626230746572"></p>
<p>刷新页面，可以看到服务已经升级完毕</p>
<p><img src="F:/java/01-重要部分：2021基础就业/05阶段：服务框架/上海05-服务框架/07.Docker高级/resources/img/image-20210626231005676-1625530478562.png" alt="image-20210626231005676"></p>
<p>也就意味着完成服务的一键部署。</p>
<p>总结：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">上面应用服务的部署可能让你觉得利用jenkins</span> <span class="string">+ rancher 也不过如此，</span></span><br><span class="line"><span class="meta">那么，这里的升级：idea中push+jenkins中构建+rancher中升级</span> <span class="string">几个步骤操作 </span></span><br><span class="line"><span class="attr">会让你更能体验到这种构建部署的便捷之处</span></span><br></pre></td></tr></table></figure>



<h2 id="4-4-自动集成及自动部署"><a href="#4-4-自动集成及自动部署" class="headerlink" title="4.4 自动集成及自动部署"></a>4.4 自动集成及自动部署</h2><p>上面的演示中，当我们<strong>把idea上的代码提交到git中之后， 手动的点击了jenkins中的构建任务，完成镜像的构建和上传注册中心。 然后，在到rancher软件中，根据最新的镜像完成一键升级</strong>。 <strong>那么自动化的流程就是让这两部也变成自动的</strong>（牛逼），我们只需要将代码上传到指定分支将会自动化的完成构建与升级部署。</p>
<h3 id="4-4-1-自动通知jenkins触发任务"><a href="#4-4-1-自动通知jenkins触发任务" class="headerlink" title="4.4.1 自动通知jenkins触发任务"></a>4.4.1 自动通知jenkins触发任务</h3><p>主流的git软件都提供了webhooks功能(web钩子), 通俗点说就是<strong>git在发生某些事件的时候可以通过POST请求调用我们指定的URL路径</strong>，那在这个案例中，我们可以<strong>在push事件上指定jenkins的任务通知路径</strong>。</p>
<h4 id="4-4-1-1-jenkins配置Gitee插件"><a href="#4-4-1-1-jenkins配置Gitee插件" class="headerlink" title="4.4.1.1 jenkins配置Gitee插件"></a>4.4.1.1 jenkins配置Gitee插件</h4><p><strong>jenkins下载webhooks插件</strong></p>
<p>gitee插件介绍: <a target="_blank" rel="noopener" href="https://gitee.com/help/articles/4193#article-header0">https://gitee.com/help/articles/4193#article-header0</a></p>
<p>jenkins也支持通过url路径来启动任务，具体设置方法: </p>
<p>jenkins的默认下载中仅下载了github的通知触发,我们需要先下载一个插件</p>
<p>(1) 下载gitee插件</p>
<p>系统管理–&gt;插件管理–&gt;可选插件–&gt;搜索 <code>Gitee</code> 下载–&gt;重启jenkins</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605863059692-1625530478562.png" alt="1605863059692"></p>
<p>(2) gitee生成访问令牌</p>
<p>   首先，去下面网址生成gitee访问令牌</p>
<p>   <a target="_blank" rel="noopener" href="https://gitee.com/profile/personal_access_tokens">https://gitee.com/profile/personal_access_tokens</a></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605863332642-1625530478563.png" alt="1605863332642"></p>
<p> 添加令牌描述，提交，弹出框输入密码</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605863372394-1625530478563.png" alt="1605863372394"></p>
<p>复制令牌</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605863446752-1625530478563.png" alt="1605863446752"></p>
<p>（3） jenkins中配置Gitee</p>
<p>系统管理 –&gt; 系统配置 –&gt; Gitee配置</p>
<ol>
<li>链接名: gitee</li>
<li>域名: <a target="_blank" rel="noopener" href="https://gitee.com/">https://gitee.com</a></li>
<li>令牌: Gitee Api 令牌   (需要点击添加按下图配置)</li>
<li>配置好后测试连接</li>
<li>测试成功后保存配置</li>
</ol>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605864020886-1625530478563.png" alt="1605864020886"></p>
<p>令牌配置: </p>
<ol>
<li>类型选择Gitee API令牌</li>
<li>私人令牌: 将码云中生成的令牌复制过来</li>
<li>点击添加</li>
</ol>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605863756159-1625530478563.png" alt="1605863756159"> </p>
<h4 id="4-4-1-2-修改jenkins构建任务"><a href="#4-4-1-2-修改jenkins构建任务" class="headerlink" title="4.4.1.2 修改jenkins构建任务"></a>4.4.1.2 修改jenkins构建任务</h4><p><strong>修改配置接收webhooks通知</strong>（<strong>前面是手动构建，这里配置后，gitee仓库被push后就会通知jenkins进行构建！</strong>）</p>
<p>任务详情中点击配置来修改任务</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605864126335-1625530478563.png" alt="1605864126335"></p>
<p>点击构建触发器页签,勾选<code>Gitee webhook</code></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626235155347-1625530478563.png" alt="image-20210626235155347"></p>
<p>生成Gitee Webhook密码</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605864316485-1625530478563.png" alt="1605864316485"></p>
<p>保存好触发路径和webhook密码，到gitee中配置webhook通知</p>
<p>如: </p>
<p><strong>触发路径:</strong>  <a target="_blank" rel="noopener" href="http://192.168.80.151:8888/gitee-project/dockerDemo">http://192.168.80.151:8888/gitee-project/dockerDemo</a></p>
<p><strong>触发密码:</strong> a591baa17f90e094500e0a11b831af9c</p>
<h4 id="4-4-1-3-Gitee添加webhooks通知"><a href="#4-4-1-3-Gitee添加webhooks通知" class="headerlink" title="4.4.1.3 Gitee添加webhooks通知"></a>4.4.1.3 Gitee添加webhooks通知</h4><p><strong>gitee仓库配置webhooks通知</strong></p>
<p>点击仓库页面的管理</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626235434055-1625530478563.png" alt="image-20210626235434055"></p>
<p>添加webhook</p>
<ol>
<li>点击webhooks菜单，然后点击添加</li>
<li>配置jenkins通知地址</li>
<li>填写密码</li>
<li>点击添加</li>
</ol>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626235610214-1625530478563.png" alt="image-20210626235610214"></p>
<p>但在点击添加时，提示失败 <strong>gitee中需要配置一个公有IP或域名</strong>，这里我们可以<strong>通过内网穿透来解决</strong></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605877091111-1625530478563.png" alt="1605877091111"></p>
<h4 id="4-4-1-4-配置内网穿透"><a href="#4-4-1-4-配置内网穿透" class="headerlink" title="4.4.1.4 配置内网穿透"></a>4.4.1.4 配置内网穿透</h4><p>内网穿透的小工具很多，这里面我们使用 natapp提供的内网穿透功能</p>
<p>在资料中找到natapp,上传整个目录到linux，</p>
<p>并进入natapp，执行命令</p>
<p>授权</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x natapp </span><br></pre></td></tr></table></figure>

<p>运行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./natapp</span><br></pre></td></tr></table></figure>

<p><img src="F:/java/01-重要部分：2021基础就业/05阶段：服务框架/上海05-服务框架/07.Docker高级/resources/img/image-20210627000411799-1625530478563.png" alt="image-20210627000411799"></p>
<p>在gitee中将上面的<strong>外网地址替换之前的ip和端口部分</strong>，再次添加，</p>
<p>如：<a target="_blank" rel="noopener" href="http://hgyyd3.natappfree.cc/gitee-project/dockerDemo">http://hgyyd3.natappfree.cc/gitee-project/dockerDemo</a></p>
<p>上面截图中，Forwarding 后面的域名替代就好！</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626235755243-1625530478563.png" alt="image-20210626235755243"></p>
<p>添加成功</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210626235815645-1624723096121-1625530478563.png" alt="image-20210626235815645"></p>
<h4 id="4-4-1-5-测试自动构建"><a href="#4-4-1-5-测试自动构建" class="headerlink" title="4.4.1.5 测试自动构建"></a>4.4.1.5 测试自动构建</h4><p>添加完毕后测试一下:</p>
<p>点击webhooks,发送测试请求</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210627000626447-1624723586914-1625530478563.png" alt="image-20210627000626447"></p>
<p>点击查看更多结果，200代表请求成功</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210627000651626-1625530478563.png" alt="image-20210627000651626"></p>
<p>不过这个时候jenkins中的任务是没被触发的，我们尝试从idea中上传代码，看看任务是否自动构建</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210627002215324-1625530478563.png" alt="image-20210627002215324"></p>
<p>上传代码</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605865274308-1625530478564.png" alt="1605865274308"></p>
<p>代码上传到git后，自动触发了jenkins中的构建任务</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210627000820697-1625530478564.png" alt="image-20210627000820697"></p>
<p>上面配置完了jenkins：idea 项目push到gitee后自动构建镜像，下面配置Rancher，出发自动升级！</p>
<h3 id="4-4-2-Jenkins自动通知Rancher触发升级"><a href="#4-4-2-Jenkins自动通知Rancher触发升级" class="headerlink" title="4.4.2 Jenkins自动通知Rancher触发升级"></a>4.4.2 Jenkins自动通知Rancher触发升级</h3><h4 id="4-4-2-1-Rancher配置接收器"><a href="#4-4-2-1-Rancher配置接收器" class="headerlink" title="4.4.2.1 Rancher配置接收器"></a>4.4.2.1 Rancher配置接收器</h4><p>在rancher中，配置接收器来接收webhooks通知</p>
<p>在api下拉菜单下，点击webhooks添加接收器</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605865468861-1625530478564.png" alt="1605865468861"></p>
<ol>
<li><p>名称:自定义即可</p>
</li>
<li><p>类型：支持扩容，缩容，和服务升级 我们演示服务升级</p>
</li>
<li><p>参数格式: Docker Hub即可</p>
</li>
<li><p>镜像标签: 对应镜像的标签</p>
</li>
<li><p>服务选择器: 我们的服务也可以设置标签， 如: <strong>当前标签service=demo</strong></p>
</li>
</ol>
<p>​      <strong>当这个接收器被触发时，所有服务包含此标签的 service=demo 则会触发服务升级</strong></p>
<ol start="6">
<li>后面参数的概念:</li>
</ol>
<p><strong>先启动一个新容器， 启动成功后停止老容器，最后删除老容器完成升级</strong></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210627001042333-1625530478564.png" alt="image-20210627001042333"></p>
<p>保存，复制触发url路径</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/1605865748613-1625530478564.png" alt="1605865748613"></p>
<p>触发路径:</p>
<p><a target="_blank" rel="noopener" href="http://192.168.80.151:9099/v1-webhooks/endpoint?key=ajTY9M3GYC4geiy255UtQ0XuxluQtidIvp8mav96&amp;projectId=1a7">http://192.168.80.151:9099/v1-webhooks/endpoint?key=ajTY9M3GYC4geiy255UtQ0XuxluQtidIvp8mav96&amp;projectId=1a7</a></p>
<h4 id="4-4-2-2-服务添加标签"><a href="#4-4-2-2-服务添加标签" class="headerlink" title="4.4.2.2 服务添加标签"></a>4.4.2.2 服务添加标签</h4><p>最后，<strong>给我们的服务设置标签，删除之前的服务，重新添加服</strong>务 ，<strong>以及负载均衡器</strong></p>
<p>注意在下面标签下的内容，一致要和接收器设置的标签和值一致此服务才会触发升级</p>
<p><strong>标签:  service      docker</strong></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210627001326171-1625530478564.png" alt="image-20210627001326171"></p>
<h4 id="4-4-2-3-测试服务升级"><a href="#4-4-2-3-测试服务升级" class="headerlink" title="4.4.2.3 测试服务升级"></a>4.4.2.3 测试服务升级</h4><p>通过POSTMAN进行测试</p>
<p>在触发请求时还需要携带一些必要的参数:</p>
<ol>
<li>镜像的标签 tag: 这个标签的值要和上面接收器中的标签值一致才可以触发</li>
<li>仓库的名称 repo_name: 镜像的仓库名称</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;push_data&quot;: &#123;</span><br><span class="line">        &quot;tag&quot;: &quot;1.0.0-SNAPSHOT&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;repository&quot;: &#123;</span><br><span class="line">        &quot;repo_name&quot;: &quot;192.168.80.151:5000/docker-demo&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="F:/java/01-重要部分：2021基础就业/05阶段：服务框架/上海05-服务框架/07.Docker高级/resources/img/image-20210627001556812-1625530478564.png" alt="image-20210627001556812"></p>
<p>点击完毕后观察rancher中服务列表变化，会发现服务将自动完成升级</p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210627002142463-1625530478564.png" alt="image-20210627002142463"></p>
<h4 id="4-4-2-4-配置jenkins的后置处理"><a href="#4-4-2-4-配置jenkins的后置处理" class="headerlink" title="4.4.2.4 配置jenkins的后置处理"></a>4.4.2.4 配置jenkins的后置处理</h4><p>最后，让jenkins来触发rancher,修改jenkins中的配置</p>
<ol>
<li>在构建完毕的后置处理步骤中添加 执行Shell脚本</li>
<li>选择Run only if build succeeds 仅在构建成功时运行下面脚本</li>
<li>执行脚本</li>
</ol>
<p>注意: 调用的路径是我们接收器所生成的路径</p>
<p>tag: 是镜像的tag标签</p>
<p>repo_name: 是对应镜像的仓库名称</p>
<p>要根据自己的实际情况修改哦~~~~~</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&quot;http://192.168.80.151:9099/v1-webhooks/endpoint?key=KoA2vrxiAycydPNDwlb3DLkZ5Kghdshs58lN2lia&amp;projectId=1a13&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type:application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&quot;&#123;\&quot;push_data\&quot;: &#123;\&quot;tag\&quot;: \&quot;1.0.0-SNAPSHOT\&quot;&#125;,\&quot;repository\&quot;: &#123;\&quot;repo_name\&quot;: \&quot;192.168.80.151:5000/docker-demo\&quot;&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210627002516069-1625530478564.png" alt="image-20210627002516069"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210627002549319-1625530478564.png" alt="image-20210627002549319"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210627002730322-1625530478564.png" alt="image-20210627002730322"></p>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/image-20210627002831259-1625530478564.png" alt="image-20210627002831259"></p>
<h3 id="4-4-3-自动集成-amp-自动部署演示"><a href="#4-4-3-自动集成-amp-自动部署演示" class="headerlink" title="4.4.3 自动集成&amp;自动部署演示"></a><strong>4.4.3 自动集成&amp;自动部署演示</strong></h3><p>操作步骤:</p>
<ol>
<li>变更代码并上传到git </li>
<li>注意jenkins任务是否被触发</li>
<li>注意rancher自动升级是否被触发</li>
<li>访问项目查看变更是否生效</li>
</ol>
<p><img src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/docker%E9%AB%98%E7%BA%A7/sqmxvOw23L-1625530478564.gif" alt="sqmxvOw23L"></p>
<p>OK，如果成功了，说明你只需要提交代码就可以了， 和部署相关的 <strong>编译，测试，构建，上传镜像，服务升级，扩容缩容</strong>全部交给工具吧~~~</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">高明辉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/05/26/docker%E9%AB%98%E7%BA%A7/">http://example.com/2022/05/26/docker%E9%AB%98%E7%BA%A7/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Jason</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Docker/">Docker</a><a class="post-meta__tags" href="/tags/Docker-Compose/">Docker Compose</a><a class="post-meta__tags" href="/tags/Docker-Swarm/">Docker Swarm</a><a class="post-meta__tags" href="/tags/jenkins/">jenkins</a><a class="post-meta__tags" href="/tags/Rancher/">Rancher</a></div><div class="post_share"><div class="social-share" data-image="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/01-Docker%E5%9F%BA%E7%A1%80/%E5%B0%81%E9%9D%A2.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="添加微信"/></a><div class="post-qr-code-desc">添加微信</div></li><li class="reward-item"><a href="/img/pay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/pay.jpg" alt="付款码"/></a><div class="post-qr-code-desc">付款码</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/05/31/RabbitMQ/"><img class="prev-cover" src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/rabbitMQ/%E5%B0%81%E9%9D%A2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">RabbitMQ</div></div></a></div><div class="next-post pull-right"><a href="/2022/05/23/numpy-%E5%B0%8F%E7%BB%83%E4%B9%A0/"><img class="next-cover" src="/img/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/numpy-pandas-matplotlib/%E5%B0%81%E9%9D%A2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">numpy-小练习</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/05/10/Docker%E5%9F%BA%E7%A1%80/" title="Docker基础"><img class="cover" src="/img/java/05%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6/01-Docker%E5%9F%BA%E7%A1%80/%E5%B0%81%E9%9D%A2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-10</div><div class="title">Docker基础</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker%E9%AB%98%E7%BA%A7"><span class="toc-number">1.</span> <span class="toc-text">Docker高级</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E6%A6%82%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">1 容器编排概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Docker-Compose"><span class="toc-number">3.</span> <span class="toc-text">2 Docker Compose</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8Docker-Compose"><span class="toc-number">3.1.</span> <span class="toc-text">2.1 为什么要用Docker Compose</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Docker-Compose%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.</span> <span class="toc-text">2.2 Docker Compose安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-Docker-Compose%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">3.3.</span> <span class="toc-text">2.3 Docker Compose快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-%E5%AF%BC%E5%85%A5%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%B7%A5%E7%A8%8B"><span class="toc-number">3.3.1.</span> <span class="toc-text">2.3.1 导入微服务工程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-%E7%BC%96%E5%86%99Dockerfile"><span class="toc-number">3.3.2.</span> <span class="toc-text">2.3.2 编写Dockerfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-%E7%BC%96%E5%86%99docker-compose"><span class="toc-number">3.3.3.</span> <span class="toc-text">2.3.3 编写docker-compose</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-4-%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">3.3.4.</span> <span class="toc-text">2.3.4 启动测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-Docker-Compose-%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="toc-number">3.4.</span> <span class="toc-text">2.4 Docker Compose 相关命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-Docker-Compose%E5%B8%B8%E7%94%A8%E8%AF%AD%E6%B3%95"><span class="toc-number">3.5.</span> <span class="toc-text">2.5 Docker Compose常用语法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">3.5.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#version"><span class="toc-number">3.5.2.</span> <span class="toc-text">version</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#build"><span class="toc-number">3.5.3.</span> <span class="toc-text">build</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#command"><span class="toc-number">3.5.4.</span> <span class="toc-text">command</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#depends-on"><span class="toc-number">3.5.5.</span> <span class="toc-text">depends_on</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ENTRYPOINT"><span class="toc-number">3.5.6.</span> <span class="toc-text">ENTRYPOINT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#environment"><span class="toc-number">3.5.7.</span> <span class="toc-text">environment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#expose"><span class="toc-number">3.5.8.</span> <span class="toc-text">expose</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#extra-hosts"><span class="toc-number">3.5.9.</span> <span class="toc-text">extra_hosts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#image"><span class="toc-number">3.5.10.</span> <span class="toc-text">image</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#logging"><span class="toc-number">3.5.11.</span> <span class="toc-text">logging</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#network-mode"><span class="toc-number">3.5.12.</span> <span class="toc-text">network_mode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#networks"><span class="toc-number">3.5.13.</span> <span class="toc-text">networks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ports"><span class="toc-number">3.5.14.</span> <span class="toc-text">ports</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#restart"><span class="toc-number">3.5.15.</span> <span class="toc-text">restart</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#volumes"><span class="toc-number">3.5.16.</span> <span class="toc-text">volumes</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Docker-Swarm"><span class="toc-number">4.</span> <span class="toc-text">3 Docker Swarm</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-Docker-Swarm%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">4.1.</span> <span class="toc-text">3.1 Docker Swarm相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-Node%E8%8A%82%E7%82%B9"><span class="toc-number">4.1.1.</span> <span class="toc-text">3.1.1 Node节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-Service%E6%9C%8D%E5%8A%A1%E5%92%8CTask%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.1.2.</span> <span class="toc-text">3.1.2 Service服务和Task任务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%88%9B%E5%BB%BASwarm%E9%9B%86%E7%BE%A4"><span class="toc-number">4.2.</span> <span class="toc-text">3.2 创建Swarm集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E5%88%9B%E5%BB%BA%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9"><span class="toc-number">4.2.1.</span> <span class="toc-text">3.2.1 创建管理节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-%E5%88%9B%E5%BB%BA%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9"><span class="toc-number">4.2.2.</span> <span class="toc-text">3.2.2 创建工作节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E6%9F%A5%E7%9C%8Bswarm%E9%9B%86%E7%BE%A4"><span class="toc-number">4.2.3.</span> <span class="toc-text">3.2.3.查看swarm集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E9%83%A8%E7%BD%B2%E5%8D%95%E4%B8%AA%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.3.</span> <span class="toc-text">3.3 部署单个服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.3.1.</span> <span class="toc-text">3.3.1.创建服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.3.2.</span> <span class="toc-text">3.3.2 查看服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E9%83%A8%E7%BD%B2%E5%A4%9A%E4%B8%AA%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.4.</span> <span class="toc-text">3.4 部署多个服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-%E5%87%86%E5%A4%87%E9%95%9C%E5%83%8F"><span class="toc-number">4.4.1.</span> <span class="toc-text">3.4.1 准备镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-%E7%BC%96%E5%86%99nginx%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.2.</span> <span class="toc-text">3.4.2 编写nginx配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-%E7%BC%96%E5%86%99docker-compose"><span class="toc-number">4.4.3.</span> <span class="toc-text">3.4.3 编写docker-compose</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-4-%E9%83%A8%E7%BD%B2%E8%BF%90%E8%A1%8C"><span class="toc-number">4.4.4.</span> <span class="toc-text">3.4.4 部署运行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90-amp-%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2"><span class="toc-number">5.</span> <span class="toc-text">4 持续集成&amp;持续部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E7%90%86%E8%A7%A3%E4%BB%80%E4%B9%88%E6%98%AF%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90-amp-%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2"><span class="toc-number">5.1.</span> <span class="toc-text">4.1 理解什么是持续集成&amp;持续部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90"><span class="toc-number">5.1.1.</span> <span class="toc-text">4.1.1 持续集成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98"><span class="toc-number">5.1.2.</span> <span class="toc-text">4.1.2 持续交付</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2"><span class="toc-number">5.1.3.</span> <span class="toc-text">4.1.3 持续部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-4-%E6%BC%94%E7%A4%BA%E6%B5%81%E7%A8%8B%E8%AF%B4%E6%98%8E"><span class="toc-number">5.1.4.</span> <span class="toc-text">4.1.4 演示流程说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-CI-amp-CD-jenkins"><span class="toc-number">5.2.</span> <span class="toc-text">4.2 CI&amp;CD jenkins</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-jenkins%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.2.1.</span> <span class="toc-text">4.2.1 jenkins介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEjenkins"><span class="toc-number">5.2.2.</span> <span class="toc-text">4.2.2 安装配置jenkins</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-1-%E5%AE%89%E8%A3%85jenkins"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">4.2.2.1 安装jenkins</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-2-%E8%A7%A3%E9%94%81jenkins"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">4.2.2.2 解锁jenkins</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-3-%E5%AE%89%E8%A3%85%E6%8E%A8%E8%8D%90%E6%8F%92%E4%BB%B6"><span class="toc-number">5.2.2.3.</span> <span class="toc-text">4.2.2.3 安装推荐插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-4-jenkins%E6%8F%92%E4%BB%B6%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F"><span class="toc-number">5.2.2.4.</span> <span class="toc-text">4.2.2.4 jenkins插件下载镜像加速</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-4-%E9%85%8D%E7%BD%AEmaven%E7%8E%AF%E5%A2%83"><span class="toc-number">5.2.2.5.</span> <span class="toc-text">4.2.2.4 配置maven环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Docker%E7%A7%81%E6%9C%89Registry"><span class="toc-number">5.2.2.6.</span> <span class="toc-text">Docker私有Registry</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-jenkins%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">5.2.3.</span> <span class="toc-text">4.2.3 jenkins快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-1-%E5%87%86%E5%A4%87%E8%A6%81%E9%83%A8%E7%BD%B2%E7%9A%84%E5%B7%A5%E7%A8%8B"><span class="toc-number">5.2.3.1.</span> <span class="toc-text">4.2.3.1 准备要部署的工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-2-%E5%88%9B%E5%BB%BAmaven%E6%9E%84%E5%BB%BA%E4%BB%BB%E5%8A%A1"><span class="toc-number">5.2.3.2.</span> <span class="toc-text">4.2.3.2 创建maven构建任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-3-%E6%89%A7%E8%A1%8Cmaven%E6%9E%84%E5%BB%BA%E4%BB%BB%E5%8A%A1"><span class="toc-number">5.2.3.3.</span> <span class="toc-text">4.2.3.3 执行maven构建任务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B9%B3%E5%8F%B0-Rancher"><span class="toc-number">5.3.</span> <span class="toc-text">4.3 容器编排平台 Rancher</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-Rancher%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.3.1.</span> <span class="toc-text">4.3.1 Rancher介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-Rancher%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">5.3.2.</span> <span class="toc-text">4.3.1 Rancher快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1-1-%E5%AE%89%E8%A3%85Rancher"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">4.3.1.1 安装Rancher</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1-2-%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83"><span class="toc-number">5.3.2.2.</span> <span class="toc-text">4.3.1.2 配置环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1-3-%E9%85%8D%E7%BD%AE%E4%B8%BB%E6%9C%BA"><span class="toc-number">5.3.2.3.</span> <span class="toc-text">4.3.1.3 配置主机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1-4-%E7%AE%A1%E7%90%86%E5%AE%B9%E5%99%A8"><span class="toc-number">5.3.2.4.</span> <span class="toc-text">4.3.1.4 管理容器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-3-Rancher%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8%E4%B8%8E%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.3.3.</span> <span class="toc-text">4.3.3 Rancher中的应用与服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-3-1-%E5%BA%94%E7%94%A8%E4%B8%8E%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">5.3.3.1.</span> <span class="toc-text">4.3.3.1 应用与服务的概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-3-2-%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8%E4%B8%8E%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.3.3.2.</span> <span class="toc-text">4.3.3.2 创建应用与服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-3-3-%E6%BC%94%E7%A4%BA%E6%9C%8D%E5%8A%A1%E6%89%A9%E5%AE%B9"><span class="toc-number">5.3.3.3.</span> <span class="toc-text">4.3.3.3 演示服务扩容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-3-4-%E6%BC%94%E7%A4%BA%E6%9C%8D%E5%8A%A1%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.3.3.4.</span> <span class="toc-text">4.3.3.4 演示服务负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-3-5-%E6%BC%94%E7%A4%BA%E6%9C%8D%E5%8A%A1%E5%8D%87%E7%BA%A7"><span class="toc-number">5.3.3.5.</span> <span class="toc-text">4.3.3.5 演示服务升级</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E8%87%AA%E5%8A%A8%E9%9B%86%E6%88%90%E5%8F%8A%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">5.4.</span> <span class="toc-text">4.4 自动集成及自动部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1-%E8%87%AA%E5%8A%A8%E9%80%9A%E7%9F%A5jenkins%E8%A7%A6%E5%8F%91%E4%BB%BB%E5%8A%A1"><span class="toc-number">5.4.1.</span> <span class="toc-text">4.4.1 自动通知jenkins触发任务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-1-jenkins%E9%85%8D%E7%BD%AEGitee%E6%8F%92%E4%BB%B6"><span class="toc-number">5.4.1.1.</span> <span class="toc-text">4.4.1.1 jenkins配置Gitee插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-2-%E4%BF%AE%E6%94%B9jenkins%E6%9E%84%E5%BB%BA%E4%BB%BB%E5%8A%A1"><span class="toc-number">5.4.1.2.</span> <span class="toc-text">4.4.1.2 修改jenkins构建任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-3-Gitee%E6%B7%BB%E5%8A%A0webhooks%E9%80%9A%E7%9F%A5"><span class="toc-number">5.4.1.3.</span> <span class="toc-text">4.4.1.3 Gitee添加webhooks通知</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-4-%E9%85%8D%E7%BD%AE%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F"><span class="toc-number">5.4.1.4.</span> <span class="toc-text">4.4.1.4 配置内网穿透</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-5-%E6%B5%8B%E8%AF%95%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA"><span class="toc-number">5.4.1.5.</span> <span class="toc-text">4.4.1.5 测试自动构建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2-Jenkins%E8%87%AA%E5%8A%A8%E9%80%9A%E7%9F%A5Rancher%E8%A7%A6%E5%8F%91%E5%8D%87%E7%BA%A7"><span class="toc-number">5.4.2.</span> <span class="toc-text">4.4.2 Jenkins自动通知Rancher触发升级</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-2-1-Rancher%E9%85%8D%E7%BD%AE%E6%8E%A5%E6%94%B6%E5%99%A8"><span class="toc-number">5.4.2.1.</span> <span class="toc-text">4.4.2.1 Rancher配置接收器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-2-2-%E6%9C%8D%E5%8A%A1%E6%B7%BB%E5%8A%A0%E6%A0%87%E7%AD%BE"><span class="toc-number">5.4.2.2.</span> <span class="toc-text">4.4.2.2 服务添加标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-2-3-%E6%B5%8B%E8%AF%95%E6%9C%8D%E5%8A%A1%E5%8D%87%E7%BA%A7"><span class="toc-number">5.4.2.3.</span> <span class="toc-text">4.4.2.3 测试服务升级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-2-4-%E9%85%8D%E7%BD%AEjenkins%E7%9A%84%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86"><span class="toc-number">5.4.2.4.</span> <span class="toc-text">4.4.2.4 配置jenkins的后置处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-3-%E8%87%AA%E5%8A%A8%E9%9B%86%E6%88%90-amp-%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E6%BC%94%E7%A4%BA"><span class="toc-number">5.4.3.</span> <span class="toc-text">4.4.3 自动集成&amp;自动部署演示</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 高明辉</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'Aaee0Vekhg5KbLhMOJQrEU6A-gzGzoHsz',
      appKey: 'mmLHPEEtqvOSJhsqWra8Sq6K',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script type="text/javascript" src="/js/fairyDustCursor.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>