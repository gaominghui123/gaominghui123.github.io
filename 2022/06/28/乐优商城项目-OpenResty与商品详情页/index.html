<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>乐优商城项目-OpenResty与商品详情页 | Jason</title><meta name="keywords" content="Canal,OpenResty,Lua"><meta name="author" content="高明辉"><meta name="copyright" content="高明辉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="商品详情页学习目标123456- 实现商品详情页几种解决办法- 学会OpenResty的使用- 学会Lua的基本语法- 理解Nginx模板渲染功能- 学会OpenResty操作Redis- 学会Canal的使用（同步mysql与redis的spu详情信息）  1.实现思路用户搜索到商品后，就会点击商品，查看商品详情内容，就会访问到商品详情页。商品详情页是展示商品详细信息的一个页面，承载在网站的大部">
<meta property="og:type" content="article">
<meta property="og:title" content="乐优商城项目-OpenResty与商品详情页">
<meta property="og:url" content="http://example.com/2022/06/28/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-OpenResty%E4%B8%8E%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/index.html">
<meta property="og:site_name" content="Jason">
<meta property="og:description" content="商品详情页学习目标123456- 实现商品详情页几种解决办法- 学会OpenResty的使用- 学会Lua的基本语法- 理解Nginx模板渲染功能- 学会OpenResty操作Redis- 学会Canal的使用（同步mysql与redis的spu详情信息）  1.实现思路用户搜索到商品后，就会点击商品，查看商品详情内容，就会访问到商品详情页。商品详情页是展示商品详细信息的一个页面，承载在网站的大部">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/%E5%B0%81%E9%9D%A2.png">
<meta property="article:published_time" content="2022-06-28T14:10:45.000Z">
<meta property="article:modified_time" content="2022-12-11T02:30:16.810Z">
<meta property="article:author" content="高明辉">
<meta property="article:tag" content="Canal">
<meta property="article:tag" content="OpenResty">
<meta property="article:tag" content="Lua">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/%E5%B0%81%E9%9D%A2.png"><link rel="shortcut icon" href="/img/%E7%BD%91%E7%AB%99%E5%9B%BE%E6%A0%87.png"><link rel="canonical" href="http://example.com/2022/06/28/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-OpenResty%E4%B8%8E%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '乐优商城项目-OpenResty与商品详情页',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-12-11 10:30:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Jason" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/%E5%A4%B4%E5%83%8F.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">192</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">230</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">36</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li><li><a class="site-page child" href="/butterfly%E4%B8%BB%E9%A2%98"><i class="fa-fw https://github.com/jerryc127/hexo-theme-butterfly/"></i><span> 2</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/%E5%B0%81%E9%9D%A2.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Jason</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li><li><a class="site-page child" href="/butterfly%E4%B8%BB%E9%A2%98"><i class="fa-fw https://github.com/jerryc127/hexo-theme-butterfly/"></i><span> 2</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">乐优商城项目-OpenResty与商品详情页</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-06-28T14:10:45.000Z" title="发表于 2022-06-28 22:10:45">2022-06-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-12-11T02:30:16.810Z" title="更新于 2022-12-11 10:30:16">2022-12-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/">乐优商城项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="乐优商城项目-OpenResty与商品详情页"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="商品详情页"><a href="#商品详情页" class="headerlink" title="商品详情页"></a>商品详情页</h1><h1 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h1><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">实现商品详情页几种解决办法</span></span><br><span class="line"><span class="meta">-</span> <span class="string">学会OpenResty的使用</span></span><br><span class="line"><span class="meta">-</span> <span class="string">学会Lua的基本语法</span></span><br><span class="line"><span class="meta">-</span> <span class="string">理解Nginx模板渲染功能</span></span><br><span class="line"><span class="meta">-</span> <span class="string">学会OpenResty操作Redis</span></span><br><span class="line"><span class="meta">-</span> <span class="string">学会Canal的使用（同步mysql与redis的spu详情信息）</span></span><br></pre></td></tr></table></figure>

<h1 id="1-实现思路"><a href="#1-实现思路" class="headerlink" title="1.实现思路"></a>1.实现思路</h1><p>用户搜索到商品后，就会点击商品，查看商品详情内容，就会访问到商品详情页。商品详情页是展示商品详细信息的一个页面，承载在网站的大部分流量和订单的入口。</p>
<p>因此，<strong>商品详情页必须能够应对高并发的压力</strong>。那么如何才能实现一个满足<strong>千万级并发量</strong>的商品详情页面呢？</p>
<p>接下来，我们就一起分析下商品详情页的设计思路。</p>
<h2 id="1-1-传统模式"><a href="#1-1-传统模式" class="headerlink" title="1.1.传统模式"></a>1.1.传统模式</h2><p>首先，来看下传统模式下，一个页面的加载和渲染过程：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200310173422202.png" alt="image-20200310173422202"></p>
<p>基本流程如下：</p>
<ul>
<li>用户请求Nginx服务，获取到静态页面</li>
<li>然后页面发起ajax，向Tomcat服务获取数据</li>
<li>Tomcat查询数据库</li>
<li>页面渲染</li>
</ul>
<p>这种模式下，<strong>数据库称为了瓶颈，高并发情况下</strong>， 数据库难以支撑，因此我们可能会<strong>在服务之前加入缓存，减小数据库压力</strong>：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200310173700012.png" alt="image-20200310173700012"></p>
<p><strong>此时，整个服务的并发能力，就受限于Tomcat</strong>了，业务经常受到依赖的服务不稳定而导致的性能抖动。</p>
<h2 id="1-2-静态化页面"><a href="#1-2-静态化页面" class="headerlink" title="1.2.静态化页面"></a>1.2.静态化页面</h2><p>为了解决上述问题，就有了页面静态化方案，如图：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200310174506082.png" alt="image-20200310174506082"></p>
<p>基本流程：</p>
<ul>
<li>商品修改发送消息到MQ</li>
<li>微服务监听MQ，得知商品变化，渲染并生成一个静态页面</li>
<li>用户请求Nginx</li>
<li>Nginx直接返回渲染好的静态Html</li>
</ul>
<p>优点：</p>
<ul>
<li>用户请求渲染好的Html，响应速度快</li>
<li>通过MQ异步更新，保证数据同步</li>
</ul>
<p>缺陷：</p>
<ul>
<li>小部分数据如价格变更，整个静态页都要重新生成</li>
<li>随着商品数量增加，页面会越来越多</li>
<li>页面模板变更，所有商品的静态页都要重新生成，非常困难</li>
</ul>
<p><strong>分析方法总结：</strong>（两种方案都不行，然后提出两种优化方法）</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/313d024d6eed3ba52bf255e109e39f1.png" alt="313d024d6eed3ba52bf255e109e39f1"></p>
<h2 id="1-3-动态模板，静态化数据"><a href="#1-3-动态模板，静态化数据" class="headerlink" title="1.3.动态模板，静态化数据"></a>1.3.动态模板，静态化数据</h2><p>我们要解决的问题：</p>
<ul>
<li>能迅速响瞬变的需求，和各种变态需求；</li>
<li>支持各种垂直化页面改版；</li>
<li>页面模块化；</li>
<li>高性能、水平扩容；</li>
</ul>
<p>怎么办？</p>
<ul>
<li><strong>1 如何做到动态响应需求变化，页面变化？</strong><ul>
<li>将页面模板动态化，需要的数据静态化</li>
</ul>
</li>
<li><strong>2 如何避免整个页面的全量更新？</strong><ul>
<li>我们把页面分成几部分：如顶部面包屑、商品SKU展示、商品描述、商品评论等，形成多个页面模板（模块）。对应的数据也分成几部分，这些数据可能来自不同的微服务。这样可以减少因局部变更引起的整个页面重新生成。</li>
</ul>
</li>
<li><strong>3 如何应对Tomcat的并发能力低问题？</strong><ul>
<li>将模板渲染、数据放到nginx中做，利用nginx的高并发能力提高系统吞吐量</li>
</ul>
</li>
<li><strong>4 如何实现数据静态化？</strong><ul>
<li>需要的数据可以<strong>缓存在Nginx的本地共享词典</strong>中（长期不会修改的数据），如果命中则直接渲染并返回。如果未命中，则<strong>查询Redis集群</strong>，获取数据。如果Redis集群依然未命中，再去<strong>查询后台微服务</strong>，由微服务获取数据，然后写入缓存中，保证下次Nginx可以从缓存中拿到数据。这样可以减少服务端压力。</li>
</ul>
</li>
<li><strong>5 如何保证数据一致性？</strong><ul>
<li>为了<strong>保证Redis数据与数据库数据一致，我们还要用到Canal技术</strong>，监听数据库变化，及时更新Redis数据。</li>
</ul>
</li>
</ul>
<p>流程图：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200310181707858.png" alt="image-20200310181707858"></p>
<p>因此，我们需要做的事情包括：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">1 静态页数据服务：一个收集商品相关数据，并更新Redis缓存的数据服务</span></span><br><span class="line"><span class="meta">-</span> <span class="string">2 Nginx服务：接收用户请求，查询模板数据，利用模板渲染商品页面</span></span><br><span class="line"><span class="meta">-</span> <span class="string">3 Canal服务：监听数据库变化，同步通知静态页数据服务，更新Redis数据</span></span><br></pre></td></tr></table></figure>

<p>上图中，如果redis有想要的缓存数据，直接返回给nginx</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1</span> <span class="string">相比上上图的传统缓冲，使用redis性能大大提高</span></span><br><span class="line"><span class="attr">2</span> <span class="string">以前redis都是与后端代码交互的（这里更新写入时才与Tomcat交互）</span></span><br><span class="line">	<span class="attr">但是访问时，直接由nginx访问，都不用经过后端，效率可想而知！</span></span><br></pre></td></tr></table></figure>

<h1 id="2-静态页数据服务"><a href="#2-静态页数据服务" class="headerlink" title="2.静态页数据服务"></a>2.静态页数据服务</h1><p>我们搭建一个微服务，来做静态页数据处理。事实上，这样的<strong>页面静态化功能可以拓展至任何数据更新不频繁的其它页面</strong>，都可以在我们这个微服务完成数据处理。</p>
<h2 id="2-1-搭建微服务"><a href="#2-1-搭建微服务" class="headerlink" title="2.1.搭建微服务"></a>2.1.搭建微服务</h2><p>项目坐标：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200310183315470.png" alt="image-20200310183315470"></p>
<p>位置：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200310183319641.png" alt="image-20200310183319641"></p>
<p>依赖：</p>
<p>修改项目中的<code>pom.xml</code>文件，添加下面依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--web依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--redis依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--商品微服务接口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ly-item-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--openfeign--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka客户端--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>启动类：</p>
<p>在<code>ly-page</code>的<code>com.leyou.page</code>包下，添加一个启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.page;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// feign在一个公共代码模块（maven工程中），直接导进来依赖，扫描就好。</span></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.leyou.item.client&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &#123;&quot;com.leyou.page&quot;, &quot;com.leyou.common.advice&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LyPageApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(LyPageApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件application.yml中，添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8084</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">page-service</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">ly-redis</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://ly-registry:10086/eureka</span></span><br></pre></td></tr></table></figure>



<h2 id="2-2-数据分析"><a href="#2-2-数据分析" class="headerlink" title="2.2.数据分析"></a>2.2.数据分析</h2><p>商品详情页渲染过程中，需要哪些数据呢？</p>
<h3 id="2-2-1-需要的数据"><a href="#2-2-1-需要的数据" class="headerlink" title="2.2.1.需要的数据"></a>2.2.1.需要的数据</h3><p>来看这张图：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200310183805526.png" alt="image-20200310183805526"></p>
<p>其中包含的如：<strong>商品三级分类、商品品牌、商品名称</strong>，这些数据主要是<strong>在<code>tb_spu</code>表</strong>中</p>
<p>而像：<strong>标题、价格、库存、特有规格参数、图片</strong>等数据，<strong>来自于<code>tb_sku</code>表</strong></p>
<p>再往下看：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200310184017361.png" alt="image-20200310184017361"></p>
<p>这里的<strong>商品介绍、规格保证、售后保障、通用的规格参数</strong>等数据，<strong>来自于<code>tb_spu_detail</code>表</strong>，当然，<strong>规格参数的名字是在<code>tb_spec_param</code>表中查询</strong>的，<strong>规格组信息是在<code>tb_spec_group</code>表</strong>。</p>
<h3 id="2-2-2-数据的格式"><a href="#2-2-2-数据的格式" class="headerlink" title="2.2.2.数据的格式"></a>2.2.2.数据的格式</h3><p>我们需要的数据在很多表中，不过我们希望<strong>将来不同的数据库更新，只更新对应的缓存数据。因此我们不能将这些数据一次从商品服务查询并放入缓存</strong>，而是分开来做。</p>
<p>1）<strong>与SPU有关的信息：</strong></p>
<ul>
<li>id：spu的id</li>
<li>name：商品名称</li>
<li>cid1\cid2\cid3：分类的三级id</li>
<li>brandId：品牌id</li>
</ul>
<p>2）<strong>分类</strong></p>
<ul>
<li>categories：商品有关的三级分类对象的集合，对象只包含id和name</li>
</ul>
<p>3）<strong>品牌</strong></p>
<ul>
<li>brand：商品相关的品牌对象，id和name</li>
</ul>
<p>4）<strong>spu下的所有sku集合</strong></p>
<p>5）<strong>spu的SpuDetail信息</strong></p>
<p>6）<strong>规格组及组内的参数集合</strong></p>
<ul>
<li><p>因为页面渲染知道<strong>参数名称、id</strong>，还有<strong>规格组名称</strong>：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200310190549005.png" alt="image-20200310190549005"> </p>
</li>
</ul>
<h2 id="2-3-查询商品信息，存入Redis"><a href="#2-3-查询商品信息，存入Redis" class="headerlink" title="2.3.查询商品信息，存入Redis"></a>2.3.查询商品信息，存入Redis</h2><p>接下来，<strong>在静态页数据服务中，提供对Nginx访问的接口。当Nginx访问时，我们查询商品信息，存入Redis，然后把结果返回给Nginx</strong>。</p>
<h3 id="2-3-1-业务分析"><a href="#2-3-1-业务分析" class="headerlink" title="2.3.1.业务分析"></a>2.3.1.业务分析</h3><p>service业务中，我们需要做的事情包括：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">1 根据spuId查询spu</span></span><br><span class="line"><span class="meta">-</span> <span class="string">2 根据spuId查询detail</span></span><br><span class="line"><span class="meta">-</span> <span class="string">3 根据spuId查询Sku</span></span><br><span class="line"><span class="meta">-</span> <span class="string">4 根据categoryId集合查询Category对象集合</span></span><br><span class="line"><span class="meta">-</span> <span class="string">5 根据brandId查询Brand</span></span><br><span class="line"><span class="meta">-</span> <span class="string">6 根据categoryId查询规格组及组内参数</span></span><br><span class="line"><span class="meta">-</span> <span class="string">7 把上述数据`分别`存入Redis</span></span><br></pre></td></tr></table></figure>



<p>为了<strong>保证将来可以做到数据的局部修改</strong>，我们处理数据要分<strong>开到不同的业务方法中，分别查询、分别存储</strong>。</p>
<h3 id="2-3-2-DTO"><a href="#2-3-2-DTO" class="headerlink" title="2.3.2.DTO"></a>2.3.2.DTO</h3><p><strong>缓存到redis的数据要尽可能简化</strong>，因此我们不能直接把从商品微服务查询的数据写入Redis，而是要简单处理下。</p>
<p>我们<strong>从商品微服务查询的规格参数信息数据较臃肿</strong>，这里要处理一下，<strong>封装到两个新的DTO中</strong>。</p>
<p>规格参数的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.page.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpecParamNameDTO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Boolean numeric;</span><br><span class="line">    <span class="keyword">private</span> Boolean generic;</span><br><span class="line">    <span class="keyword">private</span> String unit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>规格组的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.page.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpecGroupNameDTO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;SpecParamNameDTO&gt; params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-3-定义Service"><a href="#2-3-3-定义Service" class="headerlink" title="2.3.3.定义Service"></a>2.3.3.定义Service</h3><p>在<code>ly-page</code>的<code>com.leyou.page.service</code>包下的<code>GoodsPageService</code>中，添加代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.page.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GoodsPageService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载spu到redis中并返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> spuId 商品id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">loadSpuData</span><span class="params">(Long spuId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载spuDetail到redis中并返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> spuId 商品id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">loadSpuDetailData</span><span class="params">(Long spuId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载sku信息到redis中并返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> spuId 商品id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">loadSkuListData</span><span class="params">(Long spuId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载分类信息到redis中并返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ids 商品分类的三级分类id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">loadCategoriesData</span><span class="params">(List&lt;Long&gt; ids)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载品牌信息到redis中并返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> brandId 品牌id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">loadBrandData</span><span class="params">(Long brandId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载规格参数信息到redis中并返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId 商品第三级分类id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">loadSpecData</span><span class="params">(Long categoryId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>ly-page</code>的<code>com.leyou.page.service</code>包下的<code>GoodsPageServiceImpl</code>中，添加代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.page.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.common.utils.BeanHelper;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.utils.JsonUtils;</span><br><span class="line"><span class="keyword">import</span> com.leyou.item.client.ItemClient;</span><br><span class="line"><span class="keyword">import</span> com.leyou.item.dto.*;</span><br><span class="line"><span class="keyword">import</span> com.leyou.page.dto.SpecGroupNameDTO;</span><br><span class="line"><span class="keyword">import</span> com.leyou.page.dto.SpecParamNameDTO;</span><br><span class="line"><span class="keyword">import</span> com.leyou.page.service.GoodsPageService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsPageServiceImpl</span> <span class="keyword">implements</span> <span class="title">GoodsPageService</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// itemClient 指的是ly-common中的feign注解的接口，用来访问ly-item,间接访问mysql！</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ItemClient itemClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_PREFIX_SPU = <span class="string">&quot;page:spu:id:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_PREFIX_SKU = <span class="string">&quot;page:sku:id:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_PREFIX_DETAIL = <span class="string">&quot;page:detail:id:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_PREFIX_CATEGORY = <span class="string">&quot;page:category:id:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_PREFIX_BRAND = <span class="string">&quot;page:brand:id:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_PREFIX_SPEC = <span class="string">&quot;page:spec:id:&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GoodsPageServiceImpl</span><span class="params">(ItemClient itemClient, StringRedisTemplate redisTemplate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.itemClient = itemClient;</span><br><span class="line">        <span class="keyword">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//总结就是：查（通过feign访问ly-item查mysql），存（存redis），返（返回给nginx）！</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">loadSpuData</span><span class="params">(Long spuId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 查询信息</span></span><br><span class="line">        SpuDTO spu = itemClient.querySpuById(spuId);</span><br><span class="line">        <span class="comment">// 组织数据</span></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;id&quot;</span>, spu.getId());</span><br><span class="line">        map.put(<span class="string">&quot;name&quot;</span>, spu.getName());</span><br><span class="line">        map.put(<span class="string">&quot;categoryIds&quot;</span>, spu.getCategoryIds());</span><br><span class="line">        map.put(<span class="string">&quot;brandId&quot;</span>, spu.getBrandId());</span><br><span class="line">        String json = JsonUtils.toJson(map);</span><br><span class="line">        <span class="comment">// 存入redis, 如果数据量逐渐增多，可以用SSDB代替</span></span><br><span class="line">        redisTemplate.opsForValue().set(KEY_PREFIX_SPU + spuId, json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">loadSpuDetailData</span><span class="params">(Long spuId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 查询信息</span></span><br><span class="line">        SpuDetailDTO detail = itemClient.querySpuDetailById(spuId);</span><br><span class="line">        String json = JsonUtils.toJson(detail);</span><br><span class="line">        <span class="comment">// 存入redis</span></span><br><span class="line">        redisTemplate.opsForValue().set(KEY_PREFIX_DETAIL + spuId, json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">loadSkuListData</span><span class="params">(Long spuId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 查询信息</span></span><br><span class="line">        List&lt;SkuDTO&gt; skuList = itemClient.querySkuBySpuId(spuId);</span><br><span class="line">        String json = JsonUtils.toJson(skuList);</span><br><span class="line">        <span class="comment">// 存入redis</span></span><br><span class="line">        redisTemplate.opsForValue().set(KEY_PREFIX_SKU + spuId, json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">loadCategoriesData</span><span class="params">(List&lt;Long&gt; ids)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 查询信息</span></span><br><span class="line">        List&lt;CategoryDTO&gt; list = itemClient.queryCategoryByIds(ids);</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; categoryList = list.stream().map(categoryDTO -&gt; &#123;</span><br><span class="line">            Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">&quot;id&quot;</span>, categoryDTO.getId());</span><br><span class="line">            map.put(<span class="string">&quot;name&quot;</span>, categoryDTO.getName());</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        String json = JsonUtils.toJson(categoryList);</span><br><span class="line">        <span class="comment">// 存入Redis</span></span><br><span class="line">        redisTemplate.opsForValue().set(KEY_PREFIX_CATEGORY + ids.get(<span class="number">2</span>), json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">loadBrandData</span><span class="params">(Long brandId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 查询信息</span></span><br><span class="line">        BrandDTO brand = itemClient.queryBrandById(brandId);</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;id&quot;</span>, brand.getId());</span><br><span class="line">        map.put(<span class="string">&quot;name&quot;</span>, brand.getName());</span><br><span class="line">        String json = JsonUtils.toJson(map);</span><br><span class="line">        <span class="comment">// 存入Redis</span></span><br><span class="line">        redisTemplate.opsForValue().set(KEY_PREFIX_BRAND + brandId, json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">loadSpecData</span><span class="params">(Long categoryId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 查询信息</span></span><br><span class="line">        List&lt;SpecGroupDTO&gt; list = itemClient.querySpecList(categoryId);</span><br><span class="line"></span><br><span class="line">        List&lt;SpecGroupNameDTO&gt; groupList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (SpecGroupDTO groupDTO : list) &#123;</span><br><span class="line">            SpecGroupNameDTO nameDTO = <span class="keyword">new</span> SpecGroupNameDTO();</span><br><span class="line">            nameDTO.setName(groupDTO.getName());</span><br><span class="line">            nameDTO.setParams(BeanHelper.copyWithCollection(groupDTO.getParams(), SpecParamNameDTO.class));</span><br><span class="line">            groupList.add(nameDTO);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String json = JsonUtils.toJson(groupList);</span><br><span class="line">        <span class="comment">// 存入Redis</span></span><br><span class="line">        redisTemplate.opsForValue().set(KEY_PREFIX_SPEC + categoryId, json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-4-定义controller"><a href="#2-3-4-定义controller" class="headerlink" title="2.3.4.定义controller"></a>2.3.4.定义controller</h3><p>在<code>ly-page</code>的<code>com.leyou.page.web</code>中，添加一个<code>PageController</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.page.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.page.service.GoodsPageService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;page&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GoodsPageService goodsPageService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PageController</span><span class="params">(GoodsPageService goodsPageService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.goodsPageService = goodsPageService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询商品spu数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> spuId 商品id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> spu数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/spu/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">querySpuPageData</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long spuId)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(goodsPageService.loadSpuData(spuId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询商品sku数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> spuId 商品id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> sku数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sku/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">querySkuPageData</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long spuId)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(goodsPageService.loadSkuListData(spuId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询商品spuDetail数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> spuId 商品id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> spu数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/detail/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">queryDetailPageData</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long spuId)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(goodsPageService.loadSpuDetailData(spuId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询商品分类数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ids 商品分类id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 分类数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/categories&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">queryCategoryPageData</span><span class="params">(<span class="meta">@RequestParam(&quot;ids&quot;)</span> List&lt;Long&gt; ids)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(goodsPageService.loadCategoriesData(ids));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询品牌数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 品牌id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> spu数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/brand/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">queryBrandPageData</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(goodsPageService.loadBrandData(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询规格数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId 分类id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 规格参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/spec/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">queryGoodsPageData</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long categoryId)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(goodsPageService.loadSpecData(categoryId));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="3-OpenResty渲染静态页"><a href="#3-OpenResty渲染静态页" class="headerlink" title="3.OpenResty渲染静态页"></a>3.OpenResty渲染静态页</h1><p>之前分析中，我们计划使用Nginx来完成<strong>静态页面模板的渲染</strong>，不过我们之前只学习过Nginx的<strong>web服务器功能（静态资源部署）、反向代理功能、负载均衡功能</strong>。但是<strong>如何利用Nginx查询Redis缓存？如何利用Nginx完成页面模板渲染？</strong></p>
<p>nginx中有一个模块叫做<strong>ngx_lua</strong>，可以将Lua嵌入到Nginx中，从而可以使用Lua来编写脚本，这样就可以<strong>使用Lua编写应用逻辑，操作Redis、MySQL</strong>等等；这样就可以使用Lua语言开发高性能Web应用了。</p>
<p>那么OpenResty是什么呢？</p>
<h2 id="3-1-介绍OpenResty"><a href="#3-1-介绍OpenResty" class="headerlink" title="3.1.介绍OpenResty"></a>3.1.介绍OpenResty</h2><p>OpenResty官网地址：<a target="_blank" rel="noopener" href="http://openresty.org/cn/">http://openresty.org/cn/</a></p>
<p><strong>OpenResty® 是一个基于 <a target="_blank" rel="noopener" href="http://openresty.org/cn/nginx.html">Nginx</a> 与 Lua 的高性能 Web 平台</strong>，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建<strong>能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关</strong>。</p>
<p>OpenResty® 通过汇聚各种设计精良的 <a target="_blank" rel="noopener" href="http://openresty.org/cn/nginx.html">Nginx</a> 模块（主要由 OpenResty 团队自主开发），从而将 <a target="_blank" rel="noopener" href="http://openresty.org/cn/nginx.html">Nginx</a> 有效地变成一个<strong>强大的通用 Web 应用平台</strong>。这样，Web 开发人员和系统工程师可以使用 Lua 脚本语言调动 <a target="_blank" rel="noopener" href="http://openresty.org/cn/nginx.html">Nginx</a> 支持的各种 C 以及 Lua 模块，快速构造出足以胜任 10K 乃至 <strong>1000K 以上单机并发</strong>连接的高性能 Web 应用系统。</p>
<p><strong>OpenResty® 的目标是让你的Web服务直接跑在 <a target="_blank" rel="noopener" href="http://openresty.org/cn/nginx.html">Nginx</a> 服务内部</strong>，充分利用 <a target="_blank" rel="noopener" href="http://openresty.org/cn/nginx.html">Nginx</a> 的非阻塞 I/O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应。性能这么高，那以后Tomcat不得被完全取代了？？？</p>
<p>小结：OpenResty实际上就是封装了lua模块等组件的nginx，能够解决我们项目中的问题：</p>
<p><strong>1 查询redis，2 访问微服查数据，3 渲染模板</strong></p>
<h2 id="3-2-安装OpenResty（先拍照！！！）"><a href="#3-2-安装OpenResty（先拍照！！！）" class="headerlink" title="3.2.安装OpenResty（先拍照！！！）"></a>3.2.安装OpenResty（先拍照！！！）</h2><p><strong>形成好习惯，安装前都要拍照。</strong></p>
<p>首先你的Linux虚拟机必须联网，这里建议大家统一使用CentOS7版本。</p>
<p>1）安装开发库:</p>
<p>首先要安装OpenResty的依赖开发库，执行命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pcre-devel openssl-devel gcc curl</span><br></pre></td></tr></table></figure>

<p>2）安装OpenResty仓库</p>
<p>你可以在你的 CentOS 系统中添加 <code>openresty</code> 仓库，这样就可以便于未来安装或更新我们的软件包（通过 <code>yum check-update</code> 命令）。运行下面的命令就可以添加我们的仓库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils</span><br></pre></td></tr></table></figure>

<p>然后执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo</span><br></pre></td></tr></table></figure>



<p>3）安装OpenResty</p>
<p>然后就可以像下面这样安装软件包，比如 <code>openresty</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openresty</span><br></pre></td></tr></table></figure>

<p>4）安装opm工具</p>
<p>opm是OpenResty的一个管理工具，可以帮助我们安装一个第三方的Lua模块。</p>
<p>如果你想安装命令行工具 <code>opm</code>，那么可以像下面这样安装 <code>openresty-opm</code> 包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openresty-opm</span><br></pre></td></tr></table></figure>

<p>5）目录结构</p>
<p>默认情况下，OpenResty安装的目录是：/usr/local/openresty</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200310225539214.png" alt="image-20200310225539214"> </p>
<p>看到里面的nginx目录了吗，<strong>OpenResty就是在Nginx基础上集成了一些Lua模块</strong>。</p>
<p><strong>4）配置nginx的环境变量</strong></p>
<p>打开配置文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br></pre></td></tr></table></figure>

<p>在最下面加入两行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> NGINX_HOME=/usr/<span class="built_in">local</span>/openresty/nginx</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;NGINX_HOME&#125;</span>/sbin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p>NGINX_HOME：后面是OpenResty安装目录下的nginx的目录</p>
<p>然后让配置生效：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>



<h2 id="3-3-Lua语言"><a href="#3-3-Lua语言" class="headerlink" title="3.3.Lua语言"></a>3.3.Lua语言</h2><p>OpenResty的开发和使用离不开Lua脚本，那么Lua又是什么呢？</p>
<h3 id="3-3-1-Lua介绍"><a href="#3-3-1-Lua介绍" class="headerlink" title="3.3.1.Lua介绍"></a>3.3.1.Lua介绍</h3><p><strong>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放</strong>， 其设计目的是<strong>为了嵌入应用程序中</strong>，从而为应用程序提供灵活的扩展和定制功能。</p>
<p>Lua 是巴西里约热内卢天主教大学（Pontifical Catholic University of Rio de Janeiro）里的一个研究小组于 1993 年开发的，该小组成员有：Roberto Ierusalimschy、Waldemar Celes 和 Luiz Henrique de Figueiredo。</p>
<h3 id="3-3-2-语法入门"><a href="#3-3-2-语法入门" class="headerlink" title="3.3.2.语法入门"></a>3.3.2.语法入门</h3><p>Lua的详细语法大家可以参考网站上的一些教学，例如：<a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-tutorial.html">Lua菜鸟教程</a>，任何语言都是从基本的如：变量、数据类型、循环、逻辑判断、运算、数组等入手。相信熟悉java的你应该可以快速上手Lua。</p>
<p>因此我们从这几块入手，看一些简单命令即可：</p>
<p>1）变量声明</p>
<p>声明一个局部变量，用local关键字即可：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 定义数字</span></span><br><span class="line"><span class="keyword">local</span> a = <span class="number">123</span></span><br><span class="line"><span class="comment">-- 定义字符串</span></span><br><span class="line"><span class="keyword">local</span> b = <span class="string">&quot;hello world&quot;</span></span><br><span class="line"><span class="comment">-- 定义数组</span></span><br><span class="line"><span class="keyword">local</span> c = &#123;<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>, <span class="string">&quot;lua&quot;</span>&#125;</span><br><span class="line"><span class="comment">-- 定义table</span></span><br><span class="line"><span class="keyword">local</span> d = &#123;</span><br><span class="line">    name = <span class="string">&quot;jack&quot;</span>,</span><br><span class="line">    age = <span class="number">21</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）打印结果</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;hello world&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>3）条件控制</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( 布尔表达式 <span class="number">1</span>)</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ 在布尔表达式 1 为 true 时执行该语句块 --]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elseif</span>( 布尔表达式 <span class="number">2</span>)</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ 在布尔表达式 2 为 true 时执行该语句块 --]</span></span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">   <span class="comment">--[ 如果以上布尔表达式都不为 true 则执行该语句块 --]</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>4）循环语句：</p>
<p>遍历数字</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i=<span class="number">0</span>, <span class="number">10</span>, <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>遍历数组：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--打印数组a的所有值  </span></span><br><span class="line"><span class="keyword">local</span> a = &#123;<span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>, <span class="string">&quot;three&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i, v)</span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"><span class="comment">-- 遍历时，i是角标，v是元素。Lua中数组角标从1开始</span></span><br></pre></td></tr></table></figure>

<p>遍历table：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 定义table</span></span><br><span class="line"><span class="keyword">local</span> b = &#123;</span><br><span class="line">    name = <span class="string">&quot;jack&quot;</span>,</span><br><span class="line">    age = <span class="number">21</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(b) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k, v)</span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"><span class="comment">-- 遍历时，k是key，v是值。</span></span><br></pre></td></tr></table></figure>



<h2 id="3-4-OpenResty快速入门"><a href="#3-4-OpenResty快速入门" class="headerlink" title="3.4.OpenResty快速入门"></a>3.4.OpenResty快速入门</h2><p>为了不影响OpenResty安装目录的结构，我们在新的目录中来启动和配置。（本来应该是在nginx安装目录下的conf目录下的配置文件进行配置的）</p>
<h3 id="3-4-1-基本配置"><a href="#3-4-1-基本配置" class="headerlink" title="3.4.1.基本配置"></a>3.4.1.基本配置</h3><p>我们创建一个新的目录：/usr/resty</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr</span><br><span class="line">mkdir resty</span><br></pre></td></tr></table></figure>

<p>然后在这个目录下创建几个新目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> resty</span><br><span class="line">mkdir conf logs lua</span><br></pre></td></tr></table></figure>



<p>然后新建一个配置文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/resty</span><br><span class="line">vi conf/nginx.conf</span><br></pre></td></tr></table></figure>

<p>添加下面的内容：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="attribute">error_log</span> logs/error.log;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">lua_package_path</span> <span class="string">&quot;/usr/local/openresty/lualib/?.lua;;&quot;</span>;  <span class="comment">#lua 模块  </span></span><br><span class="line">    <span class="attribute">lua_package_cpath</span> <span class="string">&quot;/usr/local/openresty/lualib/?.so;;&quot;</span>;  <span class="comment">#c模块 </span></span><br><span class="line">	<span class="attribute">lua_shared_dict</span> item_local_cache <span class="number">50m</span>; <span class="comment">#共享全局变量，在所有worker间共享</span></span><br><span class="line">	</span><br><span class="line">    <span class="attribute">default_type</span>  text/html; <span class="comment"># 默认响应类型是html</span></span><br><span class="line">    <span class="attribute">charset</span> utf-<span class="number">8</span>;	<span class="comment"># 解决ngx.say 返回中文乱码问题！</span></span><br><span class="line">    <span class="attribute">include</span> lua.conf;    <span class="comment"># 引入一个lua.conf文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们<strong>通过include导入另一个配置，不在nginx.conf中写入太多内容</strong>。</p>
<h3 id="3-4-2-监听端口"><a href="#3-4-2-监听端口" class="headerlink" title="3.4.2.监听端口"></a>3.4.2.监听端口</h3><p>现在，<code>lua.conf</code>已经被引入，我们的所有配置都写到这个里面。</p>
<p>新建一个文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/resty</span><br><span class="line">vi conf/lua.conf</span><br></pre></td></tr></table></figure>

<p>添加下面的内容：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="comment"># 响应数据由 lua/test.lua这个文件来指定</span></span><br><span class="line">        <span class="attribute">content_by_lua_file</span> lua/test.lua;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-4-3第一个lua脚本"><a href="#3-4-3第一个lua脚本" class="headerlink" title="3.4.3第一个lua脚本"></a>3.4.3第一个lua脚本</h3><p>现在，响应数据已经交给 <code>lua/test.lua</code>来处理了，我们编写<code>lua/test.lua</code>文件，返回你想返回的任何内容即可。</p>
<p>新建一个文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/resty</span><br><span class="line">vi lua/test.lua</span><br></pre></td></tr></table></figure>

<p>写入下面内容：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx.say(<span class="string">&quot;&lt;h1&gt;hello, &lt;/h1&gt;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><code>ngx.say()</code>可以理解成<code>HttpServletResponse</code>中的<code>response.getWriter().println()</code></p>
<h3 id="3-4-4-启动并访问"><a href="#3-4-4-启动并访问" class="headerlink" title="3.4.4.启动并访问"></a>3.4.4.启动并访问</h3><p>当前必须在<code>/usr/resty</code>目录中，然后执行命令</p>
<p>运行启动命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -p `<span class="built_in">pwd</span>` -c conf/nginx.conf</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-p `pwd` </code>：-p 指定运行时路径前缀，pwd代表当前路径</li>
<li><code>-c conf/nginx.conf</code>：-c 指定运行时配置文件，这里指定了<code>conf/nginx.conf</code></li>
</ul>
<p>重新加载配置命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -p `<span class="built_in">pwd</span>` -c conf/nginx.conf -s reload</span><br></pre></td></tr></table></figure>

<p>停止命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -p `<span class="built_in">pwd</span>` -c conf/nginx.conf -s stop</span><br></pre></td></tr></table></figure>

<p>注意，在编写conf或者lua文件时，<strong>如果直接赋值过去vim打开的文件，可能会缺少个别字符，要仔细检查哦</strong>！还有还有还有还有，pwd 左右要有两个符号`</p>
<p>访问你的虚拟机地址（或者云服务地址），例如：<a target="_blank" rel="noopener" href="http://192.168.206.99/">http://192.168.206.99/</a> ，（默认80端口了）看到这个说明成功了：</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200724220724841.png" alt="image-20200724220724841"></p>
<h2 id="3-5-获取请求参数"><a href="#3-5-获取请求参数" class="headerlink" title="3.5.获取请求参数"></a>3.5.获取请求参数</h2><p>Nginx接收到请求后，会帮我们解析并存储到内置变量中，只需要调用这些变量或方法就可以拿到。</p>
<ul>
<li><p><code>ngx.var</code> ： nginx变量，如果要赋值如ngx.var.b = 2，此变量必须提前声明；另外对于nginx location中使用正则捕获的捕获组可以使用ngx.var[捕获组数字]获取；</p>
</li>
<li><p><code>ngx.req.get_headers()</code>：获取请求头，获取带中划线的请求头时请使用如headers.user_agent这种方式；如果一个请求头有多个值，则返回的是table；</p>
</li>
<li><p><code>ngx.req.get_uri_args()</code>：获取url请求参数，其用法和<code>get_headers</code>类似；?name=jack</p>
</li>
<li><p><code>ngx.req.get_post_args()</code>：获取post请求内容体，其用法和<code>get_headers</code>类似，但是必须提前调用<code>ngx.req.read_body()</code>来读取body体（也可以选择在nginx配置文件使用<code>lua_need_request_body</code> on;开启读取body体，但是官方不推荐）；</p>
</li>
<li><p><code>ngx.req.get_body_data()</code>：为解析的请求body体内容字符串。</p>
</li>
</ul>
<h3 id="3-5-1-编写映射规则"><a href="#3-5-1-编写映射规则" class="headerlink" title="3.5.1.编写映射规则"></a>3.5.1.编写映射规则</h3><p>现在，我们在lua.conf中编写一条规则，来监听请求：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 采用正则表达式映射路径，有两个(\d+)，分别是第1组、第2组正则</span></span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~ /lua_request/(\d+)/(\d+)</span> &#123;  </span><br><span class="line">    <span class="comment"># $1代表获取第1组正则捕获的内容，set $a $1代表把$1的值赋值给$a这个变量</span></span><br><span class="line">    <span class="attribute">set</span> $a <span class="variable">$1</span>;</span><br><span class="line">    <span class="comment"># $2代表获取第2组正则捕获的内容，set $b $2代表把$2的值赋值给$b这个变量</span></span><br><span class="line">    <span class="attribute">set</span> $b <span class="variable">$2</span>; </span><br><span class="line">    <span class="comment">#nginx内容处理  </span></span><br><span class="line">    <span class="attribute">content_by_lua_file</span> lua/test_request.lua;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-5-2-编写脚本"><a href="#3-5-2-编写脚本" class="headerlink" title="3.5.2.编写脚本"></a>3.5.2.编写脚本</h3><p>然后在新建test_request.lua文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/resty</span><br><span class="line">vi lua/test_request.lua</span><br></pre></td></tr></table></figure>

<p>添加内容：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 定义一个函数，打印table数据,,-- 获取路径占位符中通过正则得到的参数,,-- 获取请求url参数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayTables</span><span class="params">(val)</span></span></span><br><span class="line">	<span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(val) <span class="keyword">do</span></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">type</span>(v) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">			ngx.say(k, <span class="string">&quot; : &quot;</span>, <span class="built_in">table</span>.<span class="built_in">concat</span>(v, <span class="string">&quot;, &quot;</span>), <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			ngx.say(k, <span class="string">&quot; : &quot;</span>, v, <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">ngx.say(<span class="string">&#x27;&lt;header&gt;&#x27;</span>)</span><br><span class="line">ngx.say(<span class="string">&#x27;&lt;meta charset=&quot;utf-8&quot;&gt;&#x27;</span>)</span><br><span class="line">ngx.say(<span class="string">&#x27;&lt;/header&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;&lt;h1&gt; -----请求路径占位符参数------- &lt;/h1&gt;&quot;</span>);</span><br><span class="line">ngx.say(<span class="string">&quot;&lt;h4&gt;&quot;</span>)</span><br><span class="line">ngx.say(<span class="string">&quot;ngx.var.a : &quot;</span>, ngx.var.a, <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br><span class="line">ngx.say(<span class="string">&quot;ngx.var.b : &quot;</span>, ngx.var.b, <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br><span class="line">ngx.say(<span class="string">&quot;ngx.var[1] : &quot;</span>, ngx.var[<span class="number">1</span>], <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br><span class="line">ngx.say(<span class="string">&quot;ngx.var[2] : &quot;</span>, ngx.var[<span class="number">2</span>], <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br><span class="line">ngx.say(<span class="string">&quot;&lt;/h4&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;&lt;h1&gt; -----请求url参数------- &lt;/h1&gt;&quot;</span>);</span><br><span class="line">ngx.say(<span class="string">&quot;&lt;h4&gt;&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> params = ngx.req.get_uri_args()</span><br><span class="line">sayTables(params)</span><br><span class="line">ngx.say(<span class="string">&quot;&lt;/h4&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ngx.<span class="built_in">exit</span>(<span class="number">200</span>) </span><br></pre></td></tr></table></figure>



<h3 id="3-5-3-重启测试"><a href="#3-5-3-重启测试" class="headerlink" title="3.5.3.重启测试"></a>3.5.3.重启测试</h3><p>重启：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -p `<span class="built_in">pwd</span>` -c conf/nginx.conf -s reload</span><br></pre></td></tr></table></figure>

<p>通过浏览器访问：</p>
<p><a target="_blank" rel="noopener" href="http://192.168.206.99/lua_request/110/120?name=jack&amp;age=22">http://192.168.206.99/lua_request/110/120?name=jack&amp;age=22</a></p>
<p>结果：</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200724221338944.png" alt="image-20200724221338944"></p>
<h2 id="3-6-OpenResty模板渲染模块"><a href="#3-6-OpenResty模板渲染模块" class="headerlink" title="3.6.OpenResty模板渲染模块"></a>3.6.OpenResty模板渲染模块</h2><p>动态web网页开发是Web开发中一个常见的场景，我们的商品详情页就需要nginx来完成页面的动态渲染，这要用到模板渲染模块。</p>
<p>我们会使用<a target="_blank" rel="noopener" href="https://github.com/bungle/lua-resty-template">lua-resty-template</a>来完成。</p>
<h3 id="3-6-1-安装模板渲染模块"><a href="#3-6-1-安装模板渲染模块" class="headerlink" title="3.6.1.安装模板渲染模块"></a>3.6.1.安装模板渲染模块</h3><p><strong>模板渲染组件并不是OpenResty自带的，需要我们自己来安装</strong>。</p>
<p>确保自己已经安装过OPM命令（参考安装OpenResty部分）。</p>
<p>输入命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opm get bungle/lua-resty-template</span><br></pre></td></tr></table></figure>



<h3 id="3-6-2-定义模板位置"><a href="#3-6-2-定义模板位置" class="headerlink" title="3.6.2.定义模板位置"></a>3.6.2.定义模板位置</h3><p>模板渲染与服务端的JSP类似，需要知道的信息包括：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">1-</span> <span class="string">模板文件的位置</span></span><br><span class="line"><span class="meta">2-</span> <span class="string">模板中的数据（上下文Context）</span></span><br></pre></td></tr></table></figure>

<p>我们先在<code>lua.conf</code>文件的server部分，定义全局的模板文件位置信息：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">set</span> $template_root <span class="string">&quot;/usr/resty/templates&quot;</span>; </span><br></pre></td></tr></table></figure>

<p>如图：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200311121942817.png" alt="image-20200311121942817"></p>
<p>然后需要在<code>/usr/resty</code>目录下创建<code>templates</code>目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/resty</span><br><span class="line">mkdir templates</span><br></pre></td></tr></table></figure>



<h3 id="3-6-3-模板渲染"><a href="#3-6-3-模板渲染" class="headerlink" title="3.6.3.模板渲染"></a>3.6.3.模板渲染</h3><p>在<code>/usr/resty/conf/lua.conf</code>中定义一个location映射：</p>
<p>注意是在server的{}里面添加下面代码！</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ /lua_template/(.*)</span> &#123;</span><br><span class="line">    <span class="comment"># 关闭lua代码缓存</span></span><br><span class="line">    <span class="attribute">lua_code_cache</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="comment"># 指定请求交给lua/test_template.lua脚本来处理</span></span><br><span class="line">    <span class="attribute">content_by_lua_file</span> lua/test_template.lua;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建<code>test_template.lua</code>文件，编写脚本：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/resty</span><br><span class="line">vi lua/test_template.lua</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 导入template模块,类似java导包</span></span><br><span class="line"><span class="keyword">local</span> template = <span class="built_in">require</span>(<span class="string">&quot;resty.template&quot;</span>)  </span><br><span class="line"><span class="comment">--渲染模板需要的上下文(数据)  </span></span><br><span class="line"><span class="keyword">local</span> context = &#123;</span><br><span class="line">    title = <span class="string">&quot;template test&quot;</span>, </span><br><span class="line">    msg = <span class="string">&quot;&lt;h1&gt;hello,&quot;</span>..ngx.var[<span class="number">1</span>]..<span class="string">&quot;&lt;/h1&gt;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">--渲染模板 ，指定模板文件名称，指定所需要的数据，table格式</span></span><br><span class="line">template.render(<span class="string">&quot;t1.html&quot;</span>, context)  </span><br></pre></td></tr></table></figure>

<p>在<code>/usr/resty/templates</code>下新建模板文件：<code>t1.html</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/resty/templates/t1.html</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;&#123;title&#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;msg&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;*msg*&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="3-6-4-测试"><a href="#3-6-4-测试" class="headerlink" title="3.6.4.测试"></a>3.6.4.测试</h3><p>重启：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -p `<span class="built_in">pwd</span>` -c conf/nginx.conf -s reload</span><br></pre></td></tr></table></figure>

<p>通过浏览器访问：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.206.99/lua_template/社会我拓哥</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200724221823448.png" alt="image-20200724221823448">  </p>
<p><strong>OpenResty 渲染模板的方法总结：</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">启动nginx，监听80端口，然后由一个路径定向到本地的某个文件夹下的lua文件，</span></span><br><span class="line"><span class="attr">lua文件处理数据然后转到html模板文件，将数据进行渲染，然后返回！</span></span><br></pre></td></tr></table></figure>



<h2 id="3-7-OpenResty的Redis模块"><a href="#3-7-OpenResty的Redis模块" class="headerlink" title="3.7.OpenResty的Redis模块"></a>3.7.OpenResty的Redis模块</h2><p><strong>渲染页面时，需要的数据要从redis中获取，而OpenResty中整合了操作Redis的模块</strong>，可以直接使用。</p>
<p>前置条件：你的Linux上已经安装了Redis</p>
<p>如果你的redis装在windows，关闭windows防火墙，知道window的ip地址</p>
<h3 id="3-7-1-定义映射规则"><a href="#3-7-1-定义映射规则" class="headerlink" title="3.7.1.定义映射规则"></a>3.7.1.定义映射规则</h3><p>现在，我们在<code>lua.conf</code>中编写一条规则，来监听请求：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ /lua_redis/(.*)</span> &#123;</span><br><span class="line">    <span class="comment"># 关闭lua代码缓存</span></span><br><span class="line">	<span class="attribute">lua_code_cache</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="comment"># 指定请求交给lua/test_template.lua脚本来处理</span></span><br><span class="line">    <span class="attribute">content_by_lua_file</span> lua/test_redis.lua;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-7-2-使用Redis模块功能"><a href="#3-7-2-使用Redis模块功能" class="headerlink" title="3.7.2.使用Redis模块功能"></a>3.7.2.使用Redis模块功能</h3><p>然后在<code>lua</code>目录下创建文件：<code>test_redis.lua</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/resty/lua/test_redis.lua</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 导入redis模块</span></span><br><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span>(<span class="string">&quot;resty.redis&quot;</span>)</span><br><span class="line"><span class="comment">-- 定义释放redis连接的方法</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">close_redis</span><span class="params">(red)</span></span>  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> red <span class="keyword">then</span>  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="keyword">local</span> ok, err = red:<span class="built_in">close</span>()  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">        ngx.say(<span class="string">&quot;close redis error : &quot;</span>, err)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span>   </span><br><span class="line"></span><br><span class="line"><span class="comment">--创建实例  </span></span><br><span class="line"><span class="keyword">local</span> red = redis:new()  </span><br><span class="line"><span class="comment">--设置超时（毫秒）  </span></span><br><span class="line">red:set_timeout(<span class="number">1000</span>)  </span><br><span class="line"><span class="comment">--建立连接 ,这里要指定redis的安装的ip和端口</span></span><br><span class="line"><span class="keyword">local</span> ip = <span class="string">&quot;127.0.0.1&quot;</span>  </span><br><span class="line"><span class="keyword">local</span> port = <span class="number">6379</span>  </span><br><span class="line"><span class="keyword">local</span> ok, err = red:connect(ip, port)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;connect to redis error : &quot;</span>, err)  </span><br><span class="line">    <span class="keyword">return</span> close_redis(red)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">--调用API进行处理  </span></span><br><span class="line">ok, err = red:set(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;hello,&quot;</span>..ngx.var[<span class="number">1</span>])  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;set msg error : &quot;</span>, err)  </span><br><span class="line">    <span class="keyword">return</span> close_redis(red)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">--调用API获取数据  </span></span><br><span class="line"><span class="keyword">local</span> resp, err = red:get(<span class="string">&quot;msg&quot;</span>)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;get msg error : &quot;</span>, err)  </span><br><span class="line">    <span class="keyword">return</span> close_redis(red)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="comment">--得到的数据为空处理  </span></span><br><span class="line"><span class="keyword">if</span> resp == ngx.null <span class="keyword">then</span>  </span><br><span class="line">    resp = <span class="string">&#x27;default&#x27;</span>  <span class="comment">--比如默认值  </span></span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">ngx.say(<span class="string">&quot;msg : &quot;</span>, resp)  </span><br><span class="line">  </span><br><span class="line">close_redis(red)  </span><br></pre></td></tr></table></figure>



<h3 id="3-7-3-测试"><a href="#3-7-3-测试" class="headerlink" title="3.7.3.测试"></a>3.7.3.测试</h3><p>重启：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -p `<span class="built_in">pwd</span>` -c conf/nginx.conf -s reload</span><br></pre></td></tr></table></figure>

<p>通过浏览器访问：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.206.99/lua_redis/jack</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200724222028688.png" alt="image-20200724222028688"></p>
<h2 id="3-8-OpenResty-内部-请求代理"><a href="#3-8-OpenResty-内部-请求代理" class="headerlink" title="3.8.OpenResty  内部  请求代理"></a>3.8.OpenResty  内部  请求代理</h2><p>按照之前分析的实现原理，获取页面渲染数据时，我们先从redis拿，如果<strong>获取失败则请求tomcat，也就是之前我们准备的<code>ly-page</code>服务</strong>。</p>
<p>先来个小结：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">至此，浏览器发送请求，到达了windows的nginx，然后进行反向代理，</span></span><br><span class="line"><span class="attr">到第三方的openresty（安装在linux上）进行页面渲染</span></span><br><span class="line"><span class="attr">进行渲染前要先获取数据，要么从linux上的redis获取，这由上面的lua脚本语言可以实现。</span></span><br><span class="line"><span class="attr">但是当redis没有对应的缓存数据时，openresty需要从windows上的Tomcat服务器获取数据，这可如何是好？？？？</span></span><br></pre></td></tr></table></figure>

<p>那么<strong>如何在OpenResty内部主动发送一个http请求呢？</strong></p>
<h3 id="3-8-1-两种实现方案"><a href="#3-8-1-两种实现方案" class="headerlink" title="3.8.1.两种实现方案"></a>3.8.1.两种实现方案</h3><p>在OpenResty中有两种主动发送http请求的方案：</p>
<ul>
<li>1 利用http模块：利用第三方提供的http模块工具，模拟一个http请求</li>
<li>2 利用内部请求代理：利用nginx自带的capture功能</li>
</ul>
<p>这里我们使用nginx的capture功能，也就是<strong>内部请求代理</strong></p>
<h3 id="3-8-2-内部请求代理"><a href="#3-8-2-内部请求代理" class="headerlink" title="3.8.2.内部请求代理"></a>3.8.2.内部请求代理</h3><p>nginx的capture功能语法如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> resp = ngx.location.capture(<span class="string">&quot;/path&quot;</span>,&#123;</span><br><span class="line">    method = ngx.HTTP_GET,   #请求方式</span><br><span class="line">    args = &#123;a=<span class="number">1</span>,b=<span class="number">2</span>&#125;,  #get方式传参数</span><br><span class="line">    body = <span class="string">&quot;c=3&amp;d=4&quot;</span> #post方式传参数</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>返回的响应内容包括：</p>
<ul>
<li>resp.status：响应状态码</li>
<li>resp.header：响应头，是一个table</li>
<li>resp.body：响应体，就是响应数据</li>
</ul>
<p>不过，capture功能发起的请求<strong>只能指向nginx的内部，不能访问外部请求</strong>（例如百度）。该怎么解决？</p>
<p>我们可以<strong>将capture请求的地址指向一个内部的location，然后在这个location中做反向代理，指向目标地址</strong>（外部网站地址）。</p>
<h3 id="3-8-3-示例"><a href="#3-8-3-示例" class="headerlink" title="3.8.3.示例"></a>3.8.3.示例</h3><p>假设我们希望在nginx内部向百度发请求，然后把结果输出到页面，大概思路是这样的：</p>
<ul>
<li>利用capture向某个路径发请求，指向内部的一个location，比如 <code>/baidu</code></li>
<li>定义个location，接收 <code>/baidu</code>开头的请求</li>
<li>将请求反向代理到 <a target="_blank" rel="noopener" href="https://www.baidu.com/">https://www.baidu.com</a></li>
</ul>
<p>1）定义location</p>
<p>我们先在<code>/usr/resty/conf/lua.conf</code>中定义一个location映射，用来处理内部请求，然后反向代理到百度。修改lua.conf文件，添加内容：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ /baidu/(.*)</span> &#123;</span><br><span class="line">    <span class="comment"># 重写路径，去掉路径前面的 /baidu</span></span><br><span class="line">    <span class="attribute">rewrite</span> /baidu(/.*) <span class="variable">$1</span> <span class="literal">break</span>;</span><br><span class="line">    <span class="comment"># 禁止响应体压缩</span></span><br><span class="line">    <span class="attribute">proxy_set_header</span> Accept-Encoding <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="comment"># 反向代理到百度</span></span><br><span class="line">    <span class="attribute">proxy_pass</span> https://www.baidu.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）内部代理</p>
<p>然后我们再次修改lua.conf，添加一个location，作为测试接口：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ /lua_http/(.*)</span> &#123;</span><br><span class="line">    <span class="comment"># 关闭lua代码缓存</span></span><br><span class="line">    <span class="attribute">lua_code_cache</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="comment"># 指定请求交给lua/test_http.lua脚本来处理</span></span><br><span class="line">    <span class="attribute">content_by_lua_file</span> lua/test_http.lua;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里接收请求，并执行<code>lua/test_http.lua</code>这个文件。我们新建一个<code>lua/test_http.lua</code>文件，内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 向 /baidu 这个location发请求，并且携带请求参数</span></span><br><span class="line"><span class="keyword">local</span> resp = ngx.location.capture(<span class="string">&quot;/baidu/s?wd=&quot;</span>..ngx.var[<span class="number">1</span>], &#123;  </span><br><span class="line">	method = ngx.HTTP_GET</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询失败的处理</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span></span><br><span class="line">	ngx.say(<span class="string">&quot;request error&quot;</span>); </span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"><span class="comment">-- 查询成功的处理，这里是打印响应体</span></span><br><span class="line">ngx.say(resp.body)</span><br></pre></td></tr></table></figure>

<p>3）测试</p>
<p>打开浏览器，访问：<a target="_blank" rel="noopener" href="http://192.168.206.99/lua_http/hello">http://192.168.206.99/lua_http/hello</a> ，可以看到内容：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200724222759304.png" alt="image-20200724222759304"></p>
<p>lua_http  测试小结：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1</span> <span class="string">请求到centos系统时（端口80），nginx监听后，根据location定位到test_http.lua 文件</span></span><br><span class="line"><span class="attr">2</span> <span class="string">test_http.lua文件中使用capture功能，去nginx.conf 文件中找对应的location</span></span><br><span class="line"><span class="attr">3</span> <span class="string">找到location之后，去掉location前缀并且代理到http://www.baidu.com/+拼接url </span></span><br></pre></td></tr></table></figure>



<p>承接上面的小结：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">至此，我们想要实现的步骤：浏览器发送请求，到达了windows的nginx，</span></span><br><span class="line"><span class="attr">然后转到第三方的openresty（安装在linux上）进行页面渲染（上图是直接访问linux的openresty了）</span></span><br><span class="line"><span class="attr">进行渲染前要先获取数据，要么从linux上的redis获取，这由上面的lua脚本语言可以实现。</span></span><br><span class="line"><span class="attr">但是当redis没有对应的缓存数据时，openresty需要从windows上的Tomcat服务器获取数据，这可如何是好？？？？</span></span><br><span class="line"></span><br><span class="line"><span class="attr">使用nginx自带的capture功能来实现。</span></span><br><span class="line"><span class="attr">当请求达到openresty时，匹配lua_http路径，到达指定的test_http.lua文件，</span></span><br><span class="line"><span class="attr">在test_http.lua文件中利用capture指向一个nginx.conf内部的location，</span></span><br><span class="line"><span class="attr">然后反向代理到百度网址，百度网址拼接上子路径以及参数作为完整的url去访问百度！！</span></span><br></pre></td></tr></table></figure>



<h2 id="3-8-实现商品详情页渲染"><a href="#3-8-实现商品详情页渲染" class="headerlink" title="3.8.实现商品详情页渲染"></a>3.8.实现商品详情页渲染</h2><p>接下来我们利用OpenResty实现商品详情页渲染，大概需要这样的步骤：</p>
<ul>
<li>监听用户请求，进入定义好的lua脚本</li>
<li>lua脚本中尝试读取redis数据</li>
<li>读取数据失败，尝试从<code>ly-page</code>微服务读取数据<ul>
<li>获取数据失败：返回404</li>
<li>获取数据成功：开始渲染</li>
</ul>
</li>
<li>把数据和模板交给template模块渲染，然后返回</li>
</ul>
<p>我们要做的事情包括：</p>
<ul>
<li><p>配置内部请求代理</p>
</li>
<li><p>定义通用工具模块：</p>
<ul>
<li>访问Redis的工具</li>
<li>访问<code>ly-page</code>的http工具</li>
</ul>
</li>
<li><p>定义商品详情页面模板</p>
</li>
<li><p>编写商品页面请求的路径映射</p>
</li>
<li><p>编写处理请求，查询数据，处理数据，渲染模板的lua脚本</p>
</li>
</ul>
<h3 id="3-8-1-内部请求代理配置"><a href="#3-8-1-内部请求代理配置" class="headerlink" title="3.8.1.内部请求代理配置"></a>3.8.1.内部请求代理配置</h3><p>我们计划采用内部请求代理实现对微服务的访问，因此需要定义一个location，拦截内部请求，转发到<code>ly-page</code>微服务。这里我们约定，这个内部的location地址为：<code>/backend/*</code></p>
<p>为了与之前的demo分离，我们修改<code>nginx.conf</code>，注释以前的<code>lua.conf</code>文件，并添加一个新的<code>leyou.conf</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/resty/conf/nginx.conf</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="attribute">error_log</span> logs/error.log;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">http</span> &#123; </span><br><span class="line">    <span class="attribute">lua_package_path</span> <span class="string">&quot;/usr/local/openresty/lualib/?.lua;;&quot;</span>;  <span class="comment">#lua 模块  </span></span><br><span class="line">    <span class="attribute">lua_package_cpath</span> <span class="string">&quot;/usr/local/openresty/lualib/?.so;;&quot;</span>;  <span class="comment">#c模块 </span></span><br><span class="line">	<span class="attribute">lua_shared_dict</span> shared_data <span class="number">20m</span>; <span class="comment">#共享全局变量，在所有worker间共享</span></span><br><span class="line">	</span><br><span class="line">    <span class="attribute">default_type</span>  text/html; <span class="comment"># 默认响应类型是html</span></span><br><span class="line">    <span class="comment">#include lua.conf;    # 引入一个lua.conf文件</span></span><br><span class="line">    <span class="attribute">include</span> leyou.conf;    <span class="comment"># 引入一个leyou.conf文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在<code>/usr/resty/conf/leyou.conf</code>中编写location监听：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/resty/conf/leyou.conf</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> backend &#123;  </span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8084</span> max_fails=<span class="number">5</span> fail_timeout=<span class="number">10s</span> weight=<span class="number">1</span>;    </span><br><span class="line">    <span class="attribute">keepalive</span> <span class="number">100</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="section">server</span> &#123;  </span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>; </span><br><span class="line">	<span class="attribute">set</span> $template_root <span class="string">&quot;/usr/resty/templates&quot;</span>; </span><br><span class="line">  	<span class="comment"># 我们要求内部请求以 /backend开头，与其他请求区分</span></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ /backend/(.*)</span> &#123;  </span><br><span class="line">        <span class="comment">#internal;  </span></span><br><span class="line">        <span class="attribute">keepalive_timeout</span>   <span class="number">30s</span>;  </span><br><span class="line">        <span class="attribute">keepalive_requests</span>  <span class="number">1000</span>;  </span><br><span class="line">        <span class="comment">#支持keep-alive  </span></span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;  </span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="attribute">rewrite</span> /backend(/.*) <span class="variable">$1</span> <span class="literal">break</span>;  </span><br><span class="line">        <span class="attribute">proxy_pass_request_headers</span> <span class="literal">off</span>;  </span><br><span class="line">        <span class="comment">#more_clear_input_headers Accept-Encoding;  </span></span><br><span class="line">        <span class="attribute">proxy_next_upstream</span> <span class="literal">error</span> timeout;  </span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，上面配置的backend集群中，ip地址必须是你<strong>自己的宿主机地址,VM-NET8的虚拟主机地址，一般地址为:网段.1</strong>，不要直接拷贝。<strong>（我使用的是云服务，因此得内网穿透）</strong></p>
<p>请求处理大概过程：</p>
<ul>
<li><p>假如我们内部访问：/backend/page/spu/1</p>
</li>
<li><p>地址被监听到后，会处理成：<a target="_blank" rel="noopener" href="http://backend/page/spu/1">http://backend/page/spu/1</a></p>
</li>
<li><p>而后进入 backend的upstream集群</p>
<ul>
<li>集群默认利用轮询策略对集群负载均衡，例如本例中的地址：192.168.206.99:8084</li>
<li>发送请求到：http//192.168.206.99:8084/page/spu/1，就是宿主机</li>
</ul>
</li>
<li><p>这样就被宿主机的<code>ly-page</code>微服务接收到了</p>
</li>
</ul>
<p>重启nginx：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -p `<span class="built_in">pwd</span>` -c conf/nginx.conf -s reload</span><br></pre></td></tr></table></figure>

<p>测试，在浏览器访问：<a target="_blank" rel="noopener" href="http://192.168.206.99/backend/page/spu/5">http://192.168.206.99/backend/page/spu/5</a></p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200724224019970.png" alt="image-20200724224019970"> </p>
<p><strong>注意注意注意：</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">要将六个API都测一遍哦，不要偷懒了！</span></span><br><span class="line"><span class="attr">注意注意：linux系统上有一个openresty，里面已经包含nginx了，这里要卸载原来的nginx哦。</span></span><br></pre></td></tr></table></figure>

<h3 id="3-8-2-编写通用工具模块"><a href="#3-8-2-编写通用工具模块" class="headerlink" title="3.8.2.编写通用工具模块"></a>3.8.2.编写通用工具模块</h3><p>接下来，编写一个通用的工具模块，方便后期连接Redis，查询tomcat</p>
<p>脚本要定义到<code>/usr/local/openresty/lualib</code>目录，因为这里的lua会被扫描到模块库，供其它脚本共享使用。</p>
<p>新建脚本文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/<span class="built_in">local</span>/openresty/lualib/common.lua</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 导入redis模块</span></span><br><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span>(<span class="string">&quot;resty.redis&quot;</span>)  </span><br><span class="line"><span class="comment">-- 日志</span></span><br><span class="line"><span class="keyword">local</span> ngx_log = ngx.<span class="built_in">log</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_ERR = ngx.ERR  </span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">close_redis</span><span class="params">(red)</span></span>  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> red <span class="keyword">then</span>  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="comment">--释放连接(连接池实现)  </span></span><br><span class="line">    <span class="keyword">local</span> pool_max_idle_time = <span class="number">10000</span> <span class="comment">--毫秒  </span></span><br><span class="line">    <span class="keyword">local</span> pool_size = <span class="number">100</span> <span class="comment">--连接池大小  </span></span><br><span class="line">    <span class="keyword">local</span> ok, err = red:set_keepalive(pool_max_idle_time, pool_size)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;set redis keepalive error : &quot;</span>, err)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="comment">-- 查询redis的方法 ip和port是redis地址，keys是查询的key，数组格式</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read_redis</span><span class="params">(ip, port, keys)</span></span>  </span><br><span class="line">	<span class="comment">-- 获取一个连接</span></span><br><span class="line">    <span class="keyword">local</span> red = redis:new()  </span><br><span class="line">    red:set_timeout(<span class="number">1000</span>)  </span><br><span class="line">    <span class="keyword">local</span> ok, err = red:connect(ip, port)  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;connect to redis error : &quot;</span>, err)  </span><br><span class="line">        <span class="keyword">return</span> close_redis(red)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="keyword">local</span> resp = <span class="literal">nil</span></span><br><span class="line">	<span class="comment">-- 判断key数量，如果多个key，就利用mget批量查询</span></span><br><span class="line">    <span class="keyword">if</span> #keys == <span class="number">1</span> <span class="keyword">then</span>  </span><br><span class="line">        resp, err = red:get(keys[<span class="number">1</span>])  </span><br><span class="line">    <span class="keyword">else</span>  </span><br><span class="line">        resp, err = red:mget(keys)  </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">	<span class="comment">-- 查询失败处理</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;get redis content error : &quot;</span>, err)  </span><br><span class="line">        <span class="keyword">return</span> close_redis(red)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">--得到的数据为空处理  </span></span><br><span class="line">    <span class="keyword">if</span> resp == ngx.null <span class="keyword">then</span>  </span><br><span class="line">        resp = <span class="literal">nil</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    close_redis(red)  </span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="comment">-- 查询http请求的方法，path是请求路径，args是参数，table格式</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read_http</span><span class="params">(path, args)</span></span> </span><br><span class="line">	<span class="comment">-- 默认查询地址走 /backend/page/,内部转发到8084端口</span></span><br><span class="line">    <span class="keyword">local</span> resp = ngx.location.capture(<span class="string">&quot;/backend/page&quot;</span>..<span class="built_in">path</span>, &#123;  </span><br><span class="line">        method = ngx.HTTP_GET,  </span><br><span class="line">        args = args  </span><br><span class="line">    &#125;)  </span><br><span class="line">	<span class="comment">-- 查询失败的处理</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;request error&quot;</span>)  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">	<span class="comment">-- 返回状态码不是200就报错</span></span><br><span class="line">    <span class="keyword">if</span> resp.<span class="built_in">status</span> ~= <span class="number">200</span> <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;request error, status :&quot;</span>, resp.<span class="built_in">status</span>)  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> resp.body  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="comment">-- 将方法导出</span></span><br><span class="line"><span class="keyword">local</span> _M = &#123;  </span><br><span class="line">    read_redis = read_redis,  </span><br><span class="line">    read_http = read_http  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">return</span> _M </span><br></pre></td></tr></table></figure>

<p>核心方法有两个：</p>
<ul>
<li><strong>read_redis</strong>(ip, port, keys)：查询redis数据，参数：<ul>
<li>ip：就是redis的ip地址</li>
<li>port：就是redis的端口</li>
<li>keys：查询用到的key，数组，可以同时查询多个</li>
</ul>
</li>
<li><strong>read_http</strong>(path, args)：http请求查询，内部会转发到<code>ly-page</code>参数：<ul>
<li>path：请求路径，方法内部会在path前拼接：/backend/page</li>
<li>args：请求参数，table类型</li>
</ul>
</li>
</ul>
<h3 id="3-8-3-页面模板"><a href="#3-8-3-页面模板" class="headerlink" title="3.8.3.页面模板"></a>3.8.3.页面模板</h3><p>我已经提前写好了一个页面模板，在课前资料中获取：item.html,<strong>上传item.html到 /usr/resty/templates</strong></p>
<p>其中需要的参数包括：</p>
<ul>
<li>spu：商品spu，需要的是spu中的name，分类id、品牌id</li>
<li>skuList：商品spu下的sku</li>
<li>spuDetail：商品详情</li>
<li>categories：商品分类</li>
<li>brand：品牌</li>
<li>specs：规格组包含规格参数</li>
</ul>
<h3 id="3-8-4-数据处理脚本"><a href="#3-8-4-数据处理脚本" class="headerlink" title="3.8.4.数据处理脚本"></a>3.8.4.数据处理脚本</h3><p>下面，我们编写数据处理的脚本。</p>
<p>新建脚本文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/resty/lua/item.lua</span><br></pre></td></tr></table></figure>

<p>内容：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 导入模块</span></span><br><span class="line"><span class="keyword">local</span> common = <span class="built_in">require</span>(<span class="string">&quot;common&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> read_redis = common.read_redis  </span><br><span class="line"><span class="keyword">local</span> read_http = common.read_http</span><br><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span>(<span class="string">&quot;cjson&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> template = <span class="built_in">require</span>(<span class="string">&quot;resty.template&quot;</span>)  </span><br><span class="line"><span class="comment">-- 常用变量和方法</span></span><br><span class="line"><span class="keyword">local</span> ngx_log = ngx.<span class="built_in">log</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_ERR = ngx.ERR  </span><br><span class="line"><span class="keyword">local</span> ngx_exit = ngx.<span class="built_in">exit</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_print = ngx.<span class="built_in">print</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_re_match = ngx.re.<span class="built_in">match</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取商品id</span></span><br><span class="line"><span class="keyword">local</span> spuId = ngx.var.spuId</span><br><span class="line"><span class="comment">-- 获取spu</span></span><br><span class="line"><span class="keyword">local</span> spuKey = <span class="string">&quot;page:spu:id:&quot;</span>..spuId </span><br><span class="line"><span class="keyword">local</span> spuInfoStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, &#123;spuKey&#125;)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> spuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found spu info, back to http, spuId : &quot;</span>, spuId)  </span><br><span class="line">   spuInfoStr = read_http(<span class="string">&quot;/spu/&quot;</span>..spuId, &#123;&#125;)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> spuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found spuInfoStr info, spuId : &quot;</span>, spuId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取sku</span></span><br><span class="line"><span class="keyword">local</span> skuKey = <span class="string">&quot;page:sku:id:&quot;</span>..spuId </span><br><span class="line"><span class="keyword">local</span> skuInfoStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, &#123;skuKey&#125;)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> skuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found sku info, back to http, spuId : &quot;</span>, spuId)  </span><br><span class="line">   skuInfoStr = read_http(<span class="string">&quot;/sku/&quot;</span>..spuId, &#123;&#125;)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> skuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found skuInfoStr info, spuId : &quot;</span>, spuId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取spuDetail</span></span><br><span class="line"><span class="keyword">local</span> detailKey = <span class="string">&quot;page:detail:id:&quot;</span>..spuId </span><br><span class="line"><span class="keyword">local</span> detailInfoStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, &#123;detailKey&#125;)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> detailInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found detail info, back to http, spuId : &quot;</span>, spuId)  </span><br><span class="line">   detailInfoStr = read_http(<span class="string">&quot;/detail/&quot;</span>..spuId, &#123;&#125;)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> detailInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found detailInfoStr info, spuId : &quot;</span>, spuId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取categories</span></span><br><span class="line"><span class="keyword">local</span> spuInfo = cjson.decode(spuInfoStr)  </span><br><span class="line"><span class="keyword">local</span> cid3 = spuInfo[<span class="string">&quot;categoryIds&quot;</span>][<span class="number">3</span>]</span><br><span class="line"><span class="keyword">local</span> categoryKey = <span class="string">&quot;page:category:id:&quot;</span>..cid3 </span><br><span class="line"><span class="keyword">local</span> categoryStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, &#123;categoryKey&#125;)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> categoryStr <span class="keyword">then</span>  </span><br><span class="line">   <span class="keyword">local</span> idStr = <span class="built_in">table</span>.<span class="built_in">concat</span>(spuInfo[<span class="string">&quot;categoryIds&quot;</span>],<span class="string">&quot;,&quot;</span>);</span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found category info, back to http, categoryIds : &quot;</span>, idStr)  </span><br><span class="line">   categoryStr = read_http(<span class="string">&quot;/categories/&quot;</span>, &#123;ids  = idStr&#125;)</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> categoryStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found categoryStr info, categoryId : &quot;</span>, cid3)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取品牌  </span></span><br><span class="line"><span class="keyword">local</span> brandId = spuInfo[<span class="string">&quot;brandId&quot;</span>]</span><br><span class="line"><span class="keyword">local</span> brandKey = <span class="string">&quot;page:brand:id:&quot;</span>..brandId </span><br><span class="line"><span class="keyword">local</span> brandStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, &#123;brandKey&#125;)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> brandStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found brand info, back to http, brandId : &quot;</span>, brandId)  </span><br><span class="line">   brandStr = read_http(<span class="string">&quot;/brand/&quot;</span>..brandId, &#123;&#125;)</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> brandStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found brandStr info, brandId : &quot;</span>, brandId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取规格</span></span><br><span class="line"><span class="keyword">local</span> specKey = <span class="string">&quot;page:spec:id:&quot;</span>..cid3 </span><br><span class="line"><span class="keyword">local</span> specStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, &#123;specKey&#125;)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> specStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found spec info, back to http, cid3 : &quot;</span>, cid3)  </span><br><span class="line">   specStr = read_http(<span class="string">&quot;/spec/&quot;</span>..cid3, &#123;&#125;)</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> specStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found specStr info, cid3 : &quot;</span>, cid3)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 组织数据</span></span><br><span class="line"><span class="keyword">local</span> context = &#123;</span><br><span class="line">	name = spuInfo[<span class="string">&quot;name&quot;</span>],</span><br><span class="line">	skuList =  skuInfoStr,</span><br><span class="line">	detail =  detailInfoStr,</span><br><span class="line">	categories =  categoryStr,</span><br><span class="line">	brand =  brandStr,</span><br><span class="line">	specs =  specStr</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">--渲染模板  ##########################################</span></span><br><span class="line">template.render(<span class="string">&quot;item.html&quot;</span>, context)</span><br></pre></td></tr></table></figure>



<h3 id="3-8-5-路径映射"><a href="#3-8-5-路径映射" class="headerlink" title="3.8.5.路径映射"></a>3.8.5.路径映射</h3><p>最后，我们监听页面请求，把商品页面交给模板来处理.</p>
<p>在<code>/usr/resty/conf/leyou.conf</code>中添加映射：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ /item/(\d+).html$</span> &#123;</span><br><span class="line">    <span class="comment"># 获取路径参数</span></span><br><span class="line">    <span class="attribute">set</span> $spuId <span class="variable">$1</span>;</span><br><span class="line">    <span class="comment"># 禁止除了www.leyou.com以外的请求访问</span></span><br><span class="line">    <span class="attribute">if</span> ($host !<span class="regexp">~ &quot;^www\.leyou\.com$&quot;)</span> &#123;  </span><br><span class="line">        <span class="attribute">return</span> <span class="number">403</span>;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 关闭缓存/打开缓存</span></span><br><span class="line">    <span class="attribute">lua_code_cache</span> <span class="literal">on</span>; </span><br><span class="line">    <span class="attribute">default_type</span> <span class="string">&#x27;text/html&#x27;</span>;  </span><br><span class="line">    <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line">    <span class="comment"># 指定请求交给lua/item.lua脚本来处理</span></span><br><span class="line">    <span class="attribute">content_by_lua_file</span> lua/item.lua;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-8-6-修改宿主机路径映射"><a href="#3-8-6-修改宿主机路径映射" class="headerlink" title="3.8.6.修改宿主机路径映射"></a>3.8.6.修改宿主机路径映射</h3><p>现在，OpenResty已经准备就绪，不过我们在浏览器中输入：</p>
<p><a target="_blank" rel="noopener" href="http://www.leyou.com/item/141.html">http://www.leyou.com/item/141.html</a></p>
<p>这个商品地址时，目前依然走的是<code>ly-portal</code>。我们需要把请求地址修改到你的虚拟机地址，例如我的地址是：<code>192.168.206.99</code></p>
<p>修改宿主机中的<code>leyou.conf</code>文件，修改原来的 <a href="http://www.leyou.com的域名解析部分：">www.leyou.com的域名解析部分：</a></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">	<span class="attribute">server_name</span>  www.leyou.com;</span><br><span class="line">	<span class="attribute">location</span> /item &#123;</span><br><span class="line">		<span class="comment"># 携带hosts地址，避免因代理导致host丢失</span></span><br><span class="line">		<span class="attribute">proxy_set_header</span> Host       $host;</span><br><span class="line">	    <span class="attribute">proxy_pass</span>   http://192.168.206.99;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="attribute">location</span> / &#123;</span><br><span class="line">	    <span class="attribute">root</span> C:\develop\idea-space\leyou3\leyou-portal;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>重启：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -p `<span class="built_in">pwd</span>` -c conf/nginx.conf -s reload</span><br></pre></td></tr></table></figure>

<p>通过浏览器访问：</p>
<p><a target="_blank" rel="noopener" href="http://www.leyou.com/item/127.html">http://www.leyou.com/item/127.html</a></p>
<p>结果：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200311202533350.png" alt="image-20200311202533350"></p>
<p>总结：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">请求url中的127.html</span> <span class="string">的127就是商品的spuid，</span></span><br><span class="line"><span class="attr">根据这个spuid可以得到spu，spudetail，skus，brand，category，spec六种数据</span></span><br><span class="line"><span class="attr">流程如下：</span></span><br><span class="line"><span class="attr">浏览器发起请求，请求先到达本地nginx，接着反向代理到centos的openresty，</span></span><br><span class="line"><span class="attr">通过openresty相关配置文件的location进行路径映射，交由指定的lua脚本文件执行</span></span><br><span class="line"></span><br><span class="line"><span class="attr">在lua脚本文件中，先尝试去centos的redis访问，访问到就先保存数据</span></span><br><span class="line"><span class="attr">访问不到就发送http请求，需要借助capture来将web请求路径转发到指定location，</span></span><br><span class="line"><span class="attr">再反向代理到page微服务，从而获取到上面说的六种数据</span></span><br><span class="line"><span class="attr">获取到的数据存放redis中，并组织六种数据，给openresty的模板页面item.html，</span></span><br><span class="line"><span class="attr">然后将渲染之后的页面返回给浏览器！</span></span><br></pre></td></tr></table></figure>



<h3 id="3-8-7-优化（理解即可）"><a href="#3-8-7-优化（理解即可）" class="headerlink" title="3.8.7.优化（理解即可）"></a>3.8.7.优化（理解即可）</h3><p>虽然已经实现了页面静态化，不过依然有值得优化的地方：</p>
<ul>
<li>在Nginx中设置本地缓存，把几乎不变的数据直接存储在nginx内部，例如：<ul>
<li>商品分类数据</li>
<li>品牌数据</li>
<li>规格参数数据</li>
</ul>
</li>
<li>在nginx中对生成的页面做缓存或静态化，做CDN服务，页面不变的时候，减少渲染对CPU的消耗</li>
<li>随着商品数据的日益增多，Redis可能难以支持海量商品信息，此时可以用SSDB来代替，SSDB存储基于磁盘存储，查询性能与Redis差不多，因此可以作为海量数据的缓存库</li>
</ul>
<p>参考：本地缓存的实现：</p>
<p>修改nginx.conf，配置本地缓存大小和名称：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="attribute">error_log</span> logs/error.log;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">	</span><br><span class="line">    <span class="attribute">lua_package_path</span> <span class="string">&quot;/usr/local/openresty/lualib/?.lua;;&quot;</span>;  <span class="comment">#lua 模块  </span></span><br><span class="line">    <span class="attribute">lua_package_cpath</span> <span class="string">&quot;/usr/local/openresty/lualib/?.so;;&quot;</span>;  <span class="comment">#c模块 </span></span><br><span class="line">    <span class="comment">#本地缓存，名称叫做：item_local_cache，大小50m</span></span><br><span class="line">	<span class="attribute">lua_shared_dict</span> item_local_cache <span class="number">50m</span>; </span><br><span class="line">	</span><br><span class="line">    <span class="attribute">default_type</span>  text/html; <span class="comment"># 默认响应类型是html</span></span><br><span class="line">    <span class="comment">#include lua.conf;    # 引入一个lua.conf文件</span></span><br><span class="line">    <span class="attribute">include</span> leyou.conf;    <span class="comment"># 引入一个leyou.conf文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改common.lua，添加数据查询方法：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 导入redis模块</span></span><br><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span>(<span class="string">&quot;resty.redis&quot;</span>) </span><br><span class="line"><span class="comment">-- 配置商品的本地缓存 </span></span><br><span class="line"><span class="keyword">local</span> local_cache = ngx.shared.item_local_cache</span><br><span class="line"><span class="comment">-- 日志</span></span><br><span class="line"><span class="keyword">local</span> ngx_log = ngx.<span class="built_in">log</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_ERR = ngx.ERR</span><br><span class="line"><span class="comment">-- 读取本地缓存</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">cache_get</span><span class="params">(key)</span></span>  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> local_cache <span class="keyword">then</span>  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="keyword">return</span> local_cache:get(key)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 写入本地缓存</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">cache_set</span><span class="params">(key, value)</span></span>  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> local_cache <span class="keyword">then</span>  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="keyword">return</span> local_cache:set(key, value, <span class="number">10</span> * <span class="number">60</span>) <span class="comment">--10分钟  </span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">close_redis</span><span class="params">(red)</span></span>  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> red <span class="keyword">then</span>  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="comment">--释放连接(连接池实现)  </span></span><br><span class="line">    <span class="keyword">local</span> pool_max_idle_time = <span class="number">10000</span> <span class="comment">--毫秒  </span></span><br><span class="line">    <span class="keyword">local</span> pool_size = <span class="number">100</span> <span class="comment">--连接池大小  </span></span><br><span class="line">    <span class="keyword">local</span> ok, err = red:set_keepalive(pool_max_idle_time, pool_size)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;set redis keepalive error : &quot;</span>, err)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="comment">-- 查询本地缓存，没有则查询redis, ip和port是redis地址，key是查询的key</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read_cache</span><span class="params">(ip, port, key)</span></span> </span><br><span class="line">	<span class="comment">-- 尝试读本地缓存</span></span><br><span class="line">	<span class="keyword">local</span> resp = cache_get(key)</span><br><span class="line">	<span class="comment">-- ngx_log(ngx_ERR, &quot;debug local cache data : &quot;, resp) </span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span></span><br><span class="line">		ngx_log(ngx_ERR, <span class="string">&quot;read local cache fail , key&quot;</span>, key)</span><br><span class="line">		<span class="comment">-- 获取一个redis连接</span></span><br><span class="line">		<span class="keyword">local</span> red = redis:new()  </span><br><span class="line">		red:set_timeout(<span class="number">1000</span>)  </span><br><span class="line">		<span class="keyword">local</span> ok, err = red:connect(ip, port)  </span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">			ngx_log(ngx_ERR, <span class="string">&quot;connect to redis error : &quot;</span>, err)  </span><br><span class="line">			<span class="keyword">return</span> close_redis(red)  </span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		<span class="comment">-- 利用get查询</span></span><br><span class="line">		resp, err = red:get(key) </span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="comment">-- 查询失败处理</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;get redis content error : &quot;</span>, err)  </span><br><span class="line">        <span class="keyword">return</span> close_redis(red)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">--得到的数据为空处理  </span></span><br><span class="line">    <span class="keyword">if</span> resp == ngx.null <span class="keyword">then</span>  </span><br><span class="line">        resp = <span class="literal">nil</span>  </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">	cache_set(key, resp)</span><br><span class="line">    close_redis(red)  </span><br><span class="line">    <span class="keyword">return</span> resp  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 查询redis的方法 ip和port是redis地址，keys是查询的key，数组格式</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read_redis</span><span class="params">(ip, port, key)</span></span>  </span><br><span class="line">	<span class="comment">-- 获取一个连接</span></span><br><span class="line">    <span class="keyword">local</span> red = redis:new()  </span><br><span class="line">    red:set_timeout(<span class="number">1000</span>)  </span><br><span class="line">    <span class="keyword">local</span> ok, err = red:connect(ip, port)  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;connect to redis error : &quot;</span>, err)  </span><br><span class="line">        <span class="keyword">return</span> close_redis(red)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="keyword">local</span> resp = <span class="literal">nil</span></span><br><span class="line">	<span class="comment">-- 利用get查询 </span></span><br><span class="line">    resp, err = red:get(key)  </span><br><span class="line">	<span class="comment">-- 查询失败处理</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;get redis content error : &quot;</span>, err)  </span><br><span class="line">        <span class="keyword">return</span> close_redis(red)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">--得到的数据为空处理  </span></span><br><span class="line">    <span class="keyword">if</span> resp == ngx.null <span class="keyword">then</span>  </span><br><span class="line">        resp = <span class="literal">nil</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    close_redis(red)  </span><br><span class="line">    <span class="keyword">return</span> resp  </span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"><span class="comment">-- 查询http请求的方法，path是请求路径，args是参数，table格式</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read_http</span><span class="params">(path, args)</span></span> </span><br><span class="line">	<span class="comment">-- 默认查询地址走 /backend/page/,内部转发到8083端口</span></span><br><span class="line">    <span class="keyword">local</span> resp = ngx.location.capture(<span class="string">&quot;/backend/page&quot;</span>..<span class="built_in">path</span>, &#123;  </span><br><span class="line">        method = ngx.HTTP_GET,  </span><br><span class="line">        args = args  </span><br><span class="line">    &#125;)  </span><br><span class="line">	<span class="comment">-- 查询失败的处理</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;request error&quot;</span>)  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">	<span class="comment">-- 返回状态码不是200就报错</span></span><br><span class="line">    <span class="keyword">if</span> resp.<span class="built_in">status</span> ~= <span class="number">200</span> <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;request error, status :&quot;</span>, resp.<span class="built_in">status</span>)  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> resp.body  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="comment">-- 将方法导出</span></span><br><span class="line"><span class="keyword">local</span> _M = &#123;  </span><br><span class="line">    read_redis = read_redis,  </span><br><span class="line">    read_cache = read_cache,  </span><br><span class="line">    read_http = read_http  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">return</span> _M </span><br></pre></td></tr></table></figure>



<p>改造<code>item.lua</code>，将分类、品牌、规格查询走本地缓存</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 导入模块</span></span><br><span class="line"><span class="keyword">local</span> common = <span class="built_in">require</span>(<span class="string">&quot;common&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> read_redis = common.read_redis  </span><br><span class="line"><span class="keyword">local</span> read_http = common.read_http</span><br><span class="line"><span class="keyword">local</span> read_cache = common.read_cache</span><br><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span>(<span class="string">&quot;cjson&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> template = <span class="built_in">require</span>(<span class="string">&quot;resty.template&quot;</span>)  </span><br><span class="line"><span class="comment">-- 常用变量和方法</span></span><br><span class="line"><span class="keyword">local</span> ngx_log = ngx.<span class="built_in">log</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_ERR = ngx.ERR  </span><br><span class="line"><span class="keyword">local</span> ngx_exit = ngx.<span class="built_in">exit</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_print = ngx.<span class="built_in">print</span>  </span><br><span class="line"><span class="keyword">local</span> ngx_re_match = ngx.re.<span class="built_in">match</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取商品id</span></span><br><span class="line"><span class="keyword">local</span> spuId = ngx.var.spuId</span><br><span class="line"><span class="comment">-- 获取spu</span></span><br><span class="line"><span class="keyword">local</span> spuKey = <span class="string">&quot;page:spu:id:&quot;</span>..spuId </span><br><span class="line"><span class="keyword">local</span> spuInfoStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, spuKey)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> spuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found spu info, back to http, spuId : &quot;</span>, spuId)  </span><br><span class="line">   spuInfoStr = read_http(<span class="string">&quot;/spu/&quot;</span>..spuId, &#123;&#125;)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> spuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found spuInfoStr info, spuId : &quot;</span>, spuId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取sku</span></span><br><span class="line"><span class="keyword">local</span> skuKey = <span class="string">&quot;page:sku:id:&quot;</span>..spuId </span><br><span class="line"><span class="keyword">local</span> skuInfoStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, skuKey)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> skuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found sku info, back to http, spuId : &quot;</span>, spuId)  </span><br><span class="line">   skuInfoStr = read_http(<span class="string">&quot;/sku/&quot;</span>..spuId, &#123;&#125;)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> skuInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found skuInfoStr info, spuId : &quot;</span>, spuId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取spuDetail</span></span><br><span class="line"><span class="keyword">local</span> detailKey = <span class="string">&quot;page:detail:id:&quot;</span>..spuId </span><br><span class="line"><span class="keyword">local</span> detailInfoStr = read_redis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, detailKey)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> detailInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found detail info, back to http, spuId : &quot;</span>, spuId)  </span><br><span class="line">   detailInfoStr = read_http(<span class="string">&quot;/detail/&quot;</span>..spuId, &#123;&#125;)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> detailInfoStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found detailInfoStr info, spuId : &quot;</span>, spuId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取categories</span></span><br><span class="line"><span class="keyword">local</span> spuInfo = cjson.decode(spuInfoStr)  </span><br><span class="line"><span class="keyword">local</span> cid3 = spuInfo[<span class="string">&quot;categoryIds&quot;</span>][<span class="number">3</span>]</span><br><span class="line"><span class="keyword">local</span> categoryKey = <span class="string">&quot;page:category:id:&quot;</span>..cid3 </span><br><span class="line"><span class="keyword">local</span> categoryStr = read_cache(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, categoryKey)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> categoryStr <span class="keyword">then</span>  </span><br><span class="line">   <span class="keyword">local</span> idStr = <span class="built_in">table</span>.<span class="built_in">concat</span>(spuInfo[<span class="string">&quot;categoryIds&quot;</span>],<span class="string">&quot;,&quot;</span>);</span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found category info, back to http, categoryIds : &quot;</span>, idStr)  </span><br><span class="line">   categoryStr = read_http(<span class="string">&quot;/categories/&quot;</span>, &#123;ids  = idStr&#125;)</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> categoryStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found categoryStr info, categoryId : &quot;</span>, cid3)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取品牌  </span></span><br><span class="line"><span class="keyword">local</span> brandId = spuInfo[<span class="string">&quot;brandId&quot;</span>]</span><br><span class="line"><span class="keyword">local</span> brandKey = <span class="string">&quot;page:brand:id:&quot;</span>..brandId </span><br><span class="line"><span class="keyword">local</span> brandStr = read_cache(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, brandKey)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> brandStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found brand info, back to http, brandId : &quot;</span>, brandId)  </span><br><span class="line">   brandStr = read_http(<span class="string">&quot;/brand/&quot;</span>..brandId, &#123;&#125;)</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> brandStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found brandStr info, brandId : &quot;</span>, brandId)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 获取规格</span></span><br><span class="line"><span class="keyword">local</span> specKey = <span class="string">&quot;page:spec:id:&quot;</span>..cid3 </span><br><span class="line"><span class="keyword">local</span> specStr = read_cache(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, specKey)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> specStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;redis not found spec info, back to http, cid3 : &quot;</span>, cid3)  </span><br><span class="line">   specStr = read_http(<span class="string">&quot;/spec/&quot;</span>..cid3, &#123;&#125;)</span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> specStr <span class="keyword">then</span>  </span><br><span class="line">   ngx_log(ngx_ERR, <span class="string">&quot;http not found specStr info, cid3 : &quot;</span>, cid3)  </span><br><span class="line">   <span class="keyword">return</span> ngx_exit(<span class="number">404</span>)  </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 组织数据1</span></span><br><span class="line"><span class="keyword">local</span> context = &#123;</span><br><span class="line">	name = spuInfo[<span class="string">&quot;name&quot;</span>],</span><br><span class="line">	skuList =  skuInfoStr,</span><br><span class="line">	detail =  detailInfoStr,</span><br><span class="line">	categories =  categoryStr,</span><br><span class="line">	brand =  brandStr,</span><br><span class="line">	specs =  specStr</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">--渲染模板  1</span></span><br><span class="line">template.render(<span class="string">&quot;item.html&quot;</span>, context)  </span><br></pre></td></tr></table></figure>

<h1 id="4-缓存数据同步"><a href="#4-缓存数据同步" class="headerlink" title="4.缓存数据同步"></a>4.缓存数据同步</h1><p>当商品、分类、品牌、规格等数据改变时，<strong>mysql数据会变化，Redis中数据也必须同步改变</strong>，如何做到呢？</p>
<p>这里我们会采用Canal这个框架来实现。</p>
<h2 id="4-1-什么是Canal"><a href="#4-1-什么是Canal" class="headerlink" title="4.1.什么是Canal"></a>4.1.什么是Canal</h2><p><strong>canal [kə’næl]，</strong>译意为水道/管道/沟渠，canal是阿里巴巴旗下的一款开源项目，基于Java开发。基于数据库增量日志解析，提供增量数据订阅&amp;消费。</p>
<p>基于日志增量订阅和消费的业务包括</p>
<ul>
<li>数据库镜像</li>
<li>数据库实时备份</li>
<li>索引构建和实时维护(拆分异构索引、倒排索引等)</li>
<li>业务 cache 刷新</li>
<li>带业务逻辑的增量数据处理</li>
</ul>
<p>当前的 canal 支持源端 MySQL 版本包括 5.1.x , 5.5.x , 5.6.x , 5.7.x , 8.0.x</p>
<p>在GitHub的地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/canal">https://github.com/alibaba/canal</a></p>
<p>基本原理如下图：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200311220739591.png" alt="image-20200311220739591"></p>
<p>MySQL主备复制原理</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">MySQL master 将**数据变更**写入二进制日志( binary log, 其中记录叫做二进制日志事件binary log events，</span></span><br><span class="line">	<span class="meta">可以通过</span> <span class="string">show binlog events 进行查看)</span></span><br><span class="line"><span class="meta">-</span> <span class="string">MySQL slave 将 master 的 binary log events 拷贝到它的中继日志(relay log)</span></span><br><span class="line"><span class="meta">-</span> <span class="string">MySQL slave 重放 relay log 中事件，将数据变更反映它自己的数据</span></span><br></pre></td></tr></table></figure>

<p>canal 工作原理</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送dump 协议</span></span><br><span class="line"><span class="meta">-</span> <span class="string">MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal )</span></span><br><span class="line"><span class="meta">-</span> <span class="string">canal 解析 binary log 对象(原始为 byte 流)</span></span><br></pre></td></tr></table></figure>



<h2 id="4-2-设置主从同步"><a href="#4-2-设置主从同步" class="headerlink" title="4.2.设置主从同步"></a>4.2.设置主从同步</h2><p>下面我们就开启mysql的主从同步机制，让Canal来模拟salve</p>
<p>这里以linux版本的mysql为例</p>
<h3 id="4-2-1-设置binary-log"><a href="#4-2-1-设置binary-log" class="headerlink" title="4.2.1.设置binary log"></a>4.2.1.设置binary log</h3><p>根据上面介绍的原理，我们首先要开启mysql的binary log日志。</p>
<p>打开mysql容器挂载的日志文件，我的在<code>/home/leyou/mysql/conf</code>目录:</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200311221433314.png" alt="image-20200311221433314"> </p>
<p>修改文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /home/leyou/mysql/conf/my.cnf</span><br></pre></td></tr></table></figure>

<p>最新内容为：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line">skip-name-resolve</span><br><span class="line"><span class="attr">character_set_server</span>=utf8</span><br><span class="line"><span class="attr">datadir</span>=/var/lib/mysql</span><br><span class="line"><span class="attr">server-id</span>=<span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log-bin</span>=/var/lib/mysql/mysql-bin</span><br><span class="line"><span class="attr">binlog-do-db</span>=heima</span><br></pre></td></tr></table></figure>

<p>配置解读：</p>
<ul>
<li><code>log-bin=/var/lib/mysql/mysql-bin</code>：设置binary log文件的存放地址</li>
<li><code>server-id=1000</code>：设置当前服务id</li>
<li><code>binlog-do-db=heima</code>：设置生成binary log的database名称，这里设置的是heima</li>
</ul>
<p>效果截图：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200725214927404.png" alt="image-20200725214927404"> </p>
<h3 id="4-2-2-设置账号权限"><a href="#4-2-2-设置账号权限" class="headerlink" title="4.2.2.设置账号权限"></a>4.2.2.设置账号权限</h3><p>接下来添加一个仅用于数据同步的账户，出于安全考虑，这里仅提供对heima这个库的操作权限。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it ly-mysql /bin/bash</span><br></pre></td></tr></table></figure>

<p>链接mysql:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create user canal@&#x27;%&#x27; IDENTIFIED by &#x27;canal&#x27;;</span><br><span class="line">GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT,SUPER ON *.* TO &#x27;canal&#x27;@&#x27;%&#x27; identified by &#x27;canal&#x27;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<p>两次<code>exit</code>退出mysql，退出容器,到宿主机</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure>



<p>重启mysql容器即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart mysql</span><br></pre></td></tr></table></figure>



<p>测试设置是否成功：在mysql控制台，或者Navicat中，输入命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br></pre></td></tr></table></figure>

<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/image-20200327094735948.png" alt="image-20200327094735948"> </p>
<h2 id="4-3-安装canal"><a href="#4-3-安装canal" class="headerlink" title="4.3.安装canal"></a>4.3.安装canal</h2><p>拉取镜像：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull canal/canal-server</span><br></pre></td></tr></table></figure>

<p>运行容器：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 11111:11111 --name canal \</span><br><span class="line">-e canal.destinations=<span class="built_in">test</span> \</span><br><span class="line">-e canal.instance.master.address=172.17.0.5:3306 \</span><br><span class="line">-e canal.instance.dbUsername=canal \</span><br><span class="line">-e canal.instance.dbPassword=canal \</span><br><span class="line">-e canal.instance.connectionCharset=UTF-8 \</span><br><span class="line">-e canal.instance.tsdb.enable=<span class="literal">true</span> \</span><br><span class="line">-e canal.instance.gtidon=<span class="literal">false</span>  \</span><br><span class="line">-e canal.instance.filter.regex=heima.tb_spu,heima.tb_sku,heima.tb_spu_detail,heima.tb_category,heima.tb_brand,heima.tb_spec_param \</span><br><span class="line">--network bridge \</span><br><span class="line">-d canal/canal-server</span><br></pre></td></tr></table></figure>

<p>说明:</p>
<ul>
<li><code>-p 11111:11111</code>：这是canal的默认监听端口</li>
<li><code>-e canal.instance.master.address=172.17.0.4:3306</code>：数据库地址和端口，如果不知道mysql容器地址，可以通过<code>docker inspect 容器id</code>来查看</li>
<li><code>-e canal.instance.dbUsername=canal</code>：数据库用户名</li>
<li><code>-e canal.instance.dbPassword=canal</code> ：数据库密码</li>
<li><code>-e canal.instance.filter.regex=</code>：要监听的表名称</li>
</ul>
<p>表名称监听支持的语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql 数据解析关注的表，Perl正则表达式.</span><br><span class="line">多个正则之间以逗号(,)分隔，转义符需要双斜杠(\\) </span><br><span class="line">常见例子：</span><br><span class="line">1.  所有表：.*   or  .*\\..*</span><br><span class="line">2.  canal schema下所有表： canal\\..*</span><br><span class="line">3.  canal下的以canal打头的表：canal\\.canal.*</span><br><span class="line">4.  canal schema下的一张表：canal.test1</span><br><span class="line">5.  多个规则组合使用然后以逗号隔开：canal\\..*,mysql.test1,mysql.test2 </span><br></pre></td></tr></table></figure>

<p>设置canal的自动启动：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker update --restart=always canal</span><br></pre></td></tr></table></figure>

<p>现在，canal就会去监听我们的数据库变化，并通知canal客户端。</p>
<h2 id="4-4-编写canal客户端"><a href="#4-4-编写canal客户端" class="headerlink" title="4.4.编写canal客户端"></a>4.4.编写canal客户端</h2><p>我们在<code>ly-page</code>中配置canal客户端，当数据库变化时我们就能得到通知。</p>
<h3 id="4-4-1引入依赖"><a href="#4-4-1引入依赖" class="headerlink" title="4.4.1引入依赖"></a>4.4.1引入依赖</h3><p>在<code>ly-page</code>的<code>pom.xml</code>中添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.javatool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>canal-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1-RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编写<code>ly-page</code>的配置文件<code>application.yml</code>，指定canal服务端地址：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="comment"># top.javatool.canal: warn # 关闭心跳日志</span></span><br><span class="line">    <span class="attr">com.leyou:</span> <span class="string">debug</span> <span class="comment"># 日志配置</span></span><br><span class="line"><span class="attr">canal:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">test</span>  <span class="comment">############这里要跟启动canal容器时的destination一致。</span></span><br><span class="line">  <span class="attr">server:</span> <span class="string">ly-canal:11111</span> <span class="comment"># canal地址    ####注意要去hosts文件配置ly-canal 域名的ip地址。</span></span><br></pre></td></tr></table></figure>



<h3 id="4-4-2-添加Redis操作方法"><a href="#4-4-2-添加Redis操作方法" class="headerlink" title="4.4.2.添加Redis操作方法"></a>4.4.2.添加Redis操作方法</h3><p>等会监听到表的操作包括：增、删、改</p>
<ul>
<li>增、改：我们写入数据到redis</li>
<li>删：我们把数据从redis删除</li>
</ul>
<p>这里要监听的数据比较多，业务代码较多，我们以sku为例来给大家介绍。</p>
<p>给<code>ly-page</code>中的<code>GoodsPageService</code>中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把Sku从Redis删除</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function">Boolean <span class="title">deleteSku</span><span class="params">(Long spuId)</span></span>;</span><br></pre></td></tr></table></figure>



<p>然后在<code>GoodsPageServiceImpl</code>中实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Boolean <span class="title">deleteSku</span><span class="params">(Long spuId)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.delete(KEY_PREFIX_SKU + spuId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="4-4-2-编写监听器"><a href="#4-4-2-编写监听器" class="headerlink" title="4.4.2.编写监听器"></a>4.4.2.编写监听器</h3><p>我们在ly-page的<code>com.leyou.page.canal</code>包下，新增一个类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.page.canal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.page.service.GoodsPageService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> top.javatool.canal.client.annotation.CanalTable;</span><br><span class="line"><span class="keyword">import</span> top.javatool.canal.client.context.CanalContext;</span><br><span class="line"><span class="keyword">import</span> top.javatool.canal.client.handler.EntryHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@CanalTable(value = &quot;all&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CanalHandler</span> <span class="keyword">implements</span> <span class="title">EntryHandler</span>&lt;<span class="title">Map</span>&lt;<span class="title">String</span>,<span class="title">String</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GoodsPageService goodsPageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(Map&lt;String,String&gt; model)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取表的名称</span></span><br><span class="line">        String table = CanalContext.getModel().getTable();</span><br><span class="line">        <span class="comment">// 如果表是tb_sku</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;tb_sku&quot;</span>.equals(table))&#123;</span><br><span class="line">            log.info(<span class="string">&quot;sku新增了&#123;&#125;&quot;</span>, model);</span><br><span class="line">            goodsPageService.loadSkuListData(Long.valueOf(model.get(<span class="string">&quot;spu_id&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Map&lt;String,String&gt; before, Map&lt;String,String&gt; after)</span> </span>&#123;</span><br><span class="line">        String table = CanalContext.getModel().getTable();</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;tb_sku&quot;</span>.equals(table))&#123;</span><br><span class="line">            log.info(<span class="string">&quot;sku修改了&#123;&#125;&quot;</span>, after);</span><br><span class="line">            goodsPageService.loadSkuListData(Long.valueOf(after.get(<span class="string">&quot;spu_id&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(Map&lt;String,String&gt; model)</span> </span>&#123;</span><br><span class="line">        String table = CanalContext.getModel().getTable();</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;tb_sku&quot;</span>.equals(table))&#123;</span><br><span class="line">            log.info(<span class="string">&quot;sku删除了&#123;&#125;&quot;</span>, model);</span><br><span class="line">            goodsPageService.deleteSku(Long.valueOf(model.get(<span class="string">&quot;spu_id&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1</span> <span class="string">将mysql中的heima数据库设置为master</span></span><br><span class="line"><span class="attr">2</span> <span class="string">在centos中安装canal 模拟mysql的slave，向master发送请求</span></span><br><span class="line"><span class="attr">3</span> <span class="string">canal将请求放到test中，供客户端访问（只要heima数据库有增删改就会更新test内容）</span></span><br><span class="line"><span class="attr">4</span> <span class="string">page微服务器也就是客户端，编写监听器（通过canal依赖包以及一些配置）绑定canal的test，</span></span><br><span class="line"><span class="attr">5</span> <span class="string">只要test内容变化，page微服监听到增删改变化之后就会去操作更新到redis。</span></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">高明辉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/06/28/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-OpenResty%E4%B8%8E%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/">http://example.com/2022/06/28/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-OpenResty%E4%B8%8E%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Jason</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Canal/">Canal</a><a class="post-meta__tags" href="/tags/OpenResty/">OpenResty</a><a class="post-meta__tags" href="/tags/Lua/">Lua</a></div><div class="post_share"><div class="social-share" data-image="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/9%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5/%E5%B0%81%E9%9D%A2.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="添加微信"/></a><div class="post-qr-code-desc">添加微信</div></li><li class="reward-item"><a href="/img/pay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/pay.jpg" alt="付款码"/></a><div class="post-qr-code-desc">付款码</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/06/30/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83-%E6%B3%A8%E5%86%8C/"><img class="prev-cover" src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/10%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83-%E6%B3%A8%E5%86%8C/%E5%B0%81%E9%9D%A2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">乐优商城项目-用户中心-注册</div></div></a></div><div class="next-post pull-right"><a href="/2022/06/26/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-ElesticSear%E6%95%B0%E6%8D%AE%E6%90%9C%E7%B4%A2%E4%BB%A5%E5%8F%8Aes%E4%B8%8Emysql%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/"><img class="next-cover" src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/8%E6%90%9C%E7%B4%A2%E8%BF%87%E6%BB%A4%E5%8F%8A%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/%E5%B0%81%E9%9D%A2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">乐优商城项目-ElesticSear数据搜索以及es与mysql数据同步</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="toc-number">1.</span> <span class="toc-text">商品详情页</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">2.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">3.</span> <span class="toc-text">1.实现思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E4%BC%A0%E7%BB%9F%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.</span> <span class="toc-text">1.1.传统模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E9%9D%99%E6%80%81%E5%8C%96%E9%A1%B5%E9%9D%A2"><span class="toc-number">3.2.</span> <span class="toc-text">1.2.静态化页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%8A%A8%E6%80%81%E6%A8%A1%E6%9D%BF%EF%BC%8C%E9%9D%99%E6%80%81%E5%8C%96%E6%95%B0%E6%8D%AE"><span class="toc-number">3.3.</span> <span class="toc-text">1.3.动态模板，静态化数据</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E9%9D%99%E6%80%81%E9%A1%B5%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.</span> <span class="toc-text">2.静态页数据服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%90%AD%E5%BB%BA%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.1.</span> <span class="toc-text">2.1.搭建微服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><span class="toc-number">4.2.</span> <span class="toc-text">2.2.数据分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E9%9C%80%E8%A6%81%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">4.2.1.</span> <span class="toc-text">2.2.1.需要的数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E6%95%B0%E6%8D%AE%E7%9A%84%E6%A0%BC%E5%BC%8F"><span class="toc-number">4.2.2.</span> <span class="toc-text">2.2.2.数据的格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E6%9F%A5%E8%AF%A2%E5%95%86%E5%93%81%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%AD%98%E5%85%A5Redis"><span class="toc-number">4.3.</span> <span class="toc-text">2.3.查询商品信息，存入Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-%E4%B8%9A%E5%8A%A1%E5%88%86%E6%9E%90"><span class="toc-number">4.3.1.</span> <span class="toc-text">2.3.1.业务分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-DTO"><span class="toc-number">4.3.2.</span> <span class="toc-text">2.3.2.DTO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-%E5%AE%9A%E4%B9%89Service"><span class="toc-number">4.3.3.</span> <span class="toc-text">2.3.3.定义Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-4-%E5%AE%9A%E4%B9%89controller"><span class="toc-number">4.3.4.</span> <span class="toc-text">2.3.4.定义controller</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-OpenResty%E6%B8%B2%E6%9F%93%E9%9D%99%E6%80%81%E9%A1%B5"><span class="toc-number">5.</span> <span class="toc-text">3.OpenResty渲染静态页</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E4%BB%8B%E7%BB%8DOpenResty"><span class="toc-number">5.1.</span> <span class="toc-text">3.1.介绍OpenResty</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%AE%89%E8%A3%85OpenResty%EF%BC%88%E5%85%88%E6%8B%8D%E7%85%A7%EF%BC%81%EF%BC%81%EF%BC%81%EF%BC%89"><span class="toc-number">5.2.</span> <span class="toc-text">3.2.安装OpenResty（先拍照！！！）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-Lua%E8%AF%AD%E8%A8%80"><span class="toc-number">5.3.</span> <span class="toc-text">3.3.Lua语言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-Lua%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.3.1.</span> <span class="toc-text">3.3.1.Lua介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-%E8%AF%AD%E6%B3%95%E5%85%A5%E9%97%A8"><span class="toc-number">5.3.2.</span> <span class="toc-text">3.3.2.语法入门</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-OpenResty%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">5.4.</span> <span class="toc-text">3.4.OpenResty快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="toc-number">5.4.1.</span> <span class="toc-text">3.4.1.基本配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-%E7%9B%91%E5%90%AC%E7%AB%AF%E5%8F%A3"><span class="toc-number">5.4.2.</span> <span class="toc-text">3.4.2.监听端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3%E7%AC%AC%E4%B8%80%E4%B8%AAlua%E8%84%9A%E6%9C%AC"><span class="toc-number">5.4.3.</span> <span class="toc-text">3.4.3第一个lua脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-4-%E5%90%AF%E5%8A%A8%E5%B9%B6%E8%AE%BF%E9%97%AE"><span class="toc-number">5.4.4.</span> <span class="toc-text">3.4.4.启动并访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0"><span class="toc-number">5.5.</span> <span class="toc-text">3.5.获取请求参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-%E7%BC%96%E5%86%99%E6%98%A0%E5%B0%84%E8%A7%84%E5%88%99"><span class="toc-number">5.5.1.</span> <span class="toc-text">3.5.1.编写映射规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-2-%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC"><span class="toc-number">5.5.2.</span> <span class="toc-text">3.5.2.编写脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-3-%E9%87%8D%E5%90%AF%E6%B5%8B%E8%AF%95"><span class="toc-number">5.5.3.</span> <span class="toc-text">3.5.3.重启测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-OpenResty%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93%E6%A8%A1%E5%9D%97"><span class="toc-number">5.6.</span> <span class="toc-text">3.6.OpenResty模板渲染模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-1-%E5%AE%89%E8%A3%85%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93%E6%A8%A1%E5%9D%97"><span class="toc-number">5.6.1.</span> <span class="toc-text">3.6.1.安装模板渲染模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-2-%E5%AE%9A%E4%B9%89%E6%A8%A1%E6%9D%BF%E4%BD%8D%E7%BD%AE"><span class="toc-number">5.6.2.</span> <span class="toc-text">3.6.2.定义模板位置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-3-%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93"><span class="toc-number">5.6.3.</span> <span class="toc-text">3.6.3.模板渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-4-%E6%B5%8B%E8%AF%95"><span class="toc-number">5.6.4.</span> <span class="toc-text">3.6.4.测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7-OpenResty%E7%9A%84Redis%E6%A8%A1%E5%9D%97"><span class="toc-number">5.7.</span> <span class="toc-text">3.7.OpenResty的Redis模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-1-%E5%AE%9A%E4%B9%89%E6%98%A0%E5%B0%84%E8%A7%84%E5%88%99"><span class="toc-number">5.7.1.</span> <span class="toc-text">3.7.1.定义映射规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-2-%E4%BD%BF%E7%94%A8Redis%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD"><span class="toc-number">5.7.2.</span> <span class="toc-text">3.7.2.使用Redis模块功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-3-%E6%B5%8B%E8%AF%95"><span class="toc-number">5.7.3.</span> <span class="toc-text">3.7.3.测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-OpenResty-%E5%86%85%E9%83%A8-%E8%AF%B7%E6%B1%82%E4%BB%A3%E7%90%86"><span class="toc-number">5.8.</span> <span class="toc-text">3.8.OpenResty  内部  请求代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-1-%E4%B8%A4%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-number">5.8.1.</span> <span class="toc-text">3.8.1.两种实现方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-2-%E5%86%85%E9%83%A8%E8%AF%B7%E6%B1%82%E4%BB%A3%E7%90%86"><span class="toc-number">5.8.2.</span> <span class="toc-text">3.8.2.内部请求代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-3-%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.8.3.</span> <span class="toc-text">3.8.3.示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-%E5%AE%9E%E7%8E%B0%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5%E6%B8%B2%E6%9F%93"><span class="toc-number">5.9.</span> <span class="toc-text">3.8.实现商品详情页渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-1-%E5%86%85%E9%83%A8%E8%AF%B7%E6%B1%82%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE"><span class="toc-number">5.9.1.</span> <span class="toc-text">3.8.1.内部请求代理配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-2-%E7%BC%96%E5%86%99%E9%80%9A%E7%94%A8%E5%B7%A5%E5%85%B7%E6%A8%A1%E5%9D%97"><span class="toc-number">5.9.2.</span> <span class="toc-text">3.8.2.编写通用工具模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-3-%E9%A1%B5%E9%9D%A2%E6%A8%A1%E6%9D%BF"><span class="toc-number">5.9.3.</span> <span class="toc-text">3.8.3.页面模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-4-%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E8%84%9A%E6%9C%AC"><span class="toc-number">5.9.4.</span> <span class="toc-text">3.8.4.数据处理脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-5-%E8%B7%AF%E5%BE%84%E6%98%A0%E5%B0%84"><span class="toc-number">5.9.5.</span> <span class="toc-text">3.8.5.路径映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-6-%E4%BF%AE%E6%94%B9%E5%AE%BF%E4%B8%BB%E6%9C%BA%E8%B7%AF%E5%BE%84%E6%98%A0%E5%B0%84"><span class="toc-number">5.9.6.</span> <span class="toc-text">3.8.6.修改宿主机路径映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-7-%E4%BC%98%E5%8C%96%EF%BC%88%E7%90%86%E8%A7%A3%E5%8D%B3%E5%8F%AF%EF%BC%89"><span class="toc-number">5.9.7.</span> <span class="toc-text">3.8.7.优化（理解即可）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">6.</span> <span class="toc-text">4.缓存数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E4%BB%80%E4%B9%88%E6%98%AFCanal"><span class="toc-number">6.1.</span> <span class="toc-text">4.1.什么是Canal</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E8%AE%BE%E7%BD%AE%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5"><span class="toc-number">6.2.</span> <span class="toc-text">4.2.设置主从同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E8%AE%BE%E7%BD%AEbinary-log"><span class="toc-number">6.2.1.</span> <span class="toc-text">4.2.1.设置binary log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E8%AE%BE%E7%BD%AE%E8%B4%A6%E5%8F%B7%E6%9D%83%E9%99%90"><span class="toc-number">6.2.2.</span> <span class="toc-text">4.2.2.设置账号权限</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E5%AE%89%E8%A3%85canal"><span class="toc-number">6.3.</span> <span class="toc-text">4.3.安装canal</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E7%BC%96%E5%86%99canal%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">6.4.</span> <span class="toc-text">4.4.编写canal客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">6.4.1.</span> <span class="toc-text">4.4.1引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2-%E6%B7%BB%E5%8A%A0Redis%E6%93%8D%E4%BD%9C%E6%96%B9%E6%B3%95"><span class="toc-number">6.4.2.</span> <span class="toc-text">4.4.2.添加Redis操作方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2-%E7%BC%96%E5%86%99%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">6.4.3.</span> <span class="toc-text">4.4.2.编写监听器</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 高明辉</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'Aaee0Vekhg5KbLhMOJQrEU6A-gzGzoHsz',
      appKey: 'mmLHPEEtqvOSJhsqWra8Sq6K',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script type="text/javascript" src="/js/fairyDustCursor.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>