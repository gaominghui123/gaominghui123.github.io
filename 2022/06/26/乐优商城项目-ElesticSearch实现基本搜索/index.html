<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>乐优商城项目-ElesticSearch实现基本搜索 | Jason</title><meta name="keywords" content="乐优商城项目"><meta name="author" content="高明辉"><meta name="copyright" content="高明辉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="学习目标1234- 理解索引库数据结构设计- 能够把商品数据导入到索引库- 能实现搜索补全功能- 能实现基本搜索功能  1.ElasticSearch的starterElasticSearch的异步API代码编写比较复杂，因此我们需要封装成工具，方便后期的使用。而且最好与SpringBoot整合，完成自动配置的starter。最终达成与MybatisPlus一样的效果：  用户定义接口并继承我们的">
<meta property="og:type" content="article">
<meta property="og:title" content="乐优商城项目-ElesticSearch实现基本搜索">
<meta property="og:url" content="http://example.com/2022/06/26/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-ElesticSearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/index.html">
<meta property="og:site_name" content="Jason">
<meta property="og:description" content="学习目标1234- 理解索引库数据结构设计- 能够把商品数据导入到索引库- 能实现搜索补全功能- 能实现基本搜索功能  1.ElasticSearch的starterElasticSearch的异步API代码编写比较复杂，因此我们需要封装成工具，方便后期的使用。而且最好与SpringBoot整合，完成自动配置的starter。最终达成与MybatisPlus一样的效果：  用户定义接口并继承我们的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/%E5%B0%81%E9%9D%A2.png">
<meta property="article:published_time" content="2022-06-26T07:39:55.000Z">
<meta property="article:modified_time" content="2022-12-11T02:30:16.773Z">
<meta property="article:author" content="高明辉">
<meta property="article:tag" content="乐优商城项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/%E5%B0%81%E9%9D%A2.png"><link rel="shortcut icon" href="/img/%E7%BD%91%E7%AB%99%E5%9B%BE%E6%A0%87.png"><link rel="canonical" href="http://example.com/2022/06/26/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-ElesticSearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '乐优商城项目-ElesticSearch实现基本搜索',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-12-11 10:30:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Jason" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/%E5%A4%B4%E5%83%8F.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">186</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">206</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">35</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li><li><a class="site-page child" href="/butterfly%E4%B8%BB%E9%A2%98"><i class="fa-fw https://github.com/jerryc127/hexo-theme-butterfly/"></i><span> 2</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/%E5%B0%81%E9%9D%A2.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Jason</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li><li><a class="site-page child" href="/butterfly%E4%B8%BB%E9%A2%98"><i class="fa-fw https://github.com/jerryc127/hexo-theme-butterfly/"></i><span> 2</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">乐优商城项目-ElesticSearch实现基本搜索</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-06-26T07:39:55.000Z" title="发表于 2022-06-26 15:39:55">2022-06-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-12-11T02:30:16.773Z" title="更新于 2022-12-11 10:30:16">2022-12-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/">乐优商城项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="乐优商城项目-ElesticSearch实现基本搜索"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h1><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">理解索引库数据结构设计</span></span><br><span class="line"><span class="meta">-</span> <span class="string">能够把商品数据导入到索引库</span></span><br><span class="line"><span class="meta">-</span> <span class="string">能实现搜索补全功能</span></span><br><span class="line"><span class="meta">-</span> <span class="string">能实现基本搜索功能</span></span><br></pre></td></tr></table></figure>

<h1 id="1-ElasticSearch的starter"><a href="#1-ElasticSearch的starter" class="headerlink" title="1.ElasticSearch的starter"></a>1.ElasticSearch的starter</h1><p>ElasticSearch的<strong>异步API代码编写比较复杂，因此我们需要封装成工具</strong>，方便后期的使用。而且最好与SpringBoot整合，完成自动配置的starter。最终达成与MybatisPlus一样的效果：</p>
<ul>
<li>用户定义接口并继承我们的接口，获取CRUD的方法</li>
<li>我们实现接口中的方法</li>
<li>通过动态代理来代理用户接口，并注入Spring容器</li>
<li>实现自动配置</li>
</ul>
<p>我们大概会经过这样几个步骤来完成：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">定义工具类</span></span><br><span class="line"><span class="meta">-</span> <span class="string">与spring整合</span></span><br><span class="line"><span class="meta">-</span> <span class="string">形成starter</span></span><br></pre></td></tr></table></figure>



<h2 id="1-1-搭建工程"><a href="#1-1-搭建工程" class="headerlink" title="1.1.搭建工程"></a>1.1.搭建工程</h2><p>SpringBoot的starter结构一般如下：</p>
<ul>
<li>spring-boot-xxx-autoconfigure：实现自动配置的代码、工具类、配置类等</li>
<li>spring-boot-starter-xxx：管理spring-boot-xxx-autoconfigure及其它所需依赖的版本</li>
</ul>
<p>因此我们如果要自定义工具类，并且实现starter，项目结构也是如此，包含：</p>
<ul>
<li>leyou-starters：父工程，起聚合作用，方便开发<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">elastic-spring-boot-autoconfigure：工具类、配置类等</span></span><br><span class="line"><span class="meta">-</span> <span class="string">elastic-spring-boot-starter：引入spring-boot-xxx-autoconfigure及其它所需依赖</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>补充：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">项目里使用官方提供的elasticSearch版本，高级特性用不了，</span></span><br><span class="line"><span class="attr">比如说显示提示，因为是绑定了springBoot版本的，</span></span><br><span class="line"><span class="attr">但是我又想要使用elasticSearch高级特性，怎么办？？？</span></span><br><span class="line"><span class="meta">需要自定义elasticSearch</span> <span class="string">start 启动依赖包！！！</span></span><br></pre></td></tr></table></figure>



<h3 id="1-1-1-创建父工程："><a href="#1-1-1-创建父工程：" class="headerlink" title="1.1.1.创建父工程："></a>1.1.1.创建父工程：</h3><p>创建一个普通maven工程</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200517111029233.png" alt="image-20200517111029233"></p>
<p>位置：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200517111050389.png" alt="image-20200517111050389"></p>
<p>pom：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>leyou-starters<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring.boot.version</span>&gt;</span>2.1.12.RELEASE<span class="tag">&lt;/<span class="name">spring.boot.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">elasticsearch.version</span>&gt;</span>7.4.2<span class="tag">&lt;/<span class="name">elasticsearch.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="1-1-2-AutoConfigure"><a href="#1-1-2-AutoConfigure" class="headerlink" title="1.1.2.AutoConfigure"></a>1.1.2.AutoConfigure</h3><p>然后是搭建AutoConfigure模块。</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200517111202030.png" alt="image-20200517111202030"> </p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200517111215955.png" alt="image-20200517111215955"></p>
<p>坐标：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200517111222004.png" alt="image-20200517111222004"></p>
<p>依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>leyou-starters<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elastic-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--springboot 自动配置基本依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--elasticsearch依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;elasticsearch.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--JSON依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.10.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--通用模块--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--响应式API 依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-netty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.8.15.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志相关--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-to-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jul-to-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.30<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h3 id="1-1-3-Starter模块"><a href="#1-1-3-Starter模块" class="headerlink" title="1.1.3.Starter模块"></a>1.1.3.Starter模块</h3><p>然后是starter模块，与AutoConfigure模块一样，是一个普通maven模块</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200517111258427.png" alt="image-20200517111258427"></p>
<p>依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>leyou-starters<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elastic-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elastic-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="1-2-定义工具类"><a href="#1-2-定义工具类" class="headerlink" title="1.2.定义工具类"></a>1.2.定义工具类</h2><p>课程中为了时间考虑，我们只把核心需要的几个功能封装，并不追求功能的完整性，包括下列方法：</p>
<ul>
<li>创建索引库和映射</li>
<li>删除索引库</li>
<li>新增文档</li>
<li>查询文档</li>
<li>删除文档</li>
<li>搜索并实现分页、高亮、排序</li>
<li>自动补全查询</li>
</ul>
<p>因为包含分页查询，因此需要一个DTO，代表分页结果，</p>
<p>我们在<code>com.leyou.starter.elastic.entity</code>包下定义一个类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.starter.elastic.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageInfo</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> total;</span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PageInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PageInfo</span><span class="params">(<span class="keyword">long</span> total, List&lt;T&gt; content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.total = total;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTotal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTotal</span><span class="params">(<span class="keyword">long</span> total)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.total = total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(List&lt;T&gt; content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="1-2-1-定义工具接口"><a href="#1-2-1-定义工具接口" class="headerlink" title="1.2.1.定义工具接口"></a>1.2.1.定义工具接口</h3><p>首先我们在<code>com.leyou.starter.elastic.repository</code>包中定义一个接口，声明需要的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.starter.elastic.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.starter.elastic.dto.PageInfo;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定义了操作Elasticsearch的CRUD的功能 &lt;br/&gt;</span></span><br><span class="line"><span class="comment"> * 泛型说明 &lt;br/&gt;</span></span><br><span class="line"><span class="comment"> * T：实体类类型</span></span><br><span class="line"><span class="comment"> * ID：实体类中的id类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Repository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建索引库</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> source setting和mapping的json字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否创建成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Boolean <span class="title">createIndex</span><span class="params">(String source)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除当前实体类相关的索引库</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否删除成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Boolean <span class="title">deleteIndex</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t 要新增的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否新增成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">save</span><span class="params">(T t)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量新增</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> iterable 要新增的数据结婚</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否新增成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">saveAll</span><span class="params">(Iterable&lt;T&gt; iterable)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id删除数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否删除成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">deleteById</span><span class="params">(ID id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异步功能，根据id查询数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 包含实体类的Mono实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Mono&lt;T&gt; <span class="title">queryById</span><span class="params">(ID id)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据&#123;<span class="doctag">@link</span> SearchSourceBuilder&#125;查询数据，返回分页结果&#123;<span class="doctag">@link</span> PageInfo&#125;，其中的数据已经高亮处理</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sourceBuilder 查询条件构建器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果处理器处理后的的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Mono&lt;PageInfo&lt;T&gt;&gt; queryBySourceBuilderForPageHighlight(SearchSourceBuilder sourceBuilder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据指定的prefixKey对单个指定suggestField 做自动补全，返回推荐结果的列表&#123;<span class="doctag">@link</span> List&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> suggestField 补全字段</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefixKey 关键字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回推荐结果列表&#123;<span class="doctag">@link</span> List&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Mono&lt;List&lt;String&gt;&gt; suggestBySingleField(String suggestField, String prefixKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-2-定义实现类"><a href="#1-2-2-定义实现类" class="headerlink" title="1.2.2.定义实现类"></a>1.2.2.定义实现类</h3><p>我们在<code>com.leyou.starter.elastic.repository</code>包中定义实现类，暂时不实现代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.starter.elastic.repository;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepositoryHandler</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; <span class="keyword">implements</span> <span class="title">Repository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Elasticsearch的客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestHighLevelClient client;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 索引库名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String indexName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RepositoryHandler</span><span class="params">(RestHighLevelClient client, String indexName)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.client = client;</span><br><span class="line">        <span class="keyword">this</span>.indexName = indexName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>解读：</p>
<p>通过构造函数我们注入了两个属性：</p>
<ul>
<li>RestHighLevelClient client：操作elasticsearch需要用到的客户端</li>
<li>String indexName：要操作的索引库名称</li>
</ul>
<h3 id="1-2-3-创建和删除索引库"><a href="#1-2-3-创建和删除索引库" class="headerlink" title="1.2.3.创建和删除索引库"></a>1.2.3.创建和删除索引库</h3><p>先来实现索引库操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Boolean <span class="title">createIndex</span><span class="params">(String source)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 发起请求，准备创建索引库</span></span><br><span class="line">        CreateIndexResponse response = client.indices().create(</span><br><span class="line">            <span class="keyword">new</span> CreateIndexRequest(indexName).source(source, XContentType.JSON),</span><br><span class="line">            RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 返回执行结果</span></span><br><span class="line">        <span class="keyword">return</span> response.isAcknowledged();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Boolean <span class="title">deleteIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 发起请求，删除索引库</span></span><br><span class="line">        AcknowledgedResponse response = client.indices()</span><br><span class="line">            .delete(<span class="keyword">new</span> DeleteIndexRequest(indexName), RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 返回执行结果</span></span><br><span class="line">        <span class="keyword">return</span> response.isAcknowledged();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个都是同步操作，没有调用异步的API。</p>
<h3 id="1-2-4-新增文档"><a href="#1-2-4-新增文档" class="headerlink" title="1.2.4.新增文档"></a>1.2.4.新增文档</h3><p>新增文档代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 从对象中获取id</span></span><br><span class="line">        String id = getID(t);</span><br><span class="line">        <span class="comment">// 把对象转为JSON</span></span><br><span class="line">        String json = toJson(t);</span><br><span class="line">        <span class="comment">// 准备请求</span></span><br><span class="line">        IndexRequest request = <span class="keyword">new</span> IndexRequest(indexName)</span><br><span class="line">            .id(id)</span><br><span class="line">            .source(json, XContentType.JSON);</span><br><span class="line">        <span class="comment">// 发出请求</span></span><br><span class="line">        IndexResponse response = client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 判断是否有失败</span></span><br><span class="line">        <span class="keyword">return</span> response.getShardInfo().getFailed() == <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，新增的时候需要做两件事情：</p>
<ul>
<li><p>获取文档数据中的ID属性：这里通过一个getID()方法来获取，这个方法暂时空实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getID</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// TODO 待完成</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>将文档转为JSON格式：这里通过Jackson的ObjectMapper来封装方法toJson()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toJson</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mapper.writeValueAsString(o);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">fromJson</span><span class="params">(String json)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mapper.readValue(json, clazz);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-2-5-批量新增"><a href="#1-2-5-批量新增" class="headerlink" title="1.2.5.批量新增"></a>1.2.5.批量新增</h3><p>批量新增时利用BulkRequest，把多个IndexRequest封装，然后一次请求中发出，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">saveAll</span><span class="params">(Iterable&lt;T&gt; iterable)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建批处理请求</span></span><br><span class="line">    BulkRequest request = <span class="keyword">new</span> BulkRequest();</span><br><span class="line">    <span class="comment">// 遍历要处理的文档集合，然后创建成IndexRequest，逐个添加到BulkRequest中</span></span><br><span class="line">    iterable.forEach(t -&gt; request.add(<span class="keyword">new</span> IndexRequest(indexName).id(getID(t)).source(toJson(t), XContentType.JSON)));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 发送批处理请求</span></span><br><span class="line">        BulkResponse bulkResponse = client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 判断结果</span></span><br><span class="line">        <span class="keyword">if</span>(bulkResponse.status() != RestStatus.OK)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(bulkResponse.hasFailures())&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(bulkResponse.buildFailureMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-6-删除文档"><a href="#1-2-6-删除文档" class="headerlink" title="1.2.6.删除文档"></a>1.2.6.删除文档</h3><p>这里采用根据id删除文档的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteById</span><span class="params">(ID id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 准备请求</span></span><br><span class="line">        DeleteRequest request = <span class="keyword">new</span> DeleteRequest(indexName, id.toString());</span><br><span class="line">        <span class="comment">// 发出请求</span></span><br><span class="line">        DeleteResponse response = client.delete(request, RequestOptions.DEFAULT);</span><br><span class="line">        <span class="comment">// 判断是否有失败</span></span><br><span class="line">        <span class="keyword">return</span> response.getShardInfo().getFailed() == <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-7-根据id查询文档"><a href="#1-2-7-根据id查询文档" class="headerlink" title="1.2.7.根据id查询文档"></a>1.2.7.根据id查询文档</h3><p>查询业务采用异步操作，并将结果用Mono封装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;T&gt; <span class="title">queryById</span><span class="params">(ID id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通过Mono.create函数来构建一个Mono，sink用来发布查询到的数据或失败结果</span></span><br><span class="line">    <span class="keyword">return</span> Mono.create(sink -&gt; &#123;</span><br><span class="line">        <span class="comment">// 开启异步查询</span></span><br><span class="line">        client.getAsync(</span><br><span class="line">            <span class="keyword">new</span> GetRequest(indexName, id.toString()),</span><br><span class="line">            RequestOptions.DEFAULT,</span><br><span class="line">            <span class="comment">// 异步回调</span></span><br><span class="line">            <span class="keyword">new</span> ActionListener&lt;GetResponse&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(GetResponse response)</span> </span>&#123;</span><br><span class="line">                    <span class="comment">// 判断查询是否成功</span></span><br><span class="line">                    <span class="keyword">if</span> (!response.isExists()) &#123;</span><br><span class="line">                        <span class="comment">// 不成功则返回错误</span></span><br><span class="line">                        sink.error(<span class="keyword">new</span> RuntimeException(<span class="string">&quot;文档不存在！&quot;</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 成功时的回调，</span></span><br><span class="line">                    sink.success(fromJson(response.getSourceAsString()));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">                    <span class="comment">// 失败时的回调</span></span><br><span class="line">                    sink.error(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-8-搜索并分页、高亮、排序"><a href="#1-2-8-搜索并分页、高亮、排序" class="headerlink" title="1.2.8.搜索并分页、高亮、排序"></a>1.2.8.搜索并分页、高亮、排序</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO 等待后续完成</span></span><br><span class="line"><span class="comment"> * T 类型的字节码，将来需要知道，这样才能把查询到的JSON的反序列化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Class&lt;T&gt; clazz;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;PageInfo&lt;T&gt;&gt; queryBySourceBuilderForPageHighlight(SearchSourceBuilder sourceBuilder) &#123;</span><br><span class="line">    <span class="keyword">return</span> Mono.create(sink -&gt; &#123;</span><br><span class="line">        <span class="comment">// 准备搜索请求，并接受用户提交的查询参数</span></span><br><span class="line">        SearchRequest request = <span class="keyword">new</span> SearchRequest(indexName).source(sourceBuilder);</span><br><span class="line">        <span class="comment">// 发送异步请求</span></span><br><span class="line">        client.searchAsync(request, RequestOptions.DEFAULT, <span class="keyword">new</span> ActionListener&lt;SearchResponse&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(SearchResponse response)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 成功的回调函数</span></span><br><span class="line">                <span class="keyword">if</span> (response.status() != RestStatus.OK) &#123;</span><br><span class="line">                    sink.error(<span class="keyword">new</span> RuntimeException(<span class="string">&quot;查询失败&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 处理返回结果</span></span><br><span class="line">                <span class="comment">// 获取命中的结果</span></span><br><span class="line">                SearchHits searchHits = response.getHits();</span><br><span class="line">                <span class="comment">// 总条数</span></span><br><span class="line">                <span class="keyword">long</span> total = searchHits.getTotalHits().value;</span><br><span class="line">                <span class="comment">// 数据</span></span><br><span class="line">                SearchHit[] hits = searchHits.getHits();</span><br><span class="line">                <span class="comment">// 处理数据</span></span><br><span class="line">                List&lt;T&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(hits.length);</span><br><span class="line">                <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                    T t = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 把查询到的json反序列化为T类型</span></span><br><span class="line">                        t = mapper.readValue(hit.getSourceAsString(), clazz);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        sink.error(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    list.add(t);</span><br><span class="line">                    <span class="comment">// 获取高亮结果的集合</span></span><br><span class="line">                    Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">                    <span class="comment">// 判断是否有高亮</span></span><br><span class="line">                    <span class="keyword">if</span> (!CollectionUtils.isEmpty(highlightFields)) &#123;</span><br><span class="line">                        <span class="comment">// 遍历高亮字段</span></span><br><span class="line">                        <span class="keyword">for</span> (HighlightField highlightField : highlightFields.values()) &#123;</span><br><span class="line">                            <span class="comment">// 获取字段名称</span></span><br><span class="line">                            String fieldName = highlightField.getName();</span><br><span class="line">                            <span class="comment">// 获取高亮值</span></span><br><span class="line">                            String value = StringUtils.join(highlightField.getFragments());</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="comment">// 把高亮值注入 t 中</span></span><br><span class="line">                                BeanUtils.setProperty(t, fieldName, value);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                                sink.error(e);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 发布分页结果</span></span><br><span class="line">                sink.success(<span class="keyword">new</span> PageInfo&lt;&gt;(total, list));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 失败回调</span></span><br><span class="line">                sink.error(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-9-自动补全"><a href="#1-2-9-自动补全" class="headerlink" title="1.2.9.自动补全"></a>1.2.9.自动补全</h3><p>异步实现查询：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;List&lt;String&gt;&gt; suggestBySingleField(String suggestField, String prefixKey) &#123;</span><br><span class="line">    <span class="keyword">return</span> Mono.create(sink -&gt; &#123;</span><br><span class="line">        <span class="comment">// 准备查询条件</span></span><br><span class="line">        SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        sourceBuilder.suggest(<span class="keyword">new</span> SuggestBuilder()</span><br><span class="line">                              .addSuggestion(<span class="string">&quot;mySuggestion&quot;</span>,</span><br><span class="line">                                             SuggestBuilders.completionSuggestion(suggestField).prefix(prefixKey)</span><br><span class="line">                                             .size(<span class="number">30</span>).skipDuplicates(<span class="keyword">true</span>)));</span><br><span class="line">        <span class="comment">// 准备请求对象</span></span><br><span class="line">        SearchRequest request = <span class="keyword">new</span> SearchRequest(indexName).source(sourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送异步请求</span></span><br><span class="line">        client.searchAsync(request, RequestOptions.DEFAULT, <span class="keyword">new</span> ActionListener&lt;SearchResponse&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(SearchResponse response)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 成功的回调函数</span></span><br><span class="line">                <span class="keyword">if</span> (response.status() != RestStatus.OK) &#123;</span><br><span class="line">                    sink.error(<span class="keyword">new</span> RuntimeException(<span class="string">&quot;查询失败&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 处理结果</span></span><br><span class="line">                List&lt;String&gt; list = handleSuggestResponse(response);</span><br><span class="line">                <span class="comment">// 发布数据</span></span><br><span class="line">                sink.success(list);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">                sink.error(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">handleSuggestResponse</span><span class="params">(SearchResponse response)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> StreamSupport.stream(response.getSuggest().spliterator(), <span class="keyword">true</span>)</span><br><span class="line">        .map(s -&gt; (CompletionSuggestion) s)</span><br><span class="line">        .map(CompletionSuggestion::getOptions)</span><br><span class="line">        .flatMap(List::stream)</span><br><span class="line">        .map(CompletionSuggestion.Entry.Option::getText)</span><br><span class="line">        .map(Text::string)</span><br><span class="line">        .distinct()</span><br><span class="line">        .filter(StringUtils::isNotBlank)</span><br><span class="line">        .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>



<h3 id="1-2-10-获取泛型中的类型信息（了解）"><a href="#1-2-10-获取泛型中的类型信息（了解）" class="headerlink" title="1.2.10.获取泛型中的类型信息（了解）"></a>1.2.10.获取泛型中的类型信息（了解）</h3><p>在之前开发工具类的时候，我们发现需要获取泛型T和ID的具体类型，这两个东西只有在用户实现我们的接口时指定。</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyRepository</span> <span class="keyword">extends</span> <span class="title">Repository</span>&lt;<span class="title">IndexData</span>, <span class="title">Long</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>



<p>我们可以利用反射来拿到接口上的泛型，不过需要用户把自己定义的MyRepository接口字节码通过构造函数传递给我们：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RepositoryHandler</span><span class="params">(RestHighLevelClient client, Class&lt;?&gt; repositoryInterface)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.client = client;</span><br><span class="line">	<span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后，我们就可以利用反射来拿到泛型信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * T对应的字节码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; clazz;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ID对应的字节码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;ID&gt; idType;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RepositoryHandler</span><span class="params">(RestHighLevelClient client, Class&lt;?&gt; repositoryInterface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.client = client;</span><br><span class="line">    <span class="comment">// 参数的接口应该是这样的：interface MyRepository extends Repository&lt;IndexData, Long&gt;</span></span><br><span class="line">    <span class="comment">// 反射获取接口声明的泛型</span></span><br><span class="line">    ParameterizedType parameterizedType = (ParameterizedType) repositoryInterface.getGenericInterfaces()[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 获取泛型对应的真实类型,这里有2个，&lt;IndexData, Long&gt;</span></span><br><span class="line">    Type[] actualType = parameterizedType.getActualTypeArguments();</span><br><span class="line">    <span class="comment">// 我们取数组的第一个，肯定是T的类型，即实体类类型</span></span><br><span class="line">    <span class="keyword">this</span>.clazz = (Class&lt;T&gt;) actualType[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 我们取数组的第一个，肯定是ID的类型，即ID的类型</span></span><br><span class="line">    <span class="keyword">this</span>.idType = (Class&lt;ID&gt;) actualType[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-11-获取索引库名称和ID属性（了解）"><a href="#1-2-11-获取索引库名称和ID属性（了解）" class="headerlink" title="1.2.11.获取索引库名称和ID属性（了解）"></a>1.2.11.获取索引库名称和ID属性（了解）</h3><p>索引库操作必须知道两个东西：</p>
<ul>
<li>索引库名称</li>
<li>文档中哪个属性是ID</li>
</ul>
<p>我们定义工具的时候是不确定的，将来由使用者来告诉我们，之前是通过通过构造函数传递？太low了！我们可以这样做：</p>
<ul>
<li><p>自定义注解，用来获取索引库、ID信息</p>
<ul>
<li>@Index：加在与索引库相关的实体类上，声明索引库名称</li>
<li>@Id：加在实体类的某个字段上，声明这个字段作为ID</li>
</ul>
</li>
<li><p>使用者准备实体类，并在实体类上使用我们的注解，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Index(&quot;myIndex&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexData</span></span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>我们利用反射获取IndexData注解信息，即可得知索引库和ID信息</p>
</li>
</ul>
<h4 id="1）自定义注解"><a href="#1）自定义注解" class="headerlink" title="1）自定义注解"></a>1）自定义注解</h4><p>我们在<code>com.leyou.starter.elastic.annotaions</code>包下自定义两个注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.starter.elastic.annotaions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 标记一个索引库信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Index &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 索引库名称，必填</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 索引库名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ID的注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.starter.elastic.annotaions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 标记实体类中的id字段</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(ElementType.FIELD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Id &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2）反射获取注解信息"><a href="#2）反射获取注解信息" class="headerlink" title="2）反射获取注解信息"></a>2）反射获取注解信息</h4><p>继续在RepositoryHandler的构造函数中完成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * id字段名称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String id;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * id字段</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Field idField;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 索引库的名称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String indexName;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RepositoryHandler</span><span class="params">(RestHighLevelClient client, Class&lt;?&gt; repositoryInterface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.client = client;</span><br><span class="line">    <span class="comment">// 参数的接口应该是这样的：interface MyRepository extends Repository&lt;IndexData, Long&gt;</span></span><br><span class="line">    <span class="comment">// 反射获取接口声明的泛型。&lt;IndexData, Long&gt;</span></span><br><span class="line">    ParameterizedType parameterizedType = (ParameterizedType) repositoryInterface.getGenericInterfaces()[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 获取泛型对应的真实类型,这里有2个，&lt;IndexData, Long&gt;</span></span><br><span class="line">    Type[] actualType = parameterizedType.getActualTypeArguments();</span><br><span class="line">    <span class="comment">// 我们取数组的第一个，肯定是T的类型，即实体类类型</span></span><br><span class="line">    <span class="keyword">this</span>.clazz = (Class&lt;T&gt;) actualType[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 我们取数组的第一个，肯定是ID的类型，即ID的类型</span></span><br><span class="line">    <span class="keyword">this</span>.idType = (Class&lt;ID&gt;) actualType[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 利用反射获取注解</span></span><br><span class="line">    <span class="keyword">if</span> (clazz.isAnnotationPresent(Index.class)) &#123;</span><br><span class="line">        <span class="comment">// 获取@Index注解</span></span><br><span class="line">        Index indices = clazz.getAnnotation(Index.class);</span><br><span class="line">        <span class="comment">// 获取索引库及类型名称</span></span><br><span class="line">        indexName = indices.value();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 没有注解，我们用类名称首字母小写，作为索引库名称</span></span><br><span class="line">        String simpleName = clazz.getSimpleName();</span><br><span class="line">        indexName = simpleName.substring(<span class="number">0</span>, <span class="number">1</span>).toLowerCase() + simpleName.substring(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取带有@Id注解的字段：</span></span><br><span class="line">    <span class="comment">// 获取所有字段</span></span><br><span class="line">    Field[] fields = clazz.getDeclaredFields();</span><br><span class="line">    <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 判断是否包含@Id注解</span></span><br><span class="line">        <span class="keyword">if</span> (field.isAnnotationPresent(Id.class)) &#123;</span><br><span class="line">            id = field.getName();</span><br><span class="line">            idField = field;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 没有发现包含@Id的字段，抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(id)) &#123;</span><br><span class="line">        <span class="comment">// 没有找到id字段，则抛出异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;实体类中必须有一个字段标记@IndexID注解。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3）getId方法"><a href="#3）getId方法" class="headerlink" title="3）getId方法"></a>3）getId方法</h4><p>之前有一个getId的方法未完成，现在可以写完了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getID</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(t == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(t.getClass().getName() + <span class="string">&quot;实例不能为null！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object value = idField.get(t);</span><br><span class="line">        <span class="keyword">return</span> value == <span class="keyword">null</span> ? <span class="keyword">null</span> : value.toString();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;实体类中没有id字段或者id字段没有get方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="1-3-与spring整合（了解）"><a href="#1-3-与spring整合（了解）" class="headerlink" title="1.3.与spring整合（了解）"></a>1.3.与spring整合（了解）</h2><p>在这一部分我们需要利用动态代理动态的给Repository接口生成实现类，并且注入到Spring容器。</p>
<h3 id="1-3-1-动态代理"><a href="#1-3-1-动态代理" class="headerlink" title="1.3.1.动态代理"></a>1.3.1.动态代理</h3><p>用户使用的时候会定义接口并继承我们的接口，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyRepository</span> <span class="keyword">extends</span> <span class="title">Repository</span>&lt;<span class="title">IndexData</span>, <span class="title">Long</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>而我们要动态代理来生成<code>MyRepository</code>的实现类。动态代理的API如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Proxy.newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h) </span><br></pre></td></tr></table></figure>

<p>需要三个参数：</p>
<ul>
<li>ClassLoader loader：类加载器，用当前类的类加载器即可</li>
<li>Class&lt;?&gt;[] interfaces：要代理的接口，这里就是Repository接口</li>
<li>InvocationHandler h：代理处理器，执行真正的业务逻辑</li>
</ul>
<p>我们可以把刚刚的RepositoryHandler作为InvocationHandler来实现，简单改造下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepositoryHandler</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; <span class="keyword">implements</span> <span class="title">Repository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt;, <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ....略</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// object 方法，走原生方法</span></span><br><span class="line">        <span class="keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>,args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 其它走本地代理</span></span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>生成动态代理对象可以这样做：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Proxy.newProxyInstance(</span><br><span class="line">    <span class="comment">// 类加载器</span></span><br><span class="line">    Repository.getClass().getClassLoader(),</span><br><span class="line">    <span class="comment">// 接口</span></span><br><span class="line">    <span class="keyword">new</span> Class[]&#123;Repository.class&#125;,</span><br><span class="line">    <span class="comment">// 代理处理器，构造函数需要一些参数</span></span><br><span class="line">    <span class="keyword">new</span> RepositoryHandler(clazz, client)</span><br><span class="line">) </span><br></pre></td></tr></table></figure>



<h3 id="1-3-2-FactoryBean"><a href="#1-3-2-FactoryBean" class="headerlink" title="1.3.2.FactoryBean"></a>1.3.2.FactoryBean</h3><p>为了方便与Spring整合，我们需要定义一个创建bean的工厂：<code>FactoryBean&lt;Repository&gt;</code>.</p>
<p>在<code>com.leyou.starter.elastic.repository</code>包中定义FactoryBean代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.starter.elastic.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.FactoryBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepositoryFactory</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">	<span class="comment">// 日志记录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(RepositoryFactory.class);</span><br><span class="line">	<span class="comment">// 被代理的接口，就是例子中的MyRepository</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;T&gt; interfaceType;</span><br><span class="line">    <span class="comment">// elasticsearch客户端</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RepositoryFactory</span><span class="params">(Class&lt;T&gt; interfaceType, RestHighLevelClient client)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;RepositoryFactory init ...&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.interfaceType = interfaceType;</span><br><span class="line">        <span class="keyword">this</span>.client = client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;RepositoryBean proxy init ...&quot;</span>);</span><br><span class="line">        <span class="comment">// 生成动态代理对象并返回</span></span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(interfaceType.getClassLoader(), <span class="keyword">new</span> Class[]&#123;interfaceType&#125;,</span><br><span class="line">                <span class="keyword">new</span> RepositoryHandler(client, interfaceType));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> interfaceType;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-3-3-注入Bean到容器"><a href="#1-3-3-注入Bean到容器" class="headerlink" title="1.3.3.注入Bean到容器"></a>1.3.3.注入Bean到容器</h3><p>实现动态代理并注入spring分这样几步：</p>
<ul>
<li>扫描包，找到项目中的接口</li>
<li>过滤出所有的继承了<code>Repository</code>接口的接口，例如<code>MyRepository</code></li>
<li>给扫描到的接口生成 <code>BeanDefinition</code></li>
<li>将<code>BeanDefinition</code>注册到Spring容器</li>
</ul>
<h4 id="1）完整代码"><a href="#1）完整代码" class="headerlink" title="1）完整代码"></a>1）完整代码</h4><p>在<code>com.leyou.starter.elastic.scanner</code>中定义一个扫描器<code>RepositoryScanner</code>，完整代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.starter.elastic.scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.starter.elastic.repository.Repository;</span><br><span class="line"><span class="keyword">import</span> com.leyou.starter.elastic.repository.RepositoryFactory;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionRegistryPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.GenericBeanDefinition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigurationPackages;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ResourceLoaderAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ResourceLoader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.ResourcePatternResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.ResourcePatternUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.classreading.CachingMetadataReaderFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.classreading.MetadataReader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.classreading.MetadataReaderFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ClassUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepositoryScanner</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionRegistryPostProcessor</span>, <span class="title">ResourceLoaderAware</span>, <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_RESOURCE_PATTERN = <span class="string">&quot;**/*.class&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MetadataReaderFactory metadataReaderFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ResourcePatternResolver resourcePatternResolver;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RepositoryScanner</span><span class="params">(RestHighLevelClient client)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.client = client;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry beanDefinitionRegistry)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取启动类所在包</span></span><br><span class="line">        List&lt;String&gt; packages = AutoConfigurationPackages.get(applicationContext);</span><br><span class="line">        <span class="comment">// 开始扫描包，获取字节码</span></span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; beanClazzSet = scannerPackages(packages.get(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">for</span> (Class beanClazz : beanClazzSet) &#123;</span><br><span class="line">            <span class="comment">// 判断是否是repository</span></span><br><span class="line">            <span class="keyword">if</span>(isNotElasticsearchRepository(beanClazz))&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// BeanDefinition构建器</span></span><br><span class="line">            BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(beanClazz);</span><br><span class="line">            GenericBeanDefinition definition = (GenericBeanDefinition) builder.getRawBeanDefinition();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//在这里，我们可以给该对象的属性注入对应的实例。</span></span><br><span class="line">            definition.getConstructorArgumentValues().addGenericArgumentValue(beanClazz);</span><br><span class="line">            definition.getConstructorArgumentValues().addIndexedArgumentValue(<span class="number">1</span>, client);</span><br><span class="line">            <span class="comment">// 定义Bean工程</span></span><br><span class="line">            definition.setBeanClass(RepositoryFactory.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//这里采用的是byType方式注入，类似的还有byName等</span></span><br><span class="line">            definition.setAutowireMode(GenericBeanDefinition.AUTOWIRE_BY_TYPE);</span><br><span class="line">            String simpleName = beanClazz.getSimpleName();</span><br><span class="line">            simpleName = simpleName.substring(<span class="number">0</span>, <span class="number">1</span>).toLowerCase() + simpleName.substring(<span class="number">1</span>);</span><br><span class="line">            beanDefinitionRegistry.registerBeanDefinition(simpleName, definition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isNotElasticsearchRepository</span><span class="params">(Class beanClazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> !beanClazz.isInterface() || beanClazz.getInterfaces().length &lt;= <span class="number">0</span> || beanClazz.getInterfaces()[<span class="number">0</span>] != Repository.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据包路径获取包及子包下的所有类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basePackage basePackage</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Set&lt;Class&lt;?&gt;&gt; Set&lt;Class&lt;?&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Class&lt;?&gt;&gt; scannerPackages(String basePackage) &#123;</span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; set = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">        String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +</span><br><span class="line">                resolveBasePackage(basePackage) + <span class="string">&#x27;/&#x27;</span> + DEFAULT_RESOURCE_PATTERN;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Resource[] resources = <span class="keyword">this</span>.resourcePatternResolver.getResources(packageSearchPath);</span><br><span class="line">            <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">                <span class="keyword">if</span> (resource.isReadable()) &#123;</span><br><span class="line">                    MetadataReader metadataReader = <span class="keyword">this</span>.metadataReaderFactory.getMetadataReader(resource);</span><br><span class="line">                    String className = metadataReader.getClassMetadata().getClassName();</span><br><span class="line">                    Class&lt;?&gt; clazz;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        clazz = Class.forName(className);</span><br><span class="line">                        set.add(clazz);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">resolveBasePackage</span><span class="params">(String basePackage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ClassUtils.convertClassNameToResourcePath(</span><br><span class="line">                <span class="keyword">this</span>.applicationContext.getEnvironment().resolveRequiredPlaceholders(basePackage));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResourceLoader</span><span class="params">(ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.resourcePatternResolver = ResourcePatternUtils.getResourcePatternResolver(resourceLoader);</span><br><span class="line">        <span class="keyword">this</span>.metadataReaderFactory = <span class="keyword">new</span> CachingMetadataReaderFactory(resourceLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory configurableListableBeanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2）扫描包"><a href="#2）扫描包" class="headerlink" title="2）扫描包"></a>2）扫描包</h4><p>扫描启动类所在的包，加载所有的字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据包路径获取包及子包下的所有类</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> basePackage basePackage</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Set&lt;Class   &lt;   ?&gt;&gt; Set&lt;Class&lt;?&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> Set&lt;Class&lt;?&gt;&gt; scannerPackages(String basePackage) &#123;</span><br><span class="line">    <span class="comment">// 准备集合，装扫描到的类</span></span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; set = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">    <span class="comment">// 设置要扫描的文件路径匹配模板 classpath*:/xx/xx/**/*.class</span></span><br><span class="line">    String packageSearchPath =</span><br><span class="line">        <span class="comment">// classpath*:</span></span><br><span class="line">        ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +</span><br><span class="line">        <span class="comment">// 启动类所在包</span></span><br><span class="line">        resolveBasePackage(basePackage) +</span><br><span class="line">        <span class="comment">// **/*.class</span></span><br><span class="line">        <span class="string">&#x27;/&#x27;</span> + DEFAULT_RESOURCE_PATTERN;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 读取符合匹配模板的所有文件</span></span><br><span class="line">        Resource[] resources = <span class="keyword">this</span>.resourcePatternResolver.getResources(packageSearchPath);</span><br><span class="line">        <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resource.isReadable()) &#123;</span><br><span class="line">                MetadataReader metadataReader = <span class="keyword">this</span>.metadataReaderFactory.getMetadataReader(resource);</span><br><span class="line">                <span class="comment">// 读取类名称</span></span><br><span class="line">                String className = metadataReader.getClassMetadata().getClassName();</span><br><span class="line">                Class&lt;?&gt; clazz;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 加载为字节码</span></span><br><span class="line">                    clazz = Class.forName(className);</span><br><span class="line">                    set.add(clazz);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> set;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3）定义BeanDefinition并注册"><a href="#3）定义BeanDefinition并注册" class="headerlink" title="3）定义BeanDefinition并注册"></a>3）定义BeanDefinition并注册</h4><p>要注册BeanDefinition，可以通过实现<strong>后处理器</strong><code>BeanDefinitionRegistryPostProcessor</code>来达成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这个接口允许你在Spring容器中注册更多的Bean。通过BeanDefinitionRegistry中的方法来</span></span><br><span class="line"><span class="comment"> * 完成注册</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanDefinitionRegistryPostProcessor</span> <span class="keyword">extends</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的<code>RepositoryScanner</code>实现了这个接口：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200718212814098.png" alt="image-20200718212814098"></p>
<p>并且实现了对应的方法：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200517211638324.png" alt="image-20200517211638324"></p>
<p>在这个方法中，我们过滤出哪些实现了Repository接口的class：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200517210608698.png" alt="image-20200517210608698"></p>
<p>isNotElasticsearchRepository方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isNotElasticsearchRepository</span><span class="params">(Class beanClazz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !beanClazz.isInterface() || beanClazz.getInterfaces().length &lt;= <span class="number">0</span> || beanClazz.getInterfaces()[<span class="number">0</span>] != Repository.class;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>并且通过BeanDefinitionBuilder来构建BeanDefinition:</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200517211823253.png" alt="image-20200517211823253"></p>
<h2 id="1-4-编写starter-了解"><a href="#1-4-编写starter-了解" class="headerlink" title="1.4.编写starter(了解)"></a>1.4.编写starter(了解)</h2><p>starter的目的是减少用户要做的配置，并且让这些配置自动被扫描生效。在当前案例中，我们需要让之前写的<code>RepositoryScanner</code>这个类可以被实例化，并注册为一个Spring的Bean。而<code>RepositoryScanner</code>在实例化的时候又需要1个东西：</p>
<ul>
<li>HighLevelRestClient对象</li>
</ul>
<p>而HighLevelRestClient对象在初始化的过程中，又需要知道elasticsearch集群的地址信息。</p>
<h3 id="1-4-1-读取elasticsearch地址"><a href="#1-4-1-读取elasticsearch地址" class="headerlink" title="1.4.1.读取elasticsearch地址"></a>1.4.1.读取elasticsearch地址</h3><p>我们约定用户会在yml文件中添加这样的配置来指定elasticsearch的地址：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ly:</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">hosts:</span> <span class="string">http://192.168.206.99:9200</span></span><br></pre></td></tr></table></figure>

<p>那么我们就必须通过代码去读取这些配置。</p>
<p>我们在<code>com.leyou.starter.elastic.config</code>包中，创建一个配置类<code>ElasticSearchAutoConfiguration</code>，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.starter.elastic.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.stream.Stream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticSearchAutoConfiguration</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line">	<span class="comment">// elasticsearch的地址，默认是本机</span></span><br><span class="line">    <span class="keyword">private</span> String hosts = <span class="string">&quot;http://127.0.0.1:9200&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="comment">// 读取配置文件中的 &quot;ly.elasticsearch.hosts&quot;属性</span></span><br><span class="line">        <span class="keyword">this</span>.hosts = applicationContext.getEnvironment().getProperty(<span class="string">&quot;ly.elasticsearch.hosts&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解读：</p>
<ul>
<li><code>ApplicationContextAware</code>接口：<ul>
<li>spring中的Aware类型接口，Spring发现一个类实现了Aware接口，就会调用该接口的方法：<code>setApplicationContext(ApplicationContext applicationContext)</code>，并且将<code>ApplicationContext applicationContext</code>实例作为参数。这样我们就能拿到spring的容器了。</li>
</ul>
</li>
<li><code>applicationContext.getEnvironment().getProperty(&quot;ly.elasticsearch.hosts&quot;)</code>：读取配置环境中的属性，这里是读取”ly.elasticsearch.hosts”属性。</li>
</ul>
<h3 id="1-4-2-配置HighLevelRestClient"><a href="#1-4-2-配置HighLevelRestClient" class="headerlink" title="1.4.2.配置HighLevelRestClient"></a>1.4.2.配置HighLevelRestClient</h3><p>有了属性，接下来就可以创建HighLevelRestClient的实例了，接着在上面的配置类：<code>ElasticSearchAutoConfiguration</code>中编写代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.starter.elastic.config;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"><span class="keyword">import</span> java.util.stream.Stream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticSearchAutoConfiguration</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"> <span class="comment">// ...略</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestHighLevelClient <span class="title">restHighLevelClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">                <span class="comment">// 利用Builder构建器来初始化，接收HttpHost数组</span></span><br><span class="line">                RestClient.builder(</span><br><span class="line">                        <span class="comment">// 将地址以 , 分割得到其中的每个地址</span></span><br><span class="line">                        Stream.of(StringUtils.split(hosts, <span class="string">&quot;,&quot;</span>))</span><br><span class="line">                                <span class="comment">// 将单个地址封装为HttpHost对象</span></span><br><span class="line">                                .map(HttpHost::create)</span><br><span class="line">                                <span class="comment">// 转为HttpHost数组</span></span><br><span class="line">                                .toArray(HttpHost[]::<span class="keyword">new</span>)</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">// ...略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="1-4-3-注册RepositoryScanner"><a href="#1-4-3-注册RepositoryScanner" class="headerlink" title="1.4.3.注册RepositoryScanner"></a>1.4.3.注册<code>RepositoryScanner</code></h3><p>最后，我们来讲RepositoryScanner创建对象，并注入到Spring中。接着在上面的配置类：<code>ElasticSearchAutoConfiguration</code>中编写代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.starter.elastic.config;</span><br><span class="line"><span class="comment">// ...略</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;Mono.class, Flux.class, RestHighLevelClient.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticSearchAutoConfiguration</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...略</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RepositoryScanner <span class="title">repositoryScanner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RepositoryScanner(restHighLevelClient());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意，类上我们加了注解：</p>
<ul>
<li><code>@ConditionalOnClass(&#123;Mono.class, Flux.class, RestHighLevelClient.class&#125;)</code>：当这些类存在配置才生效</li>
</ul>
<h3 id="1-4-4-配置spring-factories"><a href="#1-4-4-配置spring-factories" class="headerlink" title="1.4.4.配置spring.factories"></a>1.4.4.配置spring.factories</h3><p>最后，为了让引用当前starter的项目可以读取到我们写的配置类，我们需要在classpath下的META-INF文件夹下，新增一个spring.factories文件，内容如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Auto Configure</span></span><br><span class="line"><span class="meta">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">com.leyou.starter.elastic.config.ElasticSearchAutoConfiguration</span></span><br></pre></td></tr></table></figure>

<p>另外，为了让用户编写application.yml文件时有提示，我们可以在META-INF文件夹下再新建一个文件，内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;properties&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ly.elasticsearch.hosts&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;java.lang.String&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;elasticsearch集群中节点信息，多个以,隔开&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span>: <span class="string">&quot;http://127.0.0.1:9200&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>结构如图：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200605213500742.png" alt="image-20200605213500742"> </p>
<h1 id="2-安装es的starter到仓库"><a href="#2-安装es的starter到仓库" class="headerlink" title="2.安装es的starter到仓库"></a>2.安装es的starter到仓库</h1><h2 id="2-1-安装到本地仓库"><a href="#2-1-安装到本地仓库" class="headerlink" title="2.1.安装到本地仓库"></a>2.1.安装到本地仓库</h2><p>最后，我们把整个项目install到本地仓库中。</p>
<p>可以使用课前资料提供的<code>elasticsearch-spring-boot-starter</code>项目即可：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200605213737162.png" alt="image-20200605213737162"> </p>
<p>然后有两种安装方式。</p>
<h3 id="2-1-1-IDEA导入"><a href="#2-1-1-IDEA导入" class="headerlink" title="2.1.1.IDEA导入"></a>2.1.1.IDEA导入</h3><p>你可以使用Idea直接打开项目，查看源码：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200313121102412.png" alt="image-20200313121102412"> </p>
<p>然后在窗口的右侧，通过maven窗口中的install命令，安装代码到本地仓库：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200313121243671.png" alt="image-20200313121243671"> </p>
<h3 id="2-1-2-命令行导入"><a href="#2-1-2-命令行导入" class="headerlink" title="2.1.2.命令行导入"></a>2.1.2.命令行导入</h3><p>IDEA方式安装本地仓库并不包含源码，如果要把源码也安装到本地仓库，需要执行mvn命令。</p>
<p>在项目根目录下，打开控制台，输入命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn <span class="built_in">source</span>:jar install -Dmaven.test.skip=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>如图：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200313121817564.png" alt="image-20200313121817564"></p>
<p>打开本地仓库目录，可以看到已经安装完毕：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200313121953687.png" alt="image-20200313121953687"> </p>
<p>使用方法1，生成不了上面的xxx-resources.jar 文件，maven配置，本地仓库都配置好了，还是不行；<strong>使用方法二命令行的方式就可以生成全部文件！</strong></p>
<h2 id="2-2-功能测试"><a href="#2-2-功能测试" class="headerlink" title="2.2.功能测试"></a>2.2.功能测试</h2><p>下面，我们通过案例来演示下如何使用。</p>
<h3 id="2-2-1-创建demo工程"><a href="#2-2-1-创建demo工程" class="headerlink" title="2.2.1.创建demo工程"></a>2.2.1.创建demo工程</h3><p>首先，我们创建一个新的工程：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200313194238042.png" alt="image-20200313194238042"></p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200313194243560.png" alt="image-20200313194243560"></p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200313194229515.png" alt="image-20200313194229515"></p>
<p>在pom文件中加入自定义的starter的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--自定义elasticsearch的starter--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>**上面好不容易install的时候有了xxx-resources.jar 文件，但是这里导入依赖又不成功，原因是elasticsearch-spring-boot-starter文件夹放到了starter文件夹下面，参照前面导入依赖时，<artifactId>与<groupId>之间是没有其他层级目录的，因此将elasticsearch-spring-boot-starter文件夹拷贝到starter同级目录，然后将starter删除后就可以正常导进来了！！！,**或者不用那么繁琐操作，直接在com.leyou后面加个.starter，不用删除，移动文件夹位置！</p>
<p>另外，SpringBoot会自定义es的版本为6.4.3，<strong>这里要强制修改为7.4.2</strong>，下面我们集成到项目中时就不用管了，<strong>因为父工程leyou.com已经帮我们做了这个属性限定！</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">elasticsearch.version</span>&gt;</span>7.4.2<span class="tag">&lt;/<span class="name">elasticsearch.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>完整依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.itcast.demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>es-starter-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>es-starter-demo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">elasticsearch.version</span>&gt;</span>7.4.2<span class="tag">&lt;/<span class="name">elasticsearch.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--自定义elasticsearch的starter--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou.starter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>在<code>cn.itcast</code>包创建启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsStarterDemoApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EsStarterDemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在application.yml中配置日志级别：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">cn.itcast:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>





<h3 id="2-2-2-初始化"><a href="#2-2-2-初始化" class="headerlink" title="2.2.2.初始化"></a>2.2.2.初始化</h3><h4 id="1）配置地址"><a href="#1）配置地址" class="headerlink" title="1）配置地址"></a>1）配置地址</h4><p>接下来，我们在<code>application.yml</code>中添加elasticsearch地址</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">cn.itcast:</span> <span class="string">debug</span></span><br><span class="line"></span><br><span class="line"><span class="attr">elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">http://39.108.67.244:9200</span></span><br></pre></td></tr></table></figure>



<h4 id="2）编写实体类"><a href="#2）编写实体类" class="headerlink" title="2）编写实体类"></a>2）编写实体类</h4><p>我们准备一个实体类，测试数据CRUD：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.demo.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.starter.elastic.annotation.IndexID;</span><br><span class="line"><span class="keyword">import</span> com.leyou.starter.elastic.annotation.Indices;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Indexed;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Indices(&quot;goods&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Goods</span> </span>&#123;</span><br><span class="line">    <span class="meta">@IndexID</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> Long price;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要注意，我们的自定义starter会帮我们实现各种增删改查的功能，不过需要通过两个注解来声明索引库信息：</p>
<ul>
<li><code>@Index(&quot;goods&quot;)</code>：声明实体类相关的索引库名称，如果没指定，会以类名首字母小写后做索引库名称</li>
<li><code>@Id</code>：实体类中的id字段的类型，名称可以不叫id，只要加注解就可以</li>
</ul>
<h4 id="3）准备客户端Repository"><a href="#3）准备客户端Repository" class="headerlink" title="3）准备客户端Repository"></a>3）准备客户端Repository</h4><p>我们在<code>cn.itcast.demo.repository</code>包中创建一个接口：<code>GoodsRepository</code>，然后要继承工具包中的接口：Repository，将来该接口就会被动态代理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.demo.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.itcast.demo.pojo.Goods;</span><br><span class="line"><span class="keyword">import</span> com.leyou.starter.elastic.repository.Repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GoodsRepository</span> <span class="keyword">extends</span> <span class="title">Repository</span>&lt;<span class="title">Goods</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-2-3-创建索引库"><a href="#2-2-3-创建索引库" class="headerlink" title="2.2.3.创建索引库"></a>2.2.3.创建索引库</h3><p>先来测试创建索引库:</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200314203242102.png" alt="image-20200314203242102"> </p>
<p>说明，这里索引库名称会根据Repository泛型的实体类来判断，因此其它配置如：settings、mapping需要通过参数指定。参数的格式是json字符串，与kibana中的参数一致，我们可以把kibana中的json复制，粘贴进去即可:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;my_pinyin&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;tokenizer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;filter&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;py&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;py&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;pinyin&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;keep_full_pinyin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;keep_joined_full_pinyin&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;keep_original&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;limit_first_letter_length&quot;</span>: <span class="number">16</span>,</span><br><span class="line">          <span class="attr">&quot;remove_duplicated_term&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;completion&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;my_pinyin&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;my_pinyin&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;price&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;long&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.itcast.demo.pojo.Goods;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.demo.repository.GoodsRepository;</span><br><span class="line"><span class="comment">//import com.leyou.starter.elastic.dto.PageInfo;//自定义的start里面都没有dao这个包</span></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsStarterDemoApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GoodsRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建索引库</span></span><br><span class="line">        repository.createIndex(<span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;settings\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;analysis\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;analyzer\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;my_pinyin\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;tokenizer\&quot;: \&quot;ik_smart\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;filter\&quot;: [\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;py\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          ]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;filter\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;py\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;type\&quot;: \&quot;pinyin\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;keep_full_pinyin\&quot;: false,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;keep_joined_full_pinyin\&quot;: true,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;keep_original\&quot;: true,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;limit_first_letter_length\&quot;: 16,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;remove_duplicated_term\&quot;: true\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;mappings\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;properties\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;id\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;name\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;completion\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;analyzer\&quot;: \&quot;my_pinyin\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;title\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;analyzer\&quot;: \&quot;my_pinyin\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;search_analyzer\&quot;: \&quot;ik_smart\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;price\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;long\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="2-2-4-文档的CRUD"><a href="#2-2-4-文档的CRUD" class="headerlink" title="2.2.4.文档的CRUD"></a>2.2.4.文档的CRUD</h3><p>文档操作主要是新增文档、删除文档、查询文档</p>
<h4 id="1）新增文档"><a href="#1）新增文档" class="headerlink" title="1）新增文档"></a>1）新增文档</h4><p>API：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200314204715647.png" alt="image-20200314204715647"> </p>
<p>一个是单个增、一个是批量增。</p>
<p>代码示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单个文档的新增，id存在时会修改</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAddDocument</span><span class="params">()</span></span>&#123;</span><br><span class="line">    repository.save(<span class="keyword">new</span> Goods(<span class="number">1L</span>, <span class="string">&quot;红米9&quot;</span>, <span class="string">&quot;红米9手机 数码&quot;</span>, <span class="number">1499L</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 批量增</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAddBatch</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;Goods&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    list.add(<span class="keyword">new</span> Goods(<span class="number">1L</span>, <span class="string">&quot;红米9&quot;</span>, <span class="string">&quot;红米9手机 数码&quot;</span>, <span class="number">1499L</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Goods(<span class="number">2L</span>, <span class="string">&quot;三星 Galaxy A90&quot;</span>, <span class="string">&quot;三星 Galaxy A90 手机 数码 疾速5G 骁龙855&quot;</span>, <span class="number">3099L</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Goods(<span class="number">3L</span>, <span class="string">&quot;Sony WH-1000XM3&quot;</span>, <span class="string">&quot;Sony WH-1000XM3 降噪耳机 数码&quot;</span>, <span class="number">2299L</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Goods(<span class="number">4L</span>, <span class="string">&quot;松下剃须刀&quot;</span>, <span class="string">&quot;松下电动剃须刀高转速磁悬浮马达&quot;</span>, <span class="number">599L</span>));</span><br><span class="line"></span><br><span class="line">    repository.saveAll(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2）文档删除"><a href="#2）文档删除" class="headerlink" title="2）文档删除"></a>2）文档删除</h4><p>API：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200314210057075.png" alt="image-20200314210057075"> </p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDelete</span><span class="params">()</span></span>&#123;</span><br><span class="line">    repository.deleteById(<span class="number">1L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3）根据id查询"><a href="#3）根据id查询" class="headerlink" title="3）根据id查询"></a>3）根据id查询</h4><p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200314214423045.png" alt="image-20200314214423045"> </p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetById</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;开始查询。。。&quot;</span>);</span><br><span class="line">    Mono&lt;Goods&gt; mono = repository.queryById(<span class="number">2L</span>);</span><br><span class="line">    mono.subscribe(System.out::println);</span><br><span class="line">    log.info(<span class="string">&quot;查询结束。。。&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Thread.sleep(<span class="number">2000L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">开始查询</span><br><span class="line">查询结束</span><br><span class="line">Goods(id=2, name=三星A90, title=三星 Galaxy A90 手机 数码 疾速5G, price=2499)</span><br></pre></td></tr></table></figure>

<p>注意：<strong>使用subscribe订阅返回，：：：测试案例有订阅，开发中坚决不能写订阅；如果写了订阅相当于破坏了异步逻辑。</strong></p>
<h3 id="2-2-5-条件查询"><a href="#2-2-5-条件查询" class="headerlink" title="2.2.5.条件查询"></a>2.2.5.条件查询</h3><p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQuery</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// 搜索条件的构建器</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">// 1.查询条件</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;红米手机&quot;</span>));</span><br><span class="line">    <span class="comment">// 2.分页条件</span></span><br><span class="line">    sourceBuilder.from(<span class="number">0</span>);</span><br><span class="line">    sourceBuilder.size(<span class="number">20</span>);</span><br><span class="line">    <span class="comment">// 3.高亮条件</span></span><br><span class="line">    sourceBuilder.highlighter(<span class="keyword">new</span> HighlightBuilder().field(<span class="string">&quot;title&quot;</span>));</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;开始查询。。。&quot;</span>);</span><br><span class="line">    Mono&lt;PageInfo&lt;Goods&gt;&gt; mono = repository.queryBySourceBuilderForPageHighlight(sourceBuilder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    mono.subscribe(info -&gt; &#123;</span><br><span class="line">        <span class="keyword">long</span> total = info.getTotal();</span><br><span class="line">        System.out.println(<span class="string">&quot;total = &quot;</span> + total);</span><br><span class="line">        List&lt;Goods&gt; list = info.getContent();</span><br><span class="line">        list.forEach(System.out::println);</span><br><span class="line">    &#125;);</span><br><span class="line">    System.out.println(<span class="string">&quot;结束查询。。。&quot;</span>);</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">开始查询。。。</span><br><span class="line">结束查询。。。</span><br><span class="line">total = 2</span><br><span class="line">Goods(id=1, name=红米9, title=&lt;em&gt;红&lt;/em&gt;&lt;em&gt;米&lt;/em&gt;9&lt;em&gt;手机&lt;/em&gt; 数码, price=1499)</span><br><span class="line">Goods(id=2, name=三星 Galaxy A90, title=三星 Galaxy A90 &lt;em&gt;手机&lt;/em&gt; 数码 疾速5G 骁龙855, price=3099)</span><br></pre></td></tr></table></figure>



<h3 id="2-2-6-自动补全"><a href="#2-2-6-自动补全" class="headerlink" title="2.2.6.自动补全"></a>2.2.6.自动补全</h3><p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSuggest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;开始查询&quot;</span>);</span><br><span class="line">    Mono&lt;List&lt;String&gt;&gt; mono = repository.suggestBySingleField(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;s&quot;</span>);</span><br><span class="line">    mono.subscribe(list -&gt; list.forEach(System.out::println));</span><br><span class="line">    log.info(<span class="string">&quot;结束查询&quot;</span>);</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2020-06-05 23:06:00.645  INFO 35188 --- [           main] c.i.demo.EsStarterDemoApplicationTests   : 开始查询</span><br><span class="line">2020-06-05 23:06:00.806  INFO 35188 --- [           main] c.i.demo.EsStarterDemoApplicationTests   : 结束查询</span><br><span class="line">Sony WH-1000XM3</span><br><span class="line">三星 Galaxy A90</span><br><span class="line">松下剃须刀</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<pre><code>搜索支持容错
自动补全不支持容错
</code></pre>
<h1 id="3-数据导入"><a href="#3-数据导入" class="headerlink" title="3.数据导入"></a>3.数据导入</h1><h2 id="3-1-前台门户"><a href="#3-1-前台门户" class="headerlink" title="3.1.前台门户"></a>3.1.前台门户</h2><p>门户系统面向的是用户，安全性很重要，而且搜索引擎对于单页应用并不友好。因此我们的门户系统不再采用与后台系统类似的SPA（单页应用）。</p>
<p>依然是前后端分离，不过前端的页面会使用独立的html，在每个页面中使用vue来做页面渲染。</p>
<h3 id="3-1-1-解压"><a href="#3-1-1-解压" class="headerlink" title="3.1.1.解压"></a>3.1.1.解压</h3><p>将课前资料中的leyou-portal解压，并把结果复制到工作空间的目录</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/1526460560069.png" alt="1526460560069"></p>
<p>然后通过idea打开，可以看到项目结构：</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/1526460701617.png" alt="1526460701617"></p>
<h3 id="3-1-2-启动"><a href="#3-1-2-启动" class="headerlink" title="3.1.2.启动"></a>3.1.2.启动</h3><p>我们把静态资源代码用nginx去部署加载，即可在每次启动项目时直接访问到。</p>
<p>假设你的静态资源代码位置如图：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/1563965104443.png" alt="1563965104443"> </p>
<p>然后修改hosts文件，添加一行配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 www.leyou.com</span><br></pre></td></tr></table></figure>

<p>修改nginx配置，将<a href="http://www.leyou.com反向代理到你的目录中,不要出现中文目录：">www.leyou.com反向代理到你的目录中,不要出现中文目录：</a></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  www.leyou.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span>	F:/java/MyCode/leyouProject/leyou-portal;</span><br><span class="line">        <span class="attribute">index</span>	index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新加载nginx配置：<code>nginx.exe -s reload</code></p>
<p>然后访问即可：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/1526462774092.png" alt="1526462774092"></p>
<p>nginx 的几种功能介绍：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1</span> <span class="string">本机静态资源部署，</span></span><br><span class="line"><span class="comment">    # 匹配localhost下的一切路径</span></span><br><span class="line">    <span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line"><span class="comment">        # 默认资源去nginx目录下的html目录寻找</span></span><br><span class="line">        <span class="attr">root</span>   <span class="string">html;</span></span><br><span class="line">        <span class="attr">index</span>  <span class="string">index.html index.htm;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="comment">    # 访问：http://localhost/  就是nginx目录下的html文件夹下的资源</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">location</span> <span class="string">/gaominghui &#123;</span></span><br><span class="line">        <span class="attr">alias</span> <span class="string">F:/java/MyCode/leyouProject/leyou-portal/;</span></span><br><span class="line">        <span class="attr">index</span> <span class="string">index.html;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="comment">    # 访问：http://localhost/gaominghui/  就是F:/java/MyCode/leyouProject/leyou-portal/文件夹下的资源</span></span><br><span class="line"><span class="attr">2</span> <span class="string">本机静态资源反向代理，直接在外部conf配置文件进行如下配置就好：</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">listen</span>       <span class="string">80;</span></span><br><span class="line">        <span class="attr">server_name</span>  <span class="string">image.leyou.com;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line"><span class="comment">            # 默认资源去nginx目录下的html目录寻找</span></span><br><span class="line">            <span class="attr">root</span>   <span class="string">html;</span></span><br><span class="line">            <span class="attr">index</span>  <span class="string">/images/0/0/1524297512647.jpg;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">	<span class="attr">&#125;</span></span><br><span class="line"><span class="comment">	# 访问 http://image.leyou.com/ 就是访问nginx目录下的html文件夹下的资源</span></span><br><span class="line">	</span><br><span class="line">    <span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">listen</span>       <span class="string">80;</span></span><br><span class="line">        <span class="attr">server_name</span>  <span class="string">www.leyou.com;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line">                <span class="attr">root</span>	<span class="string">F:/java/MyCode/leyouProject/leyou-portal;</span></span><br><span class="line">                <span class="attr">index</span>	<span class="string">index.html;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="comment">    # 访问：http://www.leyou.com/  就是F:/java/MyCode/leyouProject/leyou-portal/文件夹下的资源</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">3</span> <span class="string">微服务反向代理,直接在外部conf配置文件进行如下配置就好：</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">listen</span>       <span class="string">80;</span></span><br><span class="line">        <span class="attr">server_name</span>  <span class="string">manage.leyou.com;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line">            <span class="attr">proxy_pass</span>   <span class="string">http://127.0.0.1:9001;</span></span><br><span class="line">            <span class="attr">proxy_connect_timeout</span> <span class="string">600;</span></span><br><span class="line">            <span class="attr">proxy_read_timeout</span> <span class="string">5000;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="comment"># 访问 http://www.manage.leyou.com  会反向代理到http://127.0.0.1:9001</span></span><br></pre></td></tr></table></figure>

<p><strong>注意注意注意：</strong>上面使用域名的反向代理，一定要在本地hosts域名配置文件中配置域名映射！</p>
<p>至此，项目总共配置了四个域名：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">127.0.0.1</span> <span class="string">api.leyou.com(在nginx中代理到网关)</span></span><br><span class="line"><span class="meta">127.0.0.1</span> <span class="string">manage.leyou.com(在nginx中代理到本地的9001端口，也就是项目的前端管理页面)</span></span><br><span class="line"><span class="meta">127.0.0.1</span> <span class="string">www.leyou.com(在nginx中代理到本地的静态资源，也就是项目的用户浏览前端页面)</span></span><br><span class="line"><span class="meta">127.0.0.1</span> <span class="string">image.leyou.com(在nginx中代理到本地的静态资源，专门存放图片资源的路径)</span></span><br></pre></td></tr></table></figure>

<p>首页顶部的搜索框，是用户购买商品最常见的入口，下面我们就来实现搜索功能。</p>
<h2 id="3-2-搭建搜索微服务"><a href="#3-2-搭建搜索微服务" class="headerlink" title="3.2.搭建搜索微服务"></a>3.2.搭建搜索微服务</h2><p>项目坐标：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200301203756276.png" alt="image-20200301203756276"></p>
<p>存放路径：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200301203808451.png" alt="image-20200301203808451"></p>
<p>pom文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>leyou<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ly-search<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elastic-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ly-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>ly-search</code>的<code>com.leyou.search</code>包下添加启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.search;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &#123;&quot;com.leyou.search&quot;, &quot;com.leyou.common.advice&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LySearchApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(LySearchApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>添加配置文件<code>application.yml</code>：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8083</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">search-service</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://ly-registry:10086/eureka</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.leyou:</span> <span class="string">debug</span></span><br><span class="line"></span><br><span class="line"><span class="attr">elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">http://ly-es:9200</span></span><br></pre></td></tr></table></figure>



<p>在<code>ly-gateway</code>的<code>application.yml</code>文件中添加路由配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ly-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="comment"># ...</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="comment"># ...</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">search-service</span> <span class="comment"># 搜索服务</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://search-service</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/search/**</span></span><br></pre></td></tr></table></figure>



<h2 id="3-3-索引库数据结构"><a href="#3-3-索引库数据结构" class="headerlink" title="3.3.索引库数据结构"></a>3.3.索引库数据结构</h2><p>我们存入elasticsearch的数据包含spu、sku、spuDetail等信息，必须组织成一个实体，然后写入。</p>
<p>这个实体中要包含的内容，一般需要通过搜索业务的需求来分析。来看下搜索页面：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200625192928829.png" alt="image-20200625192928829"></p>
<p>搜索的需求主要包括搜索和展示，因此其中的数据也是根据这两个需求来划分：</p>
<ul>
<li>用来参与搜索的数据<ul>
<li>① 标题：用户输入关键字搜索时根据商品标题分词查询<ul>
<li>② 分类：过滤条件<ul>
<li>③ 品牌：过滤条件</li>
<li>④ 规格参数：过滤条件，会随着商品变化而变化</li>
<li>⑤ 销量：排序条件</li>
<li>⑥ 更新时间：排序条件</li>
<li>⑦ 价格：排序条件</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20200625193240254.png" alt="image-20200625193240254"> </p>
<ul>
<li>用来参与展示的数据<pre><code>图片、价格、标题、销量、商品id
</code></pre>
</li>
</ul>
<p>我们存入Elasticsearch的最终实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.search.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.starter.elastic.annotation.IndexID;</span><br><span class="line"><span class="keyword">import</span> com.leyou.starter.elastic.annotation.Indices;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Indices(&quot;goods&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Goods</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品的id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@IndexID</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品标题，用于搜索</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品预览图，从sku中取出一个即可</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String image;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自动补全的候选字段，可以包含多个值，例如分类名称、品牌名称、商品名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; suggestion;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品分类，包含id和name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long categoryId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品品牌，包含id和name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long brandId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 规格参数的key和value对，用于过滤</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Map&lt;String,Object&gt;&gt; specs;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品spu中的所有sku的价格集合（滤重）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Long&gt; prices;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * spu下的多个sku的销量之和</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long sold;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品更新时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>特殊字段说明：</p>
<ul>
<li><p>title：商品搜索字段，包含商品的各种信息，需要分词，并且分词器为自定义的拼音分词器</p>
</li>
<li><p>suggestion：自动补全字段，包含商品名称、分类、品牌等信息，使用completion类型</p>
</li>
<li><p>prices：价格，一个SPU可能包含多个价格信息，因此这里采用set集合</p>
</li>
<li><p>sold：效率，当前spu下的多个sku的销量之和。</p>
</li>
<li><p>specs：规格参数，因为商品规格参数数量较多，而且都是键值对格式，计划的数据格式是这样的：</p>
<ul>
<li>```json<br>[<pre><code>&#123;&quot;name&quot;:&quot;CPU频率&quot;, &quot;value&quot;: &quot;2.5Hz&quot;&#125;,
&#123;&quot;name&quot;:&quot;CPU品牌&quot;, &quot;value&quot;: &quot;骁龙&quot;&#125;,
&#123;&quot;name&quot;:&quot;内存大小&quot;, &quot;value&quot;: &quot;6GB&quot;&#125;
</code></pre>
]<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - 这样的JSON风格，对应到Java中，就是List中嵌套Map：`List&lt;Map&lt;String,Object&gt;&gt;`</span><br><span class="line"></span><br><span class="line">  - 对象数组在写入elasticsearch时，必须使用Nested格式</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">对应的mapping映射：</span><br><span class="line"></span><br><span class="line">```json</span><br><span class="line">PUT /goods</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_pinyin&quot;: &#123;</span><br><span class="line">          &quot;tokenizer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">          &quot;filter&quot;: [</span><br><span class="line">            &quot;py&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;py&quot;: &#123;</span><br><span class="line">		  &quot;type&quot;: &quot;pinyin&quot;,</span><br><span class="line">          &quot;keep_full_pinyin&quot;: true,</span><br><span class="line">          &quot;keep_joined_full_pinyin&quot;: true,</span><br><span class="line">          &quot;keep_original&quot;: true,</span><br><span class="line">          &quot;limit_first_letter_length&quot;: 16,</span><br><span class="line">          &quot;remove_duplicated_term&quot;: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;id&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;suggestion&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;completion&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;my_pinyin&quot;,</span><br><span class="line">        &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;title&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;my_pinyin&quot;,</span><br><span class="line">        &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;image&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">        &quot;index&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;updateTime&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;date&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;specs&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;nested&quot;,</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;name&quot;:&#123;&quot;type&quot;: &quot;keyword&quot; &#125;,</span><br><span class="line">          &quot;value&quot;:&#123;&quot;type&quot;: &quot;keyword&quot; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="3-4-接入Feign客户端"><a href="#3-4-接入Feign客户端" class="headerlink" title="3.4.接入Feign客户端"></a>3.4.接入Feign客户端</h2><p>构建Goods时需要的数据都来自于商品微服务，主要包括下面的查询功能：</p>
<ul>
<li>批量查询Spu</li>
<li>查询Spu包含的Sku</li>
<li>查询Spu的规格参数键值对信息</li>
</ul>
<p>商品微服务需要对外提供这样的接口，我们在其它微服务中才可以调用。而远程调用需要通过Feign完成，因此我们要在ly-item-api项目中，编写Feign客户端。</p>
<h3 id="3-4-1-ly-item提供Feign客户端"><a href="#3-4-1-ly-item提供Feign客户端" class="headerlink" title="3.4.1.ly-item提供Feign客户端"></a>3.4.1.ly-item提供Feign客户端</h3><p>在于<code>ly-item-api</code>中创建包：<code>com.leyou.item.client</code>，然后创建<code>ItemClient</code>接口，引入下面代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.item.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.common.dto.PageDTO;</span><br><span class="line"><span class="keyword">import</span> com.leyou.item.dto.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Feign的原理: 对 http 请求的伪装</span></span><br><span class="line"><span class="comment"> * 需要知道：localhost:8081/goods/spu/page?page=1</span></span><br><span class="line"><span class="comment"> *  - 主机和端口：通过<span class="doctag">@FeignClient</span>(&quot;item-service&quot;)得到服务名称，去eureka根据服务名称拉取服务列表</span></span><br><span class="line"><span class="comment"> *  - 请求方式： <span class="doctag">@GetMapping</span></span></span><br><span class="line"><span class="comment"> *  - 请求路径：<span class="doctag">@GetMapping</span>(&quot;/goods/spu/page&quot;)</span></span><br><span class="line"><span class="comment"> *  - 请求参数：<span class="doctag">@RequestParam</span>(value = &quot;page&quot;, defaultValue = &quot;1&quot;) Integer page</span></span><br><span class="line"><span class="comment"> *  - 返回值类型：响应体的类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(&quot;item-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemClient</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询品牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 品牌的id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 品牌对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/brand/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">BrandDTO <span class="title">queryBrandById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id的查询商品分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 商品分类的id集</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/category/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">CategoryDTO <span class="title">queryCategoryById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询spu</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> page 当前页</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rows 每页大小</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> saleable 上架商品或下降商品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 当前页商品数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/goods/spu/page&quot;)</span></span><br><span class="line">    <span class="function">PageDTO&lt;SpuDTO&gt; <span class="title">querySpuByPage</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam(value = &quot;page&quot;, defaultValue = &quot;1&quot;)</span> Integer page,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam(value = &quot;rows&quot;, defaultValue = &quot;5&quot;)</span> Integer rows,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam(value = &quot;saleable&quot;, required = false)</span> Boolean saleable,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam(value = &quot;categoryId&quot;, required = false)</span> Long categoryId,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam(value = &quot;brandId&quot;, required = false)</span> Long brandId,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam(value = &quot;id&quot;, required = false)</span> Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据spuID查询spuDetail</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id spuID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SpuDetail</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/goods/spu/detail&quot;)</span></span><br><span class="line">    <span class="function">SpuDetailDTO <span class="title">querySpuDetailById</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据spuID查询sku</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id spuID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> sku的集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/goods/sku/of/spu&quot;)</span></span><br><span class="line">    <span class="function">List&lt;SkuDTO&gt; <span class="title">querySkuBySpuId</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询规格参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> groupId 组id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId 分类id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searching 是否用于搜索</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 规格组集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/spec/params&quot;)</span></span><br><span class="line">    <span class="function">List&lt;SpecParamDTO&gt; <span class="title">querySpecParams</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam(value = &quot;categoryId&quot;, required = false)</span> Long categoryId,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam(value = &quot;groupId&quot;, required = false)</span> Long groupId,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam(value = &quot;searching&quot;, required = false)</span> Boolean searching</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据spuId查询spu的所有规格参数值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id spu的id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searching 是否参与搜索</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 规格参数值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/goods/spec/value&quot;)</span></span><br><span class="line">    <span class="function">List&lt;SpecParamDTO&gt; <span class="title">querySpecsValues</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam(&quot;id&quot;)</span> Long id,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam(value = &quot;searching&quot;, required = false)</span> Boolean searching)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类id查询分类集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idList id集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> category集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/category/list&quot;)</span></span><br><span class="line">    <span class="function">List&lt;CategoryDTO&gt; <span class="title">queryCategoryByIds</span><span class="params">(<span class="meta">@RequestParam(&quot;ids&quot;)</span> List&lt;Long&gt; idList)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据品牌id查询分类集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idList id集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> category集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/brand/list&quot;)</span></span><br><span class="line">    <span class="function">List&lt;BrandDTO&gt; <span class="title">queryBrandByIds</span><span class="params">(<span class="meta">@RequestParam(&quot;ids&quot;)</span> List&lt;Long&gt; idList)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id批量查询sku</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ids skuId的集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> sku的集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/goods/sku/list&quot;)</span></span><br><span class="line">    <span class="function">List&lt;SkuDTO&gt; <span class="title">querySkuByIds</span><span class="params">(<span class="meta">@RequestParam(&quot;ids&quot;)</span> List&lt;Long&gt; ids)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询商品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 商品id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 商品信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/goods/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">SpuDTO <span class="title">queryGoodsById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询spu，不包含别的</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 商品id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> spu</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/goods/spu/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">SpuDTO <span class="title">querySpuById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类id查询规格组及组内参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 分类id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 组及组内参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/spec/list&quot;)</span></span><br><span class="line">    <span class="function">List&lt;SpecGroupDTO&gt; <span class="title">querySpecList</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-4-2-ly-search引入Feign客户端"><a href="#3-4-2-ly-search引入Feign客户端" class="headerlink" title="3.4.2.ly-search引入Feign客户端"></a>3.4.2.ly-search引入Feign客户端</h3><p>接下来，我们在ly-search中引入刚刚定义的Feign客户端</p>
<h4 id="1）引入依赖"><a href="#1）引入依赖" class="headerlink" title="1）引入依赖"></a>1）引入依赖</h4><p>在<code>ly-search</code>的<code>pom.xml</code>中引入<code>ly-item-api</code>和<code>OpenFeign</code>的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ly-item-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="2）启用FeignClient功能"><a href="#2）启用FeignClient功能" class="headerlink" title="2）启用FeignClient功能"></a>2）启用FeignClient功能</h4><p>在启动类<code>LySearchApplication</code>上添加注解，开启Feign功能：</p>
<p><code>@EnableFeignClients(basePackages = &quot;com.leyou.item.client&quot;)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.search;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.leyou.item.client&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &#123;&quot;com.leyou.search&quot;, &quot;com.leyou.common.advice&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LySearchApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(LySearchApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3）单元测试"><a href="#3）单元测试" class="headerlink" title="3）单元测试"></a>3）单元测试</h4><p>我们编写一个单元测试，看看是否好用。</p>
<p>在<code>ly-search</code>的<code>test</code>下的<code>com.leyou.search.client</code>包下新建一个测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.search.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.item.client.ItemClient;</span><br><span class="line"><span class="keyword">import</span> com.leyou.item.dto.SpecParamDTO;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemClient itemClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQuerySpecValues</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;SpecParamDTO&gt; list = itemClient.querySpecsValues(<span class="number">114L</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        list.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-5-完成数据导入"><a href="#3-5-完成数据导入" class="headerlink" title="3.5.完成数据导入"></a>3.5.完成数据导入</h2><p>接下来我们就查询数据，并完成索引库数据导入。</p>
<p>先来个小结：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">Good类对应一个索引库里面的文档，Good字段</span> <span class="string">包含了spu，spuDetail，sku，brand，category 所有字段信息。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">通过访问微服务item-service</span> <span class="string">获取到mysql中的数据，</span></span><br><span class="line"><span class="meta">然后通过定义好的</span> <span class="string">访问操作elasticSearch的 service接口代码 </span></span><br><span class="line"><span class="meta">把数据加载到elasticSearch，并进行</span> <span class="string">es的检索功能。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">通过item-service</span> <span class="string">查询到的spuDTO 转为 GoodDTO时，GoodDTO还有好几个字段为空的，</span></span><br><span class="line"><span class="attr">因此再根据spuDTO，再次封装属性到GoodDTO中，</span></span><br></pre></td></tr></table></figure>



<h3 id="3-5-1-创建Repository"><a href="#3-5-1-创建Repository" class="headerlink" title="3.5.1.创建Repository"></a>3.5.1.创建Repository</h3><p>首先，我们需要创建一个Repository，继承ElasticsearchRepository。</p>
<p>我们在<code>ly-search</code>的<code>com.leyou.search.repository</code>中定义类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.search.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.search.entity.Goods;</span><br><span class="line"><span class="keyword">import</span> com.leyou.starter.elastic.repository.Repository;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GoodsRepository</span> <span class="keyword">extends</span> <span class="title">Repository</span>&lt;<span class="title">Goods</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-5-2-创建索引库"><a href="#3-5-2-创建索引库" class="headerlink" title="3.5.2.创建索引库"></a>3.5.2.创建索引库</h3><p>我们在<code>ly-search</code>的<code>com.leyou.search.service</code>包中创建一个<code>SearchService</code>接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.search.service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SearchService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建索引库并设置映射</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">createIndexAndMapping</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载数据到索引库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">loadData</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里定义了两个方法，一个用来创建索引库，一个用来加载数据到索引库</p>
<p>然后我们在<code>ly-search</code>的<code>com.leyou.search.service.impl</code>包中创建一个<code>SearchServiceImpl</code>实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.search.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.search.repository.GoodsRepository;</span><br><span class="line"><span class="keyword">import</span> com.leyou.search.service.SearchService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchServiceImpl</span> <span class="keyword">implements</span> <span class="title">SearchService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GoodsRepository goodsRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ItemClient itemClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SearchServiceImpl</span><span class="params">(GoodsRepository goodsRepository, ItemClient itemClient)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.goodsRepository = goodsRepository;</span><br><span class="line">        <span class="keyword">this</span>.itemClient = itemClient;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createIndexAndMapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 删除已经存在的索引库</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            repository.deleteIndex();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;删除失败，可能索引库不存在！&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 然后创建一个新的</span></span><br><span class="line">        goodsRepository.createIndex(<span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;settings\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;analysis\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;analyzer\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;my_pinyin\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;tokenizer\&quot;: \&quot;ik_smart\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;filter\&quot;: [\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;py\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          ]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;filter\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;py\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\t\t  \&quot;type\&quot;: \&quot;pinyin\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;keep_full_pinyin\&quot;: true,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;keep_joined_full_pinyin\&quot;: true,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;keep_original\&quot;: true,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;limit_first_letter_length\&quot;: 16,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;remove_duplicated_term\&quot;: true\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;mappings\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;properties\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;id\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;suggestion\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;completion\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;analyzer\&quot;: \&quot;my_pinyin\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;search_analyzer\&quot;: \&quot;ik_smart\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;title\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;analyzer\&quot;: \&quot;my_pinyin\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;search_analyzer\&quot;: \&quot;ik_smart\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;image\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;index\&quot;: false\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;updateTime\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;date\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;specs\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;type\&quot;: \&quot;nested\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;properties\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;name\&quot;:&#123;\&quot;type\&quot;: \&quot;keyword\&quot; &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          \&quot;value\&quot;:&#123;\&quot;type\&quot;: \&quot;keyword\&quot; &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-5-3-批量导入"><a href="#3-5-3-批量导入" class="headerlink" title="3.5.3.批量导入"></a>3.5.3.批量导入</h3><p>我们在<code>ly-search</code>的<code>com.leyou.search.service.impl</code>包中的<code>SearchServiceImpl</code>的<code>loadData()</code>方法中完成数据导入逻辑：</p>
<ul>
<li>批量查询Spu</li>
<li>将查询到的Spu的集合转为Goods对象的集合</li>
<li>调用repository的saveAll方法，批量存入Elasticsearch</li>
</ul>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> page = <span class="number">1</span>, rows = <span class="number">100</span>;</span><br><span class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">           log.info(<span class="string">&quot;开始导入第&#123;&#125;页数据&quot;</span>, page);</span><br><span class="line">           <span class="comment">// 分页查询已经上架的spu</span></span><br><span class="line">           PageDTO&lt;SpuDTO&gt; result = itemClient.querySpuByPage(page, rows, <span class="keyword">true</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">           List&lt;SpuDTO&gt; list = result.getItems();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 遍历Spu集合，把SpuDTO通过buildGoods方法转为Goods</span></span><br><span class="line">           List&lt;Goods&gt; goodsList = list.stream()</span><br><span class="line">                   .map(<span class="keyword">this</span>::buildGoods).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 批量写入Elasticsearch</span></span><br><span class="line">           repository.saveAll(goodsList);</span><br><span class="line">           log.info(<span class="string">&quot;导入第&#123;&#125;页数据结束。&quot;</span>, page);</span><br><span class="line">           <span class="comment">// 翻页</span></span><br><span class="line">           page++;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 获取总页数</span></span><br><span class="line">           Long totalPage = result.getTotalPage();</span><br><span class="line">           <span class="comment">// 判断是否还有spu没有查询</span></span><br><span class="line">           <span class="keyword">if</span> (page &gt; totalPage) &#123;</span><br><span class="line">               <span class="comment">// 没有则结束</span></span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<p>在方法执行过程中，需要调用buildGoods方法，将查询到的Spu变为Goods对象，因此我们要定义一个这样的方法。</p>
<h3 id="3-5-4-构建Goods"><a href="#3-5-4-构建Goods" class="headerlink" title="3.5.4.构建Goods"></a>3.5.4.构建Goods</h3><p>我们要定义一个方法，将查询到的Spu变为Goods对象。</p>
<p>我们在<code>ly-search</code>的<code>com.leyou.search.service.impl</code>包中的<code>SearchServiceImpl</code>添加一个<code>buildGoods()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Goods <span class="title">buildGoods</span><span class="params">(SpuDTO spu)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.自动补全的提示字段</span></span><br><span class="line">        List&lt;String&gt; suggestion = <span class="keyword">new</span> ArrayList&lt;&gt;(</span><br><span class="line">                Arrays.asList(StringUtils.split(spu.getCategoryName(), <span class="string">&quot;/&quot;</span>)));</span><br><span class="line">        suggestion.add(spu.getName());</span><br><span class="line">        suggestion.add(spu.getBrandName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.sku的价格集合</span></span><br><span class="line">        <span class="comment">// 2.1.查询sku集合</span></span><br><span class="line">        List&lt;SkuDTO&gt; skuList = spu.getSkus();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(skuList)) &#123;</span><br><span class="line">            <span class="comment">// 没有sku，我们去查询</span></span><br><span class="line">            skuList = itemClient.querySkuBySpuId(spu.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.2.获取价格集合</span></span><br><span class="line">        Set&lt;Long&gt; prices = skuList.stream().map(SkuDTO::getPrice).collect(Collectors.toSet());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.商品销量</span></span><br><span class="line">        <span class="keyword">long</span> sold = skuList.stream().mapToLong(SkuDTO::getSold).sum();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.sku的某个图片</span></span><br><span class="line">        String image = StringUtils.substringBefore(skuList.get(<span class="number">0</span>).getImages(), <span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.规格参数</span></span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; specs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 5.1.查询规格参数name和value键值对，只查询参与搜索的</span></span><br><span class="line">        List&lt;SpecParamDTO&gt; params = itemClient.querySpecsValues(spu.getId(), <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 5.2.封装</span></span><br><span class="line">        <span class="keyword">for</span> (SpecParamDTO param : params) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">            map.put(<span class="string">&quot;name&quot;</span>, param.getName());</span><br><span class="line">            map.put(<span class="string">&quot;value&quot;</span>, chooseSegment(param));</span><br><span class="line">            specs.add(map);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建Goods对象，并封装数据</span></span><br><span class="line">        Goods goods = <span class="keyword">new</span> Goods();</span><br><span class="line">        goods.setUpdateTime(<span class="keyword">new</span> Date());</span><br><span class="line">        <span class="comment">// 自动补全的提示字段</span></span><br><span class="line">        goods.setSuggestion(suggestion);</span><br><span class="line">        <span class="comment">// 规格参数</span></span><br><span class="line">        goods.setSpecs(specs);</span><br><span class="line">        <span class="comment">// 商品销量</span></span><br><span class="line">        goods.setSold(sold);</span><br><span class="line">        <span class="comment">// 商品标题</span></span><br><span class="line">        goods.setTitle(spu.getTitle() + StringUtils.join(suggestion, <span class="string">&quot; &quot;</span>));</span><br><span class="line">        <span class="comment">// sku的价格集合</span></span><br><span class="line">        goods.setPrices(prices);</span><br><span class="line">        <span class="comment">// sku的某个图片</span></span><br><span class="line">        goods.setImage(image);</span><br><span class="line">        goods.setCategoryId(spu.getCid3());</span><br><span class="line">        goods.setBrandId(spu.getBrandId());</span><br><span class="line">        goods.setId(spu.getId());</span><br><span class="line">        <span class="keyword">return</span> goods;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中有一部分处理数字value的代码，被封装到了另两个方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">chooseSegment</span><span class="params">(SpecParamDTO p)</span> </span>&#123;</span><br><span class="line">        Object value = p.getValue();</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span> || StringUtils.isBlank(value.toString())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;其它&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!p.getNumeric() || StringUtils.isBlank(p.getSegments()) || value <span class="keyword">instanceof</span> Collection) &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">double</span> val = parseDouble(value.toString());</span><br><span class="line">        String result = <span class="string">&quot;其它&quot;</span>;</span><br><span class="line">        <span class="comment">// 保存数值段</span></span><br><span class="line">        <span class="keyword">for</span> (String segment : p.getSegments().split(<span class="string">&quot;,&quot;</span>)) &#123;</span><br><span class="line">            String[] segs = segment.split(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">            <span class="comment">// 获取数值范围</span></span><br><span class="line">            <span class="keyword">double</span> begin = parseDouble(segs[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">double</span> end = Double.MAX_VALUE;</span><br><span class="line">            <span class="keyword">if</span> (segs.length == <span class="number">2</span>) &#123;</span><br><span class="line">                end = parseDouble(segs[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 判断是否在范围内</span></span><br><span class="line">            <span class="keyword">if</span> (val &gt;= begin &amp;&amp; val &lt; end) &#123;</span><br><span class="line">                <span class="keyword">if</span> (segs.length == <span class="number">1</span>) &#123;</span><br><span class="line">                    result = segs[<span class="number">0</span>] + p.getUnit() + <span class="string">&quot;以上&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (begin == <span class="number">0</span>) &#123;</span><br><span class="line">                    result = segs[<span class="number">1</span>] + p.getUnit() + <span class="string">&quot;以下&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    result = segment + p.getUnit();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">double</span> <span class="title">parseDouble</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Double.parseDouble(str);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>（可选的优化）另外，我们写入索引库的数据，将来参与展示的字段只包含：</p>
<ul>
<li>id</li>
<li>title</li>
<li>image</li>
<li>price</li>
<li>sold</li>
</ul>
<p>其它字段不包含，也就不需要存储的。</p>
<p>如果要控制存储到索引库的数据，可以通过在创建mapping时，限制<code>_source</code>来实现</p>
<h3 id="3-5-5-定义controller"><a href="#3-5-5-定义controller" class="headerlink" title="3.5.5.定义controller"></a>3.5.5.定义controller</h3><p>为了方便后期同学们导入数据，我们定义一个controller，调用刚才的功能。</p>
<p>我们在<code>ly-search</code>的<code>com.leyou.search.web</code>包中编写<code>SearchController</code>功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.search.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.search.service.SearchService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;goods&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SearchService searchService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SearchController</span><span class="params">(SearchService searchService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.searchService = searchService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化索引库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;initialization&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        searchService.createIndexAndMapping();</span><br><span class="line">        searchService.loadData();</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="string">&quot;导入成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如下用测试工具进行导入：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/image-20220816224611673.png" alt="image-20220816224611673"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">高明辉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/06/26/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-ElesticSearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/">http://example.com/2022/06/26/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-ElesticSearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Jason</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/">乐优商城项目</a></div><div class="post_share"><div class="social-share" data-image="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/7Elasticsearch%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%90%9C%E7%B4%A2/%E5%B0%81%E9%9D%A2.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="添加微信"/></a><div class="post-qr-code-desc">添加微信</div></li><li class="reward-item"><a href="/img/pay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/pay.jpg" alt="付款码"/></a><div class="post-qr-code-desc">付款码</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/06/26/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-ElesticSear%E6%95%B0%E6%8D%AE%E6%90%9C%E7%B4%A2%E4%BB%A5%E5%8F%8Aes%E4%B8%8Emysql%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/"><img class="prev-cover" src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/8%E6%90%9C%E7%B4%A2%E8%BF%87%E6%BB%A4%E5%8F%8A%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/%E5%B0%81%E9%9D%A2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">乐优商城项目-ElesticSear数据搜索以及es与mysql数据同步</div></div></a></div><div class="next-post pull-right"><a href="/2022/06/23/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-ElasticSearch%E8%BF%9B%E9%98%B6%E5%92%8CWebFlux/"><img class="next-cover" src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/6Elasticsearch%E8%BF%9B%E9%98%B6%E5%92%8CWebFlux/%E5%B0%81%E9%9D%A2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Elasticsearch进阶和WebFlux</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/06/26/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-ElesticSear%E6%95%B0%E6%8D%AE%E6%90%9C%E7%B4%A2%E4%BB%A5%E5%8F%8Aes%E4%B8%8Emysql%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/" title="乐优商城项目-ElesticSear数据搜索以及es与mysql数据同步"><img class="cover" src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/8%E6%90%9C%E7%B4%A2%E8%BF%87%E6%BB%A4%E5%8F%8A%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/%E5%B0%81%E9%9D%A2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-26</div><div class="title">乐优商城项目-ElesticSear数据搜索以及es与mysql数据同步</div></div></a></div><div><a href="/2022/06/18/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E5%93%81%E7%89%8C%E7%AE%A1%E7%90%86/" title="乐优商城项目-品牌管理"><img class="cover" src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/3%E5%93%81%E7%89%8C%E7%AE%A1%E7%90%86/%E5%B0%81%E9%9D%A2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-18</div><div class="title">乐优商城项目-品牌管理</div></div></a></div><div><a href="/2022/06/15/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA/" title="乐优商城项目-项目搭建"><img class="cover" src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/1%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA/%E5%B0%81%E9%9D%A2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-15</div><div class="title">乐优商城项目-项目搭建</div></div></a></div><div><a href="/2022/06/17/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/" title="乐优商城项目-分类管理"><img class="cover" src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/2%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86/%E5%B0%81%E9%9D%A2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-17</div><div class="title">乐优商城项目-分类管理</div></div></a></div><div><a href="/2022/06/20/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E5%95%86%E5%93%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1/" title="乐优商城项目-商品数据结构设计"><img class="cover" src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/4%E5%95%86%E5%93%81%E8%AE%BE%E8%AE%A1/%E5%B0%81%E9%9D%A2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-20</div><div class="title">乐优商城项目-商品数据结构设计</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-ElasticSearch%E7%9A%84starter"><span class="toc-number">2.</span> <span class="toc-text">1.ElasticSearch的starter</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%90%AD%E5%BB%BA%E5%B7%A5%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">1.1.搭建工程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-%E5%88%9B%E5%BB%BA%E7%88%B6%E5%B7%A5%E7%A8%8B%EF%BC%9A"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1.1.创建父工程：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-AutoConfigure"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.1.2.AutoConfigure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-3-Starter%E6%A8%A1%E5%9D%97"><span class="toc-number">2.1.3.</span> <span class="toc-text">1.1.3.Starter模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E5%AE%9A%E4%B9%89%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">2.2.</span> <span class="toc-text">1.2.定义工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-%E5%AE%9A%E4%B9%89%E5%B7%A5%E5%85%B7%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.2.1.</span> <span class="toc-text">1.2.1.定义工具接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-%E5%AE%9A%E4%B9%89%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-number">2.2.2.</span> <span class="toc-text">1.2.2.定义实现类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-3-%E5%88%9B%E5%BB%BA%E5%92%8C%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">2.2.3.</span> <span class="toc-text">1.2.3.创建和删除索引库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-4-%E6%96%B0%E5%A2%9E%E6%96%87%E6%A1%A3"><span class="toc-number">2.2.4.</span> <span class="toc-text">1.2.4.新增文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-5-%E6%89%B9%E9%87%8F%E6%96%B0%E5%A2%9E"><span class="toc-number">2.2.5.</span> <span class="toc-text">1.2.5.批量新增</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-6-%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-number">2.2.6.</span> <span class="toc-text">1.2.6.删除文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-7-%E6%A0%B9%E6%8D%AEid%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-number">2.2.7.</span> <span class="toc-text">1.2.7.根据id查询文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-8-%E6%90%9C%E7%B4%A2%E5%B9%B6%E5%88%86%E9%A1%B5%E3%80%81%E9%AB%98%E4%BA%AE%E3%80%81%E6%8E%92%E5%BA%8F"><span class="toc-number">2.2.8.</span> <span class="toc-text">1.2.8.搜索并分页、高亮、排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-9-%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="toc-number">2.2.9.</span> <span class="toc-text">1.2.9.自动补全</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-10-%E8%8E%B7%E5%8F%96%E6%B3%9B%E5%9E%8B%E4%B8%AD%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%BF%A1%E6%81%AF%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">2.2.10.</span> <span class="toc-text">1.2.10.获取泛型中的类型信息（了解）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-11-%E8%8E%B7%E5%8F%96%E7%B4%A2%E5%BC%95%E5%BA%93%E5%90%8D%E7%A7%B0%E5%92%8CID%E5%B1%9E%E6%80%A7%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">2.2.11.</span> <span class="toc-text">1.2.11.获取索引库名称和ID属性（了解）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.2.11.1.</span> <span class="toc-text">1）自定义注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E5%8F%8D%E5%B0%84%E8%8E%B7%E5%8F%96%E6%B3%A8%E8%A7%A3%E4%BF%A1%E6%81%AF"><span class="toc-number">2.2.11.2.</span> <span class="toc-text">2）反射获取注解信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89getId%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.11.3.</span> <span class="toc-text">3）getId方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E4%B8%8Espring%E6%95%B4%E5%90%88%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">1.3.与spring整合（了解）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">2.3.1.</span> <span class="toc-text">1.3.1.动态代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-FactoryBean"><span class="toc-number">2.3.2.</span> <span class="toc-text">1.3.2.FactoryBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-3-%E6%B3%A8%E5%85%A5Bean%E5%88%B0%E5%AE%B9%E5%99%A8"><span class="toc-number">2.3.3.</span> <span class="toc-text">1.3.3.注入Bean到容器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">1）完整代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E6%89%AB%E6%8F%8F%E5%8C%85"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">2）扫描包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E5%AE%9A%E4%B9%89BeanDefinition%E5%B9%B6%E6%B3%A8%E5%86%8C"><span class="toc-number">2.3.3.3.</span> <span class="toc-text">3）定义BeanDefinition并注册</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E7%BC%96%E5%86%99starter-%E4%BA%86%E8%A7%A3"><span class="toc-number">2.4.</span> <span class="toc-text">1.4.编写starter(了解)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-1-%E8%AF%BB%E5%8F%96elasticsearch%E5%9C%B0%E5%9D%80"><span class="toc-number">2.4.1.</span> <span class="toc-text">1.4.1.读取elasticsearch地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-2-%E9%85%8D%E7%BD%AEHighLevelRestClient"><span class="toc-number">2.4.2.</span> <span class="toc-text">1.4.2.配置HighLevelRestClient</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-3-%E6%B3%A8%E5%86%8CRepositoryScanner"><span class="toc-number">2.4.3.</span> <span class="toc-text">1.4.3.注册RepositoryScanner</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-4-%E9%85%8D%E7%BD%AEspring-factories"><span class="toc-number">2.4.4.</span> <span class="toc-text">1.4.4.配置spring.factories</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85es%E7%9A%84starter%E5%88%B0%E4%BB%93%E5%BA%93"><span class="toc-number">3.</span> <span class="toc-text">2.安装es的starter到仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%AE%89%E8%A3%85%E5%88%B0%E6%9C%AC%E5%9C%B0%E4%BB%93%E5%BA%93"><span class="toc-number">3.1.</span> <span class="toc-text">2.1.安装到本地仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-IDEA%E5%AF%BC%E5%85%A5"><span class="toc-number">3.1.1.</span> <span class="toc-text">2.1.1.IDEA导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%AF%BC%E5%85%A5"><span class="toc-number">3.1.2.</span> <span class="toc-text">2.1.2.命令行导入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">3.2.</span> <span class="toc-text">2.2.功能测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E5%88%9B%E5%BB%BAdemo%E5%B7%A5%E7%A8%8B"><span class="toc-number">3.2.1.</span> <span class="toc-text">2.2.1.创建demo工程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.2.2.</span> <span class="toc-text">2.2.2.初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E9%85%8D%E7%BD%AE%E5%9C%B0%E5%9D%80"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">1）配置地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E7%BC%96%E5%86%99%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">2）编写实体类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E5%87%86%E5%A4%87%E5%AE%A2%E6%88%B7%E7%AB%AFRepository"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">3）准备客户端Repository</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">3.2.3.</span> <span class="toc-text">2.2.3.创建索引库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-%E6%96%87%E6%A1%A3%E7%9A%84CRUD"><span class="toc-number">3.2.4.</span> <span class="toc-text">2.2.4.文档的CRUD</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E6%96%B0%E5%A2%9E%E6%96%87%E6%A1%A3"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">1）新增文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E6%96%87%E6%A1%A3%E5%88%A0%E9%99%A4"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">2）文档删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E6%A0%B9%E6%8D%AEid%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.4.3.</span> <span class="toc-text">3）根据id查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-5-%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.5.</span> <span class="toc-text">2.2.5.条件查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-6-%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="toc-number">3.2.6.</span> <span class="toc-text">2.2.6.自动补全</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5"><span class="toc-number">4.</span> <span class="toc-text">3.数据导入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%89%8D%E5%8F%B0%E9%97%A8%E6%88%B7"><span class="toc-number">4.1.</span> <span class="toc-text">3.1.前台门户</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-%E8%A7%A3%E5%8E%8B"><span class="toc-number">4.1.1.</span> <span class="toc-text">3.1.1.解压</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-%E5%90%AF%E5%8A%A8"><span class="toc-number">4.1.2.</span> <span class="toc-text">3.1.2.启动</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E6%90%AD%E5%BB%BA%E6%90%9C%E7%B4%A2%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.</span> <span class="toc-text">3.2.搭建搜索微服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E7%B4%A2%E5%BC%95%E5%BA%93%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">4.3.</span> <span class="toc-text">3.3.索引库数据结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E6%8E%A5%E5%85%A5Feign%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">4.4.</span> <span class="toc-text">3.4.接入Feign客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-ly-item%E6%8F%90%E4%BE%9BFeign%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">4.4.1.</span> <span class="toc-text">3.4.1.ly-item提供Feign客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-ly-search%E5%BC%95%E5%85%A5Feign%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">4.4.2.</span> <span class="toc-text">3.4.2.ly-search引入Feign客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">4.4.2.1.</span> <span class="toc-text">1）引入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E5%90%AF%E7%94%A8FeignClient%E5%8A%9F%E8%83%BD"><span class="toc-number">4.4.2.2.</span> <span class="toc-text">2）启用FeignClient功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">4.4.2.3.</span> <span class="toc-text">3）单元测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E5%AE%8C%E6%88%90%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5"><span class="toc-number">4.5.</span> <span class="toc-text">3.5.完成数据导入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-%E5%88%9B%E5%BB%BARepository"><span class="toc-number">4.5.1.</span> <span class="toc-text">3.5.1.创建Repository</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-2-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-number">4.5.2.</span> <span class="toc-text">3.5.2.创建索引库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-3-%E6%89%B9%E9%87%8F%E5%AF%BC%E5%85%A5"><span class="toc-number">4.5.3.</span> <span class="toc-text">3.5.3.批量导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-4-%E6%9E%84%E5%BB%BAGoods"><span class="toc-number">4.5.4.</span> <span class="toc-text">3.5.4.构建Goods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-5-%E5%AE%9A%E4%B9%89controller"><span class="toc-number">4.5.5.</span> <span class="toc-text">3.5.5.定义controller</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 高明辉</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'Aaee0Vekhg5KbLhMOJQrEU6A-gzGzoHsz',
      appKey: 'mmLHPEEtqvOSJhsqWra8Sq6K',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script type="text/javascript" src="/js/fairyDustCursor.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>