<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>乐优商城项目-下单功能 | Jason</title><meta name="keywords" content="下单"><meta name="author" content="高明辉"><meta name="copyright" content="高明辉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="学习目标12341- 了解订单表设计2- 实现减库存功能3- 实现下单功能4- 实现查询订单功能  大总结写在前面：1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757">
<meta property="og:type" content="article">
<meta property="og:title" content="乐优商城项目-下单功能">
<meta property="og:url" content="http://example.com/2022/07/03/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/index.html">
<meta property="og:site_name" content="Jason">
<meta property="og:description" content="学习目标12341- 了解订单表设计2- 实现减库存功能3- 实现下单功能4- 实现查询订单功能  大总结写在前面：1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/%E5%B0%81%E9%9D%A2.png">
<meta property="article:published_time" content="2022-07-03T01:52:22.000Z">
<meta property="article:modified_time" content="2022-12-11T02:30:16.839Z">
<meta property="article:author" content="高明辉">
<meta property="article:tag" content="下单">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/%E5%B0%81%E9%9D%A2.png"><link rel="shortcut icon" href="/img/%E7%BD%91%E7%AB%99%E5%9B%BE%E6%A0%87.png"><link rel="canonical" href="http://example.com/2022/07/03/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '乐优商城项目-下单功能',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-12-11 10:30:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Jason" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/%E5%A4%B4%E5%83%8F.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">186</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">206</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">36</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li><li><a class="site-page child" href="/butterfly%E4%B8%BB%E9%A2%98"><i class="fa-fw https://github.com/jerryc127/hexo-theme-butterfly/"></i><span> 2</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/%E5%B0%81%E9%9D%A2.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Jason</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li><li><a class="site-page child" href="/butterfly%E4%B8%BB%E9%A2%98"><i class="fa-fw https://github.com/jerryc127/hexo-theme-butterfly/"></i><span> 2</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">乐优商城项目-下单功能</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-03T01:52:22.000Z" title="发表于 2022-07-03 09:52:22">2022-07-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-12-11T02:30:16.839Z" title="更新于 2022-12-11 10:30:16">2022-12-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/">乐优商城项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="乐优商城项目-下单功能"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h1><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">1-</span> <span class="string">了解订单表设计</span></span><br><span class="line"><span class="meta">2-</span> <span class="string">实现减库存功能</span></span><br><span class="line"><span class="meta">3-</span> <span class="string">实现下单功能</span></span><br><span class="line"><span class="meta">4-</span> <span class="string">实现查询订单功能</span></span><br></pre></td></tr></table></figure>

<h1 id="大总结写在前面："><a href="#大总结写在前面：" class="headerlink" title="大总结写在前面："></a>大总结写在前面：</h1><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">0：</span></span><br><span class="line">	<span class="attr">下单时带给服务器只有几个key-val，只是id值，并不是sku详细信息</span></span><br><span class="line">	<span class="attr">因为以后台最新数据为准，（涨价，价格变动等），所以还有拿着id去mysql查询，才最终确定订单详情！</span></span><br><span class="line"><span class="attr">1</span>: <span class="string">由0可以知道，需要跟数据库交互，因此引入mysql，mybatis-plus依赖包</span></span><br><span class="line">	<span class="attr">同时在配置文件中配置数据源以及mybatis-plus操作库表对应的实体类位置！（entity包位置）</span></span><br><span class="line"></span><br><span class="line"><span class="attr">2</span>: <span class="string">mapper包下写三个接口：Order接口，OrderDetail接口，OrderLogistics接口，</span></span><br><span class="line">	<span class="meta">三个接口都继承BaseMapper&lt;T&gt;</span> <span class="string">T就是对应的实体类</span></span><br><span class="line"></span><br><span class="line"><span class="attr">3</span>: <span class="string">在entity包下写对应的实体类：Order，OrderDetail，OrderLogistics（属性当然是跟数据库表对应上是吧）</span></span><br><span class="line"></span><br><span class="line"><span class="attr">4</span>: <span class="string">web包下写OrderController类</span></span><br><span class="line">	<span class="meta">（1）需要注入@AutoWired</span> <span class="string">OrderService orderService(但此时还没有)</span></span><br><span class="line">		<span class="attr">利用orderService的create(orderDTO)方法来完成订单的创建</span></span><br><span class="line">			<span class="attr">ps</span>:<span class="string">orderDTO和orderService下面分解。</span></span><br><span class="line">	<span class="attr">（2）前端post过来的参数为Json，因此使用@requestBody(orderDTO)来声明参数，</span></span><br><span class="line">		<span class="attr">Json数据封装到orderDTO中。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">5</span>: <span class="string">在dto包下新建orderDTO类，类属性跟Json字段对应上就好啦。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">6</span>: <span class="string">在service层创建步骤4中web层注入的OrderService类 extend IService&lt;T&gt; 其中，泛型T为Order</span></span><br><span class="line"></span><br><span class="line"><span class="attr">7</span>: <span class="string">service包下的impl包下写OrderService的</span></span><br><span class="line">	<span class="meta">实现类OrderServiceImpl</span> <span class="string">extend ServiceImpl&lt;OrderMapper,Order&gt; implements OrderService</span></span><br><span class="line">	<span class="attr">（实现类使用注解：@Service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">8</span>: <span class="string">每次新增方法功能，在OrderService声明接口方法，然后再OrderServiceImpl中具体实现方法就好！</span></span><br><span class="line"></span><br><span class="line"><span class="attr">9</span>:<span class="string"></span></span><br><span class="line"><span class="attr">服务端必须对客户端请求（get或者post）过来的数据进行校验</span></span><br><span class="line"><span class="attr">首先第一步就是先利用日志log.error(orderDTO),后台终端打印一下数据，保证数据到达后台。</span></span><br><span class="line"><span class="attr">其次，还要对数据进行校验判断数据是否合理，增强系统的健壮性！</span></span><br><span class="line"></span><br><span class="line"><span class="attr">10</span>:<span class="string">支付方式使用枚举类型，（枚举类型有提示，一是不会写错，二是见名知其意）</span></span><br><span class="line">	<span class="attr">本质上还是Integer类型，</span></span><br><span class="line">	<span class="attr">但mysql中也没有枚举类型，因此用Integer类型作为最终存入mysql</span></span><br><span class="line"></span><br><span class="line"><span class="attr">11</span>:<span class="string"></span></span><br><span class="line"><span class="attr">（1）将前端过来的数据（封装为OrderDTO），（2）UserContext获取用户id，</span></span><br><span class="line"><span class="attr">（3）OrderDTO中获取skuid集合到数据库查询详sku详情信息，（4）...</span></span><br><span class="line">	<span class="attr">将（1）-（）。。。等等内容封装到Order对象中</span></span><br><span class="line">	<span class="meta">调用OrderService</span> <span class="string">对象的save方法（会自动调用mybatis-plus底层代码）来保存Order对象到数据库的tb_order表中去！</span></span><br><span class="line"></span><br><span class="line"><span class="attr">12</span>:<span class="string"></span></span><br><span class="line">	<span class="meta">11中</span> <span class="string">既然要“根据skuid集合查询sku详情信息”，那么就需要ly-item-api 微服的ItemClient 客户端，因此：</span></span><br><span class="line">	<span class="meta">(1)OrderServiceImpl中注入@AutoWired</span> <span class="string">ItemClient itemClient；同时添加ly-item-api 依赖</span></span><br><span class="line">	<span class="meta">(2)启动器需要添加Feign注解，同时添加openFeign</span> <span class="string">依赖包。</span></span><br><span class="line">	<span class="attr">(3)工作到这一步，就可以直接使用itemClient相关方法了，</span></span><br><span class="line">	<span class="attr">(4)但是发现itemClient并没有“根据skuid集合查询sku详情信息”feign接口哈，</span></span><br><span class="line">		<span class="meta">因此需要我们再去ly-item-api下的ItemClient接口下</span> <span class="string">声明该方法</span></span><br><span class="line">		<span class="attr">该方法在web层（controller类）中已经声明过，直接copy过来哈！</span></span><br><span class="line">	<span class="attr">ps：ItemClient是微服务的客户端，是给其他微服务访问的一个接口文件，暴露出来访问路径，</span></span><br><span class="line">		<span class="attr">最终还是定位到目标微服的web层中Controller类下的某个方法！！！</span></span><br><span class="line"></span><br><span class="line">		<span class="attr">微服A访问微服B，需要引入依赖（微服B依赖包，feign支持依赖），</span></span><br><span class="line">		<span class="attr">引入feign注解，注入客户端对象itemClient，然后使用客户端对象方法来访问微服务B。</span></span><br><span class="line"><span class="attr">13</span>: <span class="string">订单详情，批量保存订单信息</span></span><br><span class="line">	<span class="attr">完成了12：订单的创建之后，接下来是订单详情的封装以及数据库表的持久化。</span></span><br><span class="line">	<span class="attr">由11中查到的sku详情信息封装到skuDTOS详情中，</span></span><br><span class="line">	<span class="attr">利用stream的map方法将List&lt;skuDTO&gt;对象属性值封装到List&lt;OrderDetail&gt;中去。</span></span><br><span class="line">	<span class="attr">然后OrderDetailService.saveBatch(orderDetails);//；批量保存订单信息</span></span><br><span class="line">	</span><br><span class="line"><span class="attr">14</span> <span class="string">创建OrderDetailService接口，声明saveBatch方法，然后OrderDetailServiceImpl实现类，实现saveBatch方法</span></span><br><span class="line"></span><br><span class="line"><span class="attr">15</span> <span class="string">为啥有了Order表，还要OrderDetail表格，因为分工分表，分表后查询效率快了，而且分工明确。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">16</span>: <span class="string">根据前端用户id以及地址id查询地址信息</span></span><br><span class="line">	<span class="meta">ly-user-pojo微服中的dto包下新建AddressDTO实体类</span> <span class="string">，</span></span><br><span class="line">	<span class="meta">在ly-user-service</span> <span class="string">web层下建立AddressController，建立访问路径为/address的方法</span></span><br><span class="line">	<span class="meta">然后将该方法在le-user-api微服中的UserClient中声明（为了给ly-trade</span> <span class="string">微服访问）</span></span><br><span class="line">	<span class="meta">因此ly-trade</span> <span class="string">微服需要导进来ly-user-api 的依赖，然后相关代码中注入UserClient </span></span><br><span class="line">	<span class="attr">在ly-trade微服中获取到地址信息（物流信息）AddressDTO</span></span><br><span class="line"></span><br><span class="line"><span class="attr">17</span> <span class="string">：物流信息保存到tb_OrderLogistics表中。</span></span><br><span class="line">	<span class="meta">AddressDTO-&gt;OrderLogistics</span> <span class="string">-&gt;tb_OrderLogistics</span></span><br><span class="line"></span><br><span class="line"><span class="attr">19</span> <span class="string">减库存，超卖等分析：</span></span><br><span class="line">	<span class="attr">1</span> <span class="string">先减库存再下单成功 ：对于诸如火车购买等商品具有唯一性的系统，</span></span><br><span class="line">				<span class="attr">只能是先减库存，把班次，车间，座位先占领了再下单。</span></span><br><span class="line">				<span class="attr">因此下单后提醒我们几分钟内要付款，否则下单无效（释放库存）</span></span><br><span class="line">	<span class="attr">2</span> <span class="string">先下单再减库存：支付成功才减库存，所以说在下单后付款成功前，要尽早付款，防止没有库存</span></span><br><span class="line">					<span class="attr">因此经常看到下单后提示我们尽早付款，预防没有库存！</span></span><br><span class="line">	</span><br><span class="line">	<span class="attr">理论上超卖是不应该发生的，从技术上就不应该让其发生，但是超卖会给销售方带来额外的利益</span></span><br><span class="line"><span class="attr">20</span> <span class="string">批量减库存实现（加事务控制）</span></span><br><span class="line">	<span class="meta">前端带Map&lt;skuid,num&gt;</span> <span class="string">访问trade微服--&gt;item 微服，代码逻辑还是上面那一套。</span></span><br><span class="line">	<span class="attr">1</span> <span class="string">先查再减：</span></span><br><span class="line">		<span class="attr">可能会发生错误，比如两个人同时下单，那么最终的剩余库存就为最后写入数据库的库存量，</span></span><br><span class="line">		<span class="attr">只是减去一个人的购买数量。</span></span><br><span class="line">	<span class="attr">2</span> <span class="string">直接减：</span></span><br><span class="line">		<span class="attr">先查后减都是利用到了mybatis-plus的查询和update方法，但是这里直接减，跟mysql交互的sql语句</span></span><br><span class="line">		<span class="attr">mybatis-plus并没有封装，因此我们在mapper层写一个SkuMapper接口继承baseMapper</span></span><br><span class="line">		<span class="attr">然后声明方法：</span></span><br><span class="line">		<span class="meta">@Update(&quot;update</span> <span class="string">tb_sku set stock = stock - #&#123;num&#125; where id = #&#123;skuId&#125;&quot;)</span></span><br><span class="line">		<span class="attr">void</span> <span class="string">minusStock(@Param(&quot;skuId&quot;)Long skuId,@Param(&quot;num&quot;) Integer num);</span></span><br><span class="line">		<span class="attr">那么在SkuService接口就可以直接声明该方法：</span></span><br><span class="line">		<span class="attr">然后在SkuServiceImpl实现类中的“某个方法1”调用该方法实现减库存：</span></span><br><span class="line">			<span class="attr">this.baseMapper.minusStock(skuId,skuMap.get(skuId));</span></span><br><span class="line">		<span class="meta">然后在item-service的GoodService调用“某个方法1”</span> <span class="string"></span></span><br><span class="line">		<span class="attr">然后就是le-item-service的web层，</span></span><br><span class="line">		<span class="attr">再然后是le-item-api的userClient声明方法，</span></span><br><span class="line">		<span class="attr">再然后就是trade微服调用减库存的feign接口。</span></span><br><span class="line"><span class="attr">21</span> <span class="string">库存代码优化：上面代码实现是每减一个商品id的库存都需要执行一次连接，</span></span><br><span class="line">		<span class="attr">我们回顾一下前面学的最底层的sqlSesson，一次连接多次操作，就可以避免上面出现的问题！</span></span><br><span class="line"></span><br><span class="line"><span class="attr">22</span> <span class="string">由上面分析可知：点击下单后，会生成订单，物流信息等等（存入mysql表），</span></span><br><span class="line">	<span class="attr">然后前端会将购物车中已经下单的商品删除，</span></span><br><span class="line"></span><br><span class="line"><span class="attr">23：下完单之后后台需要给前端返回订单id（Long类型）</span></span><br><span class="line"></span><br><span class="line"><span class="attr">24</span> <span class="string">后端Long类型的订单id（雪花算法生成的）数据传到前端的double类型时会发生精度丢失问题，</span></span><br><span class="line">	<span class="attr">虽然都是64位，但是double还需要17位来表示小数，因此精度会丢失。</span></span><br><span class="line">	<span class="attr">解决方案1是：后台传到前端前，Long类型转为String类型。</span></span><br><span class="line">	<span class="attr">解决方案2：前端将后端传过来的数据首先统一当做String来处理，展示，不要先做类型转换。</span></span><br><span class="line">	<span class="attr">保险起见，采用方案1，因为我们并不知道前端的处理能力哈。</span></span><br><span class="line">	</span><br><span class="line"><span class="attr">25：</span></span><br><span class="line">	<span class="attr">带着订单id跳转到pay.html页面，先去根据订单id查询订单详情</span></span><br><span class="line">	<span class="attr">根据订单id查询订单信息封装到的DTO（有status变量，有订单号等信息），</span></span><br><span class="line">	<span class="attr">然后将查到的DTO返回给前端支付页面。</span></span><br><span class="line">	<span class="attr">如果status不为1表示支付成功，跳转到支付成功页面。</span></span><br><span class="line">	<span class="attr">如果status为1表示还没有付款，就会进行支付访问，然后跳转支付页面。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="1-订单数据结构"><a href="#1-订单数据结构" class="headerlink" title="1.订单数据结构"></a>1.订单数据结构</h1><p>加入购物车后，自然就要完成用户下单，订单属于对事务要求较高的业务，肯定不能写入MongoDB，应该写入MySQL数据库中。</p>
<p>我们接下来看看订单表设计：</p>
<h2 id="1-1-数据结构"><a href="#1-1-数据结构" class="headerlink" title="1.1.数据结构"></a>1.1.数据结构</h2><p>订单表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_order` (</span><br><span class="line">  `order_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">  `total_fee` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;总金额，单位为分&#x27;</span>,</span><br><span class="line">  `actual_fee` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;实付金额。单位:分。如:20007，表示:200元7分&#x27;</span>,</span><br><span class="line">  `payment_type` tinyint(<span class="number">2</span>) unsigned zerofill <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;支付类型，1、微信支付，2、支付宝支付&#x27;</span>,</span><br><span class="line">  `post_fee` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;邮费。单位:分。如:20007，表示:200元7分&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `status` tinyint(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单的状态，1、未付款 2、已付款,未发货 3、已发货,未确认 4、确认收货，交易成功 5、交易取消，订单关闭 6、交易结束，已评价&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `pay_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;支付时间&#x27;</span>,</span><br><span class="line">  `consign_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;发货时间&#x27;</span>,</span><br><span class="line">  `end_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;交易完成时间&#x27;</span>,</span><br><span class="line">  `close_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;交易关闭时间&#x27;</span>,</span><br><span class="line">  `comment_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;评价时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> UPDATE <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`order_id`),</span><br><span class="line">  KEY `multi_key_status_time` (`status`,`create_time`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin;</span><br></pre></td></tr></table></figure>



<p>物流信息表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `tb_order_logistics` (</span><br><span class="line">  `order_id` bigint(20) NOT NULL COMMENT &#x27;订单id，与订单表一对一&#x27;,</span><br><span class="line">  `logistics_number` varchar(18) DEFAULT &#x27;&#x27; COMMENT &#x27;物流单号&#x27;,</span><br><span class="line">  `logistics_company` varchar(18) DEFAULT &#x27;&#x27; COMMENT &#x27;物流公司名称&#x27;,</span><br><span class="line">  `addressee` varchar(32) NOT NULL COMMENT &#x27;收件人&#x27;,</span><br><span class="line">  `phone` varchar(11) NOT NULL COMMENT &#x27;收件人手机号码&#x27;,</span><br><span class="line">  `province` varchar(16) NOT NULL COMMENT &#x27;省&#x27;,</span><br><span class="line">  `city` varchar(32) NOT NULL COMMENT &#x27;市&#x27;,</span><br><span class="line">  `district` varchar(32) NOT NULL COMMENT &#x27;区&#x27;,</span><br><span class="line">  `street` varchar(256) NOT NULL COMMENT &#x27;街道&#x27;,</span><br><span class="line">  `postcode` int(6) DEFAULT &#x27;0&#x27; COMMENT &#x27;邮编&#x27;,</span><br><span class="line">  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;更新时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`order_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>



<p>订单条目(<strong>这个表需要重新生成，大家注意一下，ID的类型是Bigint</strong>)：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_order_detail` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `order_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单id&#x27;</span>,</span><br><span class="line">  `sku_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;sku商品id&#x27;</span>,</span><br><span class="line">  `num` <span class="type">int</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;购买数量&#x27;</span>,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品标题&#x27;</span>,</span><br><span class="line">  `spec` <span class="type">varchar</span>(<span class="number">1024</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;商品动态属性键值集&#x27;</span>,</span><br><span class="line">  `price` <span class="type">int</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;价格,单位：分&#x27;</span>,</span><br><span class="line">  `image` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;商品图片&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> UPDATE <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  KEY `key_order_id` (`order_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;订单详情表&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h2 id="1-2-整合MybatisPlus"><a href="#1-2-整合MybatisPlus" class="headerlink" title="1.2.整合MybatisPlus"></a>1.2.整合MybatisPlus</h2><h3 id="1-2-1-依赖"><a href="#1-2-1-依赖" class="headerlink" title="1.2.1.依赖"></a>1.2.1.依赖</h3><p>在<code>ly-trade</code>的<code>pom.xml</code>中添加数据库相关依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mybatis-plus --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mysql驱动 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="1-2-2-配置"><a href="#1-2-2-配置" class="headerlink" title="1.2.2.配置"></a>1.2.2.配置</h3><p>在<code>ly-trade</code>的<code>application.yml</code>中添加数据库配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://ly-mysql:3306/heima?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.leyou.trade.entity</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">INPUT</span> <span class="comment"># 此处的id类型选择INPUT，代表自定义</span></span><br><span class="line">      <span class="attr">insert-strategy:</span> <span class="string">not_null</span></span><br><span class="line">      <span class="attr">update-strategy:</span> <span class="string">not_null</span></span><br></pre></td></tr></table></figure>



<h3 id="1-2-3-启动类注解"><a href="#1-2-3-启动类注解" class="headerlink" title="1.2.3.启动类注解"></a>1.2.3.启动类注解</h3><p>在<code>ly-trade</code>的<code>com.leyou.trade</code>下的启动类<code>LyTradeApplication</code>上添加<code>@MapperScan</code>注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableJwtVerification</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.leyou.trade.mapper&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &#123;&quot;com.leyou.trade&quot;, &quot;com.leyou.common.advice&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LyTradeApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(LyTradeApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="1-3-基本代码"><a href="#1-3-基本代码" class="headerlink" title="1.3.基本代码"></a>1.3.基本代码</h2><h3 id="1-3-1-全局唯一id"><a href="#1-3-1-全局唯一id" class="headerlink" title="1.3.1.全局唯一id"></a>1.3.1.全局唯一id</h3><p>订单数据非常庞大，将来一定会做分库分表。那么这种情况下， 要保证id的唯一，就不能靠数据库自增，而是自己来实现算法，生成唯一id。</p>
<p>有很多种全局唯一ID的生成策略，包括：</p>
<blockquote>
<h4 id="UUID"><a href="#UUID" class="headerlink" title="UUID"></a>UUID</h4></blockquote>
<p>算法的核心思想是结合机器的网卡、当地时间、一个随记数来生成UUID。</p>
<ul>
<li>优点：本地生成，生成简单，性能好，没有高可用风险</li>
<li>缺点：长度过长，存储冗余，且无序不可读，查询效率低</li>
</ul>
<blockquote>
<h4 id="数据库自增ID"><a href="#数据库自增ID" class="headerlink" title="数据库自增ID"></a>数据库自增ID</h4></blockquote>
<p>使用数据库的id自增策略，如 MySQL 的 auto_increment。并且可以使用两台数据库分别设置不同步长，生成不重复ID的策略来实现高可用。</p>
<ul>
<li>优点：数据库生成的ID绝对有序，高可用实现方式简单</li>
<li>缺点：需要独立部署数据库实例，成本高，有性能瓶颈</li>
</ul>
<blockquote>
<h4 id="批量生成ID"><a href="#批量生成ID" class="headerlink" title="批量生成ID"></a>批量生成ID</h4></blockquote>
<p>一次按需批量生成多个ID，每次生成都需要访问数据库，将数据库修改为最大的ID值，并在内存中记录当前值及最大值。</p>
<ul>
<li>优点：避免了每次生成ID都要访问数据库并带来压力，提高性能</li>
<li>缺点：属于本地生成策略，存在单点故障，服务重启造成ID不连续</li>
</ul>
<blockquote>
<h4 id="Redis生成ID"><a href="#Redis生成ID" class="headerlink" title="Redis生成ID"></a>Redis生成ID</h4></blockquote>
<p>Redis的所有命令操作都是单线程的，本身提供像 incr 和 increby 这样的自增原子命令，所以能保证生成的 ID 肯定是唯一有序的。</p>
<ul>
<li>优点：不依赖于数据库，灵活方便，且性能优于数据库；数字ID天然排序，对分页或者需要排序的结果很有帮助。</li>
<li>缺点：如果系统中没有Redis，还需要引入新的组件，增加系统复杂度；需要编码和配置的工作量比较大。</li>
</ul>
<p>考虑到单节点的性能瓶颈，可以使用 Redis 集群来获取更高的吞吐量。假如一个集群中有5台 Redis。可以初始化每台 Redis 的值分别是1, 2, 3, 4, 5，然后步长都是 5。各个 Redis 生成的 ID 为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A：1, 6, 11, 16, 21</span><br><span class="line">B：2, 7, 12, 17, 22</span><br><span class="line">C：3, 8, 13, 18, 23</span><br><span class="line">D：4, 9, 14, 19, 24</span><br><span class="line">E：5, 10, 15, 20, 25</span><br></pre></td></tr></table></figure>

<p>随便负载到哪个机确定好，未来很难做修改。步长和初始值一定需要事先确定。使用 Redis 集群也可以方式单点故障的问题。</p>
<p>另外，比较适合使用 Redis 来生成每天从0开始的流水号。比如订单号 = 日期 + 当日自增长号。可以每天在 Redis 中生成一个 Key ，使用 INCR 进行累加。</p>
<blockquote>
<h4 id="Twitter的snowflake算法"><a href="#Twitter的snowflake算法" class="headerlink" title="Twitter的snowflake算法"></a>Twitter的snowflake算法</h4></blockquote>
<p>Twitter 利用 zookeeper 实现了一个全局ID生成的服务 Snowflake：<a target="_blank" rel="noopener" href="https://github.com/twitter/snowflake">github.com/twitter/sno…</a></p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/1645b1a7a9beb2b6" alt="img"></p>
<p>如上图的所示，Twitter 的 Snowflake 算法由下面几部分组成：</p>
<ul>
<li>1位符号位：**</li>
</ul>
<p>由于 long 类型在 java 中带符号的，最高位为符号位，正数为 0，负数为 1，且实际系统中所使用的ID一般都是正数，所以最高位为 0。</p>
<ul>
<li><strong>41位时间戳（毫秒级）：</strong></li>
</ul>
<p>需要注意的是此处的 41 位时间戳并非存储当前时间的时间戳，而是存储时间戳的差值（当前时间戳 - 起始时间戳），这里的起始时间戳一般是ID生成器开始使用的时间戳，由程序来指定，所以41位毫秒时间戳最多可以使用 <code>(1 &lt;&lt; 41) / (1000x60x60x24x365) = 69年</code>。</p>
<ul>
<li><strong>10位数据机器位：</strong></li>
</ul>
<p>包括5位数据标识位和5位机器标识位，这10位决定了分布式系统中最多可以部署 <code>1 &lt;&lt; 10 = 1024</code> s个节点。超过这个数量，生成的ID就有可能会冲突。</p>
<ul>
<li><strong>12位毫秒内的序列：</strong></li>
</ul>
<p>这 12 位计数支持每个节点每毫秒（同一台机器，同一时刻）最多生成 <code>1 &lt;&lt; 12 = 4096个ID</code></p>
<p>加起来刚好64位，为一个Long型。</p>
<ul>
<li>优点：高性能，低延迟，按时间有序，一般不会造成ID碰撞</li>
<li>缺点：需要独立的开发和部署，依赖于机器的时钟</li>
</ul>
<blockquote>
<h4 id="百度UidGenerator"><a href="#百度UidGenerator" class="headerlink" title="百度UidGenerator"></a>百度UidGenerator</h4></blockquote>
<p>UidGenerator是百度开源的分布式ID生成器，基于于snowflake算法的实现，看起来感觉还行。不过，国内开源的项目维护性真是担忧。</p>
<p>具体可以参考官网说明：<a target="_blank" rel="noopener" href="https://github.com/baidu/uid-generator/blob/master/README.zh_cn.md">github.com/baidu/uid-g…</a></p>
<blockquote>
<h4 id="美团Leaf"><a href="#美团Leaf" class="headerlink" title="美团Leaf"></a>美团Leaf</h4></blockquote>
<p>Leaf 是美团开源的分布式ID生成器，能保证全局唯一性、趋势递增、单调递增、信息安全，里面也提到了几种分布式方案的对比，但也需要依赖关系数据库、Zookeeper等中间件。</p>
<p>具体可以参考官网说明：<a target="_blank" rel="noopener" href="https://tech.meituan.com/MT_Leaf.html">tech.meituan.com/MT_Leaf.htm…</a></p>
<p>在我们的项目中，会使用<strong>雪花算法</strong>作为唯一id的生成算法。</p>
<h3 id="1-3-2-实体类"><a href="#1-3-2-实体类" class="headerlink" title="1.3.2.实体类"></a>1.3.2.实体类</h3><p>接下来，在<code>ly-trade</code>的<code>com.leyou.trade.entity</code>包中添加几个实体类。</p>
<h4 id="1-3-2-1-Order"><a href="#1-3-2-1-Order" class="headerlink" title="1.3.2.1.Order"></a>1.3.2.1.Order</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.handlers.MybatisEnumTypeHandler;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.entity.BaseEntity;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.enums.OrderStatus;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="meta">@TableName(&quot;tb_order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId(type = IdType.ASSIGN_ID)</span></span><br><span class="line">    <span class="keyword">private</span> Long orderId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long totalFee;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮费</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long postFee;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实付金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long actualFee;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 付款方式：1:微信支付, 2:支付宝支付</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer paymentType;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单状态,1、未付款 2、已付款,未发货 3、已发货,未确认 4、确认收货，交易成功 5、交易取消，订单关闭 6、交易结束</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(typeHandler = MybatisEnumTypeHandler.class)</span></span><br><span class="line">    <span class="keyword">private</span> OrderStatus status;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 付款时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date payTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发货时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date consignTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 确认收货时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date endTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易关闭时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date closeTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 评价时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date commentTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>需要注意的地方：</p>
<ul>
<li>id类型：这里是<code>@TableId(type = IdType.ASSIGN_ID)</code>，代表是自动生成ID，id生成算法是由MybatisPlus内置的雪花算法（SnowFlake，由Twitter公司开源）</li>
<li>订单状态：订单状态包含多个，在数据库中是数字，不太方便记忆。为了避免出错，这里我们使用了枚举<code>OrderStatus</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.entity.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.EnumValue;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonValue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">OrderStatus</span> </span>&#123;</span><br><span class="line">    INIT(<span class="number">1</span>, <span class="string">&quot;初始化，未付款&quot;</span>),</span><br><span class="line">    PAY_UP(<span class="number">2</span>, <span class="string">&quot;已付款，未发货&quot;</span>),</span><br><span class="line">    DELIVERED(<span class="number">3</span>, <span class="string">&quot;已发货，未确认&quot;</span>),</span><br><span class="line">    CONFIRMED(<span class="number">4</span>, <span class="string">&quot;已确认,未评价&quot;</span>),</span><br><span class="line">    CLOSED(<span class="number">5</span>, <span class="string">&quot;已关闭&quot;</span>),</span><br><span class="line">    RATED(<span class="number">6</span>, <span class="string">&quot;已评价，交易结束&quot;</span>)</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer value;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    OrderStatus(Integer value, String msg) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getValue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="1-3-2-2-OrderDetail"><a href="#1-3-2-2-OrderDetail" class="headerlink" title="1.3.2.2.OrderDetail"></a>1.3.2.2.OrderDetail</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.entity.BaseEntity;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="meta">@TableName(&quot;tb_order_detail&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderDetail</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId(type = IdType.ASSIGN_ID)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long orderId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long skuId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品购买数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer num;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品标题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品单价</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long price;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品规格数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String spec;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String image;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="1-3-2-3-OrderLogistics"><a href="#1-3-2-3-OrderLogistics" class="headerlink" title="1.3.2.3.OrderLogistics"></a>1.3.2.3.OrderLogistics</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.entity.BaseEntity;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="meta">@TableName(&quot;tb_order_logistics&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderLogistics</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单id，与订单表一对一</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId</span></span><br><span class="line">    <span class="keyword">private</span> Long orderId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 物流单号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String logisticsNumber;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 物流名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String logisticsCompany;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收件人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String addressee;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 手机号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 省</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String province;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 市</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 区</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String district;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 街道</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String street;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮编</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String postcode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-3-3-MybatisPlus对枚举的支持"><a href="#1-3-3-MybatisPlus对枚举的支持" class="headerlink" title="1.3.3.MybatisPlus对枚举的支持"></a>1.3.3.MybatisPlus对枚举的支持</h3><p>我们的订单实体类中使用了枚举，而数据库中是int类型，那么在读写数据库的时候，如何实现int与enum间互相转换呢？</p>
<p>MybatisPlus已经默认支持了枚举的转换，你只需要这样做：</p>
<h4 id="1）在枚举类上添加注解"><a href="#1）在枚举类上添加注解" class="headerlink" title="1）在枚举类上添加注解"></a>1）在枚举类上添加注解</h4><p>枚举中必须包含一个属性，属性值会作为将来写入数据库的值，比如：</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/image-20200730214640455.png" alt="image-20200730214640455"></p>
<p>这个字段需要添加注解：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/image-20200325171734293.png" alt="image-20200325171734293"> </p>
<p>完整内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.entity.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.EnumValue;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonValue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">OrderStatus</span> </span>&#123;</span><br><span class="line">    INIT(<span class="number">1</span>, <span class="string">&quot;初始化，未付款&quot;</span>),</span><br><span class="line">    PAY_UP(<span class="number">2</span>, <span class="string">&quot;已付款，未发货&quot;</span>),</span><br><span class="line">    DELIVERED(<span class="number">3</span>, <span class="string">&quot;已发货，未确认&quot;</span>),</span><br><span class="line">    CONFIRMED(<span class="number">4</span>, <span class="string">&quot;已确认,未评价&quot;</span>),</span><br><span class="line">    CLOSED(<span class="number">5</span>, <span class="string">&quot;已关闭&quot;</span>),</span><br><span class="line">    RATED(<span class="number">6</span>, <span class="string">&quot;已评价，交易结束&quot;</span>)</span><br><span class="line">    ;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 枚举值，对应订单状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@EnumValue</span></span><br><span class="line">    <span class="meta">@JsonValue</span></span><br><span class="line">    <span class="keyword">private</span> Integer value;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文字说明</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    OrderStatus(Integer value, String msg) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getValue</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2）在配置文件中添加枚举配置"><a href="#2）在配置文件中添加枚举配置" class="headerlink" title="2）在配置文件中添加枚举配置"></a>2）在配置文件中添加枚举配置</h4><p>修改<code>ly-trade</code>的<code>application.yml</code>，添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.leyou.trade.entity</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">INPUT</span></span><br><span class="line">      <span class="attr">insert-strategy:</span> <span class="string">not_null</span></span><br><span class="line">      <span class="attr">update-strategy:</span> <span class="string">not_null</span></span><br><span class="line">  <span class="attr">type-enums-package:</span> <span class="string">com.leyou.trade.entity.enums</span> <span class="comment"># 枚举扫描包</span></span><br></pre></td></tr></table></figure>

<p>这里添加了两个配置:</p>
<ul>
<li><code>type-enums-package</code>：自定义枚举所在的包</li>
</ul>
<h4 id="3）实体类的枚举属性添加类型转换器"><a href="#3）实体类的枚举属性添加类型转换器" class="headerlink" title="3）实体类的枚举属性添加类型转换器"></a>3）实体类的枚举属性添加类型转换器</h4><p>给Order类的枚举属性添加类型转换器（TypeHandler），将来可以实现mysql数据类型与Java类型的互相转换：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/image-20200508110802591.png" alt="image-20200508110802591"></p>
<h3 id="1-3-4-mapper接口"><a href="#1-3-4-mapper接口" class="headerlink" title="1.3.4.mapper接口"></a>1.3.4.mapper接口</h3><p>在<code>ly-trade</code>的<code>com.leyou.trade.mapper</code>包中添加几个mapper接口：</p>
<p>OrderMapper:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.mapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.Order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Order</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>OrderDetailMapper：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.OrderDetail;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderDetailMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">OrderDetail</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>OrderLogisticsMapper:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.OrderLogistics;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderLogisticsMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">OrderLogistics</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-3-5-Service"><a href="#1-3-5-Service" class="headerlink" title="1.3.5.Service"></a>1.3.5.Service</h3><p>在<code>ly-trade</code>的<code>com.leyou.trade.service</code>包中添加几个Service接口：</p>
<p>OrderService:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.Order;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">Order</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>OrderDetailService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.OrderDetail;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderDetailService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">OrderDetail</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>OrderLogisticsService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.OrderLogistics;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderLogisticsService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">OrderLogistics</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在<code>ly-trade</code>的<code>com.leyou.trade.service.impl</code>包中添加几个Service的实现类：</p>
<p>OrderServiceImpl:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.Order;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.mapper.OrderMapper;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">OrderMapper</span>, <span class="title">Order</span>&gt; <span class="keyword">implements</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OrderDetailServiceImpl:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.OrderDetail;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.mapper.OrderDetailMapper;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.service.OrderDetailService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderDetailServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">OrderDetailMapper</span>, <span class="title">OrderDetail</span>&gt; <span class="keyword">implements</span> <span class="title">OrderDetailService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OrderLogisticsServiceImpl:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.OrderLogistics;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.mapper.OrderLogisticsMapper;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.service.OrderLogisticsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderLogisticsServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">OrderLogisticsMapper</span>, <span class="title">OrderLogistics</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">OrderLogisticsService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="2-订单结算页"><a href="#2-订单结算页" class="headerlink" title="2.订单结算页"></a>2.订单结算页</h1><p>在购物车页面，用户会点击<code>去结算</code>按钮:</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/1527990452791.png" alt="1527990452791"></p>
<p>随后就会进入订单结算页，展示用户正在购买的商品，并且需要用户选择收货人地址、付款方式等信息：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/image-20200730215048559.png" alt="image-20200730215048559"></p>
<p>这个页面需要完成的功能如下：</p>
<ul>
<li>收件人信息展示、选择</li>
<li>支付方式选择</li>
<li>商品清单展示</li>
</ul>
<h2 id="2-1-收货人信息（作业）"><a href="#2-1-收货人信息（作业）" class="headerlink" title="2.1.收货人信息（作业）"></a>2.1.收货人信息（作业）</h2><p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/image-20200730215139173.png" alt="image-20200730215139173"></p>
<p>这里的收货人信息肯定是当前登录用户的收货地址。所以需要根据当前登录用户去查询，目前我们在页面是写的假数据：</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/image-20200730215536174.png" alt="image-20200730215536174"></p>
<p>大家可以在在后台提供地址的增删改查接口，然后页面加载时根据当前登录用户查询，而后赋值给addresses即可。</p>
<h2 id="2-2-支付方式"><a href="#2-2-支付方式" class="headerlink" title="2.2.支付方式"></a>2.2.支付方式</h2><p>支付方式有2种：</p>
<ul>
<li>微信支付</li>
<li>货到付款</li>
</ul>
<p>与我们订单数据中的<code>paymentType</code>关联：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/1528012065388.png" alt="1528012065388"></p>
<p>所以我们可以在Vue实例中定义一个属性来记录支付方式：</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/1535897554691.png" alt="1535897554691"></p>
<p>然后在页面渲染时与这个变量关联：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/1535897599041.png" alt="1535897599041"></p>
<p>效果：</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/abc.gif" alt="abc"></p>
<h2 id="2-3-商品清单"><a href="#2-3-商品清单" class="headerlink" title="2.3.商品清单"></a>2.3.商品清单</h2><p>商品清单是通过localstorage从购物车页面传递过来的，到了本页从localstorage取出并且记录在data中：</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/1535897715255.png" alt="1535897715255"></p>
<p>随后在页面渲染完成.</p>
<h2 id="2-4-提交订单"><a href="#2-4-提交订单" class="headerlink" title="2.4.提交订单"></a>2.4.提交订单</h2><p>当点击<code>提交订单</code>按钮，会看到控制台发起请求：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/image-20200325175330382.png" alt="image-20200325175330382"></p>
<p>参数说明：</p>
<ul>
<li>addressId：收货人地址信息的id，需要去用户中心查询收货人地址</li>
<li>carts：购物车中的商品数据，key-value结构<ul>
<li>key：购物车中的某商品的id</li>
<li>value：购物车中指定商品的购买数量</li>
</ul>
</li>
<li>paymentType：付款方式：1 在线支付，2 货到付款</li>
</ul>
<p>对应的JS代码：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/1555471464247.png" alt="1555471464247"></p>
<p>可以看到返回的提交订单成功，返回的应该是订单的编号id。</p>
<p>请求分析：</p>
<ul>
<li>请求方式：POST</li>
<li>请求路径：/order</li>
<li>请求参数：JSON对象，包含属性：<ul>
<li>addressId：收货人地址id</li>
<li>paymentType：付款方式</li>
<li>carts：购物车商品数据的map集合</li>
</ul>
</li>
<li>返回结果：订单id</li>
</ul>
<p>代表订单的DTO对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderFormDTO</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> Long addressId; <span class="comment">// 收获人地址id</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer paymentType;<span class="comment">// 付款类型</span></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">private</span> Map&lt;Long,Integer&gt; carts;<span class="comment">// 订单中商品</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="3-创建订单接口"><a href="#3-创建订单接口" class="headerlink" title="3.创建订单接口"></a>3.创建订单接口</h1><p>订单信息共有3张表，内容很多，但是前台提交的数据却只很少，也就是说我们需要自己填充很多的数据。</p>
<h2 id="3-1-Controller"><a href="#3-1-Controller" class="headerlink" title="3.1.Controller"></a>3.1.Controller</h2><p>在<code>ly-trade</code>的<code>com.leyou.trade.web</code>包中，创建一个Controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.dto.OrderFormDTO;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.Valid;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderController</span><span class="params">(OrderService orderService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.orderService = orderService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderDTO 订单数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 订单id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;Long&gt; <span class="title">createOrder</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Valid</span> OrderFormDTO orderDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.CREATED).body(orderService.createOrder(orderDTO));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-2-Service"><a href="#3-2-Service" class="headerlink" title="3.2.Service"></a>3.2.Service</h2><p>在<code>ly-trade</code>的<code>com.leyou.trade.service</code>的<code>OrderService</code>接口中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建订单</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Long <span class="title">createOrder</span><span class="params">(<span class="meta">@Valid</span> OrderFormDTO orderDTO)</span></span>;</span><br></pre></td></tr></table></figure>



<p>订单相关表有3个，包括：</p>
<ul>
<li>订单</li>
<li>订单详情</li>
<li>订单物流</li>
</ul>
<p>但是页面提交的数据却少的可怜，仅仅包括：</p>
<ul>
<li>支付类型（支付方式）</li>
<li>收获地址id</li>
<li>商品购物车列表，仅包含：商品id和购买数量</li>
</ul>
<p>那么这些数据要从哪里获取呢？怎样获取三张表的数据呢？</p>
<h3 id="3-2-1-订单Order"><a href="#3-2-1-订单Order" class="headerlink" title="3.2.1.订单Order"></a>3.2.1.订单Order</h3><p>订单表中包括的信息大概有这么几部分：</p>
<ul>
<li>订单id</li>
<li>订单金额相关，包括<ul>
<li>支付类型</li>
<li>商品总金额</li>
<li>实付金额</li>
<li>邮费</li>
</ul>
</li>
<li>用户id</li>
<li>订单状态相关，包括：<ul>
<li>订单状态</li>
<li>订单不同状态对应的时间</li>
</ul>
</li>
</ul>
<p>页面只提交了一个支付类型、商品id、购买数量，其它内容都没有，我们如何获取？</p>
<ul>
<li>订单id：可以通过雪花算法来获取</li>
<li>订单金额部分：<ul>
<li>支付类型已经有了，</li>
<li>总金额：根据商品id查询到商品价格，然后乘以商品数量，再累加各个商品结果得来</li>
<li>邮费：需要结合收获地址，去物流系统根据运费模板计算得到（其它微服务的业务），我们暂时不做。</li>
<li>实付金额：要去优惠业务的微服务查询商品是否满足优惠信息，用户是否有优惠券等，得到优惠金额，用总金额 + 邮费 - 优惠金额 得到，我们暂时不做。</li>
</ul>
</li>
<li>用户id：我们有一个UserContext可以获取</li>
<li>订单状态：默认订单为初始化状态，时间又数据库默认当前时间。其它状态以后随着业务变化再填写。</li>
</ul>
<h3 id="3-2-2-订单详情OrderDetail"><a href="#3-2-2-订单详情OrderDetail" class="headerlink" title="3.2.2.订单详情OrderDetail"></a>3.2.2.订单详情OrderDetail</h3><p>订单详情包括的数据有：</p>
<ul>
<li>订单id：在订单新增以后，就会回显id</li>
<li>商品相关：<ul>
<li>商品id：页面提交了</li>
<li>购买数量num：页面提交了</li>
<li>商品价格、图片、spec、标题：需要根据商品id到商品微服务查询</li>
</ul>
</li>
</ul>
<p>问题：为什么不让页面直接把商品价格、图片、spec、标题都提交到服务端，而是只提交了商品id？</p>
<p>答：为了安全考虑，商品价格等敏感信息由客户端提交存在风险。</p>
<p>因此，我们需要在订单微服务调用商品微服务</p>
<p><strong>1）引入Feign和商品服务的依赖</strong></p>
<p>在<code>ly-trade</code>的pom.xml中添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--item接口--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ly-item-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="3-3-3-订单物流-OrderLogistics"><a href="#3-3-3-订单物流-OrderLogistics" class="headerlink" title="3.3.3.订单物流 OrderLogistics"></a>3.3.3.订单物流 OrderLogistics</h3><p>OrderLogistics包括的数据：</p>
<ul>
<li>订单id：等订单新增完成，会回显</li>
<li>物流相关：暂时不管，这个是发货以后填写<ul>
<li>物流单号</li>
<li>物流公司</li>
</ul>
</li>
<li>收货人地址：页面仅仅提供了收件人地址的ID，需要去查询<ul>
<li>收件人</li>
<li>省</li>
<li>市</li>
<li>区</li>
<li>街道</li>
<li>电话</li>
<li>邮编</li>
</ul>
</li>
</ul>
<p>这张表数据目前需要填写的就是收货人地址，页面仅仅提供了收件人地址的ID，需要去查询。</p>
<p>而收货人地址肯定是在用户微服务(ly-user)中管理的，因此也需要到用户微服务远程调用，根据id查询出收货人详细信息。</p>
<p>目前用户微服务中没有完成收货人管理的功能，因此我们先准备一些假数据。</p>
<p><strong>1）实体类</strong>：</p>
<p>我们在<code>ly-user-pojo</code>中的<code>com.leyou.user.dto</code>包达内添加收货人地址的DTO：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.user.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.common.dto.BaseDTO;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.entity.BaseEntity;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddressDTO</span> <span class="keyword">extends</span> <span class="title">BaseDTO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String addressee;<span class="comment">// 收件人姓名</span></span><br><span class="line">    <span class="keyword">private</span> String phone;<span class="comment">// 电话</span></span><br><span class="line">    <span class="keyword">private</span> String province;<span class="comment">// 省份</span></span><br><span class="line">    <span class="keyword">private</span> String city;<span class="comment">// 城市</span></span><br><span class="line">    <span class="keyword">private</span> String district;<span class="comment">// 区</span></span><br><span class="line">    <span class="keyword">private</span> String street;<span class="comment">// 街道地址</span></span><br><span class="line">    <span class="keyword">private</span> String  postcode;<span class="comment">// 邮编</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isDefault;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AddressDTO</span><span class="params">(BaseEntity entity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(entity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2）API接口</strong></p>
<p>然后在<code>ly-user-api</code>的<code>UserClient</code>中添加新功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 地址id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 地址信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/address/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="function">AddressDTO <span class="title">queryAddressById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;</span><br></pre></td></tr></table></figure>



<p><strong>3）Controller接口</strong></p>
<p>然后在<code>ly-user-service</code>中的<code>com.leyou.user.web</code>包添加新的controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.user.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.user.dto.AddressDTO;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;address&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddressController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 地址id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 地址信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;AddressDTO&gt; <span class="title">queryAddressById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>&#123;</span><br><span class="line">        AddressDTO address = <span class="keyword">new</span> AddressDTO();</span><br><span class="line">        address.setId(<span class="number">1L</span>);</span><br><span class="line">        address.setUserId(<span class="number">30L</span>);</span><br><span class="line">        address.setStreet(<span class="string">&quot;航头镇航头路18号传智播客 3号楼&quot;</span>);</span><br><span class="line">        address.setCity(<span class="string">&quot;上海&quot;</span>);</span><br><span class="line">        address.setDistrict(<span class="string">&quot;浦东新区&quot;</span>);</span><br><span class="line">        address.setAddressee(<span class="string">&quot;社会我拓哥&quot;</span>);</span><br><span class="line">        address.setPhone(<span class="string">&quot;15800000000&quot;</span>);</span><br><span class="line">        address.setProvince(<span class="string">&quot;上海&quot;</span>);</span><br><span class="line">        address.setPostcode(<span class="string">&quot;210000&quot;</span>);</span><br><span class="line">        address.setIsDefault(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(address);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4）ly-trade中引用</strong></p>
<p>在<code>ly-trade</code>的pom.xml中添加user的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ly-user-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>5）启动类扫描包</strong></p>
<p>在<code>ly-trade</code>的启动类上，@EnableFeignClient注解需要添加一个对<code>com.leyou.user.client</code>的扫描包：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableFeignClients(&#123;&quot;com.leyou.item.client&quot;, &quot;com.leyou.user.client&quot;&#125;)</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.leyou.trade.mapper&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &#123;&quot;com.leyou.trade&quot;, &quot;com.leyou.common.advice&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJwtVerification</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LyTradeApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(LyTradeApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-4-OrderService的业务实现"><a href="#3-2-4-OrderService的业务实现" class="headerlink" title="3.2.4.OrderService的业务实现"></a>3.2.4.OrderService的业务实现</h3><p>在<code>ly-trade</code>的<code>com.leyou.trade.service.impl</code>包中的<code>OrderServiceImpl</code>中添加业务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.utils.UserContext;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.exception.LyException;</span><br><span class="line"><span class="keyword">import</span> com.leyou.item.client.ItemClient;</span><br><span class="line"><span class="keyword">import</span> com.leyou.item.dto.SkuDTO;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.dto.OrderFormDTO;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.Order;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.OrderDetail;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.OrderLogistics;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.enums.OrderStatus;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.mapper.OrderMapper;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> com.leyou.user.client.UserClient;</span><br><span class="line"><span class="keyword">import</span> com.leyou.user.dto.AddressDTO;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">OrderMapper</span>, <span class="title">Order</span>&gt; <span class="keyword">implements</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OrderDetailServiceImpl detailService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OrderLogisticsServiceImpl logisticsService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ItemClient itemClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserClient userClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderServiceImpl</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">                            OrderDetailServiceImpl detailService,</span></span></span><br><span class="line"><span class="params"><span class="function">                            OrderLogisticsServiceImpl logisticsService,</span></span></span><br><span class="line"><span class="params"><span class="function">                            ItemClient itemClient, UserClient userClient)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.detailService = detailService;</span><br><span class="line">        <span class="keyword">this</span>.logisticsService = logisticsService;</span><br><span class="line">        <span class="keyword">this</span>.itemClient = itemClient;</span><br><span class="line">        <span class="keyword">this</span>.userClient = userClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">createOrder</span><span class="params">(<span class="meta">@Valid</span> OrderFormDTO orderDTO)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.写order</span></span><br><span class="line">        Order order = <span class="keyword">new</span> Order();</span><br><span class="line">        <span class="comment">// 1.1 用户id</span></span><br><span class="line">        Long userId = UserContext.getUser().getId();</span><br><span class="line">        order.setUserId(userId);</span><br><span class="line">        <span class="comment">// 1.2 金额相关信息</span></span><br><span class="line">        Map&lt;Long, Integer&gt; carts = orderDTO.getCarts();</span><br><span class="line">        <span class="comment">// 1.2.1.获取所有sku的id</span></span><br><span class="line">        List&lt;Long&gt; idList = <span class="keyword">new</span> ArrayList&lt;&gt;(carts.keySet());</span><br><span class="line">        <span class="comment">// 1.2.2.查询sku</span></span><br><span class="line">        List&lt;SkuDTO&gt; skuList = itemClient.querySkuByIds(idList);</span><br><span class="line">        <span class="comment">// 1.2.3 计算金额的和</span></span><br><span class="line">        <span class="keyword">long</span> total = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (SkuDTO sku : skuList) &#123;</span><br><span class="line">            <span class="comment">// 获取金额</span></span><br><span class="line">            <span class="keyword">int</span> num = carts.get(sku.getId());</span><br><span class="line">            <span class="comment">// 计算总金额</span></span><br><span class="line">            total += sku.getPrice() * num;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 1.2.4 填写金额数据</span></span><br><span class="line">        order.setTotalFee(total);</span><br><span class="line">        order.setPaymentType(orderDTO.getPaymentType());</span><br><span class="line">        order.setPostFee(<span class="number">0L</span>);<span class="comment">// 全场包邮</span></span><br><span class="line">        order.setActualFee(total + order.getPostFee()<span class="comment">/* - 优惠金额*/</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.3 订单状态初始化</span></span><br><span class="line">        order.setStatus(OrderStatus.INIT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.4 写order到数据库</span></span><br><span class="line">        <span class="keyword">boolean</span> success = save(order);</span><br><span class="line">        <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LyException(<span class="number">500</span>, <span class="string">&quot;订单创建失败！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.写OrderDetail</span></span><br><span class="line">        <span class="comment">// 2.1.定义一个OrderDetail的集合</span></span><br><span class="line">        List&lt;OrderDetail&gt; details = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 2.2.遍历sku集合，转为detail</span></span><br><span class="line">        <span class="keyword">for</span> (SkuDTO sku : skuList) &#123;</span><br><span class="line">            <span class="comment">// 2.2.1.商品数量</span></span><br><span class="line">            <span class="keyword">int</span> num = carts.get(sku.getId());</span><br><span class="line">            <span class="comment">// 2.2.2.组装OrderDetail</span></span><br><span class="line">            OrderDetail detail = <span class="keyword">new</span> OrderDetail();</span><br><span class="line">            detail.setOrderId(order.getOrderId());</span><br><span class="line">            detail.setImage(StringUtils.substringBefore(sku.getImages(), <span class="string">&quot;,&quot;</span>));</span><br><span class="line">            detail.setNum(num);</span><br><span class="line">            detail.setSkuId(sku.getId());</span><br><span class="line">            detail.setSpec(sku.getSpecialSpec());</span><br><span class="line">            detail.setPrice(sku.getPrice());</span><br><span class="line">            detail.setTitle(sku.getTitle());</span><br><span class="line">            <span class="comment">// 2.2.3.装入detail集合</span></span><br><span class="line">            details.add(detail);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.3.批量新增</span></span><br><span class="line">        success = detailService.saveBatch(details);</span><br><span class="line">        <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LyException(<span class="number">500</span>, <span class="string">&quot;订单创建失败！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.写orderLogistics</span></span><br><span class="line">        <span class="comment">// 3.1.查询收货地址</span></span><br><span class="line">        AddressDTO address = userClient.queryAddressById(orderDTO.getAddressId());</span><br><span class="line">        <span class="comment">// 3.2.填写物流信息</span></span><br><span class="line">        OrderLogistics logistics = address.toEntity(OrderLogistics.class);</span><br><span class="line">        logistics.setOrderId(order.getOrderId());</span><br><span class="line">        <span class="comment">// 3.3.写入数据库</span></span><br><span class="line">        success = logisticsService.save(logistics);</span><br><span class="line">        <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LyException(<span class="number">500</span>, <span class="string">&quot;订单创建失败！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 返回订单编号</span></span><br><span class="line">        <span class="keyword">return</span> order.getOrderId();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="3-3-减库存"><a href="#3-3-减库存" class="headerlink" title="3.3.减库存"></a>3.3.减库存</h2><p>到这里似乎创建订单业务完成了。不过有一个问题需要我们思考：创建了订单，用户购买的商品是否要扣减库存呢？还是等到用户支付的时候再扣减库存？</p>
<h3 id="3-3-1-何时减库存"><a href="#3-3-1-何时减库存" class="headerlink" title="3.3.1.何时减库存"></a>3.3.1.何时减库存</h3><p>我们来分析下：</p>
<ul>
<li><p>支付减库存？</p>
<ul>
<li>优点：用户付款，才会减库存，可以确定用户一定有购买意图，不会出现恶意下单导致的库存堆积</li>
<li>缺点：可能用户付款后，发现库存不足，用户体验差</li>
</ul>
</li>
<li><p>下单减库存</p>
<ul>
<li>优点：下单就预留库存，用户付款一定能拿到商品，体验比较好</li>
<li>缺点：如果用户下单，不付款，会占用商家库存，导致它人无法购买</li>
</ul>
</li>
</ul>
<p>我们需要根据不同的场景去做选择，如果更在意用户体验，应该选择下单减库存！但是如何应对下单减库存的缺点呢？</p>
<ul>
<li>超时未支付的订单需要关闭</li>
<li>限定每个用户每天可以取消订单的次数</li>
</ul>
<p>在项目中，我们采用下单减库存方案。</p>
<h3 id="3-3-2-减库存接口"><a href="#3-3-2-减库存接口" class="headerlink" title="3.3.2.减库存接口"></a>3.3.2.减库存接口</h3><p>我们首先在商品微服务提供减库存接口</p>
<p>在<code>ly-item-api</code>的<code>ItemClient</code>中添加接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 减库存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cartMap 商品id及数量的map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/goods/stock/minus&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deductStock</span><span class="params">(<span class="meta">@RequestBody</span> Map&lt;Long, Integer&gt; cartMap)</span></span>;</span><br></pre></td></tr></table></figure>

<p>在<code>ly-item-service</code>的<code>GoodsController</code>中编写业务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣减库存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cartMap 商品集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/stock/minus&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title">deductStock</span><span class="params">(<span class="meta">@RequestBody</span> Map&lt;Long, Integer&gt; cartMap)</span></span>&#123;</span><br><span class="line">    skuService.deductStock(cartMap);</span><br><span class="line">    <span class="keyword">return</span> ResponseEntity.noContent().build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>ly-item-service</code>的<code>SkuService</code>中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deductStock</span><span class="params">(Map&lt;Long, Integer&gt; cartMap)</span></span>;</span><br></pre></td></tr></table></figure>



<p>减库存的同时还要对商品的销量做+的操作，这个sql我们通过手写完成，定义在mapper中。</p>
<p>在<code>ly-item-service</code>的<code>com.leyou.item.mapper</code>的<code>SkuMapper</code>中定义方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.item.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.leyou.item.entity.Sku;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Update;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SkuMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Sku</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Update(&quot;UPDATE tb_sku SET stock = stock - #&#123;num&#125;, sold = sold + #&#123;num&#125; WHERE id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deductStock</span><span class="params">(Map&lt;String,Object&gt; sku)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="1）扣减库存的安全问题1"><a href="#1）扣减库存的安全问题1" class="headerlink" title="1）扣减库存的安全问题1"></a>1）扣减库存的安全问题1</h4><p>在<code>ly-item-service</code>的<code>SkuServiceImpl</code>中实现业务：</p>
<p>分析减库存的安全问题，假设我们这样来实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deductStock</span><span class="params">(Map&lt;Long, Integer&gt; skuMap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Long, Integer&gt; entry : skuMap.entrySet()) &#123;</span><br><span class="line">        Long skuId = entry.getKey();</span><br><span class="line">        Integer num = entry.getValue();</span><br><span class="line">        <span class="comment">// 查询sku</span></span><br><span class="line">        Sku sku = getById(skuId);</span><br><span class="line">        <span class="comment">//  判断库存是否充足</span></span><br><span class="line">        <span class="keyword">if</span> (sku.getStock() &lt; num) &#123;</span><br><span class="line">            <span class="comment">// 如果不足，抛出异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LyException(<span class="number">400</span>, <span class="string">&quot;库存不足！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果充足，扣减库存 update tb_sku set stock = stock - 1, sold = sold + 1  where id = 1</span></span><br><span class="line">        Map&lt;String,Object&gt; param = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        param.put(<span class="string">&quot;id&quot;</span>, skuId);</span><br><span class="line">        param.put(<span class="string">&quot;num&quot;</span>, num);</span><br><span class="line">        getBaseMapper().deductStock(param);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这样的操作存在线程安全的风险，因为我们的代码是允许在多线程环境的，当多个用户并发访问时，先判断库存是否充足，然后再执行减库存，会出现一种情况：</p>
<ul>
<li>判断的时候，库存是充足的，但是在减库存之前，有其它线程抢先一步，扣减库存，导致库存不足了，此时就会出现超卖现象！</li>
</ul>
<h4 id="2）思路1，同步锁"><a href="#2）思路1，同步锁" class="headerlink" title="2）思路1，同步锁"></a>2）思路1，同步锁</h4><p>按照以往的思路，我们应该怎么做？</p>
<p>我们一般需要加同步锁，synchronized，目的是让多线程串行执行，从而保证线程安全，但是加synchronized只能保证在当前JVM内的线程安全。</p>
<p>如果是搭建一个微服务集群，同步锁synchronized就失效了。原因是因为线程锁，在多进程时会失效，因为每个进程都有自己的锁。</p>
<p>解决多进程安全问题，必须使用进程锁（分布式锁）：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/image-20200508155602143.png" alt="image-20200508155602143"></p>
<p>利用上面的方案缺点是：需要额外实现一个分布式锁功能，比较麻烦。</p>
<h4 id="3）思路2，数据库排它锁"><a href="#3）思路2，数据库排它锁" class="headerlink" title="3）思路2，数据库排它锁"></a>3）思路2，数据库排它锁</h4><p>数据库锁简单来说有两种：</p>
<ul>
<li>共享锁：读操作时会开启共享锁，此时大家都可以查询</li>
<li>排它锁（互斥锁）：一般是写操作会开启排它锁，此时其它事务无法获取共享锁或排它锁，会阻塞</li>
</ul>
<p>要保证安全，必须加排它锁。</p>
<p>但是我们之前的业务是先查询sku（读），然后判断是否充足，然后减库存（写），这样就会导致多个请求同时查询到一样的库存，减库存还是有安全问题。</p>
<p>我们必须在查询时就加排它锁，怎么办？</p>
<p>可以通过select … for update语法来开启，但是我们要加锁的商品不止一个，此时加锁就是范围锁，甚至是表锁，性能会有较大的影响</p>
<h4 id="4）思路3：乐观锁"><a href="#4）思路3：乐观锁" class="headerlink" title="4）思路3：乐观锁"></a>4）思路3：乐观锁</h4><p>上述思路1和思路2都是加锁，实现互斥，保证线程安全，我们称为悲观锁。</p>
<ul>
<li>悲观锁：认为线程安全问题一定会发生，因此会加锁保证线程串行执行，从而保证安全。</li>
</ul>
<p>我们为了追求性能，可以使用乐观锁机制。</p>
<ul>
<li>乐观锁：认为线程安全问题不一定会发生，因此允许多线程并行执行，一般会在执行那一刻进行判断和比较，然后根据是否存在风险来决定是否执行操作</li>
</ul>
<p>举例，我们可以给库存的表加一个字段，叫做version</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id  stock    version</span><br><span class="line">10	10			1</span><br></pre></td></tr></table></figure>

<p>执行更新前，先查询库存及version</p>
<p><code>select * from tb_stock</code>，此时得到stock=10, version=1</p>
<p>然后判断库存是否充足，如果充足，执行sql：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update tb_stock set stock = stock - #&#123;num&#125;, version = version + 1 WHERE id = #&#123;id&#125; AND version = 1</span><br></pre></td></tr></table></figure>

<p>乐观锁就是先比较再执行的思路，其实就是CAS（compare and set）的思想。</p>
<p>CAS的思想在很多地方都有使用，例如：</p>
<ul>
<li>JDK的JUC包下的AtomicInteger、AtomicLong等等</li>
<li>Redis的watch，也是乐观锁,CAS原理</li>
</ul>
<p>简化：我们在减库存中，可以用stock来代替version，执行sql时判断stock是否跟自己查询到的一样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update tb_stock set stock = stock - 1 WHERE id = 10 AND stock = 10</span><br></pre></td></tr></table></figure>



<p>思路4：继续简化</p>
<p>我们可以不查询库存，直接执行sql，在sql语句中做判断</p>
<p>语句时这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update tb_stock set stock = stock - 1 WHERE id = 10 AND stock &gt;= 1</span><br></pre></td></tr></table></figure>



<p>思路5：继续简化</p>
<p>我们最终的目的是 库存不能超卖，不能为负数，因此我们可以设置stock字段为无符号整数，数据库会自动对写入数据判断，如果为负，会抛出异常，我们就无需加锁或任何其它判断了。</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/image-20200508163028111.png" alt="image-20200508163028111"></p>
<p>这样，库存就永远不会超卖了。</p>
<p>最终的实现是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEDUCT_STOCK_STATEMENT = <span class="string">&quot;com.leyou.item.mapper.SkuMapper.deductStock&quot;</span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deductStock</span><span class="params">(Map&lt;Long, Integer&gt; cartMap)</span> </span>&#123;</span><br><span class="line">    executeBatch(sqlSession -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Long, Integer&gt; entry : cartMap.entrySet()) &#123;</span><br><span class="line">            <span class="comment">// 准备参数</span></span><br><span class="line">            Map&lt;String,Object&gt; param = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            param.put(<span class="string">&quot;id&quot;</span>, entry.getKey());</span><br><span class="line">            param.put(<span class="string">&quot;num&quot;</span>, entry.getValue());</span><br><span class="line">            <span class="comment">// 编译statement，namespace.statementId</span></span><br><span class="line">            sqlSession.update(DEDUCT_STOCK_STATEMENT, param);  </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 刷新</span></span><br><span class="line">       sqlSession.flushStatements();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="3-3-3-创建订单后减库存"><a href="#3-3-3-创建订单后减库存" class="headerlink" title="3.3.3.创建订单后减库存"></a>3.3.3.创建订单后减库存</h3><p>修改之前的下单业务，添加减库存的业务逻辑：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/image-20200325221607090.png" alt="image-20200325221607090"> </p>
<p>完整代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Long <span class="title">createOrder</span><span class="params">(<span class="meta">@Valid</span> OrderFormDTO orderDTO)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1.写order</span></span><br><span class="line">    Order order = <span class="keyword">new</span> Order();</span><br><span class="line">    <span class="comment">// 1.1 用户id</span></span><br><span class="line">    Long userId = UserContext.getUser().getId();</span><br><span class="line">    order.setUserId(userId);</span><br><span class="line">    <span class="comment">// 1.2 金额相关信息</span></span><br><span class="line">    Map&lt;Long, Integer&gt; carts = orderDTO.getCarts();</span><br><span class="line">    <span class="comment">// 1.2.1.获取所有sku的id</span></span><br><span class="line">    List&lt;Long&gt; idList = <span class="keyword">new</span> ArrayList&lt;&gt;(carts.keySet());</span><br><span class="line">    <span class="comment">// 1.2.2.查询sku</span></span><br><span class="line">    List&lt;SkuDTO&gt; skuList = itemClient.querySkuByIds(idList);</span><br><span class="line">    <span class="comment">// 1.2.3 计算金额的和</span></span><br><span class="line">    <span class="keyword">long</span> total = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (SkuDTO sku : skuList) &#123;</span><br><span class="line">        <span class="comment">// 获取金额</span></span><br><span class="line">        <span class="keyword">int</span> num = carts.get(sku.getId());</span><br><span class="line">        <span class="comment">// 计算总金额</span></span><br><span class="line">        total += sku.getPrice() * num;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1.2.4 填写金额数据</span></span><br><span class="line">    order.setTotalFee(total);</span><br><span class="line">    order.setPaymentType(orderDTO.getPaymentType());</span><br><span class="line">    order.setPostFee(<span class="number">0L</span>);<span class="comment">// 全场包邮</span></span><br><span class="line">    order.setActualFee(total + order.getPostFee()<span class="comment">/* - 优惠金额*/</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.3 订单状态初始化</span></span><br><span class="line">    order.setStatus(OrderStatus.INIT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.4 写order到数据库</span></span><br><span class="line">    <span class="keyword">boolean</span> success = save(order);</span><br><span class="line">    <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> LyException(<span class="number">500</span>, <span class="string">&quot;订单创建失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.写OrderDetail</span></span><br><span class="line">    <span class="comment">// 2.1.定义一个OrderDetail的集合</span></span><br><span class="line">    List&lt;OrderDetail&gt; details = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 2.2.遍历sku集合，转为detail</span></span><br><span class="line">    <span class="keyword">for</span> (SkuDTO sku : skuList) &#123;</span><br><span class="line">        <span class="comment">// 2.2.1.商品数量</span></span><br><span class="line">        <span class="keyword">int</span> num = carts.get(sku.getId());</span><br><span class="line">        <span class="comment">// 2.2.2.组装OrderDetail</span></span><br><span class="line">        OrderDetail detail = <span class="keyword">new</span> OrderDetail();</span><br><span class="line">        detail.setOrderId(order.getOrderId());</span><br><span class="line">        detail.setImage(StringUtils.substringBefore(sku.getImages(), <span class="string">&quot;,&quot;</span>));</span><br><span class="line">        detail.setNum(num);</span><br><span class="line">        detail.setSkuId(sku.getId());</span><br><span class="line">        detail.setSpec(sku.getSpecialSpec());</span><br><span class="line">        detail.setPrice(sku.getPrice());</span><br><span class="line">        detail.setTitle(sku.getTitle());</span><br><span class="line">        <span class="comment">// 2.2.3.装入detail集合</span></span><br><span class="line">        details.add(detail);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.3.批量新增</span></span><br><span class="line">    success = detailService.saveBatch(details);</span><br><span class="line">    <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> LyException(<span class="number">500</span>, <span class="string">&quot;订单创建失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.写orderLogistics</span></span><br><span class="line">    <span class="comment">// 3.1.查询收货地址</span></span><br><span class="line">    AddressDTO address = userClient.queryAddressById(orderDTO.getAddressId());</span><br><span class="line">    <span class="comment">// 3.2.填写物流信息</span></span><br><span class="line">    OrderLogistics logistics = address.toEntity(OrderLogistics.class);</span><br><span class="line">    logistics.setOrderId(order.getOrderId());</span><br><span class="line">    <span class="comment">// 3.3.写入数据库</span></span><br><span class="line">    success = logisticsService.save(logistics);</span><br><span class="line">    <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> LyException(<span class="number">500</span>, <span class="string">&quot;订单创建失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.减库存</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        itemClient.deductStock(carts);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FeignException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> LyException(e.status(), e.contentUTF8());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.返回订单编号</span></span><br><span class="line">    <span class="keyword">return</span> order.getOrderId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="3-4-删除购物车中已下单商品（作业）"><a href="#3-4-删除购物车中已下单商品（作业）" class="headerlink" title="3.4.删除购物车中已下单商品（作业）"></a>3.4.删除购物车中已下单商品（作业）</h2><p>下单完成，还要从购物车中把已经下单的商品移除，大家自己完成下。</p>
<h2 id="3-5-测试"><a href="#3-5-测试" class="headerlink" title="3.5.测试"></a>3.5.测试</h2><p>启动项目，在页面再次点击提交订单，发现提交成功，跳转到了支付页面：</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/1528362464276.png" alt="1528362464276"></p>
<p>查看数据库，发现订单已经生成：</p>
<p>订单</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/1535985796739.png" alt="1535985796739"></p>
<p>订单详情：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/1535985836733.png" alt="1535985836733"></p>
<p>订单状态：</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/1535985877827.png" alt="1535985877827"></p>
<h1 id="4-查询订单接口"><a href="#4-查询订单接口" class="headerlink" title="4.查询订单接口"></a>4.查询订单接口</h1><h2 id="4-1-接口分析"><a href="#4-1-接口分析" class="headerlink" title="4.1.接口分析"></a>4.1.接口分析</h2><p>支付页面需要展示订单信息，页面加载时，就会发起请求，查询订单信息：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/image-20200403111835412.png" alt="image-20200403111835412"></p>
<p>因此我们应该提供查询订单接口：</p>
<ul>
<li>请求方式：Get</li>
<li>请求路径：/order/{id}</li>
<li>请求参数：路径占位符的id</li>
<li>返回结果：主要包含订单id、订单金额、订单状态等信息，需要封装一个DTO</li>
</ul>
<h2 id="4-2-DTO对象"><a href="#4-2-DTO对象" class="headerlink" title="4.2.DTO对象"></a>4.2.DTO对象</h2><p>在<code>ly-trade</code>的<code>com.leyou.trade.dto</code>包下，新建一个OrderDTO：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.trade.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.common.dto.BaseDTO;</span><br><span class="line"><span class="keyword">import</span> com.leyou.trade.entity.Order;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderDTO</span> <span class="keyword">extends</span> <span class="title">BaseDTO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long orderId;</span><br><span class="line">    <span class="keyword">private</span> Long totalFee;</span><br><span class="line">    <span class="keyword">private</span> Long postFee;</span><br><span class="line">    <span class="keyword">private</span> Long actualFee;</span><br><span class="line">    <span class="keyword">private</span> Integer paymentType;</span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="keyword">private</span> Date payTime;</span><br><span class="line">    <span class="keyword">private</span> Date consignTime;</span><br><span class="line">    <span class="keyword">private</span> Date endTime;</span><br><span class="line">    <span class="keyword">private</span> Date closeTime;</span><br><span class="line">    <span class="keyword">private</span> Date commentTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderDTO</span><span class="params">(Order entity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(entity);</span><br><span class="line">        <span class="keyword">this</span>.status = entity.getStatus().getValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-3-业务"><a href="#4-3-业务" class="headerlink" title="4.3.业务"></a>4.3.业务</h2><p>在<code>ly-trade</code>的<code>com.leyou.trade.order</code>包的OrderController中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderId 订单id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 订单对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;OrderDTO&gt; <span class="title">queryOrderById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long orderId)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ResponseEntity.ok(<span class="keyword">new</span> OrderDTO(orderService.getById(orderId)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">高明辉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/07/03/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/">http://example.com/2022/07/03/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Jason</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%B8%8B%E5%8D%95/">下单</a></div><div class="post_share"><div class="social-share" data-image="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/14%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD/%E5%B0%81%E9%9D%A2.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="添加微信"/></a><div class="post-qr-code-desc">添加微信</div></li><li class="reward-item"><a href="/img/pay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/pay.jpg" alt="付款码"/></a><div class="post-qr-code-desc">付款码</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/07/03/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"><img class="prev-cover" src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/15%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/%E5%B0%81%E9%9D%A2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">乐优商城项目-微信支付-分布式事务</div></div></a></div><div class="next-post pull-right"><a href="/2022/07/03/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E8%B4%AD%E7%89%A9%E8%BD%A6%E5%8A%9F%E8%83%BD/"><img class="next-cover" src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/13%E8%B4%AD%E7%89%A9%E8%BD%A6%E5%8A%9F%E8%83%BD/%E5%B0%81%E9%9D%A2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">乐优商城项目-购物车功能</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%A7%E6%80%BB%E7%BB%93%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2%EF%BC%9A"><span class="toc-number">2.</span> <span class="toc-text">大总结写在前面：</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E8%AE%A2%E5%8D%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">1.订单数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.</span> <span class="toc-text">1.1.数据结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E6%95%B4%E5%90%88MybatisPlus"><span class="toc-number">3.2.</span> <span class="toc-text">1.2.整合MybatisPlus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-%E4%BE%9D%E8%B5%96"><span class="toc-number">3.2.1.</span> <span class="toc-text">1.2.1.依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-%E9%85%8D%E7%BD%AE"><span class="toc-number">3.2.2.</span> <span class="toc-text">1.2.2.配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-3-%E5%90%AF%E5%8A%A8%E7%B1%BB%E6%B3%A8%E8%A7%A3"><span class="toc-number">3.2.3.</span> <span class="toc-text">1.2.3.启动类注解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%9F%BA%E6%9C%AC%E4%BB%A3%E7%A0%81"><span class="toc-number">3.3.</span> <span class="toc-text">1.3.基本代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80id"><span class="toc-number">3.3.1.</span> <span class="toc-text">1.3.1.全局唯一id</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#UUID"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">UUID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%87%AA%E5%A2%9EID"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">数据库自增ID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E7%94%9F%E6%88%90ID"><span class="toc-number">3.3.1.3.</span> <span class="toc-text">批量生成ID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E7%94%9F%E6%88%90ID"><span class="toc-number">3.3.1.4.</span> <span class="toc-text">Redis生成ID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Twitter%E7%9A%84snowflake%E7%AE%97%E6%B3%95"><span class="toc-number">3.3.1.5.</span> <span class="toc-text">Twitter的snowflake算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BE%E5%BA%A6UidGenerator"><span class="toc-number">3.3.1.6.</span> <span class="toc-text">百度UidGenerator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BE%8E%E5%9B%A2Leaf"><span class="toc-number">3.3.1.7.</span> <span class="toc-text">美团Leaf</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-number">3.3.2.</span> <span class="toc-text">1.3.2.实体类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-1-Order"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">1.3.2.1.Order</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-2-OrderDetail"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">1.3.2.2.OrderDetail</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-3-OrderLogistics"><span class="toc-number">3.3.2.3.</span> <span class="toc-text">1.3.2.3.OrderLogistics</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-3-MybatisPlus%E5%AF%B9%E6%9E%9A%E4%B8%BE%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">3.3.3.</span> <span class="toc-text">1.3.3.MybatisPlus对枚举的支持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E5%9C%A8%E6%9E%9A%E4%B8%BE%E7%B1%BB%E4%B8%8A%E6%B7%BB%E5%8A%A0%E6%B3%A8%E8%A7%A3"><span class="toc-number">3.3.3.1.</span> <span class="toc-text">1）在枚举类上添加注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E5%9C%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E6%B7%BB%E5%8A%A0%E6%9E%9A%E4%B8%BE%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.3.2.</span> <span class="toc-text">2）在配置文件中添加枚举配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E5%AE%9E%E4%BD%93%E7%B1%BB%E7%9A%84%E6%9E%9A%E4%B8%BE%E5%B1%9E%E6%80%A7%E6%B7%BB%E5%8A%A0%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-number">3.3.3.3.</span> <span class="toc-text">3）实体类的枚举属性添加类型转换器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-4-mapper%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.3.4.</span> <span class="toc-text">1.3.4.mapper接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-5-Service"><span class="toc-number">3.3.5.</span> <span class="toc-text">1.3.5.Service</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E8%AE%A2%E5%8D%95%E7%BB%93%E7%AE%97%E9%A1%B5"><span class="toc-number">4.</span> <span class="toc-text">2.订单结算页</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%94%B6%E8%B4%A7%E4%BA%BA%E4%BF%A1%E6%81%AF%EF%BC%88%E4%BD%9C%E4%B8%9A%EF%BC%89"><span class="toc-number">4.1.</span> <span class="toc-text">2.1.收货人信息（作业）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E6%94%AF%E4%BB%98%E6%96%B9%E5%BC%8F"><span class="toc-number">4.2.</span> <span class="toc-text">2.2.支付方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E5%95%86%E5%93%81%E6%B8%85%E5%8D%95"><span class="toc-number">4.3.</span> <span class="toc-text">2.3.商品清单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E6%8F%90%E4%BA%A4%E8%AE%A2%E5%8D%95"><span class="toc-number">4.4.</span> <span class="toc-text">2.4.提交订单</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.</span> <span class="toc-text">3.创建订单接口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-Controller"><span class="toc-number">5.1.</span> <span class="toc-text">3.1.Controller</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Service"><span class="toc-number">5.2.</span> <span class="toc-text">3.2.Service</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E8%AE%A2%E5%8D%95Order"><span class="toc-number">5.2.1.</span> <span class="toc-text">3.2.1.订单Order</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85OrderDetail"><span class="toc-number">5.2.2.</span> <span class="toc-text">3.2.2.订单详情OrderDetail</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-%E8%AE%A2%E5%8D%95%E7%89%A9%E6%B5%81-OrderLogistics"><span class="toc-number">5.2.3.</span> <span class="toc-text">3.3.3.订单物流 OrderLogistics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-4-OrderService%E7%9A%84%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.2.4.</span> <span class="toc-text">3.2.4.OrderService的业务实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%87%8F%E5%BA%93%E5%AD%98"><span class="toc-number">5.3.</span> <span class="toc-text">3.3.减库存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-%E4%BD%95%E6%97%B6%E5%87%8F%E5%BA%93%E5%AD%98"><span class="toc-number">5.3.1.</span> <span class="toc-text">3.3.1.何时减库存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-%E5%87%8F%E5%BA%93%E5%AD%98%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.3.2.</span> <span class="toc-text">3.3.2.减库存接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E6%89%A3%E5%87%8F%E5%BA%93%E5%AD%98%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%981"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">1）扣减库存的安全问题1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E6%80%9D%E8%B7%AF1%EF%BC%8C%E5%90%8C%E6%AD%A5%E9%94%81"><span class="toc-number">5.3.2.2.</span> <span class="toc-text">2）思路1，同步锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E6%80%9D%E8%B7%AF2%EF%BC%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8E%92%E5%AE%83%E9%94%81"><span class="toc-number">5.3.2.3.</span> <span class="toc-text">3）思路2，数据库排它锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%EF%BC%89%E6%80%9D%E8%B7%AF3%EF%BC%9A%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-number">5.3.2.4.</span> <span class="toc-text">4）思路3：乐观锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E5%90%8E%E5%87%8F%E5%BA%93%E5%AD%98"><span class="toc-number">5.3.3.</span> <span class="toc-text">3.3.3.创建订单后减库存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E5%88%A0%E9%99%A4%E8%B4%AD%E7%89%A9%E8%BD%A6%E4%B8%AD%E5%B7%B2%E4%B8%8B%E5%8D%95%E5%95%86%E5%93%81%EF%BC%88%E4%BD%9C%E4%B8%9A%EF%BC%89"><span class="toc-number">5.4.</span> <span class="toc-text">3.4.删除购物车中已下单商品（作业）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E6%B5%8B%E8%AF%95"><span class="toc-number">5.5.</span> <span class="toc-text">3.5.测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E6%9F%A5%E8%AF%A2%E8%AE%A2%E5%8D%95%E6%8E%A5%E5%8F%A3"><span class="toc-number">6.</span> <span class="toc-text">4.查询订单接口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%8E%A5%E5%8F%A3%E5%88%86%E6%9E%90"><span class="toc-number">6.1.</span> <span class="toc-text">4.1.接口分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-DTO%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.2.</span> <span class="toc-text">4.2.DTO对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E4%B8%9A%E5%8A%A1"><span class="toc-number">6.3.</span> <span class="toc-text">4.3.业务</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 高明辉</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'Aaee0Vekhg5KbLhMOJQrEU6A-gzGzoHsz',
      appKey: 'mmLHPEEtqvOSJhsqWra8Sq6K',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script type="text/javascript" src="/js/fairyDustCursor.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>