<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>乐优商城项目-用户中心-JWT登录01 | Jason</title><meta name="keywords" content="JWT,登录"><meta name="author" content="高明辉"><meta name="copyright" content="高明辉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="学习目标1234- 了解什么是无状态登录- 了解JWT原理- 实现登录授权功能- 实现首页登录状态判断  1.无状态登录原理1.1.什么是有状态？有状态服务，即服务端需要记录每次会话的客户端信息，从而识别客户端身份，根据用户身份进行请求的处理，典型的设计如tomcat中的session。 例如登录：用户登录后，我们把登录者的信息保存在服务端session中，并且给用户一个cookie值，记录对应的">
<meta property="og:type" content="article">
<meta property="og:title" content="乐优商城项目-用户中心-JWT登录01">
<meta property="og:url" content="http://example.com/2022/07/01/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83-JWT%E7%99%BB%E5%BD%9501/index.html">
<meta property="og:site_name" content="Jason">
<meta property="og:description" content="学习目标1234- 了解什么是无状态登录- 了解JWT原理- 实现登录授权功能- 实现首页登录状态判断  1.无状态登录原理1.1.什么是有状态？有状态服务，即服务端需要记录每次会话的客户端信息，从而识别客户端身份，根据用户身份进行请求的处理，典型的设计如tomcat中的session。 例如登录：用户登录后，我们把登录者的信息保存在服务端session中，并且给用户一个cookie值，记录对应的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/%E5%B0%81%E9%9D%A2.png">
<meta property="article:published_time" content="2022-07-01T09:28:17.000Z">
<meta property="article:modified_time" content="2022-12-11T02:30:16.982Z">
<meta property="article:author" content="高明辉">
<meta property="article:tag" content="JWT">
<meta property="article:tag" content="登录">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/%E5%B0%81%E9%9D%A2.png"><link rel="shortcut icon" href="/img/%E7%BD%91%E7%AB%99%E5%9B%BE%E6%A0%87.png"><link rel="canonical" href="http://example.com/2022/07/01/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83-JWT%E7%99%BB%E5%BD%9501/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '乐优商城项目-用户中心-JWT登录01',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-12-11 10:30:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Jason" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/%E5%A4%B4%E5%83%8F.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">185</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">206</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">35</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li><li><a class="site-page child" href="/butterfly%E4%B8%BB%E9%A2%98"><i class="fa-fw https://github.com/jerryc127/hexo-theme-butterfly/"></i><span> 2</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/%E5%B0%81%E9%9D%A2.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Jason</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li><li><a class="site-page child" href="/butterfly%E4%B8%BB%E9%A2%98"><i class="fa-fw https://github.com/jerryc127/hexo-theme-butterfly/"></i><span> 2</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">乐优商城项目-用户中心-JWT登录01</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-01T09:28:17.000Z" title="发表于 2022-07-01 17:28:17">2022-07-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-12-11T02:30:16.982Z" title="更新于 2022-12-11 10:30:16">2022-12-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/">乐优商城项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="乐优商城项目-用户中心-JWT登录01"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h1><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">了解什么是无状态登录</span></span><br><span class="line"><span class="meta">-</span> <span class="string">了解JWT原理</span></span><br><span class="line"><span class="meta">-</span> <span class="string">实现登录授权功能</span></span><br><span class="line"><span class="meta">-</span> <span class="string">实现首页登录状态判断</span></span><br></pre></td></tr></table></figure>

<h1 id="1-无状态登录原理"><a href="#1-无状态登录原理" class="headerlink" title="1.无状态登录原理"></a>1.无状态登录原理</h1><h2 id="1-1-什么是有状态？"><a href="#1-1-什么是有状态？" class="headerlink" title="1.1.什么是有状态？"></a>1.1.什么是有状态？</h2><p>有状态服务，即服务端需要记录每次会话的客户端信息，从而识别客户端身份，根据用户身份进行请求的处理，典型的设计如tomcat中的session。</p>
<p>例如登录：用户登录后，我们把登录者的信息保存在服务端session中，并且给用户一个cookie值，记录对应的session。然后下次请求，用户携带cookie值来，我们就能识别到对应session，从而找到用户的信息。</p>
<p><strong>关于cookie跟session的描述：</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">https</span>:<span class="string">//blog.csdn.net/weixin_62304567/article/details/122205094</span></span><br></pre></td></tr></table></figure>

<p>缺点是什么？</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">服务端保存大量数据，增加服务端压力</span></span><br><span class="line"><span class="meta">-</span> <span class="string">服务端保存用户状态，无法进行水平扩展</span></span><br><span class="line"><span class="meta">-</span> <span class="string">客户端请求依赖服务端，多次请求必须访问同一台服务器</span></span><br></pre></td></tr></table></figure>



<h2 id="1-2-什么是无状态"><a href="#1-2-什么是无状态" class="headerlink" title="1.2.什么是无状态"></a>1.2.什么是无状态</h2><p>微服务集群中的每个服务，对外提供的都是Rest风格的接口。而Rest风格的一个最重要的规范就是：服务的无状态性，即：</p>
<ul>
<li><strong>服务端不保存任何客户端请求者信息</strong></li>
<li>客户端的每次请求必须具备<code>自描述信息</code>，通过这些信息识别客户端身份</li>
</ul>
<p>带来的好处是什么呢？</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">客户端请求不依赖服务端的信息，任何多次请求不需要必须访问到同一台服务</span></span><br><span class="line"><span class="meta">-</span> <span class="string">服务端的集群和状态对客户端透明</span></span><br><span class="line"><span class="meta">-</span> <span class="string">服务端可以任意的迁移和伸缩</span></span><br><span class="line"><span class="meta">-</span> <span class="string">减小服务端存储压力</span></span><br></pre></td></tr></table></figure>



<h2 id="1-3-如何实现无状态"><a href="#1-3-如何实现无状态" class="headerlink" title="1.3.如何实现无状态"></a>1.3.如何实现无状态</h2><p>无状态登录的流程：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">当客户端第一次请求服务时，服务端对用户进行信息认证（登录）</span></span><br><span class="line"><span class="meta">-</span> <span class="string">认证通过，将用户信息进行加密形成token，返回给客户端，作为登录凭证</span></span><br><span class="line"><span class="meta">-</span> <span class="string">以后每次请求，客户端都携带认证的token</span></span><br><span class="line"><span class="meta">-</span> <span class="string">服务端对token进行解密，判断是否有效。</span></span><br></pre></td></tr></table></figure>

<p>流程图：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/1527300483893.png" alt="1527300483893"></p>
<p>整个登录过程中，最关键的点是什么？</p>
<p><strong>token的安全性</strong></p>
<p>token是识别客户端身份的唯一标示，如果加密不够严密，被人伪造那就完蛋了。</p>
<p>采用何种方式加密才是安全可靠的呢？</p>
<p>我们将采用<code>JWT</code>来生成token，保证token的安全性</p>
<h2 id="1-4-JWT"><a href="#1-4-JWT" class="headerlink" title="1.4.JWT"></a>1.4.JWT</h2><h3 id="1-4-1-简介"><a href="#1-4-1-简介" class="headerlink" title="1.4.1.简介"></a>1.4.1.简介</h3><p>JWT，全称是Json Web Token， 是JSON风格轻量级的授权和身份认证规范，可实现无状态、分布式的Web应用授权；官网：<a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io</a></p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/1527301027008.png" alt="1527301027008"></p>
<p>GitHub上jwt的java客户端：<a target="_blank" rel="noopener" href="https://github.com/jwtk/jjwt">https://github.com/jwtk/jjwt</a></p>
<h3 id="1-4-2-数据格式"><a href="#1-4-2-数据格式" class="headerlink" title="1.4.2.数据格式"></a>1.4.2.数据格式</h3><p>JWT包含三部分数据：</p>
<ul>
<li><p><strong>1 Header：头部，通常头部有两部分信息：</strong></p>
<ul>
<li>token类型，这里是JWT</li>
<li>签名算法，自定义</li>
</ul>
<p>我们会对头部进行base64加密（可解密），得到第一部分数据</p>
</li>
<li><p><strong>2 Payload：载荷，就是有效数据，一般包含下面信息：</strong></p>
<ul>
<li>标准载荷：JWT规定的信息，jwt的元数据：<ul>
<li>JTI: JWT的id，当前jwt的唯一标识（像身份证号）</li>
<li>IAT:  issue at 签发时间 </li>
<li>EXP：过期时间</li>
<li>SUB：签发人</li>
<li>…</li>
</ul>
</li>
<li>自定义载荷：<ul>
<li>用户身份信息，（注意，这里因为采用base64加密，可解密，因此不要存放敏感信息，一般是id之类的，不要放手机，密码等敏感信息）</li>
</ul>
</li>
</ul>
<p>这部分也会采用base64加密，得到第二部分数据</p>
</li>
<li><p><strong>3 Signature：签名，是整个数据的认证信息。</strong>一般根据前两步的数据，再加上服务的的密钥（secret）（不要泄漏，最好周期性更换），通过加密算法生成。用于验证整个数据完整和可靠性</p>
</li>
</ul>
<p>生成的数据格式：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/1527322512370.png" alt="1527322512370"></p>
<p>可以看到分为3段，每段就是上面的一部分数据。</p>
<h2 id="1-5-JWT登录流程"><a href="#1-5-JWT登录流程" class="headerlink" title="1.5.JWT登录流程"></a>1.5.JWT登录流程</h2><p>登录一般包含授权、鉴权两部分：</p>
<ul>
<li><p>登录：也就是授权，authorize –&gt; authorization 授权</p>
</li>
<li><p>验证登录：也就是鉴权，authenticate –&gt; authentication 鉴权</p>
</li>
</ul>
<p>流程图如下：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/image-20200614172855833.png" alt="image-20200614172855833"></p>
<ul>
<li><p>授权流程authorize：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">1、用户请求登录，携带用户名密码到`授权中心`</span></span><br><span class="line"><span class="meta">-</span> <span class="string">2、`授权中心`携带用户名密码，到`用户中心`查询用户</span></span><br><span class="line"><span class="meta">-</span> <span class="string">3、查询如果正确，`生成JWT`凭证</span></span><br><span class="line"><span class="meta">-</span> <span class="string">4、把JWT带给前端，写入cookie（下次请求微服时会携带JWT）</span></span><br></pre></td></tr></table></figure></li>
<li><p>鉴权流程authenticate：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">1、用户请求某微服务功能，携带JWT</span></span><br><span class="line"><span class="meta">-</span> <span class="string">2、微服务验证JWT是否有效</span></span><br><span class="line"><span class="meta">-</span> <span class="string">3、微服务判断校验结果，成功或失败</span></span><br><span class="line"><span class="meta">-</span> <span class="string">4、失败则直接返回401</span></span><br><span class="line"><span class="meta">-</span> <span class="string">5、成功则处理业务并返回</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>因为JWT签发的token中已经包含了用户的身份信息，并且每次请求都会携带，这样,微服务就无需保存用户信息，甚至无需去数据库查询，完全符合了Rest的无状态规范。</p>
<p>拓展：<strong>微服务如何验证JWT有效性</strong>，</p>
<p>也就是说授权中心具体如何生成jwt的第三部分（签名部分），微服务又如何来解析验证你的签名有没有效？？？</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">jwt的三部分：header</span> <span class="string">(base64后的)；payload (base64后的)；签名</span></span><br><span class="line"><span class="attr">将这三部分用.连接成一个完整的字符串,构成了最终的jwt</span></span><br><span class="line"></span><br><span class="line"><span class="attr">1</span> <span class="string">签名如何生成：使用header指明的加密算法+盐 对 header和payload进行加密得到</span></span><br><span class="line"></span><br><span class="line"><span class="attr">注意：盐secret是保存在服务器端的，jwt的颁发和验证生成也是在服务器端的，</span></span><br><span class="line"><span class="attr">所以，盐就是你服务端的私钥，在任何场景都不应该流露出去。</span></span><br><span class="line"><span class="meta">一旦客户端得知这个secret,</span> <span class="string">那就意味着客户端是可以自我签发jwt了。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">2</span> <span class="string">如何验证签名的正确性：</span></span><br><span class="line"><span class="meta">拿到secret密钥后，对签名</span> <span class="string">解密，跟jwt前面两部分内容比对，一致，那么就表名身份合法。</span></span><br></pre></td></tr></table></figure>



<h1 id="2-编写JWT工具"><a href="#2-编写JWT工具" class="headerlink" title="2.编写JWT工具"></a>2.编写JWT工具</h1><p>因为生成jwt，解析jwt这样的行为以后在其它微服务中也会用到，因此我们会抽取成工具，放到<code>ly-auth-pojo</code>中。 </p>
<p>我们会用到比较流行的java语言的JWT工具，jjwt，官网如下：</p>
<h2 id="2-1-依赖"><a href="#2-1-依赖" class="headerlink" title="2.1.依赖"></a>2.1.依赖</h2><p>我们需要先在<code>ly-auth-pojo</code>中引入JWT依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-jackson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>joda-time<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>joda-time<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-2-载荷对象"><a href="#2-2-载荷对象" class="headerlink" title="2.2.载荷对象"></a>2.2.载荷对象</h2><p>JWT中，会保存载荷数据，我们计划存储2部分：</p>
<ul>
<li>jti：jwt的id</li>
<li>UserDetail：用户数据</li>
</ul>
<p>为了方便后期获取，我们定义一个类来封装。</p>
<p>我们在<code>ly-auth-pojo</code>中的<code>com.leyou.auth.dto</code>包下添加一个实体类，代表载荷信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Payload</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String jti;</span><br><span class="line">    <span class="keyword">private</span> UserDetail userDetail;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>载荷中的userInfo信息，也需要一个实体类表示，这里我们定义一个UserDetail类。</p>
<p>这里我们假设用户信息包含2部分：</p>
<ul>
<li>id：用户id</li>
<li>username：用户名</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor(staticName = &quot;of&quot;)</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetail</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-3-工具"><a href="#2-3-工具" class="headerlink" title="2.3.工具"></a>2.3.工具</h2><p>我们在<code>ly-auth-pojo</code>中的<code>com.leyou.auth.utils</code>包下创建一个工具类，用来封装几个方法：</p>
<ul>
<li>createJwt() ：生成JWT</li>
<li>parseJwt() ：验证并解析JWT</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.dto.Payload;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.dto.UserDetail;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jws;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.JwtParser;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.security.Keys;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.joda.time.DateTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.SecretKey;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JWT解析器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtParser jwtParser;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 秘钥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SecretKey secretKey;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtUtils</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 生成秘钥</span></span><br><span class="line">        secretKey = Keys.hmacShaKeyFor(key.getBytes(Charset.forName(<span class="string">&quot;UTF-8&quot;</span>)));</span><br><span class="line">        <span class="comment">// JWT解析器</span></span><br><span class="line">        <span class="keyword">this</span>.jwtParser = Jwts.parserBuilder().setSigningKey(secretKey).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成jwt，用默认的JTI</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDetails 用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> JWT</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">createJwt</span><span class="params">(Object userDetails)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createJwt(userDetails, <span class="number">1800</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成jwt，自己指定的JTI</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDetails 用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> JWT</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">createJwt</span><span class="params">(Object userDetails, <span class="keyword">int</span> expireSeconds)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 生成token</span></span><br><span class="line">            <span class="keyword">return</span> Jwts.builder().signWith(secretKey)</span><br><span class="line">                    .setId(createJti())</span><br><span class="line">                    .claim(<span class="string">&quot;user&quot;</span>, mapper.writeValueAsString(userDetails))</span><br><span class="line">                    .setExpiration(DateTime.now().plusSeconds(expireSeconds).toDate())</span><br><span class="line">                    .compact();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析jwt，并将用户信息转为指定的Clazz类型</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwt   token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 载荷，包含JTI和用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Payload <span class="title">parseJwt</span><span class="params">(String jwt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Jws&lt;Claims&gt; claimsJws = jwtParser.parseClaimsJws(jwt);</span><br><span class="line">            Claims claims = claimsJws.getBody();</span><br><span class="line"></span><br><span class="line">            Payload payload = <span class="keyword">new</span> Payload();</span><br><span class="line">            payload.setJti(claims.getId());</span><br><span class="line">            payload.setUserDetail(mapper.readValue(claims.get(<span class="string">&quot;user&quot;</span>, String.class), UserDetail.class));</span><br><span class="line">            <span class="keyword">return</span> payload;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">createJti</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> StringUtils.replace(UUID.randomUUID().toString(), <span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-4-测试"><a href="#2-4-测试" class="headerlink" title="2.4.测试"></a>2.4.测试</h2><p>我们在<code>ly-auth-service</code>中测试刚刚写的工具.</p>
<h3 id="2-4-1-引入依赖"><a href="#2-4-1-引入依赖" class="headerlink" title="2.4.1.引入依赖"></a>2.4.1.引入依赖</h3><p>我们在<code>ly-auth-service</code>中引入<code>ly-auth-pojo</code>的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--auth-api--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ly-auth-pojo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="2-4-2-配置秘钥"><a href="#2-4-2-配置秘钥" class="headerlink" title="2.4.2.配置秘钥"></a>2.4.2.配置秘钥</h3><p>然后在<code>ly-auth-service</code>的<code>application.yml</code>文件中配置秘钥：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ly:</span></span><br><span class="line">  <span class="attr">jwt:</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">helloWorldJavaLeyouAuthServiceSecretKey</span></span><br></pre></td></tr></table></figure>



<p>然后，我们在<code>ly-auth-service</code>的<code>com.leyou.auth.config</code>中定义一个配置类，注册<code>JwtUtils</code>注入到Spring的容器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;ly.jwt.key&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtUtils <span class="title">jwtUtils</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtUtils(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-4-3-测试类"><a href="#2-4-3-测试类" class="headerlink" title="2.4.3.测试类"></a>2.4.3.测试类</h3><p>然后在<code>ly-auth-service</code>中定义一个测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.dto.Payload;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.dto.UserDetail;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtUtils jwtUtils;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 生成jwt</span></span><br><span class="line">        String jwt = jwtUtils.createJwt(UserDetail.of(<span class="number">1L</span>, <span class="string">&quot;Jack&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;jwt = &quot;</span> + jwt);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// jwt = &quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiIzZTg1NWVlYmFiN2I0NDM1YjY2NzFiMzhmNDcwM2E5ZSIsInVzZXIiOiJ7XCJpZFwiOjEsXCJ1c2VybmFtZVwiOlwi6ams5LqRXCJ9In0.gnedpS9LE0VjetKVTyD2Opvi4eSyROOG_rSwQP0kDC0&quot;;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析jwt</span></span><br><span class="line">        Payload payload = jwtUtils.parseJwt(jwt);</span><br><span class="line">        System.out.println(<span class="string">&quot;payload = &quot;</span> + payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jwt = eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiIzZTg1NWVlYmFiN2I0NDM1YjY2NzFiMzhmNDcwM2E5ZSIsInVzZXIiOiJ7XCJpZFwiOjEsXCJ1c2VybmFtZVwiOlwiSmFja1wifSJ9.gnedpS9LE0VjetKVTyD2Opvi4eSyROOG_rSwQP0kDC0</span><br><span class="line"></span><br><span class="line">payload = Payload(jti=3e855eebab7b4435b6671b38f4703a9e, userDetails=UserDetails(id=1, username=Jack))</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="3-登录授权"><a href="#3-登录授权" class="headerlink" title="3.登录授权"></a>3.登录授权</h1><p>首先，我们来完成登录授权功能。这个功能要在我们的<code>ly-auth-service</code>项目中完成。</p>
<h2 id="3-1-思路分析"><a href="#3-1-思路分析" class="headerlink" title="3.1.思路分析"></a>3.1.思路分析</h2><p>在登录页面，用户会填写账号密码并提交，我们服务端接收后需要验证用户名和密码。如果验证通过则生成JWT并写入cookie中。不过验证用户名和密码需要去访问<code>ly-user</code>才可以，因此整体思路如下：</p>
<ul>
<li>用户提交用户名和密码到ly-auth</li>
<li>ly-auth远程访问ly-user，根据用户名和密码查询用户</li>
<li>ly-auth验证查询结果<ul>
<li>如果成功，生成jwt，并将JWT写入cookie</li>
<li>如果失败，返回401</li>
</ul>
</li>
</ul>
<h2 id="3-2-用户验证的接口"><a href="#3-2-用户验证的接口" class="headerlink" title="3.2.用户验证的接口"></a>3.2.用户验证的接口</h2><p>用户中心<code>ly-user</code>必须对外提供查询接口，<strong>方便<code>ly-auth</code>做用户名密码校验。</strong></p>
<h3 id="3-2-1-定义接口"><a href="#3-2-1-定义接口" class="headerlink" title="3.2.1.定义接口"></a>3.2.1.定义接口</h3><p>首先在<code>ly-user-api</code>定义接口：</p>
<p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-openfeign-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ly-user-pojo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>ly-user-api</code>的<code>com.leyou.user.client</code>中，添加用于访问接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.user.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.user.dto.UserDTO;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(&quot;user-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserClient</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据用户名和密码查询用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password 密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;info&quot;)</span></span><br><span class="line">    <span class="function">UserDTO <span class="title">queryUserByUsernameAndPassword</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username, <span class="meta">@RequestParam(&quot;password&quot;)</span> String password)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-2-ly-auth引用接口"><a href="#3-2-2-ly-auth引用接口" class="headerlink" title="3.2.2.ly-auth引用接口"></a>3.2.2.ly-auth引用接口</h3><p>然后，在ly-auth-service中引入ly-user-interface和feign的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ly-user-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在<code>ly-auth</code>的<code>com.leyou.auth</code>包下的启动类<code>LyAuthApplication</code>上添加注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.config.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.leyou.user.client&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &#123;&quot;com.leyou.auth&quot;, &quot;com.leyou.common.advice&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LyAuthApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(LyAuthApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意：对<code>FeignClient</code>的扫描包要添加到<code>@EnableFeignClients</code>注解里面！</p>
<h2 id="3-3-登录的controller"><a href="#3-3-登录的controller" class="headerlink" title="3.3.登录的controller"></a>3.3.登录的controller</h2><p>接下来，我们需要在<code>ly-auth-service</code>编写一个接口，对外提供登录授权服务，接收用户名和密码，生成JWT。</p>
<p>我们在<code>ly-auth</code>的<code>com.leyou.auth.web</code>下添加<code>UserAuthController</code>，并编写登录接口：</p>
<ul>
<li>请求方式：post</li>
<li>请求路径：/user/login</li>
<li>请求参数：username和password，另外写cookie要用到HttpServletResponse</li>
<li>返回结果：无，直接写入cookie</li>
</ul>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.service.UserAuthService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAuthController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserAuthService userAuthService;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password 密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 无</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;login&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title">login</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam(&quot;username&quot;)</span> String username,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@RequestParam(&quot;password&quot;)</span> String password,</span></span></span><br><span class="line"><span class="params"><span class="function">            HttpServletResponse response)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 调用service，完成登录</span></span><br><span class="line">        userAuthService.login(username, password, response);</span><br><span class="line">        <span class="comment">// 登录成功，无返回值, 204状态码</span></span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.noContent().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="3-4-登录的service"><a href="#3-4-登录的service" class="headerlink" title="3.4.登录的service"></a>3.4.登录的service</h2><p>service的基本流程：</p>
<ul>
<li>去ly-user查询用户</li>
<li>判断用户结果，正确则生成jwt</li>
<li>把jwt写入cookie</li>
</ul>
<p>这里还有几个属性要配置，包括：</p>
<ul>
<li>cookie名称</li>
<li>cookie的domain属性，决定cookie在哪些域名下生效</li>
</ul>
<p>这三个属性我们定义到一个常量类中，放到<code>ly-auth-pojo</code>下的 <code>com.leyou.auth.constants</code>中 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.constants;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtConstants</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户token的cookie名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String COOKIE_NAME = <span class="string">&quot;LY_TOKEN&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户token的cookie的domain</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DOMAIN = <span class="string">&quot;leyou.com&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：cookie的domain决定了cookie作用的域名，写成”<code>leyou.com</code>“可以让<code>leyou.com</code>下的所有二级以上域名共享cookie</p>
<p>在<code>ly-auth-service</code>的<code>com.leyou.auth.service</code>包中定义接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserAuthService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">(String username, String password, HttpServletResponse response)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>ly-auth-service</code>的<code>com.leyou.auth.service.impl</code>包中定义实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.dto.UserDetail;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.service.UserAuthService;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.constants.JwtConstants;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.exception.LyException;</span><br><span class="line"><span class="keyword">import</span> com.leyou.user.client.UserClient;</span><br><span class="line"><span class="keyword">import</span> com.leyou.user.dto.UserDTO;</span><br><span class="line"><span class="keyword">import</span> feign.FeignException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAuthServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserAuthService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserClient userClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtUtils jwtUtils;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserAuthServiceImpl</span><span class="params">(UserClient userClient, JwtUtils jwtUtils)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userClient = userClient;</span><br><span class="line">        <span class="keyword">this</span>.jwtUtils = jwtUtils;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">(String username, String password, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.授权中心携带用户名密码，到用户中心查询用户</span></span><br><span class="line">            UserDTO user = userClient.queryUserByUsernameAndPassword(username, password);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.校验查询结果</span></span><br><span class="line">            <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> LyException(<span class="number">400</span>, <span class="string">&quot;用户名或密码错误！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.如果正确，生成JWT凭证，查询错误则返回400</span></span><br><span class="line">            <span class="comment">// 3.1.准备用户信息</span></span><br><span class="line">            UserDetail userDetails = UserDetail.of(user.getId(), user.getUsername());</span><br><span class="line">            <span class="comment">// 3.2.生成jwt</span></span><br><span class="line">            String jwt = jwtUtils.createJwt(userDetails);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4.把JWT写入用户cookie</span></span><br><span class="line">            writeCookie(response, jwt);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (FeignException e) &#123;</span><br><span class="line">            <span class="comment">// 把远程调用异常转换抛出</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LyException(e.status(), e.contentUTF8());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeCookie</span><span class="params">(HttpServletResponse response, String token)</span> </span>&#123;</span><br><span class="line">        Cookie cookie = <span class="keyword">new</span> Cookie(JwtConstants.COOKIE_NAME, token);</span><br><span class="line">        <span class="comment">// cookie的作用域</span></span><br><span class="line">        cookie.setDomain(JwtConstants.DOMAIN);<span class="comment">//#######域名+路径 符合配置，那么就会带着jwt访问微服务。</span></span><br><span class="line">        <span class="comment">// 是否禁止JS操作cookie，避免XSS攻击</span></span><br><span class="line">        cookie.setHttpOnly(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// cookie有效期，-1就是跟随当前会话，浏览器关闭就消失</span></span><br><span class="line">        cookie.setMaxAge(-<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// cookie作用的路径，/代表一切路径,表示任何路径都会携带cookie令牌过来。</span></span><br><span class="line">        cookie.setPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        response.addCookie(cookie);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="3-5-测试"><a href="#3-5-测试" class="headerlink" title="3.5.测试"></a>3.5.测试</h2><p>在登录页面填写信息，登录后跳转到首页，发现token成功写入了：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/1527521423469.png" alt="1527521423469"></p>
<p>小思考：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1</span> <span class="string">微服务会保存密钥吗？？？</span></span><br><span class="line">	<span class="attr">（1）微服务向auth微服务发送密钥请求，如果授权中心信任这个微服务，</span></span><br><span class="line">			<span class="attr">（校验微服务请求密钥时带过来的名称密码参数，</span></span><br><span class="line">			<span class="attr">校验数据库的微服务名称以及微服务密码，一致则表明信任该微服务）</span></span><br><span class="line">		<span class="attr">那么auth就会返回密钥给微服务。</span></span><br><span class="line">		<span class="attr">微服务拿到密钥后就可以在微服本地进行jwt本解密校验了。</span></span><br><span class="line">	<span class="attr">（2）有不被信任的微服，只能带着用户端的jwt去授权中心验证，直接得到认证结果</span></span><br><span class="line"><span class="attr">2</span> <span class="string">微服务中，JWT校验的流程原理？？</span></span><br><span class="line">	<span class="meta">拿到secret密钥后，对签名</span> <span class="string">解密，跟jwt前面两部分内容比对，一致，那么就表名身份合法。</span></span><br><span class="line">	<span class="attr">或者说：可以利用JWT前两段，用同一套哈希算法和同一个secret计算一个签名值，</span></span><br><span class="line">	<span class="attr">然后把计算出来的签名值和收到的JWT第三段比较，如果相同则认证通过。</span></span><br><span class="line"><span class="attr">3</span> <span class="string">微服务知道了我的身份合法，拿到我的身份信息，跟数据库连接，查询，就可以进行业务处理啦，哈哈哈！！！</span></span><br></pre></td></tr></table></figure>

<h1 id="4-秘钥管理"><a href="#4-秘钥管理" class="headerlink" title="4.秘钥管理"></a>4.秘钥管理</h1><p>用户访问微服务的时候会携带JWT，而微服务中需要对JWT做校验和解析，这个时候就会用到秘钥。</p>
<p>但是秘钥保存在ly-auth这个授权服务中，我们不能随意暴露秘钥，否则就会有秘钥泄露的风险。</p>
<p>那么，<strong>该如何管理秘钥，让我们的微服务安全获取秘钥呢</strong>？</p>
<h2 id="4-1-思路分析"><a href="#4-1-思路分析" class="headerlink" title="4.1.思路分析"></a>4.1.思路分析</h2><p>微服务要想安全获取秘钥，必须经过<code>ly-auth</code>的身份验证。因此，我们可以给每一个微服务都定义一份“<strong>身份信息</strong>”，这些身份信息保存在数据库中，结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">SET NAMES utf8mb4;</span><br><span class="line">SET FOREIGN_KEY_CHECKS = 0;</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure for tb_client_info</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS `tb_client_info`;</span><br><span class="line">CREATE TABLE `tb_client_info`  (</span><br><span class="line">  `id` int(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;主键&#x27;,</span><br><span class="line">  `client_id` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT &#x27;服务名称&#x27;,</span><br><span class="line">  `secret` varchar(60) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT &#x27;密钥&#x27;,</span><br><span class="line">  `info` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT &#x27;服务介绍&#x27;,</span><br><span class="line">  `create_time` timestamp(0) NULL DEFAULT CURRENT_TIMESTAMP(0) COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `update_time` timestamp(0) NULL DEFAULT CURRENT_TIMESTAMP(0) ON UPDATE CURRENT_TIMESTAMP(0) COMMENT &#x27;更新时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`) USING BTREE,</span><br><span class="line">  UNIQUE INDEX `uq_key_service_name`(`client_id`) USING BTREE</span><br><span class="line">) ENGINE = InnoDB AUTO_INCREMENT = 10 CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = &#x27;服务信息表，记录微服务的id，名称，密文，用来做服务认证&#x27; ROW_FORMAT = Compact;</span><br><span class="line"></span><br><span class="line">-- ----------------------------</span><br><span class="line">-- Records of tb_client_info</span><br><span class="line">-- ----------------------------</span><br><span class="line">INSERT INTO `tb_client_info` VALUES (1, &#x27;user-service&#x27;, &#x27;$2a$10$LjOQwjNv.4cO0uftZkvZzOfhpXQxqU.XrHL5Ut6m3G4OXBkQQQdBe&#x27;, &#x27;用户微服务&#x27;, &#x27;2019-04-10 15:55:11&#x27;, &#x27;2020-06-14 21:12:16&#x27;);</span><br><span class="line">INSERT INTO `tb_client_info` VALUES (2, &#x27;item-service&#x27;, &#x27;$2a$10$LjOQwjNv.4cO0uftZkvZzOfhpXQxqU.XrHL5Ut6m3G4OXBkQQQdBe&#x27;, &#x27;商品微服务&#x27;, &#x27;2019-04-10 15:55:11&#x27;, &#x27;2020-06-14 21:12:17&#x27;);</span><br><span class="line">INSERT INTO `tb_client_info` VALUES (3, &#x27;page-service&#x27;, &#x27;$2a$10$LjOQwjNv.4cO0uftZkvZzOfhpXQxqU.XrHL5Ut6m3G4OXBkQQQdBe&#x27;, &#x27;静态页微服务&#x27;, &#x27;2019-04-10 15:55:11&#x27;, &#x27;2020-06-14 21:12:18&#x27;);</span><br><span class="line">INSERT INTO `tb_client_info` VALUES (4, &#x27;search-service&#x27;, &#x27;$2a$10$LjOQwjNv.4cO0uftZkvZzOfhpXQxqU.XrHL5Ut6m3G4OXBkQQQdBe&#x27;, &#x27;搜索微服务&#x27;, &#x27;2019-04-10 15:55:11&#x27;, &#x27;2020-06-14 21:12:19&#x27;);</span><br><span class="line">INSERT INTO `tb_client_info` VALUES (5, &#x27;cart-service&#x27;, &#x27;$2a$10$LjOQwjNv.4cO0uftZkvZzOfhpXQxqU.XrHL5Ut6m3G4OXBkQQQdBe&#x27;, &#x27;购物车微服务&#x27;, &#x27;2019-04-10 15:55:11&#x27;, &#x27;2020-06-14 21:12:20&#x27;);</span><br><span class="line">INSERT INTO `tb_client_info` VALUES (6, &#x27;trade-service&#x27;, &#x27;$2a$10$LjOQwjNv.4cO0uftZkvZzOfhpXQxqU.XrHL5Ut6m3G4OXBkQQQdBe&#x27;, &#x27;订单微服务&#x27;, &#x27;2019-04-10 15:55:11&#x27;, &#x27;2020-06-14 21:12:20&#x27;);</span><br><span class="line">INSERT INTO `tb_client_info` VALUES (7, &#x27;api-gateway&#x27;, &#x27;$2a$10$LjOQwjNv.4cO0uftZkvZzOfhpXQxqU.XrHL5Ut6m3G4OXBkQQQdBe&#x27;, &#x27;网关服务&#x27;, &#x27;2019-04-10 15:55:11&#x27;, &#x27;2020-06-14 21:12:21&#x27;);</span><br><span class="line">INSERT INTO `tb_client_info` VALUES (8, &#x27;auth-service&#x27;, &#x27;$2a$10$LjOQwjNv.4cO0uftZkvZzOfhpXQxqU.XrHL5Ut6m3G4OXBkQQQdBe&#x27;, &#x27;授权服务&#x27;, &#x27;2019-04-10 15:55:11&#x27;, &#x27;2020-06-14 21:12:22&#x27;);</span><br><span class="line">INSERT INTO `tb_client_info` VALUES (9, &#x27;pay-service&#x27;, &#x27;$2a$10$LjOQwjNv.4cO0uftZkvZzOfhpXQxqU.XrHL5Ut6m3G4OXBkQQQdBe&#x27;, &#x27;支付微服务&#x27;, &#x27;2019-04-10 15:56:38&#x27;, &#x27;2020-06-14 21:12:24&#x27;);</span><br><span class="line"></span><br><span class="line">SET FOREIGN_KEY_CHECKS = 1;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>核心字段介绍：</p>
<ul>
<li>clientId：微服务的客户端id，每个微服务都有唯一id</li>
<li>secret：客户端秘钥(密码)，微服务身份验证会用到</li>
</ul>
<p>一旦微服务有了<strong>身份</strong>，那么微服务申请秘钥的时候，ly-auth就可以<strong>对身份做验证</strong>，验证通过才发放秘钥，否则拿不到秘钥，流程如下：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/image-20200614210546978.png" alt="image-20200614210546978"></p>
<p>微服务申请秘钥流程：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">1.服务启动时向ly-auth申请秘钥，携带配置好的clientId和secret</span></span><br><span class="line"><span class="meta">-</span> <span class="string">2.ly-auth接收请求，根据clientId去数据库查询</span></span><br><span class="line"><span class="meta">-</span> <span class="string">3.验证clientId和secret</span></span><br><span class="line"><span class="meta">-</span> <span class="string">4.如果验证通过，则返回秘钥</span></span><br></pre></td></tr></table></figure>

<p>我们需要做的准备包括：</p>
<ul>
<li>在ly-auth服务中提供一个接口，微服务调用时可以获取秘钥</li>
<li>微服务启动后，向ly-auth发送请求，获取秘钥</li>
</ul>
<h2 id="4-2-基本代码"><a href="#4-2-基本代码" class="headerlink" title="4.2.基本代码"></a>4.2.基本代码</h2><p>首先是client信息表相关的基本代码，包括实体类、mapper、service等。</p>
<h3 id="4-2-1-引入依赖"><a href="#4-2-1-引入依赖" class="headerlink" title="4.2.1.引入依赖"></a>4.2.1.引入依赖</h3><p>既然要访问数据库，需要在<code>ly-auth-service</code>中引入数据库访问所需要的依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="4-2-2-配置文件"><a href="#4-2-2-配置文件" class="headerlink" title="4.2.2.配置文件"></a>4.2.2.配置文件</h3><p>然后是在<code>ly-auth-service</code>的yaml文件中添加数据库配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://ly-mysql:3306/heima?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br><span class="line">      <span class="attr">insert-strategy:</span> <span class="string">not_null</span></span><br><span class="line">      <span class="attr">update-strategy:</span> <span class="string">not_null</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.leyou.auth.entity</span></span><br></pre></td></tr></table></figure>



<h3 id="4-2-3-实体类"><a href="#4-2-3-实体类" class="headerlink" title="4.2.3.实体类"></a>4.2.3.实体类</h3><p>首先在<code>ly-auth-service</code>的<code>com.leyou.auth.entity</code>包中添加实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.entity.BaseEntity;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName(&quot;tb_client_info&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@TableId</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String clientId;</span><br><span class="line">    <span class="keyword">private</span> String secret;</span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="4-2-4-mapper"><a href="#4-2-4-mapper" class="headerlink" title="4.2.4.mapper"></a>4.2.4.mapper</h3><p>在<code>ly-auth-service</code>的<code>com.leyou.auth.mapper</code>包中添加mapper接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.entity.ClientInfo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ClientMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">ClientInfo</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-2-5-service"><a href="#4-2-5-service" class="headerlink" title="4.2.5.service"></a>4.2.5.service</h3><p>在<code>ly-auth-service</code>的<code>com.leyou.auth.service</code>包中添加接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.entity.ClientInfo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ClientService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">ClientInfo</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>ly-auth-service</code>的<code>com.leyou.auth.service.impl</code>包中添加接口实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.entity.ClientInfo;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.mapper.ClientMapper;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.service.ClientService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">ClientMapper</span>, <span class="title">ClientInfo</span>&gt; <span class="keyword">implements</span> <span class="title">ClientService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-2-6-扫描包"><a href="#4-2-6-扫描包" class="headerlink" title="4.2.6.扫描包"></a>4.2.6.扫描包</h3><p>在<code>ly-auth-service</code>的启动类上添加注解，完成mapper扫描：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.leyou.auth.mapper&quot;)</span></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.leyou.user.client&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &#123;&quot;com.leyou.auth&quot;, &quot;com.leyou.common.advice&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LyAuthApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(LyAuthApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="4-2-7-密码加密"><a href="#4-2-7-密码加密" class="headerlink" title="4.2.7.密码加密"></a>4.2.7.密码加密</h3><p>数据库中的密码加密采用的是Bcrypt算法，这里也需要配置加密工具。</p>
<p>我们在<code>ly-auth-service</code>的<code>com.leyou.auth.config</code>包的<code>JwtConfig</code>中添加一个新的bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-3-申请秘钥的接口"><a href="#4-3-申请秘钥的接口" class="headerlink" title="4.3.申请秘钥的接口"></a>4.3.申请秘钥的接口</h2><p>我们在ly-auth中提供一个接口，提供给微服务调用，获取秘钥。</p>
<h3 id="4-2-1-定义接口"><a href="#4-2-1-定义接口" class="headerlink" title="4.2.1.定义接口"></a>4.2.1.定义接口</h3><p>在<code>ly-auth-api</code>中定义一个接口，格式如下：</p>
<ul>
<li>请求方式：Get</li>
<li>请求路径：/client/key</li>
<li>请求参数：<ul>
<li>clientId：微服务id</li>
<li>secret：微服务秘钥</li>
</ul>
</li>
<li>返回值：秘钥对象，SecretKey</li>
</ul>
<p>在<code>ly-auth-api</code>的pom文件中引入feign依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-openfeign-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ly-auth-pojo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>在<code>com.leyou.auth.client</code>包中定义接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(&quot;auth-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/client/key&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">getSecretKey</span><span class="params">(<span class="meta">@RequestParam(&quot;clientId&quot;)</span> String clientId,<span class="meta">@RequestParam(&quot;secret&quot;)</span> String secret)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-2-2-controller"><a href="#4-2-2-controller" class="headerlink" title="4.2.2.controller"></a>4.2.2.controller</h3><p>在<code>ly-auth-service</code>的<code>com.leyou.auth.web</code>包中定义controller，实现接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.service.ClientService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;client&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClientService clientService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClientController</span><span class="params">(ClientService clientService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientService = clientService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;key&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">getSecretKey</span><span class="params">(<span class="meta">@RequestParam(&quot;clientId&quot;)</span> String clientId, <span class="meta">@RequestParam(&quot;secret&quot;)</span> String secret)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(clientService.getSecretKey(clientId, secret));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="4-2-3-Service"><a href="#4-2-3-Service" class="headerlink" title="4.2.3.Service"></a>4.2.3.Service</h3><p>在<code>ly-auth-service</code>的<code>com.leyou.auth.service</code>包中添加接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.entity.ClientInfo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ClientService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">ClientInfo</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getSecretKey</span><span class="params">(String clientId, String secret)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>ly-auth-service</code>的<code>com.leyou.auth.service.impl</code>包中添加接口实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.entity.ClientInfo;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.mapper.ClientMapper;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.service.ClientService;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.exceptions.LyException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">ClientMapper</span>, <span class="title">ClientInfo</span>&gt; <span class="keyword">implements</span> <span class="title">ClientService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;ly.jwt.key&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClientServiceImpl</span><span class="params">(PasswordEncoder passwordEncoder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSecretKey</span><span class="params">(String clientId, String secret)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.查询client信息</span></span><br><span class="line">        ClientInfo client = query().eq(<span class="string">&quot;client_id&quot;</span>, clientId).one();</span><br><span class="line">        <span class="keyword">if</span> (client == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LyException(<span class="number">401</span>, <span class="string">&quot;客户端的信息有误，&quot;</span> + clientId + <span class="string">&quot;不存在！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.校验client的secret</span></span><br><span class="line">        <span class="keyword">if</span> (!passwordEncoder.matches(secret, client.getSecret())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LyException(<span class="number">401</span>, <span class="string">&quot;客户端的信息有误，secret不正确！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.返回秘钥</span></span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-4-申请秘钥"><a href="#4-4-申请秘钥" class="headerlink" title="4.4.申请秘钥"></a>4.4.申请秘钥</h2><p>我们把申请秘钥的功能写到<code>ly-auth-api</code>中，供其它微服务使用。<strong>其它微服务引入该依赖后，就会根据配置的clientId和secret，!!自动!!向<code>ly-auth</code>发起请求，申请秘钥</strong>。</p>
<p>我们<strong>约定</strong>微服务要在application.yml中配置自己的clientId和secret，格式如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ly:</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">  	<span class="attr">clientId:</span> <span class="string">xxx</span></span><br><span class="line">  	<span class="attr">secret:</span> <span class="string">xxx</span></span><br></pre></td></tr></table></figure>

<p>因此我们要在<code>ly-auth-api</code>的<code>com.leyou.auth.config</code>包中定义一个属性类，读取这两个属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(&quot;ly.auth&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String clientId;</span><br><span class="line">    <span class="keyword">private</span> String secret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>另外，我们需要在读取到clientId和secret以后，向<code>ly-auth</code>发出请求，申请秘钥，因此我们在<code>ly-auth-api</code>中定义一个配置类，完成秘钥加载，并完成对JwtUtils的初始化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.client.AuthClient;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;ly.auth&quot;, name = &#123;&quot;clientId&quot;, &quot;secret&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(ClientProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AuthClient authClient;</span><br><span class="line">    <span class="keyword">private</span> ClientProperties properties;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AuthConfiguration</span><span class="params">(AuthClient authClient, ClientProperties properties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.authClient = authClient;</span><br><span class="line">        <span class="keyword">this</span>.properties = properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtUtils <span class="title">jwtUtils</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 查询秘钥</span></span><br><span class="line">            String key = authClient.getSecretKey(properties.getClientId(), properties.getSecret());</span><br><span class="line">            <span class="comment">// 创建JwtUtils</span></span><br><span class="line">            JwtUtils jwtUtils = <span class="keyword">new</span> JwtUtils(key);</span><br><span class="line">            log.info(<span class="string">&quot;秘钥加载成功。&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> jwtUtils;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;初始化JwtUtils失败，&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，在配置类上的一个条件值的关注：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;ly.auth&quot;, name = &#123;&quot;clientId&quot;, &quot;secret&quot;&#125;)</span></span><br></pre></td></tr></table></figure>

<p>条件注解，意思是环境中必须有<code>ly.auth</code>开头的属性，属性名称必须叫<code>clientId</code>和<code>secret</code>，确保<strong>使用者会在yml中配置clientId和secret时，当前配置才会生效</strong>。</p>
<p>还有这个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.leyou.auth.client&quot;)</span></span><br></pre></td></tr></table></figure>

<p>目的是引入刚刚编写的<code>AuthClient</code>，方便查询秘钥</p>
<p>最后，为了让这个配置被SpringBoot加载，我们需要在<code>ly-auth-api</code>的resources目录中创建一个文件夹：META-INF，然后创建一个文件：spring.factories，然后填写内容：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">com.leyou.auth.config.AuthConfiguration</span></span><br></pre></td></tr></table></figure>

<p>如图：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/image-20200620083641159.png" alt="image-20200620083641159"> </p>
<p>另外，这样用户写yaml时是没有提示的，为了有提示，需要在META-INF下新建一个文件：<code>spring-configuration-metadata.json</code>，内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;groups&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ly.auth&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;com.leyou.auth.config.ClientProperties&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sourceType&quot;</span>: <span class="string">&quot;com.leyou.auth.config.ClientProperties&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;properties&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ly.auth.clientId&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;java.lang.String&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sourceType&quot;</span>: <span class="string">&quot;com.leyou.auth.config.ClientProperties&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;授权客户端的id&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ly.auth.secret&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;java.lang.String&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sourceType&quot;</span>: <span class="string">&quot;com.leyou.auth.config.ClientProperties&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;授权客户端的secret&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ly.auth.includeFilterPaths&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;java.lang.String&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sourceType&quot;</span>: <span class="string">&quot;com.leyou.auth.config.ClientProperties&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;登录拦截要包含的路径&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ly.auth.secret&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;java.lang.excludeFilterPaths&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;sourceType&quot;</span>: <span class="string">&quot;com.leyou.auth.config.ClientProperties&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;登录拦截放行的路径&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;hints&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-5-测试"><a href="#4-5-测试" class="headerlink" title="4.5.测试"></a>4.5.测试</h2><p>我们在<code>ly-user</code>中测试下这个功能。</p>
<p>首先，在<code>ly-user-service</code>中引入相关依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--ly-auth的API--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ly-auth-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接着，在<code>ly-user-service</code>的application.yml中配置客户端信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ly:</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">    <span class="attr">clientId:</span> <span class="string">user-service</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="number">1234</span></span><br></pre></td></tr></table></figure>

<p>修改启动类,添加注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># ...</span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LyUserApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(LyUserApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启<code>ly-user-service</code>，应该能看到日志输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2030-06-20 08:29:26.519  INFO 12232 --- [           main] com.leyou.auth.config.AuthConfig         : 秘钥加载成功。</span><br></pre></td></tr></table></figure>

<h3 id="思考总结："><a href="#思考总结：" class="headerlink" title="思考总结："></a>思考总结：</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">办理业务的微服务想要向授权中心获取密钥，来解析前端用户带过来的jwt是否有效</span></span><br><span class="line"><span class="attr">可以在微服务本地写一个类来实现，但是想一想，每一个办理业务的微服务都需要jwt验证，</span></span><br><span class="line"><span class="attr">都需要这么一个类，那不是代码冗余嘛！！！这是失败的方式</span></span><br><span class="line"><span class="attr">因此我们将“获取jwt校验用的密钥”的公共代码抽取授权中心，</span></span><br><span class="line"><span class="meta">抽取到一个具有条件加载的配置类</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(prefix</span> = <span class="string">&quot;ly.auth&quot;, name = &#123;&quot;clientId&quot;, &quot;secret&quot;&#125;)</span></span><br><span class="line">    <span class="attr">@EnableConfigurationProperties(ClientProperties.class)</span></span><br><span class="line">    <span class="attr">public</span> <span class="string">class AuthConfiguration &#123;</span></span><br><span class="line">    <span class="attr">...</span></span><br><span class="line"><span class="attr">那么，想要办理业务，向授权中心获取密钥的微服务，就可以导入授权中心的依赖库，</span></span><br><span class="line"><span class="meta">并在微服务本地配置文件中配置了ly.auth.clientId</span>   <span class="string">ly.auth.secret,</span></span><br><span class="line"></span><br><span class="line"><span class="meta">那么授权中心中的配置类就会被注入</span> <span class="string">AuthConfiguration</span></span><br><span class="line"></span><br><span class="line"><span class="meta">至于能不能返回密钥（微服务受不受信任），就要看配置的ly.auth.clientId</span>   <span class="string">ly.auth.secret</span></span><br><span class="line"><span class="attr">能否在微服务表格查找的到对象记录哈！！！</span></span><br></pre></td></tr></table></figure>

<h1 id="5-登录验证"><a href="#5-登录验证" class="headerlink" title="5.登录验证"></a>5.登录验证</h1><p>用户登录后，会携带JWT访问微服务，而微服务需要验证当前访问者的身份，如果验证通过则执行后续业务，验证失败，则拦截请求：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/image-20200620090019046.png" alt="image-20200620090019046"> </p>
<p>很多微服务都需要做用户登录状态验证，因此我们可以<strong>把这部分拦截和判断写到<code>ly-auth-api</code>中，作为工具</strong>。</p>
<h2 id="5-1-登录拦截器"><a href="#5-1-登录拦截器" class="headerlink" title="5.1.登录拦截器"></a>5.1.登录拦截器</h2><p>在<code>ly-auth-api</code>引入编写拦截器所需依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.leyou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ly-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>ly-auth-api</code>的<code>com.leyou.auth.interceptors</code>中编写一个拦截器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.interceptors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.constants.JwtConstants;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.dto.Payload;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.dto.UserDetail;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.exception.LyException;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.utils.CookieUtils;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.JwtException;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtUtils jwtUtils;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginInterceptor</span><span class="params">(JwtUtils jwtUtils)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jwtUtils = jwtUtils;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取cookie中的jwt</span></span><br><span class="line">            String jwt = CookieUtils.getCookieValue(request, JwtConstants.COOKIE_NAME);</span><br><span class="line">            <span class="comment">// 验证并解析</span></span><br><span class="line">            Payload payload = jwtUtils.parseJwt(jwt);</span><br><span class="line">            <span class="comment">// 获取用户</span></span><br><span class="line">            UserDetail userDetail = payload.getUserDetail();</span><br><span class="line">            log.info(<span class="string">&quot;用户&#123;&#125;正在访问。&quot;</span>, userDetail.getUsername());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JwtException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LyException(<span class="number">401</span>, <span class="string">&quot;JWT无效或过期!&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LyException(<span class="number">401</span>, <span class="string">&quot;用户未登录!&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-2-配置拦截器"><a href="#5-2-配置拦截器" class="headerlink" title="5.2.配置拦截器"></a>5.2.配置拦截器</h2><p>拦截器编写了还需要注册到SpringMVC中，因此我们<strong>编写配置类，完成拦截器注册</strong>。不过，拦截器的注册可能需要指定两个参数：</p>
<ul>
<li>拦截路径：指定拦截器对哪些路径生效</li>
<li>放行路径：指定拦截器对哪些路径放行</li>
</ul>
<p>我们<strong>约定</strong>用户会在application.yml中配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ly:</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">    <span class="attr">clientId:</span> <span class="string">user-service</span> <span class="comment"># 客户端id</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="number">1234</span> <span class="comment"># 客户端秘钥</span></span><br><span class="line">    <span class="attr">excludeFilterPaths:</span> <span class="comment"># 放行的路径</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/aa/**</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/bb/**</span></span><br><span class="line">    <span class="attr">includeFilterPaths:</span> <span class="comment"># 拦截的路径</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/xx/**</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/yy/**</span></span><br></pre></td></tr></table></figure>

<p>因此，我们要在ClientProperties中添加两个属性，来读取其中的值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(&quot;ly.auth&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientProperties</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String clientId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端秘钥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String secret;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拦截器拦截路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; includeFilterPaths;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拦截器放行路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; excludeFilterPaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在<code>ly-auth-api</code>中的<code>com.leyou.auth.config</code>包下编写一个配置类，配置拦截器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.interceptors.LoginInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Lazy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MvcConfiguration</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JwtUtils jwtUtils;</span><br><span class="line">    <span class="keyword">private</span> ClientProperties properties;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//这里产生了依赖循环，因此要加上@Lazy注解，JwtUtils使用到时才去注入。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MvcConfiguration</span><span class="params">(<span class="meta">@Lazy</span> JwtUtils jwtUtils, ClientProperties properties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jwtUtils = jwtUtils;</span><br><span class="line">        <span class="keyword">this</span>.properties = properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 注册拦截器，并得到拦截器注册器</span></span><br><span class="line">        InterceptorRegistration registration = registry.addInterceptor(<span class="keyword">new</span> LoginInterceptor(jwtUtils));</span><br><span class="line">        <span class="comment">// 判断用户是否配置了拦截路径，如果没配置走默认，就是拦截 /**</span></span><br><span class="line">        <span class="keyword">if</span>(!CollectionUtils.isEmpty(properties.getIncludeFilterPaths()))&#123;</span><br><span class="line">            registration.addPathPatterns(properties.getIncludeFilterPaths());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断用户是否配置了放行路径，如果没配置就是空</span></span><br><span class="line">        <span class="keyword">if</span>(!CollectionUtils.isEmpty(properties.getExcludeFilterPaths()))&#123;</span><br><span class="line">            registration.excludePathPatterns(properties.getExcludeFilterPaths());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-3-拦截器开关"><a href="#5-3-拦截器开关" class="headerlink" title="5.3.拦截器开关"></a>5.3.拦截器开关</h2><p>我们通过自定义的<code>MvcConfiguration</code>向mvc中配置了拦截器，但是<code>MvcConfiguration</code>并没有被Spring扫描，因此<strong>配置并未生效</strong>。</p>
<p>要想让配置生效，必须得让spring扫描到<code>MvcConfiguration</code>这个类。</p>
<p>但是引用ly-auth-api的服务可能只是需要JwtUtils，不需要做登录拦截，因此我们需要<strong>定义一个开关，用来开启或关闭拦截器功能。</strong></p>
<p>在<code>ly-auth-api</code>的<code>com.leyou.auth.annotation</code>包中定义一个注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.config.MvcConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Import;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 启用JWT验证开关，会通过mvc的拦截器拦截用户请求，并获取用户信息，存入UserContext</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Import(MvcConfiguration.class)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableJwtVerification &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个注解通过<code>@Import(MvcConfiguration.class)</code>来加载<code>MvcConfiguration</code>类，因此<strong>任何项目只要引入了<code>@EnableJwtVerification</code>就可以使得<code>MvcConfiguration</code>生效，从而使拦截器生效</strong>。</p>
<h2 id="5-4-测试"><a href="#5-4-测试" class="headerlink" title="5.4.测试"></a>5.4.测试</h2><p>现在，我们在<code>ly-user-service</code>测试拦截器。</p>
<p>首先，在<code>ly-user-service</code>的启动类上，添加<code>@EnableJwtVerification</code>注解，开启登录拦截器功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.annotation.EnableJwtVerification;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableJwtVerification</span><span class="comment">//开启登录拦截器的支持！</span></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.leyou.auth.client&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &#123;&quot;com.leyou.user&quot;, &quot;com.leyou.common.advice&quot;&#125;)</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.leyou.user.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LyUserApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(LyUserApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后在<code>ly-user-service</code>的<code>com.leyou.user.web</code>包中添加一个controller，方便测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.user.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;address&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddressController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="string">&quot;上海浦东新区航头镇航头路18号传智播客&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在<code>ly-user-service</code>的<code>application.yml</code>中配置拦截和放行路径：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ly:</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">    <span class="attr">clientId:</span> <span class="string">user-service</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="number">1234</span></span><br><span class="line">    <span class="attr">includeFilterPaths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/address/**</span> <span class="comment"># 拦截 /address开头的地址</span></span><br></pre></td></tr></table></figure>

<p>重启<code>ly-user-service</code>服务，浏览器中访问地址：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/image-20200627152500736.png" alt="image-20200627152500736"> </p>
<p>然后登录一下，再次访问：</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/image-20200627152512444.png" alt="image-20200627152512444"></p>
<p><strong>登录验证过程总结：</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1</span> <span class="string">用户登录后，会携带JWT访问微服务，</span></span><br><span class="line"><span class="attr">很多微服务都需要做用户登录状态验证，</span></span><br><span class="line"><span class="attr">因此我们可以把这部分拦截和判断抽离到`ly-auth-api`中，作为工具</span></span><br><span class="line"></span><br><span class="line"><span class="attr">2</span> <span class="string">在`ly-auth-api`的`com.leyou.auth.interceptors`中编写一个拦截器：（并导入响应依赖包）</span></span><br><span class="line"><span class="attr">拦截器里面能校验jwt，并且获取到UserDetail</span></span><br><span class="line"></span><br><span class="line"><span class="attr">3</span> <span class="string">拦截器编写了还需要注册到SpringMVC中，因此我们**编写配置类，完成拦截器注册**</span></span><br><span class="line"></span><br><span class="line"><span class="attr">在ClientProperties中添加两个属性</span></span><br><span class="line"><span class="attr">package</span> <span class="string">com.leyou.auth.config;</span></span><br><span class="line"><span class="attr">@Data</span></span><br><span class="line"><span class="attr">@ConfigurationProperties(&quot;ly.auth&quot;)</span></span><br><span class="line"><span class="attr">public</span> <span class="string">class ClientProperties &#123;。。。</span></span><br><span class="line"><span class="attr">（这个属性类是给使用“要使用jwt登录认证”的微服务使用的。</span></span><br><span class="line"><span class="attr">微服务想要使用该功能，就要导入ly-auth依赖，然后会在application.yml中配置：</span></span><br><span class="line"><span class="attr">ly</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">auth</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">clientId</span>: <span class="string">user-service # 客户端id</span></span><br><span class="line">    <span class="attr">secret</span>: <span class="string">1234 # 客户端秘钥</span></span><br><span class="line">    <span class="attr">excludeFilterPaths</span>: <span class="string"># 放行的路径</span></span><br><span class="line">      <span class="meta">-</span> <span class="string">/aa/**</span></span><br><span class="line">      <span class="meta">-</span> <span class="string">/bb/**</span></span><br><span class="line">    <span class="attr">includeFilterPaths</span>: <span class="string"># 拦截的路径</span></span><br><span class="line">      <span class="meta">-</span> <span class="string">/xx/**</span></span><br><span class="line">      <span class="meta">-</span> <span class="string">/yy/**</span></span><br><span class="line"></span><br><span class="line"><span class="attr">4</span>  <span class="string">然后在`ly-auth-api`中的`com.leyou.auth.config`包下编写一个配置类，配置拦截器：</span></span><br><span class="line"><span class="attr">public</span> <span class="string">class MvcConfiguration implements WebMvcConfigurer &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">5</span> <span class="string">定义一个开关（添加一个注解），用来开启或关闭拦截器功能</span></span><br><span class="line"><span class="attr">package</span> <span class="string">com.leyou.auth.annotation;</span></span><br><span class="line"><span class="attr">@Import(MvcConfiguration.class)</span></span><br><span class="line"><span class="attr">public</span> <span class="string">@interface EnableJwtVerification &#123;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">任何项目只要引入了注解`@EnableJwtVerification`</span></span><br><span class="line"><span class="attr">就可以使得`MvcConfiguration`生效，从而使拦截器生效</span></span><br><span class="line"></span><br><span class="line"><span class="attr">6</span> <span class="string">微服务想要使用auth的登录拦截功能：</span></span><br><span class="line"><span class="meta">（0)</span> <span class="string">导入auth依赖。</span></span><br><span class="line"><span class="meta">（1）在微服务的启动类中</span> <span class="string"></span></span><br><span class="line">	<span class="attr">添加`@EnableJwtVerification`注解，开启auth的登录拦截器功能</span></span><br><span class="line">		<span class="meta">@EnableFeignClients(basePackages</span> = <span class="string">&quot;com.leyou.auth.client&quot;)微服之间调用需要这个注解</span></span><br><span class="line"><span class="attr">（2）微服务yml配置文件中配置好拦截和放行路径</span></span><br><span class="line">	<span class="attr">ly</span>:<span class="string"></span></span><br><span class="line">	  <span class="attr">auth</span>:<span class="string"></span></span><br><span class="line">	    <span class="attr">clientId</span>: <span class="string">user-service</span></span><br><span class="line">	    <span class="attr">secret</span>: <span class="string">1234</span></span><br><span class="line">	    <span class="attr">includeFilterPaths</span>:<span class="string"></span></span><br><span class="line">	      <span class="meta">-</span> <span class="string">/address/** # 拦截 /address开头的地址</span></span><br><span class="line"><span class="attr">（3）微服务器中添加controller代码（路径是配置中的拦截路径，当前端访问该微服务的这个路径是，</span></span><br><span class="line">	<span class="attr">就会被auth微服拦截，完成是否登录，以及登录后的jwt校验）</span></span><br><span class="line">	</span><br><span class="line"><span class="attr">理解误区：微服A导入了微服B的依赖，并且添加相关注释就可以使用微服B的相关方法，工具，</span></span><br><span class="line"><span class="attr">比如第四章，“微服将jwt带给auth，返回密钥”，一些工具可以使用auth的，</span></span><br><span class="line"><span class="attr">但是返回的密钥key还是要从远端的auth返回过来，并不是利用auth工具直接生成的哦。</span></span><br></pre></td></tr></table></figure>

<p>小思考：</p>
<p>这验证都在auth api里面完成了，第四章“密钥管理”不是说了：由授权中心返回密钥，然后在微服务本地进行验证嘛？？？？</p>
<h1 id="6-页面获取用户信息"><a href="#6-页面获取用户信息" class="headerlink" title="6.页面获取用户信息"></a>6.页面获取用户信息</h1><p>虽然cookie已经成功写入，但是我们首页的顶部，登录状态依然没能判断出用户信息：</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/1527521794580.png" alt="1527521794580"></p>
<p>我们思考一下，应该如何获取用户信息呢？</p>
<h2 id="6-1-步骤分析"><a href="#6-1-步骤分析" class="headerlink" title="6.1.步骤分析"></a>6.1.步骤分析</h2><p>我们现在使用的是无状态登录，用户身份写入了jwt，解析JWT即可获取用户信息。但是jwt需要通过秘钥解析才知道是否有效，才可以解析用户身份。因此查询用户信息一定要发请求到服务端。</p>
<p>分析一下步骤：</p>
<ul>
<li>1）页面向后台发起请求，携带cookie</li>
<li>2）后台获取cookie中的jwt</li>
<li>3）校验jwt是否有效<ul>
<li>无效：登录失效或未登录，返回错误信息</li>
<li>有效：解析出里面的用户信息并返回</li>
</ul>
</li>
</ul>
<p>接下来，我们就分步实现上述功能。</p>
<h2 id="6-2-页面JS代码"><a href="#6-2-页面JS代码" class="headerlink" title="6.2.页面JS代码"></a>6.2.页面JS代码</h2><p>首先是页面发起请求，校验cookie。</p>
<p>页面的顶部已经被我们封装为一个独立的Vue组件，在<code>/js/pages/shortcut.js</code>中</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/1527522039407.png" alt="1527522039407"></p>
<p>打开js，发现里面已经定义好了Vue组件，并且在created函数中，查询用户信息：</p>
<p> <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/image-20200620104716345.png" alt="image-20200620104716345"></p>
<p>因为jwt在cookie中，因此本次请求肯定会携带jwt信息在cookie中。</p>
<h2 id="6-3-查询当前用户的接口"><a href="#6-3-查询当前用户的接口" class="headerlink" title="6.3.查询当前用户的接口"></a>6.3.查询当前用户的接口</h2><p>我们在<code>ly-user-service</code>中定义用户的校验接口，通过cookie获取jwt，然后校验通过返回用户信息。</p>
<ul>
<li>请求方式：GET</li>
<li>请求路径：/info/me</li>
<li>请求参数：无，不过我们需要从cookie中获取jwt信息</li>
<li>返回结果：校验成功返回用户；校验失败，则返回401</li>
</ul>
<p>在<code>ly-user-service</code>的<code>com.leyou.user.web</code>包的<code>UserController</code>中添加代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前登录的用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;me&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;UserDetail&gt; <span class="title">me</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ResponseEntity.ok(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改ly-user-service:的application.yml添加拦截路径，最新yml内容为：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8086</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">user-service</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://ly-mysql:3306/heima?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">ly-redis</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">ly-mq</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">leyou</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123321</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://ly-registry:10086/eureka</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.leyou:</span> <span class="string">debug</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br><span class="line">      <span class="attr">insert-strategy:</span> <span class="string">not_null</span></span><br><span class="line">      <span class="attr">update-strategy:</span> <span class="string">not_null</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.leyou.user.entity</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ly:</span></span><br><span class="line">  <span class="attr">encoder:</span></span><br><span class="line">    <span class="attr">crypt:</span></span><br><span class="line">      <span class="attr">secret:</span> <span class="string">$&#123;random.uuid&#125;</span> <span class="comment"># 随机的密钥，使用uuid</span></span><br><span class="line">      <span class="attr">strength:</span> <span class="number">6</span> <span class="comment"># 加密强度4~31，决定盐加密时的运算强度，超过10以后加密耗时会显著增加</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">    <span class="attr">clientId:</span> <span class="string">user-service</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="number">1234</span></span><br><span class="line">    <span class="attr">includeFilterPaths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/address/**</span> <span class="comment"># 拦截 /address开头的地址</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/info/me</span> <span class="comment"># 展示用户登录信息时需要拦截器生效</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="6-4-用户上下文"><a href="#6-4-用户上下文" class="headerlink" title="6.4.用户上下文"></a>6.4.用户上下文</h2><p>现在，我们接收了用户的请求，但是该如何获取当前登录用户信息呢？</p>
<h3 id="6-4-1-思路分析"><a href="#6-4-1-思路分析" class="headerlink" title="6.4.1.思路分析"></a>6.4.1.思路分析</h3><p>其实，在<code>ly-user-service</code>中已经引入了<code>ly-auth-api</code>的依赖，而<code>ly-auth-api</code>中提供了一个拦截器<code>LoginInterceptor</code>，已经拦截请求并且获取了用户信息。</p>
<p>拦截器放行后才会进入<code>UserController</code>的方法<code>me()</code>中。那么，我们为什么不能<strong>把拦截器中获取的用户信息，保存起来，然后在<code>UserController</code>中直接获取并使用</strong>呢，如图：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/image-20200620111630238.png" alt="image-20200620111630238"></p>
<p>步骤如下：</p>
<ul>
<li>1.前端发出请求到服务端，查询登录用户信息</li>
<li>2.拦截器拦截请求，验证并解析JWT，得到用户信息UserDetails</li>
<li>3.<strong>将用户信息存入UserContext（需要自己实现）上下文</strong>，放行请求</li>
<li>4.controller处理请求，从UserContext获取用后，返回给前端</li>
</ul>
<h3 id="6-4-2-UserContext"><a href="#6-4-2-UserContext" class="headerlink" title="6.4.2.UserContext"></a>6.4.2.UserContext</h3><p>UserContext用来存储当前的用户信息，但是该如何保存呢？</p>
<p>要知道用户的请求肯定是<strong>多线程</strong>并发访问的，如果直接将UserDetail存入UserContext的成员变量，会存在<strong>线程并发安全问题</strong>。我们必须保证每一个请求（一个线程）都有自己的用户信息，互不干扰！</p>
<h4 id="1）ThreadLocal"><a href="#1）ThreadLocal" class="headerlink" title="1）ThreadLocal"></a>1）ThreadLocal</h4><p><code>ThreadLocal</code>恰好满足这个需求，那么ThreadLocal是如何实现这一需求的呢？</p>
<p>看下这幅图：</p>
<p>  <img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/1554964371849.png" alt="1554964371849"></p>
<p>关键点：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">每个线程（`Thread`）内部都持有一个`ThreadLocalMap`对象。</span></span><br><span class="line"><span class="meta">-</span> <span class="string">`ThreadLocalMap`的Key是某个`ThreadLocal`对象，值是任意Object。</span></span><br><span class="line"><span class="meta">-</span> <span class="string">不同线程，内部有自己的`ThreadLocalMap`，因此各线程资源互相不会干扰。</span></span><br></pre></td></tr></table></figure>

<p>当我们使用ThreadLocal存储数据时，ThreadLocal会先得到当前线程（currentThread)对象，然后获取线程中的<code>ThreadLocalMap</code>对象，接着把数据存储到这个<code>ThreadLocalMap</code>对象中，因此<strong>每个线程的用户都在线程自己的<code>ThreadLocalMap</code>对象中，互不干扰</strong>。</p>
<h4 id="2）UserContext"><a href="#2）UserContext" class="headerlink" title="2）UserContext"></a>2）UserContext</h4><p>接下来，我们实现UserContext。在<code>ly-auth-api</code>中的<code>com.leyou.auth.utils</code>定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.dto.UserDetail;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserContext</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;UserDetail&gt; TL = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存储一个用户到当前线程</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setUser</span><span class="params">(UserDetail user)</span> </span>&#123;</span><br><span class="line">        TL.set(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从当前线程获取一个用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> UserDetail <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> TL.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从当前线程移除用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TL.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-4-3-存储用户"><a href="#6-4-3-存储用户" class="headerlink" title="6.4.3.存储用户"></a>6.4.3.存储用户</h3><p>接下来，我们修改拦截器逻辑，获取用户后把用户存储在UserContext中。</p>
<p>修改<code>ly-auth-api</code>中的<code>LoginInterceptor</code>，完整代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leyou.auth.interceptors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.constants.JwtConstants;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.dto.Payload;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.dto.UserDetail;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.dto.UserDetail;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> com.leyou.auth.utils.UserContext;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.exception.LyException;</span><br><span class="line"><span class="keyword">import</span> com.leyou.common.utils.CookieUtils;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.JwtException;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtUtils jwtUtils;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginInterceptor</span><span class="params">(JwtUtils jwtUtils)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jwtUtils = jwtUtils;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取cookie中的jwt</span></span><br><span class="line">            String jwt = CookieUtils.getCookieValue(request, JwtConstants.COOKIE_NAME);</span><br><span class="line">            <span class="comment">// 验证并解析</span></span><br><span class="line">            Payload payload = jwtUtils.parseJwt(jwt);</span><br><span class="line">            <span class="comment">// 获取用户</span></span><br><span class="line">            UserDetail userDetails = payload.getUserDetail();</span><br><span class="line">            log.info(<span class="string">&quot;用户&#123;&#125;正在访问。&quot;</span>, userDetails.getUsername());</span><br><span class="line">            <span class="comment">// 保存用户</span></span><br><span class="line">            UserContext.setUser(userDetails);<span class="comment">//###########将获取到的用户信息放到</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JwtException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LyException(<span class="number">401</span>, <span class="string">&quot;JWT无效或过期!&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LyException(<span class="number">401</span>, <span class="string">&quot;用户未登录!&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 业务结束后，移除用户</span></span><br><span class="line">        UserContext.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="6-5-完成controller逻辑"><a href="#6-5-完成controller逻辑" class="headerlink" title="6.5.完成controller逻辑"></a>6.5.完成controller逻辑</h2><p>现在，让我们补充完成<code>ly-user-service</code>中的<code>UserController</code>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前登录的用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;me&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;UserDetails&gt; <span class="title">me</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ResponseEntity.ok(UserContext.getUser());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="6-6-测试"><a href="#6-6-测试" class="headerlink" title="6.6.测试"></a>6.6.测试</h2><p> 重启<code>ly-auth-service</code>后测试。</p>
<p>页面效果：</p>
<p><img src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/1527554017189.png" alt="1527554017189"></p>
<p>总结：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">状态bean,bean中存了共享信息,并且是可変化的共享信息状态</span></span><br><span class="line"><span class="attr">bean会带来的问题是?数据污染例bean线程共享,线程不安全,</span></span><br><span class="line"></span><br><span class="line"><span class="meta">综上,我们直接把</span> <span class="string">userdetail作为状态bean的属性,不可以</span></span><br><span class="line"><span class="meta">状态bean,单例bean</span>=<span class="string">=&gt;单线程 ok</span></span><br><span class="line"><span class="meta">状态bean,单例bean,多线程</span>=<span class="string">=&gt;bug</span></span><br><span class="line"><span class="meta">状态bean,中的状态属存入</span> <span class="string">Threadlocal,单例bean,多线程==&gt;OK</span></span><br><span class="line"></span><br><span class="line"><span class="meta">ThreadLocal,持点</span>:<span class="string">一次请求,一个线程,每一个线程对应的一个独立的 threadlocal</span></span><br></pre></td></tr></table></figure>



</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">高明辉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/07/01/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83-JWT%E7%99%BB%E5%BD%9501/">http://example.com/2022/07/01/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83-JWT%E7%99%BB%E5%BD%9501/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Jason</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JWT/">JWT</a><a class="post-meta__tags" href="/tags/%E7%99%BB%E5%BD%95/">登录</a></div><div class="post_share"><div class="social-share" data-image="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/11JWT%E7%99%BB%E5%BD%9501/%E5%B0%81%E9%9D%A2.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="添加微信"/></a><div class="post-qr-code-desc">添加微信</div></li><li class="reward-item"><a href="/img/pay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/pay.jpg" alt="付款码"/></a><div class="post-qr-code-desc">付款码</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/07/02/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83-JWT%E7%99%BB%E5%BD%9502/"><img class="prev-cover" src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/12JWT%E7%99%BB%E5%BD%9502/%E5%B0%81%E9%9D%A2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">乐优商城项目-用户中心-JWT登录02</div></div></a></div><div class="next-post pull-right"><a href="/2022/06/30/ali%E7%9F%AD%E4%BF%A1%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%BC%80%E9%80%9A%E4%BB%A5%E5%8F%8A%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%E4%B8%8E%E6%B5%8B%E8%AF%95/"><img class="next-cover" src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/10%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83-%E6%B3%A8%E5%86%8C/ali.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ali短信服务的开通以及基本配置与测试</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/07/02/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83-JWT%E7%99%BB%E5%BD%9502/" title="乐优商城项目-用户中心-JWT登录02"><img class="cover" src="/img/java/06%E9%98%B6%E6%AE%B5%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/12JWT%E7%99%BB%E5%BD%9502/%E5%B0%81%E9%9D%A2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-02</div><div class="title">乐优商城项目-用户中心-JWT登录02</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E6%97%A0%E7%8A%B6%E6%80%81%E7%99%BB%E5%BD%95%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">1.无状态登录原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%89%E7%8A%B6%E6%80%81%EF%BC%9F"><span class="toc-number">2.1.</span> <span class="toc-text">1.1.什么是有状态？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E4%BB%80%E4%B9%88%E6%98%AF%E6%97%A0%E7%8A%B6%E6%80%81"><span class="toc-number">2.2.</span> <span class="toc-text">1.2.什么是无状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%97%A0%E7%8A%B6%E6%80%81"><span class="toc-number">2.3.</span> <span class="toc-text">1.3.如何实现无状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-JWT"><span class="toc-number">2.4.</span> <span class="toc-text">1.4.JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-1-%E7%AE%80%E4%BB%8B"><span class="toc-number">2.4.1.</span> <span class="toc-text">1.4.1.简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-2-%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.4.2.</span> <span class="toc-text">1.4.2.数据格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-JWT%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="toc-number">2.5.</span> <span class="toc-text">1.5.JWT登录流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E7%BC%96%E5%86%99JWT%E5%B7%A5%E5%85%B7"><span class="toc-number">3.</span> <span class="toc-text">2.编写JWT工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E4%BE%9D%E8%B5%96"><span class="toc-number">3.1.</span> <span class="toc-text">2.1.依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E8%BD%BD%E8%8D%B7%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.2.</span> <span class="toc-text">2.2.载荷对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E5%B7%A5%E5%85%B7"><span class="toc-number">3.3.</span> <span class="toc-text">2.3.工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E6%B5%8B%E8%AF%95"><span class="toc-number">3.4.</span> <span class="toc-text">2.4.测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">3.4.1.</span> <span class="toc-text">2.4.1.引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-%E9%85%8D%E7%BD%AE%E7%A7%98%E9%92%A5"><span class="toc-number">3.4.2.</span> <span class="toc-text">2.4.2.配置秘钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-3-%E6%B5%8B%E8%AF%95%E7%B1%BB"><span class="toc-number">3.4.3.</span> <span class="toc-text">2.4.3.测试类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E7%99%BB%E5%BD%95%E6%8E%88%E6%9D%83"><span class="toc-number">4.</span> <span class="toc-text">3.登录授权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">4.1.</span> <span class="toc-text">3.1.思路分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E7%94%A8%E6%88%B7%E9%AA%8C%E8%AF%81%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.2.</span> <span class="toc-text">3.2.用户验证的接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.2.1.</span> <span class="toc-text">3.2.1.定义接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-ly-auth%E5%BC%95%E7%94%A8%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.2.2.</span> <span class="toc-text">3.2.2.ly-auth引用接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E7%99%BB%E5%BD%95%E7%9A%84controller"><span class="toc-number">4.3.</span> <span class="toc-text">3.3.登录的controller</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E7%99%BB%E5%BD%95%E7%9A%84service"><span class="toc-number">4.4.</span> <span class="toc-text">3.4.登录的service</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E6%B5%8B%E8%AF%95"><span class="toc-number">4.5.</span> <span class="toc-text">3.5.测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E7%A7%98%E9%92%A5%E7%AE%A1%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">4.秘钥管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">5.1.</span> <span class="toc-text">4.1.思路分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E5%9F%BA%E6%9C%AC%E4%BB%A3%E7%A0%81"><span class="toc-number">5.2.</span> <span class="toc-text">4.2.基本代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">5.2.1.</span> <span class="toc-text">4.2.1.引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.2.2.</span> <span class="toc-text">4.2.2.配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-number">5.2.3.</span> <span class="toc-text">4.2.3.实体类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-4-mapper"><span class="toc-number">5.2.4.</span> <span class="toc-text">4.2.4.mapper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-5-service"><span class="toc-number">5.2.5.</span> <span class="toc-text">4.2.5.service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-6-%E6%89%AB%E6%8F%8F%E5%8C%85"><span class="toc-number">5.2.6.</span> <span class="toc-text">4.2.6.扫描包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-7-%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86"><span class="toc-number">5.2.7.</span> <span class="toc-text">4.2.7.密码加密</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E7%94%B3%E8%AF%B7%E7%A7%98%E9%92%A5%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.3.</span> <span class="toc-text">4.3.申请秘钥的接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.3.1.</span> <span class="toc-text">4.2.1.定义接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-controller"><span class="toc-number">5.3.2.</span> <span class="toc-text">4.2.2.controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-Service"><span class="toc-number">5.3.3.</span> <span class="toc-text">4.2.3.Service</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E7%94%B3%E8%AF%B7%E7%A7%98%E9%92%A5"><span class="toc-number">5.4.</span> <span class="toc-text">4.4.申请秘钥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E6%B5%8B%E8%AF%95"><span class="toc-number">5.5.</span> <span class="toc-text">4.5.测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%80%83%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-number">5.5.1.</span> <span class="toc-text">思考总结：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81"><span class="toc-number">6.</span> <span class="toc-text">5.登录验证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">6.1.</span> <span class="toc-text">5.1.登录拦截器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E9%85%8D%E7%BD%AE%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">6.2.</span> <span class="toc-text">5.2.配置拦截器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E6%8B%A6%E6%88%AA%E5%99%A8%E5%BC%80%E5%85%B3"><span class="toc-number">6.3.</span> <span class="toc-text">5.3.拦截器开关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E6%B5%8B%E8%AF%95"><span class="toc-number">6.4.</span> <span class="toc-text">5.4.测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E9%A1%B5%E9%9D%A2%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">7.</span> <span class="toc-text">6.页面获取用户信息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E6%AD%A5%E9%AA%A4%E5%88%86%E6%9E%90"><span class="toc-number">7.1.</span> <span class="toc-text">6.1.步骤分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E9%A1%B5%E9%9D%A2JS%E4%BB%A3%E7%A0%81"><span class="toc-number">7.2.</span> <span class="toc-text">6.2.页面JS代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E6%9F%A5%E8%AF%A2%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-number">7.3.</span> <span class="toc-text">6.3.查询当前用户的接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E7%94%A8%E6%88%B7%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">7.4.</span> <span class="toc-text">6.4.用户上下文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-number">7.4.1.</span> <span class="toc-text">6.4.1.思路分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-2-UserContext"><span class="toc-number">7.4.2.</span> <span class="toc-text">6.4.2.UserContext</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89ThreadLocal"><span class="toc-number">7.4.2.1.</span> <span class="toc-text">1）ThreadLocal</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89UserContext"><span class="toc-number">7.4.2.2.</span> <span class="toc-text">2）UserContext</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-3-%E5%AD%98%E5%82%A8%E7%94%A8%E6%88%B7"><span class="toc-number">7.4.3.</span> <span class="toc-text">6.4.3.存储用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E5%AE%8C%E6%88%90controller%E9%80%BB%E8%BE%91"><span class="toc-number">7.5.</span> <span class="toc-text">6.5.完成controller逻辑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6-%E6%B5%8B%E8%AF%95"><span class="toc-number">7.6.</span> <span class="toc-text">6.6.测试</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 高明辉</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'Aaee0Vekhg5KbLhMOJQrEU6A-gzGzoHsz',
      appKey: 'mmLHPEEtqvOSJhsqWra8Sq6K',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script type="text/javascript" src="/js/fairyDustCursor.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>